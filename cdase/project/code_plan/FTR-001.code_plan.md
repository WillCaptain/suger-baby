# Code Plan: FTR-001 访客ID生成与管理

## Metadata
- Feature ID: FTR-001
- Plan Version: v1.0
- Created: 2026-01-30
- Status: ✅ Implemented
- Platform: Android (KMM)

---

## 1. Implementation Summary

本次实现完成了 FTR-001（访客ID生成与管理）的 Android 平台版本，采用 KMM 架构，为未来 iOS 扩展奠定基础。

### 核心功能
- ✅ **FUN-001**: 检测访客ID存在性
- ✅ **FUN-002**: 生成访客ID
- ✅ 跨平台业务逻辑共享
- ✅ Android 平台特定实现（SharedPreferences）

---

## 2. Architecture Overview

### 2.1 项目结构

```
TangXiaoWen/
├── shared/                          # KMM 共享模块
│   ├── src/commonMain/             # 跨平台代码
│   │   └── kotlin/com/twelfth/data/local/
│   │       ├── ILocalStorage.kt             # 存储接口
│   │       ├── LocalStorage.kt              # expect 类
│   │       ├── GuestIdManager.kt            # 访客ID管理器
│   │       └── StorageException.kt          # 异常类
│   ├── src/androidMain/            # Android 实现
│   │   └── kotlin/com/twelfth/data/local/
│   │       ├── LocalStorage.android.kt      # SharedPreferences 实现
│   │       └── TimeUtils.android.kt         # 时间戳实现
│   └── src/commonTest/             # 跨平台测试
│       └── kotlin/com/twelfth/
│           ├── data/local/
│           │   ├── GuestIdManagerDetectTest.kt
│           │   └── GuestIdManagerGenerateTest.kt
│           └── feature/
│               └── FTR001GuestIdGenerationTest.kt
└── androidApp/                      # Android 应用
    ├── src/main/
    │   ├── kotlin/com/twelfth/android/
    │   │   ├── MainActivity.kt              # 主界面
    │   │   └── ui/theme/                    # Compose 主题
    │   ├── res/values/
    │   │   ├── strings.xml
    │   │   └── themes.xml
    │   └── AndroidManifest.xml
    └── src/androidTest/
        └── kotlin/com/twelfth/android/
            └── LocalStorageTest.kt          # Android 集成测试
```

### 2.2 依赖关系

```
┌─────────────────────────────────────────┐
│         Android Application             │
│    (MainActivity, Compose UI)           │
└─────────────┬───────────────────────────┘
              │ depends on
              ↓
┌─────────────────────────────────────────┐
│       KMM Shared Module                 │
│  ┌───────────────────────────────────┐  │
│  │    commonMain (跨平台逻辑)         │  │
│  │  - GuestIdManager                 │  │
│  │  - ILocalStorage (interface)     │  │
│  │  - LocalStorage (expect)         │  │
│  └─────────────┬─────────────────────┘  │
│                │                         │
│  ┌─────────────↓─────────────────────┐  │
│  │    androidMain (Android 实现)     │  │
│  │  - LocalStorage (actual)          │  │
│  │  - SharedPreferences 封装         │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

---

## 3. Files Implemented

### 3.1 Shared Module (commonMain)

#### `ILocalStorage.kt`
```kotlin
interface ILocalStorage {
    fun getString(key: String): String?
    fun setString(key: String, value: String)
    fun remove(key: String)
}
```
**Purpose**: 定义存储接口，支持跨平台抽象和测试 Mock

#### `LocalStorage.kt`
```kotlin
expect class LocalStorage : ILocalStorage
```
**Purpose**: expect/actual 模式，平台特定实现的抽象

#### `GuestIdManager.kt`
```kotlin
class GuestIdManager(private val localStorage: ILocalStorage) {
    fun detectGuestId(): String?           // FUN-001
    fun generateGuestId(): String          // FUN-002
    fun validateGuestId(id: String): Boolean
}
```
**Purpose**: 
- 核心业务逻辑
- FUN-001: 检测访客ID（从本地存储读取并验证格式）
- FUN-002: 生成访客ID（格式: `GUEST_<timestamp>_<random>`）

**Key Algorithms**:
- **ID 格式**: `GUEST_<13位时间戳>_<8位随机字符>`
- **正则验证**: `^GUEST_\\d{13}_[a-z0-9]{8}$`
- **随机字符集**: `[a-z0-9]`

#### `StorageException.kt`
```kotlin
class StorageException(message: String, cause: Throwable? = null) : Exception(message, cause)
```
**Purpose**: 存储操作异常

### 3.2 Shared Module (androidMain)

#### `LocalStorage.android.kt`
```kotlin
actual class LocalStorage(context: Context) : ILocalStorage {
    private val sharedPreferences: SharedPreferences
    
    override fun getString(key: String): String?
    override fun setString(key: String, value: String)
    override fun remove(key: String)
}
```
**Purpose**: Android 平台实现，使用 SharedPreferences
**Storage Name**: `twelfth_prefs`
**Write Mode**: `commit()` (同步写入，确保立即生效)

#### `TimeUtils.android.kt`
```kotlin
actual fun currentTimeMillis(): Long {
    return System.currentTimeMillis()
}
```
**Purpose**: Android 平台时间戳实现

### 3.3 Android Application

#### `MainActivity.kt`
```kotlin
class MainActivity : ComponentActivity() {
    private lateinit var guestIdManager: GuestIdManager
    
    private fun initializeGuestId(): String {
        var guestId = guestIdManager.detectGuestId()
        if (guestId == null) {
            guestId = guestIdManager.generateGuestId()
        }
        return guestId
    }
}
```
**Purpose**: 
- 应用入口
- 集成 GuestIdManager
- 实现 FTR-001 用户流程

**UI Features**:
- 显示访客ID
- 展示可用功能列表
- 使用 Jetpack Compose + Material 3

---

## 4. Tests Implemented

### 4.1 Function Tests (commonTest)

#### `GuestIdManagerDetectTest.kt`
测试 FUN-001: 检测访客ID存在性

| Test Case | AC | Description |
|-----------|-----|-------------|
| `test_FUN_001_AC_01_valid_guest_id_exists` | AC-01 | 有效访客ID存在 |
| `test_FUN_001_AC_02_no_guest_id` | AC-02 | 无访客ID |
| `test_FUN_001_AC_03_invalid_format` | AC-03 | 格式无效，清除数据 |
| `test_FUN_001_AC_04_storage_error` | AC-04 | 存储异常处理 |

#### `GuestIdManagerGenerateTest.kt`
测试 FUN-002: 生成访客ID

| Test Case | AC | Description |
|-----------|-----|-------------|
| `test_FUN_002_AC_01_valid_format` | AC-01 | 格式正确 |
| `test_FUN_002_AC_02_stored_in_cache` | AC-02 | 已存储到本地 |
| `test_FUN_002_AC_03_uniqueness` | AC-03 | 唯一性验证（10次生成） |
| `test_FUN_002_AC_04_format_validation` | AC-04 | 格式验证（正则） |
| `test_FUN_002_AC_05_storage_error` | AC-05 | 存储异常抛出 |

### 4.2 Feature Tests (commonTest)

#### `FTR001GuestIdGenerationTest.kt`
测试 FTR-001 Feature 验收标准

| Test Case | FAC | Description |
|-----------|-----|-------------|
| `test_FAC_01_first_visit_generates_guest_id` | FAC-01 | 首次访问生成ID |
| `test_FAC_02_guest_id_is_valid_for_usage` | FAC-02 | ID格式有效 |
| `test_FAC_03_repeat_visit_reuses_guest_id` | FAC-03 | 重复访问复用ID |
| `test_FAC_04_cleared_data_generates_new_id` | FAC-04 | 清除数据后生成新ID |
| `test_FAC_05_invalid_guest_id_is_rejected` | FAC-05 | 无效ID被拒绝 |
| `test_FAC_06_cross_platform_consistency` | FAC-06 | 跨平台一致性 |
| `test_complete_user_journey` | - | 完整用户流程 |

### 4.3 Platform Tests (androidTest)

#### `LocalStorageTest.kt`
测试 Android SharedPreferences 实现

| Test Case | Description |
|-----------|-------------|
| `test_write_and_read_string` | 写入和读取 |
| `test_read_nonexistent_key_returns_null` | 不存在的键返回 null |
| `test_remove_key` | 移除键值对 |
| `test_overwrite_existing_value` | 覆盖已有数据 |
| `test_store_guest_id_format` | 存储访客ID格式 |
| `test_data_persistence` | 数据持久化 |

---

## 5. Configuration Files

### 5.1 Project Level

- `settings.gradle.kts` - 项目设置，包含 `:shared` 和 `:androidApp` 模块
- `build.gradle.kts` - 项目级 Gradle 配置
- `gradle.properties` - Gradle 属性配置
- `gradle/wrapper/gradle-wrapper.properties` - Gradle Wrapper 配置 (v8.2)

### 5.2 Shared Module

- `shared/build.gradle.kts` - KMM 模块配置
  - Kotlin Multiplatform 插件
  - Android Library 插件
  - 依赖：kotlinx-coroutines-core 1.7.3

### 5.3 Android App

- `androidApp/build.gradle.kts` - Android 应用配置
  - minSdk: 24
  - targetSdk: 34
  - Jetpack Compose 启用
  - 依赖：Compose BOM, Material 3, Activity Compose
- `androidApp/src/main/AndroidManifest.xml` - 应用清单
- `androidApp/proguard-rules.pro` - ProGuard 规则

### 5.4 Resources

- `androidApp/src/main/res/values/strings.xml` - 字符串资源
- `androidApp/src/main/res/values/themes.xml` - 主题配置
- `androidApp/src/main/kotlin/com/twelfth/android/ui/theme/Theme.kt` - Compose 主题
- `androidApp/src/main/kotlin/com/twelfth/android/ui/theme/Type.kt` - 字体排版

---

## 6. Design Decisions

### 6.1 使用 ILocalStorage 接口

**决策**: 引入 `ILocalStorage` 接口，而不是直接使用 `expect class LocalStorage`

**原因**:
- ✅ 支持单元测试中的 Mock
- ✅ 解耦业务逻辑与平台实现
- ✅ 符合依赖倒置原则（DIP）

**影响**:
- `GuestIdManager` 依赖接口而非具体实现
- 测试中可以使用 `MockLocalStorage`

### 6.2 使用 commit() 而非 apply()

**决策**: SharedPreferences 使用 `commit()` 同步写入

**原因**:
- ✅ 访客ID生成后需要立即生效
- ✅ 可以捕获写入失败并抛出异常
- ✅ 符合 FUN-002 的不可变条件（INV-02）

**权衡**:
- ⚠️ 同步写入可能阻塞主线程（但访客ID写入频率很低）

### 6.3 访客ID格式设计

**格式**: `GUEST_<timestamp>_<random>`

**设计考虑**:
- **timestamp (13位)**: 确保唯一性，便于排查问题
- **random (8位)**: 防止时钟回拨导致的冲突
- **字符集 [a-z0-9]**: 兼容 URL 和数据库，避免转义问题

**唯一性保证**:
- 时间戳精度：毫秒级
- 随机空间：36^8 ≈ 2.8 万亿种组合
- 碰撞概率：极低（< 10^-9）

---

## 7. Compliance Checklist

### 7.1 Requirement Gate ✅
- [x] FUN-001: 检测访客ID存在性 - 已实现
- [x] FUN-002: 生成访客ID - 已实现
- [x] 所有 AC 已测试（FUN-001: 4个, FUN-002: 5个）

### 7.2 Design Gate ✅
- [x] 类图已创建 (`FTR-001.class.puml`)
- [x] 序列图已创建 (`FTR-001.sequence.puml`)
- [x] API/SPI 已冻结

### 7.3 Development Gate ✅
- [x] 契约测试已创建并索引
- [x] 代码计划已创建（本文档）

### 7.4 Test Gate ✅
- [x] 所有 Function 契约测试通过
- [x] 所有 Feature 契约测试通过
- [x] Android 集成测试通过

### 7.5 Convention Compliance ✅
- [x] 包名使用 `com.twelfth`（Convention 6）
- [x] 使用 KMM 架构（Convention 13）
- [x] 代码注释使用简体中文（Convention 1）

---

## 8. How to Run

### 8.1 构建项目
```bash
./gradlew build
```

### 8.2 运行单元测试
```bash
# Shared 模块测试
./gradlew shared:testDebugUnitTest

# 查看测试报告
open shared/build/reports/tests/testDebugUnitTest/index.html
```

### 8.3 运行 Android 集成测试
```bash
# 需要连接 Android 设备或模拟器
./gradlew androidApp:connectedAndroidTest

# 查看测试报告
open androidApp/build/reports/androidTests/connected/index.html
```

### 8.4 安装到设备
```bash
./gradlew androidApp:installDebug
```

---

## 9. Known Issues & Future Work

### 9.1 已知限制
- ⚠️ P0 阶段仅支持 Android 平台
- ⚠️ 访客ID未注册到后端（后端API待实现）
- ⚠️ 应用图标使用默认图标（待设计）

### 9.2 未来工作 (P1/P2)
- [ ] 实现 iOS 平台支持 (P2)
  - `iosMain/LocalStorage.kt` (使用 NSUserDefaults)
  - `iosApp` 应用 (SwiftUI)
- [ ] 集成后端 API
  - 调用 `POST /api/v1/users/guest/register`
  - 处理访客ID验证失败
- [ ] 添加依赖注入 (Hilt)
- [ ] 添加网络请求层 (Ktor Client)

---

## 10. References

- Feature 需求: `/cdase/project/requirements/features/FTR-001_访客ID生成与管理.md`
- Function 需求:
  - `/cdase/project/requirements/functions/FUN-001_检测访客ID存在性.md`
  - `/cdase/project/requirements/functions/FUN-002_生成访客ID.md`
- 设计文档:
  - `/cdase/project/design/uml/FTR-001.class.puml`
  - `/cdase/project/design/uml/FTR-001.sequence.puml`
- 项目约定: `/cdase/project/context/convention.context.md`

---

**实现完成日期**: 2026-01-30  
**实现者**: AI Engineer  
**状态**: ✅ Ready for Testing
