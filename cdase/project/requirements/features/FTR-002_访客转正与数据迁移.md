> NOTE:
> The Stage Ownership table is the single source of truth
> for execution state, ownership, and task discovery.
> AI MUST NOT infer stage state from any other fields.
> all information should be short, concise, accurate

# Feature: FTR-002 访客转正与数据迁移

## 0. Metadata
- ID: FTR-002
- SCN ID: SCN-001
- Steward: hangxiao
- Group/Module: User/GuestConversion
- Priority: P1 (原 P0，已延期)
- Version: v0.2
- Last Updated: 2026-01-29 21:15
- Resolution Status: **Deferred** (暂不实现，延期到 P1 阶段)
- Change Log: v0.2 - 根据业务优先级调整，功能延期到 P1
- Depends On: 
  - `/api/modules/user.api.md` → `POST /api/v1/users/guest/convert` (FTR-002)
  - `/api/modules/glucose.api.md` → 数据迁移需要查询和更新血糖记录
  - `/api/modules/digital_human.api.md` → 数据迁移需要查询和更新会话记录

-----------------------------------------------------------------------------------------
## 1. Summary (One Paragraph)

允许访客用户通过手机号+验证码登录转为正式用户，系统自动处理两种场景：(1) 新用户场景下直接将访客账号升级为正式账号；(2) 老用户场景下将访客期间的所有数据（血糖、饮食、运动、问诊）迁移到已存在的老账号，并软删除访客账号。整个过程在单个事务中完成，确保数据一致性，用户体验无缝。

## 2. API / SPI Contract (Frozen Boundary)

### API (Provided)
- **REST** `POST /api/v1/users/guest/convert`
  - **Description**: 访客转正为正式用户，支持新用户升级和老用户数据迁移
  - **Params**: `ConvertUserRequest { guestUserId: string, phone: string, smsCode: string }`
  - **Returns**: `UserResponse { userId: string, userType: string, phone: string (脱敏), ... }`
  - **Throws**: 
    - `400 BadRequest` - 访客用户不存在或已转正、验证码错误
    - `500 InternalServerError` - 数据迁移失败（事务回滚）
    - `409 Conflict` - 并发转正冲突

-----------------------------------------------------------------------------------------

## 3. Stage Ownership and Execution State

> This table is the single source of truth for Feature execution state.

| Stage        | Status       | Owner        | Assigned At        | Last Updated       | Completed At       | Blocked Reason |
|--------------|--------------|--------------|--------------------|--------------------|--------------------|----------------|
| Requirement  | Done         | hangxiao     | 2026-01-29 20:45   | 2026-01-29 20:50   | 2026-01-29 20:50   | -              |
| Design       | NotStarted   | -            | -                  | -                  | -                  | -              |
| Development  | NotStarted   | -            | -                  | -                  | -                  | -              |
| Test         | NotStarted   | -            | -                  | -                  | -                  | -              |
| Acceptance   | NotStarted   | -            | -                  | -                  | -                  | -              |

## 4. User Journey / Flow (Text)

### 4.1 新用户场景（OpenID 首次出现）
1. **用户点击"手机号登录"**：进入手机号登录页面
2. **输入手机号并请求验证码**：用户输入手机号，系统发送短信验证码 [FUN-004]
3. **输入验证码并提交**：用户输入验证码，点击登录
4. **调用转正接口**：客户端携带访客ID、手机号和验证码调用转正接口 [FUN-005]
4. **验证访客身份**：系统验证访客用户存在且未转正 [FUN-006]
5. **检查 OpenID 是否存在**：查询数据库，判断该 OpenID 是否已关联用户 [FUN-007]
6. **OpenID 不存在（新用户）**：直接升级访客账号为正式账号 [FUN-008]
   - 更新 `user_type` 为 `NORMAL`
   - 绑定手机号（加密存储）
   - 可选：绑定手机号（加密存储 + 哈希索引）
7. **返回正式用户信息**：返回升级后的用户信息，令牌不变

### 4.2 老用户场景（OpenID 已存在）
8. **检查 OpenID 是否存在**：查询到该 OpenID 已关联老用户账号 [FUN-007]
9. **数据迁移开始**（事务保证）：[FUN-009]
   - 迁移血糖记录：`UPDATE tbl_glucose_record SET user_id = ? WHERE user_id = ?`
   - 迁移饮食记录：`UPDATE tbl_diet_record SET user_id = ? WHERE user_id = ?`
   - 迁移运动记录：`UPDATE tbl_exercise_record SET user_id = ? WHERE user_id = ?`
   - 迁移问诊记录：`UPDATE tbl_consultation SET user_id = ? WHERE user_id = ?`
   - 迁移数字人会话：`UPDATE tbl_session SET user_id = ? WHERE user_id = ?`
10. **软删除访客账号**：标记访客账号为已删除 [FUN-010]
11. **记录迁移日志**：记录数据迁移详情（迁移数量、时间等）[FUN-011]
12. **返回老用户信息**：返回老账号信息，前端需使用新令牌

## 5. Functional Composition (Functions)

| Type | ID | Title | Description | Version |
|------|----|-------|-------------|--------|
| [NEW] | FUN-004 | 发送短信验证码 | 向用户手机号发送短信验证码（6位数字） | v0.1 |
| [REUSE] | FUN-005 | 访客身份验证 | 验证访客令牌有效性（复用 FUN-003） | v0.1 |
| [NEW] | FUN-006 | 访客转正前置检查 | 检查访客是否存在、是否已转正 | v0.1 |
| [NEW] | FUN-007 | OpenID 用户查询 | 根据 OpenID 哈希查询是否存在关联用户 | v0.1 |
| [NEW] | FUN-008 | 访客账号升级 | 新用户场景：将访客账号直接升级为正式账号 | v0.1 |
| [NEW] | FUN-009 | 访客数据迁移 | 老用户场景：将访客数据迁移到老账号（事务） | v0.1 |
| [NEW] | FUN-010 | 访客账号软删除 | 标记访客账号为已删除 | v0.1 |
| [NEW] | FUN-011 | 数据迁移日志记录 | 记录数据迁移详情（审计日志） | v0.1 |

## 6. Acceptance Criteria (Feature-level)

- **FAC-01**: Given 访客用户提供正确的手机号和验证码，When 该手机号未被使用，Then 访客账号直接升级为正式账号，userType 变为 NORMAL，手机号已绑定
- **FAC-02**: Given 访客用户使用的 OpenID 已关联老账号，When 调用转正接口，Then 访客期间的所有数据（血糖、饮食、运动、问诊、会话）全部迁移到老账号
- **FAC-03**: Given 数据迁移成功，When 查询访客账号，Then 访客账号的 is_deleted 为 true
- **FAC-04**: Given 数据迁移成功，When 查询老账号的数据，Then 可以看到访客期间的数据和老数据合并在一起
- **FAC-05**: Given 数据迁移过程中发生错误（如网络中断），When 事务回滚，Then 访客账号保持不变，所有数据未迁移
- **FAC-06**: Given 同一访客账号并发发起多次转正请求，When 使用分布式锁，Then 只有一个请求成功，其他返回 409 Conflict
- **FAC-07**: Given 访客令牌已过期，When 调用转正接口，Then 返回 401 Unauthorized
- **FAC-08**: Given 访客已转正，When 再次调用转正接口，Then 返回 400 BadRequest，提示已转正

## 9. Design Artifacts Index
- Sequence Diagram: `/cdase/project/design/uml/FTR-002.sequence.puml`
- Package/Class Diagram: `/cdase/project/design/uml/FTR-002.class.puml`
- ADRs: 
  - `/cdase/project/design/adr/ADR-001_访客转正数据迁移策略.md`（新用户升级 vs 老用户迁移）

## 10. Test & Acceptance Index
- Feature-level acceptance tests: `/tests/feature/test_FTR-002_guest_conversion.py`
- Related Function tests: 
  - `/tests/function/test_FUN-006_guest_conversion_precheck.py`
  - `/tests/function/test_FUN-007_openid_user_query.py`
  - `/tests/function/test_FUN-008_guest_account_upgrade.py`
  - `/tests/function/test_FUN-009_guest_data_migration.py`
  - `/tests/function/test_FUN-010_guest_account_soft_delete.py`
  - `/tests/function/test_FUN-011_migration_log.py`

## 11. Gate Checklist (AI MUST enforce)

- [x] Required APIs discovered in `/api/modules/*.api.md` - 已注册在 `user.api.md`, `glucose.api.md`
- [x] No duplicate logic exists in current API Registries - 确认无重复

### Requirement Gate
- [x] Flow written and numbered - 已完成 12 步流程（两种场景）
- [x] Feature-level I/O explicit - API Contract 已明确
- [x] Functions list complete (IDs) - 8 个 Functions 已列出
- [x] FACs are testable and numbered - 8 个 FACs 已编号

### Design Gate
- [ ] Sequence diagram covers all steps
- [ ] Class/package diagram exists (if needed)
- [ ] All Functions have frozen API/SPI

### Development Gate
- [ ] Each Function has contract tests indexed
- [ ] Code plans exist for impacted Functions

### Test Gate
- [ ] All Function contract tests pass
- [ ] All Feature contract tests pass

### Acceptance Gate
- [ ] FACs verified by executable tests

## 12. Modification Requests

_(暂无)_
