> NOTE:
> The Stage Ownership table is the single source of truth
> for execution state, ownership, and task discovery.
> AI MUST NOT infer stage state from any other fields.
> all information should be short, concise, accurate

# Feature: FTR-003 隐私协议管理

## 0. Metadata
- ID: FTR-003
- SCN ID: SCN-001
- Steward: hangxiao
- Group/Module: User/Privacy
- Priority: P1 (原 P0，已延期)
- Version: v0.2
- Last Updated: 2026-01-29 21:15
- Resolution Status: **Deferred** (暂不实现，延期到 P1 阶段)
- Change Log: v0.2 - 根据业务优先级调整，功能延期到 P1
- Depends On: 
  - `/api/modules/user.api.md` → `POST /api/v1/users/{userId}/privacy-agreement` (FTR-003)

-----------------------------------------------------------------------------------------
## 1. Summary (One Paragraph)

用户在转正或首次保存敏感信息前，必须同意最新版本的隐私协议。系统记录用户同意的协议版本和时间，并在协议更新时提示用户重新同意。所有敏感信息（姓名、电话、身份证、病史等）在用户同意隐私协议后才能加密存储，确保合规性和用户隐私保护。

## 2. API / SPI Contract (Frozen Boundary)

### API (Provided)
- **REST** `POST /api/v1/users/{userId}/privacy-agreement`
  - **Description**: 记录用户同意隐私协议
  - **Params**: `PrivacyAgreementRequest { agreementVersion: string, agreedAt?: datetime }`
  - **Returns**: `void`
  - **Throws**: 
    - `404 NotFound` - 用户不存在
    - `403 Forbidden` - 访客不可同意（必须先转正）

- **REST** `GET /api/v1/privacy-agreement/latest`
  - **Description**: 获取最新版本的隐私协议内容
  - **Params**: 无
  - **Returns**: `PrivacyAgreementResponse { version: string, content: string, effectiveDate: date }`

- **REST** `GET /api/v1/users/{userId}/privacy-agreement/status`
  - **Description**: 检查用户是否已同意最新版本的隐私协议
  - **Params**: `userId: string`
  - **Returns**: `PrivacyStatusResponse { hasAgreed: boolean, currentVersion: string, userAgreedVersion?: string, needReAgree: boolean }`

-----------------------------------------------------------------------------------------

## 3. Stage Ownership and Execution State

> This table is the single source of truth for Feature execution state.

| Stage        | Status       | Owner        | Assigned At        | Last Updated       | Completed At       | Blocked Reason |
|--------------|--------------|--------------|--------------------|--------------------|--------------------|----------------|
| Requirement  | Done         | hangxiao     | 2026-01-29 20:50   | 2026-01-29 20:55   | 2026-01-29 20:55   | -              |
| Design       | NotStarted   | -            | -                  | -                  | -                  | -              |
| Development  | NotStarted   | -            | -                  | -                  | -                  | -              |
| Test         | NotStarted   | -            | -                  | -                  | -                  | -              |
| Acceptance   | NotStarted   | -            | -                  | -                  | -                  | -              |

## 4. User Journey / Flow (Text)

### 4.1 转正时同意隐私协议（强制）
1. **用户转正**：用户通过"手机号+验证码登录"完成转正 [FTR-002]
2. **检查协议状态**：系统检查用户是否已同意最新版本隐私协议 [FUN-012]
3. **弹出隐私协议**：如果未同意，前端弹出隐私协议内容 [FUN-013]
4. **用户阅读协议**：用户阅读隐私协议全文
5. **用户同意协议**：用户点击"同意"按钮 [FUN-014]
6. **记录同意状态**：系统记录协议版本和同意时间 [FUN-015]
7. **允许使用敏感功能**：用户可以保存敏感信息（姓名、电话等）

### 4.2 保存敏感信息前检查协议
8. **用户编辑个人信息**：用户尝试保存姓名、电话等敏感信息
9. **检查协议状态**：系统检查用户是否已同意最新版本隐私协议 [FUN-012]
10. **未同意协议**：如果未同意，拦截保存操作，提示用户先同意协议
11. **已同意协议**：允许保存，敏感信息加密存储

### 4.3 协议版本更新时重新同意
12. **系统更新协议**：管理员发布新版本隐私协议（如：v1.0 → v1.1）
13. **用户再次访问**：用户打开应用
14. **检测协议版本**：系统检测到用户同意的是旧版本 [FUN-012]
15. **提示重新同意**：前端提示"隐私协议已更新，请重新阅读并同意"
16. **用户重新同意**：用户阅读新版本协议并同意 [FUN-014]
17. **更新同意记录**：系统更新用户的协议版本和时间 [FUN-015]

## 5. Functional Composition (Functions)

| Type | ID | Title | Description | Version |
|------|----|-------|-------------|--------|
| [NEW] | FUN-012 | 隐私协议状态检查 | 检查用户是否已同意最新版本的隐私协议 | v0.1 |
| [NEW] | FUN-013 | 隐私协议内容获取 | 获取最新版本的隐私协议全文 | v0.1 |
| [NEW] | FUN-014 | 隐私协议同意操作 | 用户同意隐私协议，触发记录 | v0.1 |
| [NEW] | FUN-015 | 隐私协议同意记录 | 记录用户同意的协议版本和时间到数据库 | v0.1 |
| [NEW] | FUN-016 | 敏感信息保存拦截 | 在保存敏感信息前检查协议状态，未同意则拦截 | v0.1 |

## 6. Acceptance Criteria (Feature-level)

- **FAC-01**: Given 用户刚转正且未同意隐私协议，When 系统检查协议状态，Then 返回 hasAgreed = false，needReAgree = true
- **FAC-02**: Given 用户点击"同意隐私协议"，When 调用同意接口，Then 系统记录协议版本（如：v1.0）和当前时间
- **FAC-03**: Given 用户已同意协议，When 再次检查协议状态，Then 返回 hasAgreed = true，userAgreedVersion = v1.0
- **FAC-04**: Given 用户未同意协议，When 尝试保存姓名或电话，Then 返回 403 Forbidden，提示"请先同意隐私协议"
- **FAC-05**: Given 用户已同意协议，When 保存姓名或电话，Then 保存成功，数据加密存储
- **FAC-06**: Given 系统更新协议版本为 v1.1，When 用户（同意了 v1.0）再次访问，Then 系统提示"隐私协议已更新，请重新同意"
- **FAC-07**: Given 用户同意新版本协议（v1.1），When 查询同意记录，Then userAgreedVersion 更新为 v1.1，同意时间更新
- **FAC-08**: Given 访客用户，When 尝试同意隐私协议，Then 返回 403 Forbidden，提示"访客不可同意，请先转正"

## 9. Design Artifacts Index
- Sequence Diagram: `/cdase/project/design/uml/FTR-003.sequence.puml`
- Package/Class Diagram: `/cdase/project/design/uml/FTR-003.class.puml`
- ADRs: 
  - `/cdase/project/design/adr/ADR-002_隐私协议版本管理策略.md`

## 10. Test & Acceptance Index
- Feature-level acceptance tests: `/tests/feature/test_FTR-003_privacy_agreement.py`
- Related Function tests: 
  - `/tests/function/test_FUN-012_privacy_status_check.py`
  - `/tests/function/test_FUN-013_privacy_content_fetch.py`
  - `/tests/function/test_FUN-014_privacy_agreement_action.py`
  - `/tests/function/test_FUN-015_privacy_agreement_record.py`
  - `/tests/function/test_FUN-016_sensitive_data_save_intercept.py`

## 11. Gate Checklist (AI MUST enforce)

- [x] Required APIs discovered in `/api/modules/*.api.md` - 已注册在 `user.api.md`
- [x] No duplicate logic exists in current API Registries - 确认无重复

### Requirement Gate
- [x] Flow written and numbered - 已完成 17 步流程（三种场景）
- [x] Feature-level I/O explicit - API Contract 已明确
- [x] Functions list complete (IDs) - 5 个 Functions 已列出
- [x] FACs are testable and numbered - 8 个 FACs 已编号

### Design Gate
- [ ] Sequence diagram covers all steps
- [ ] Class/package diagram exists (if needed)
- [ ] All Functions have frozen API/SPI

### Development Gate
- [ ] Each Function has contract tests indexed
- [ ] Code plans exist for impacted Functions

### Test Gate
- [ ] All Function contract tests pass
- [ ] All Feature contract tests pass

### Acceptance Gate
- [ ] FACs verified by executable tests

## 12. Modification Requests

_(暂无)_
