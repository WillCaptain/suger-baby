> NOTE:
> The Stage Ownership table is the single source of truth
> for execution state, ownership, and task discovery.
> AI MUST NOT infer stage state from any other fields.
> all information should be short, concise, accurate

# Feature: FTR-003 血糖记录管理

## 0. Metadata
- ID: FTR-003
- SCN ID: SCN-002
- Steward: hangxiao
- Group/Module: Glucose/GlucoseRecordManagement
- Priority: P0
- Version: v0.2
- Last Updated: 2026-01-31 15:15
- Resolution Status: Design Complete
- Change Log: 
  - v0.2 - 完成设计阶段：创建序列图、类图、API 规范
  - v0.1 - 初始化需求文档
- Depends On: 
  - FTR-001（访客ID生成与管理）

-----------------------------------------------------------------------------------------
## 1. Summary (One Paragraph)

允许用户（访客或正式用户）记录每日血糖测量数据，包括血糖值、测量类型（空腹/餐前/餐后/睡前/随机）、测量时间和备注信息。系统对输入进行校验（范围 1.0-33.3 mmol/L），并将数据持久化到数据库。用户可以查询历史记录、按日期范围筛选，以及删除错误的记录。所有记录关联用户ID（访客ID或正式用户ID），支持访客转正后的数据迁移。

## 2. API / SPI Contract (Frozen Boundary)

### API (Provided)
- **REST** `POST /api/v1/glucose/records`
  - **Description**: 创建血糖记录
  - **Params**: 
    - `value` (float): 血糖值（mmol/L），精度1位小数
    - `measureType` (enum): 测量类型（fasting/before_meal/after_meal/before_sleep/random）
    - `measuredAt` (timestamp): 测量时间（可选，默认当前时间）
    - `note` (string): 备注（可选，最大200字符）
  - **Returns**: `GlucoseRecordResponse { id: UUID, value: float, measureType: enum, measuredAt: timestamp, userId: string }`
  - **Throws**: 
    - `400 BadRequest` - 血糖值超出范围或格式错误
    - `401 Unauthorized` - 用户未授权
    - `500 InternalServerError` - 系统错误

- **REST** `GET /api/v1/glucose/records`
  - **Description**: 查询血糖记录列表（分页）
  - **Params**: 
    - `page` (int): 页码，默认1
    - `pageSize` (int): 每页条数，默认20
    - `startDate` (date): 开始日期（可选）
    - `endDate` (date): 结束日期（可选）
  - **Returns**: `GlucoseRecordListResponse { records: List<GlucoseRecord>, total: int, page: int, pageSize: int }`
  - **Throws**: 
    - `401 Unauthorized` - 用户未授权

- **REST** `DELETE /api/v1/glucose/records/{id}`
  - **Description**: 删除血糖记录
  - **Params**: 
    - `id` (UUID): 记录ID
  - **Returns**: `DeleteResponse { success: boolean }`
  - **Throws**: 
    - `404 NotFound` - 记录不存在
    - `403 Forbidden` - 无权删除他人记录
    - `401 Unauthorized` - 用户未授权

-----------------------------------------------------------------------------------------

## 3. Stage Ownership and Execution State

> This table is the single source of truth for Feature execution state.

| Stage        | Status       | Owner        | Assigned At        | Last Updated       | Completed At       | Blocked Reason |
|--------------|--------------|--------------|--------------------|--------------------|--------------------|----------------|
| Requirement  | Done         | hangxiao     | 2026-01-31 14:45   | 2026-01-31 15:00   | 2026-01-31 15:00   | -              |
| Design       | Done         | hangxiao     | 2026-01-31 15:00   | 2026-01-31 15:15   | 2026-01-31 15:15   | -              |
| Development  | NotStarted   | -            | -                  | -                  | -                  | -              |
| Test         | NotStarted   | -            | -                  | -                  | -                  | -              |
| Acceptance   | NotStarted   | -            | -                  | -                  | -                  | -              |

## 4. User Journey / Flow (Text)

1. **用户打开血糖记录界面**：点击"记录血糖"按钮
2. **输入血糖值**：输入测量的血糖数值（如 6.5）[FUN-003]
3. **验证血糖值范围**：系统验证输入是否在 1.0-33.3 mmol/L 范围内 [FUN-004]
4. **选择测量类型**：用户选择测量类型（空腹/餐前/餐后/睡前/随机）
5. **可选添加备注**：用户可添加备注信息（如"今天吃了甜食"）
6. **确认测量时间**：默认当前时间，用户可手动调整
7. **保存记录**：调用后端 API 创建记录 [FUN-005]
8. **显示成功反馈**：保存成功后显示提示，并更新记录列表
9. **查看历史记录**：用户进入"血糖管理"页面，查看记录列表 [FUN-006]
10. **筛选记录**：可按日期范围筛选（今日/近7天/近30天）[FUN-007]
11. **删除错误记录**：用户长按记录，选择删除 [FUN-008]

## 5. Functional Composition (Functions)

| Type | ID | Title | Description | Version |
|------|----|-------|-------------|--------|
| [NEW] | FUN-003 | 血糖值输入与格式化 | 输入血糖值并格式化为小数点后1位 | v0.1 |
| [NEW] | FUN-004 | 血糖值范围校验 | 校验血糖值是否在 1.0-33.3 mmol/L 范围内 | v0.1 |
| [NEW] | FUN-005 | 创建血糖记录 | 调用后端API保存血糖记录 | v0.1 |
| [NEW] | FUN-006 | 查询血糖记录列表 | 分页查询用户的血糖记录 | v0.1 |
| [NEW] | FUN-007 | 按日期筛选记录 | 根据日期范围筛选血糖记录 | v0.1 |
| [NEW] | FUN-008 | 删除血糖记录 | 删除指定的血糖记录 | v0.1 |

## 6. Acceptance Criteria (Feature-level)

- **FAC-01**: Given 用户输入血糖值 6.5，When 选择测量类型"餐后"并保存，Then 记录成功创建并关联用户ID
- **FAC-02**: Given 用户输入血糖值 0.5（超出最小值），When 点击保存，Then 系统提示"血糖值必须在 1.0-33.3 mmol/L 之间"
- **FAC-03**: Given 用户输入血糖值 35.0（超出最大值），When 点击保存，Then 系统提示范围错误
- **FAC-04**: Given 用户已有10条血糖记录，When 查询记录列表，Then 按时间倒序展示
- **FAC-05**: Given 用户选择筛选"近7天"，When 查询，Then 只返回近7天的记录
- **FAC-06**: Given 用户长按某条记录选择删除，When 确认删除，Then 记录被删除且列表更新
- **FAC-07**: Given 访客用户创建了5条记录，When 访客转正为正式用户，Then 记录自动关联到正式账号

## 7. Data Model

### GlucoseRecord (Entity)
```kotlin
data class GlucoseRecord(
    val id: String,              // UUID
    val userId: String,          // 用户ID（访客ID或正式用户ID）
    val value: Float,            // 血糖值（mmol/L），精度1位小数
    val measureType: MeasureType, // 测量类型
    val measuredAt: Long,        // 测量时间（时间戳）
    val note: String?,           // 备注（可选）
    val createdAt: Long,         // 创建时间
    val updatedAt: Long          // 更新时间
)

enum class MeasureType {
    FASTING,        // 空腹
    BEFORE_MEAL,    // 餐前
    AFTER_MEAL,     // 餐后
    BEFORE_SLEEP,   // 睡前
    RANDOM          // 随机
}
```

### Database Schema
```sql
CREATE TABLE tbl_glucose_records (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    value DECIMAL(4,1) NOT NULL,
    measure_type VARCHAR(20) NOT NULL,
    measured_at BIGINT NOT NULL,
    note VARCHAR(200),
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    INDEX idx_user_measured (user_id, measured_at DESC)
);
```

## 8. Business Rules

### 血糖值范围
- 最小值：1.0 mmol/L
- 最大值：33.3 mmol/L
- 精度：小数点后1位

### 测量类型
- 必填字段，默认为 RANDOM
- 5种类型：空腹、餐前、餐后、睡前、随机

### 时间有效性
- 测量时间不能晚于当前时间
- 允许回溯录入（如补录昨天的数据）

### 数据归属
- 每条记录必须关联用户ID
- 访客数据标记为 user_type = 'guest'
- 转正后数据迁移到正式账号

## 9. Design Artifacts Index
- Sequence Diagram: `/cdase/project/design/uml/FTR-003.sequence.puml` (待创建)
- Class Diagram: `/cdase/project/design/uml/FTR-003.class.puml` (待创建)
- API Design: `/cdase/project/api/modules/glucose.api.md` (待更新)

## 10. Test & Acceptance Index
- Feature tests: `/shared/src/commonTest/kotlin/com/twelfth/feature/FTR003GlucoseRecordTest.kt` (待创建)
- Function tests: `/shared/src/commonTest/kotlin/com/twelfth/domain/glucose/` (待创建)

## 11. Gate Checklist (AI MUST enforce)

- [x] Required APIs discovered in `/api/modules/*.api.md` - 已注册在 glucose.api.md
- [x] No duplicate logic exists in current API Registries - 确认无重复

### Requirement Gate
- [x] Flow written and numbered - 11 步流程
- [x] Feature-level I/O explicit - API Contract 已明确
- [x] Functions list complete (IDs) - 6 个 Functions 已列出
- [x] FACs are testable and numbered - 7 个 FACs 已编号

### Design Gate
- [x] Sequence diagram covers all steps - FTR-003.sequence.puml
- [x] Class/package diagram exists - FTR-003.class.puml
- [x] All Functions have frozen API/SPI - FUN-004, FUN-005 已冻结

### Development Gate
- [ ] Each Function has contract tests indexed
- [ ] Code plans exist for impacted Functions

### Test Gate
- [ ] All Function contract tests pass
- [ ] All Feature contract tests pass

### Acceptance Gate
- [ ] FACs verified by executable tests
