> NOTE:
> The Stage Ownership table is the single source of truth
> for execution state, ownership, and task discovery.
> AI MUST NOT infer stage state from any other fields.
> all information should be short, concise, accurate

# Feature: FTR-004 血糖数据统计与展示

## 0. Metadata
- ID: FTR-004
- SCN ID: SCN-002
- Steward: hangxiao
- Group/Module: Glucose/GlucoseStatistics
- Priority: P0
- Version: v0.2
- Last Updated: 2026-01-31 15:20
- Resolution Status: Design Complete
- Change Log: 
  - v0.2 - 完成设计阶段：创建序列图、类图、API 规范
  - v0.1 - 初始化需求文档
- Depends On: 
  - FTR-003（血糖记录管理）

-----------------------------------------------------------------------------------------
## 1. Summary (One Paragraph)

为用户提供血糖数据的统计分析功能，包括平均值、最高值、最低值和达标率计算。用户可以查看不同时间段（今日、近7天、近30天）的统计数据，帮助用户了解血糖控制趋势。统计计算在后端实时聚合，前端通过 API 获取并展示。支持访客和正式用户的数据统计。

## 2. API / SPI Contract (Frozen Boundary)

### API (Provided)
- **REST** `GET /api/v1/glucose/statistics`
  - **Description**: 获取血糖统计数据
  - **Params**: 
    - `period` (enum): 统计周期（today/last7days/last30days），默认 today
    - `targetValue` (float): 达标目标值（mmol/L），默认 7.0
  - **Returns**: `GlucoseStatisticsResponse`
    ```json
    {
      "period": "last7days",
      "recordCount": 21,
      "averageValue": 6.8,
      "maxValue": 9.2,
      "minValue": 4.5,
      "targetRate": 85.7,
      "targetValue": 7.0
    }
    ```
  - **Throws**: 
    - `401 Unauthorized` - 用户未授权
    - `500 InternalServerError` - 系统错误

- **REST** `GET /api/v1/glucose/records/summary`
  - **Description**: 获取记录列表摘要（用于首页展示）
  - **Params**: 
    - `limit` (int): 返回条数，默认5
  - **Returns**: `GlucoseRecordSummaryResponse { records: List<GlucoseRecord>, latestStatistics: GlucoseStatistics }`
  - **Throws**: 
    - `401 Unauthorized` - 用户未授权

-----------------------------------------------------------------------------------------

## 3. Stage Ownership and Execution State

> This table is the single source of truth for Feature execution state.

| Stage        | Status       | Owner        | Assigned At        | Last Updated       | Completed At       | Blocked Reason |
|--------------|--------------|--------------|--------------------|--------------------|--------------------|----------------|
| Requirement  | Done         | hangxiao     | 2026-01-31 14:50   | 2026-01-31 15:00   | 2026-01-31 15:00   | -              |
| Design       | Done         | hangxiao     | 2026-01-31 15:00   | 2026-01-31 15:20   | 2026-01-31 15:20   | -              |
| Development  | NotStarted   | -            | -                  | -                  | -                  | -              |
| Test         | NotStarted   | -            | -                  | -                  | -                  | -              |
| Acceptance   | NotStarted   | -            | -                  | -                  | -                  | -              |

## 4. User Journey / Flow (Text)

1. **用户进入血糖统计页面**：从首页或血糖管理页面进入
2. **选择统计周期**：用户选择"今日"、"近7天"或"近30天" [FUN-009]
3. **加载统计数据**：调用后端 API 获取统计信息 [FUN-010]
4. **展示统计卡片**：显示平均值、最高值、最低值 [FUN-011]
5. **展示达标率**：计算并显示血糖达标率（< 7.0 mmol/L 的记录占比）[FUN-012]
6. **刷新数据**：用户可下拉刷新最新统计
7. **查看详细记录**：点击统计卡片跳转到记录列表

## 5. Functional Composition (Functions)

| Type | ID | Title | Description | Version |
|------|----|-------|-------------|--------|
| [NEW] | FUN-009 | 选择统计周期 | 用户选择统计的时间范围（今日/近7天/近30天） | v0.1 |
| [NEW] | FUN-010 | 获取统计数据 | 调用后端API获取指定周期的统计数据 | v0.1 |
| [NEW] | FUN-011 | 展示统计卡片 | 展示平均值、最高值、最低值等统计信息 | v0.1 |
| [NEW] | FUN-012 | 计算达标率 | 计算血糖达标率（< 目标值的记录占比） | v0.1 |

## 6. Acceptance Criteria (Feature-level)

- **FAC-01**: Given 用户近7天有10条记录，When 选择"近7天"统计，Then 显示10条记录的平均值、最高值、最低值
- **FAC-02**: Given 用户今日有5条记录（值为：5.5, 6.0, 6.5, 7.5, 8.0），When 查看今日统计，Then 平均值为 6.7，最高值为 8.0，最低值为 5.5
- **FAC-03**: Given 用户近7天有10条记录，其中7条 < 7.0 mmol/L，When 查看达标率，Then 显示 70%
- **FAC-04**: Given 用户今日无记录，When 查看今日统计，Then 显示"暂无数据"
- **FAC-05**: Given 统计数据已加载，When 用户添加新记录后返回统计页面，Then 统计数据自动更新
- **FAC-06**: Given 用户选择"近30天"，When 加载统计，Then 只计算最近30天内的记录

## 7. Data Model

### GlucoseStatistics (DTO)
```kotlin
data class GlucoseStatistics(
    val period: StatisticsPeriod,   // 统计周期
    val recordCount: Int,           // 记录条数
    val averageValue: Float,        // 平均血糖值
    val maxValue: Float,            // 最高血糖值
    val minValue: Float,            // 最低血糖值
    val targetRate: Float,          // 达标率（百分比）
    val targetValue: Float          // 达标目标值
)

enum class StatisticsPeriod {
    TODAY,          // 今日
    LAST_7_DAYS,    // 近7天
    LAST_30_DAYS    // 近30天
}
```

## 8. Business Rules

### 统计计算规则
- **平均值**：所有记录的算术平均值，精度小数点后1位
- **最高值**：所有记录中的最大值
- **最低值**：所有记录中的最小值
- **达标率**：`(血糖值 < 目标值的记录数 / 总记录数) × 100%`

### 默认达标目标
- 默认目标值：7.0 mmol/L（空腹血糖）
- 用户可自定义目标值（P1 阶段功能）

### 时间范围
- **今日**：当天 00:00:00 至当前时间
- **近7天**：当前时间往前推7天（168小时）
- **近30天**：当前时间往前推30天（720小时）

### 无数据处理
- 如果选定时间范围内无记录，返回空统计（recordCount = 0）
- 前端显示"暂无数据"提示

## 9. Design Artifacts Index
- Sequence Diagram: `/cdase/project/design/uml/FTR-004.sequence.puml` (待创建)
- Class Diagram: `/cdase/project/design/uml/FTR-004.class.puml` (待创建)
- API Design: `/cdase/project/api/modules/glucose.api.md` (待更新)

## 10. Test & Acceptance Index
- Feature tests: `/shared/src/commonTest/kotlin/com/twelfth/feature/FTR004GlucoseStatisticsTest.kt` (待创建)
- Function tests: `/shared/src/commonTest/kotlin/com/twelfth/domain/glucose/` (待创建)

## 11. Gate Checklist (AI MUST enforce)

- [x] Required APIs discovered in `/api/modules/*.api.md` - 已注册在 glucose.api.md
- [x] No duplicate logic exists in current API Registries - 确认无重复

### Requirement Gate
- [x] Flow written and numbered - 7 步流程
- [x] Feature-level I/O explicit - API Contract 已明确
- [x] Functions list complete (IDs) - 4 个 Functions 已列出
- [x] FACs are testable and numbered - 6 个 FACs 已编号

### Design Gate
- [x] Sequence diagram covers all steps - FTR-004.sequence.puml
- [x] Class/package diagram exists - FTR-004.class.puml
- [x] All Functions have frozen API/SPI - FUN-010 已冻结

### Development Gate
- [ ] Each Function has contract tests indexed
- [ ] Code plans exist for impacted Functions

### Test Gate
- [ ] All Function contract tests pass
- [ ] All Feature contract tests pass

### Acceptance Gate
- [ ] FACs verified by executable tests
