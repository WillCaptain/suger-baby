# Function: FUN-004 è¡€ç³–å€¼èŒƒå›´æ ¡éªŒ

## 0. Metadata
- ID: FUN-004
- Feature ID: FTR-003
- Owner: hangxiao
- Version: v0.2
- Last Updated: 2026-01-31 15:30
- Status: Draft
- Change Log:
  - v0.2 - å¢åŠ è¡€ç³–ç­‰çº§åˆ†ç±»å’Œå¥åº·å»ºè®®åŠŸèƒ½ï¼ˆå‡ç³–/é™ç³–å»ºè®®ï¼‰
  - v0.1 - åˆå§‹ç‰ˆæœ¬ï¼ˆä»…åŸºç¡€èŒƒå›´æ ¡éªŒï¼‰

## 1. Purpose
æ ¡éªŒç”¨æˆ·è¾“å…¥çš„è¡€ç³–å€¼æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ1.0 - 33.3 mmol/Lï¼‰ï¼Œå¹¶æ ¹æ®è¡€ç³–å€¼ç­‰çº§æä¾›å¥åº·å‘Šè­¦å’Œå»ºè®®ã€‚å½“è¡€ç³–è¿‡ä½æ—¶æä¾›å‡ç³–å»ºè®®ï¼Œè¡€ç³–è¿‡é«˜æ—¶æä¾›é™ç³–å»ºè®®ã€‚

## 2. API/SPI Contract

### Function Signature (Kotlin)
```kotlin
/**
 * æ ¡éªŒè¡€ç³–å€¼èŒƒå›´å¹¶æä¾›å¥åº·å»ºè®®
 * 
 * @param value è¡€ç³–å€¼ï¼ˆmmol/Lï¼‰
 * @param measureType æµ‹é‡ç±»å‹ï¼ˆå¯é€‰ï¼Œç”¨äºæ›´ç²¾ç¡®çš„è¯„ä¼°ï¼‰
 * @return æ ¡éªŒç»“æœï¼ˆåŒ…å«ç­‰çº§ã€å‘Šè­¦å’Œå»ºè®®ï¼‰
 */
fun validateGlucoseValue(
    value: Float, 
    measureType: MeasureType? = null
): GlucoseValidationResult

data class GlucoseValidationResult(
    val isValid: Boolean,              // æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ1.0-33.3ï¼‰
    val level: GlucoseLevel,           // è¡€ç³–ç­‰çº§
    val alert: GlucoseAlert?,          // å‘Šè­¦ä¿¡æ¯ï¼ˆä½è¡€ç³–æˆ–é«˜è¡€ç³–ï¼‰
    val suggestion: String?,           // å¥åº·å»ºè®®
    val errorMessage: String? = null   // é”™è¯¯ä¿¡æ¯ï¼ˆè¶…å‡ºæœ‰æ•ˆèŒƒå›´æ—¶ï¼‰
)

enum class GlucoseLevel {
    CRITICALLY_LOW,   // å±é™©ä½è¡€ç³– (< 3.0)
    LOW,              // ä½è¡€ç³– (3.0 - 3.8)
    NORMAL,           // æ­£å¸¸ (3.9 - 6.1 ç©ºè…¹, 3.9 - 7.8 é¤å2å°æ—¶)
    SLIGHTLY_HIGH,    // åé«˜ (6.2 - 7.0 ç©ºè…¹, 7.9 - 11.0 é¤å)
    HIGH,             // é«˜è¡€ç³– (7.1 - 13.9)
    CRITICALLY_HIGH,  // å±é™©é«˜è¡€ç³– (â‰¥ 14.0)
    INVALID           // æ— æ•ˆå€¼ï¼ˆè¶…å‡º 1.0-33.3 èŒƒå›´ï¼‰
}

enum class GlucoseAlert {
    CRITICALLY_LOW_ALERT,    // ä¸¥é‡ä½è¡€ç³–å‘Šè­¦
    LOW_ALERT,               // ä½è¡€ç³–å‘Šè­¦
    HIGH_ALERT,              // é«˜è¡€ç³–å‘Šè­¦
    CRITICALLY_HIGH_ALERT    // ä¸¥é‡é«˜è¡€ç³–å‘Šè­¦
}
```

### Input
- `value` (Float): å¾…æ ¡éªŒçš„è¡€ç³–å€¼

### Output
- `GlucoseValidationResult`:
  - `isValid`: æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ1.0-33.3 mmol/Lï¼‰
  - `level`: è¡€ç³–ç­‰çº§åˆ†ç±»
  - `alert`: å‘Šè­¦ç±»å‹ï¼ˆå¦‚æœéœ€è¦å‘Šè­¦ï¼‰
  - `suggestion`: å¥åº·å»ºè®®æ–‡æœ¬
  - `errorMessage`: é”™è¯¯ä¿¡æ¯ï¼ˆä»…å½“è¶…å‡ºæœ‰æ•ˆèŒƒå›´æ—¶ï¼‰

### Throws
- æ— å¼‚å¸¸æŠ›å‡ºï¼ˆè¿”å›æ ¡éªŒç»“æœï¼‰

## 3. Acceptance Criteria

### åŸºç¡€æ ¡éªŒ
- **AC-01**: Given value = 5.5, When æ ¡éªŒ, Then isValid = true, level = NORMAL
- **AC-02**: Given value = 0.9 (å°äºæœ€å°å€¼), When æ ¡éªŒ, Then isValid = false, level = INVALID, errorMessage = "è¡€ç³–å€¼å¿…é¡»åœ¨ 1.0-33.3 mmol/L ä¹‹é—´"
- **AC-03**: Given value = 33.4 (å¤§äºæœ€å¤§å€¼), When æ ¡éªŒ, Then isValid = false, level = INVALID, errorMessage = "è¡€ç³–å€¼å¿…é¡»åœ¨ 1.0-33.3 mmol/L ä¹‹é—´"

### ä½è¡€ç³–å‘Šè­¦
- **AC-04**: Given value = 2.5 (å±é™©ä½è¡€ç³–), When æ ¡éªŒ, Then isValid = true, level = CRITICALLY_LOW, alert = CRITICALLY_LOW_ALERT, suggestion = "âš ï¸ è¡€ç³–è¿‡ä½ï¼ç«‹å³è¿›é£Ÿï¼š\n1. å¿«é€Ÿåƒ 15-20g ç¢³æ°´ï¼ˆ3-4é¢—ç³–æœæˆ–åŠæ¯æœæ±ï¼‰\n2. 15åˆ†é’Ÿåå¤æµ‹\n3. å¦‚ç—‡çŠ¶æŒç»­ï¼Œç«‹å³å°±åŒ»"
- **AC-05**: Given value = 3.5 (ä½è¡€ç³–), When æ ¡éªŒ, Then isValid = true, level = LOW, alert = LOW_ALERT, suggestion = "âš ï¸ è¡€ç³–åä½ï¼Œå»ºè®®ï¼š\n1. é€‚é‡è¿›é£Ÿç¢³æ°´åŒ–åˆç‰©\n2. é¿å…å‰§çƒˆè¿åŠ¨\n3. å¯†åˆ‡ç›‘æµ‹è¡€ç³–å˜åŒ–"

### æ­£å¸¸èŒƒå›´
- **AC-06**: Given value = 5.0 (ç©ºè…¹æ­£å¸¸), When æ ¡éªŒ, Then isValid = true, level = NORMAL, alert = null, suggestion = "âœ… è¡€ç³–æ­£å¸¸ï¼Œä¿æŒè‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯"

### é«˜è¡€ç³–å‘Šè­¦
- **AC-07**: Given value = 6.8 (åé«˜), When æ ¡éªŒ, Then isValid = true, level = SLIGHTLY_HIGH, alert = null, suggestion = "ğŸ“Š è¡€ç³–åé«˜ï¼Œå»ºè®®ï¼š\n1. æ³¨æ„æ§åˆ¶é¥®é£Ÿ\n2. é€‚é‡è¿åŠ¨\n3. å®šæœŸç›‘æµ‹"
- **AC-08**: Given value = 10.0 (é«˜è¡€ç³–), When æ ¡éªŒ, Then isValid = true, level = HIGH, alert = HIGH_ALERT, suggestion = "âš ï¸ è¡€ç³–åé«˜ï¼Œå»ºè®®ï¼š\n1. å‡å°‘ç³–åˆ†å’Œç¢³æ°´æ‘„å…¥\n2. å¢åŠ è¿åŠ¨é‡\n3. å’¨è¯¢åŒ»ç”Ÿè°ƒæ•´ç”¨è¯\n4. æ¯æ—¥å¤šæ¬¡ç›‘æµ‹"
- **AC-09**: Given value = 16.0 (å±é™©é«˜è¡€ç³–), When æ ¡éªŒ, Then isValid = true, level = CRITICALLY_HIGH, alert = CRITICALLY_HIGH_ALERT, suggestion = "ğŸš¨ è¡€ç³–ä¸¥é‡åé«˜ï¼\n1. ç«‹å³è”ç³»åŒ»ç”Ÿ\n2. æ£€æŸ¥æ˜¯å¦æ¼æœè¯ç‰©\n3. å¤šå–æ°´\n4. é¿å…å‰§çƒˆè¿åŠ¨\n5. è­¦æƒ•é…®ç—‡é…¸ä¸­æ¯’ç—‡çŠ¶"

### è¾¹ç•Œå€¼æµ‹è¯•
- **AC-10**: Given value = 1.0 (æœ€å°æœ‰æ•ˆå€¼), When æ ¡éªŒ, Then isValid = true, level = CRITICALLY_LOW
- **AC-11**: Given value = 33.3 (æœ€å¤§æœ‰æ•ˆå€¼), When æ ¡éªŒ, Then isValid = true, level = CRITICALLY_HIGH

## 4. Business Rules

### æœ‰æ•ˆèŒƒå›´
- æœ€å°å€¼ï¼š1.0 mmol/Lï¼ˆå«ï¼‰
- æœ€å¤§å€¼ï¼š33.3 mmol/Lï¼ˆå«ï¼‰
- è¾¹ç•Œå€¼åŒ…å«åœ¨æœ‰æ•ˆèŒƒå›´å†…

### è¡€ç³–ç­‰çº§åˆ†ç±»ï¼ˆåŸºäºåŒ»å­¦æ ‡å‡†ï¼‰
| è¡€ç³–å€¼èŒƒå›´ | ç­‰çº§ | å‘Šè­¦ | è¯´æ˜ |
|-----------|------|------|------|
| < 1.0 | INVALID | - | è¶…å‡ºæœ‰æ•ˆèŒƒå›´ |
| 1.0 - 2.9 | CRITICALLY_LOW | CRITICALLY_LOW_ALERT | å±é™©ä½è¡€ç³–ï¼Œéœ€ç«‹å³å¤„ç† |
| 3.0 - 3.8 | LOW | LOW_ALERT | ä½è¡€ç³–ï¼Œéœ€è¦å‡ç³– |
| 3.9 - 6.1 | NORMAL | - | æ­£å¸¸èŒƒå›´ï¼ˆç©ºè…¹ï¼‰ |
| 6.2 - 7.0 | SLIGHTLY_HIGH | - | åé«˜ï¼Œéœ€æ³¨æ„ |
| 7.1 - 13.9 | HIGH | HIGH_ALERT | é«˜è¡€ç³–ï¼Œéœ€è¦å¹²é¢„ |
| â‰¥ 14.0 | CRITICALLY_HIGH | CRITICALLY_HIGH_ALERT | ä¸¥é‡é«˜è¡€ç³–ï¼Œéœ€å°±åŒ» |
| > 33.3 | INVALID | - | è¶…å‡ºæœ‰æ•ˆèŒƒå›´ |

### å¥åº·å»ºè®®è§„åˆ™
#### ä½è¡€ç³–å»ºè®®ï¼ˆå‡ç³–ï¼‰
- **å±é™©ä½è¡€ç³–ï¼ˆ< 3.0ï¼‰**ï¼š
  - ç«‹å³è¿›é£Ÿ 15-20g å¿«é€Ÿç¢³æ°´ï¼ˆç³–æœã€æœæ±ï¼‰
  - 15åˆ†é’Ÿåå¤æµ‹
  - ç—‡çŠ¶æŒç»­ç«‹å³å°±åŒ»
  
- **ä½è¡€ç³–ï¼ˆ3.0-3.8ï¼‰**ï¼š
  - é€‚é‡è¿›é£Ÿç¢³æ°´åŒ–åˆç‰©
  - é¿å…å‰§çƒˆè¿åŠ¨
  - å¯†åˆ‡ç›‘æµ‹

#### é«˜è¡€ç³–å»ºè®®ï¼ˆé™ç³–ï¼‰
- **åé«˜ï¼ˆ6.2-7.0ï¼‰**ï¼š
  - æ§åˆ¶é¥®é£Ÿ
  - é€‚é‡è¿åŠ¨
  - å®šæœŸç›‘æµ‹

- **é«˜è¡€ç³–ï¼ˆ7.1-13.9ï¼‰**ï¼š
  - å‡å°‘ç³–åˆ†å’Œç¢³æ°´æ‘„å…¥
  - å¢åŠ è¿åŠ¨é‡
  - å’¨è¯¢åŒ»ç”Ÿè°ƒæ•´ç”¨è¯
  - æ¯æ—¥å¤šæ¬¡ç›‘æµ‹

- **å±é™©é«˜è¡€ç³–ï¼ˆâ‰¥ 14.0ï¼‰**ï¼š
  - ç«‹å³è”ç³»åŒ»ç”Ÿ
  - æ£€æŸ¥ç”¨è¯æƒ…å†µ
  - å¤šå–æ°´
  - è­¦æƒ•å¹¶å‘ç—‡

## 5. Invariants
- **INV-01**: æ ¡éªŒç»“æœå¿…é¡»æ˜ç¡®ï¼ˆtrue æˆ– falseï¼‰
- **INV-02**: å½“ isValid = false æ—¶ï¼Œå¿…é¡»æä¾› errorMessage

## 6. Implementation Notes
- é‡‡ç”¨é—­åŒºé—´æ ¡éªŒï¼š[1.0, 33.3]
- è¡€ç³–ç­‰çº§åˆ¤æ–­ä¼˜å…ˆäºæœ‰æ•ˆæ€§æ ¡éªŒ
- å¥åº·å»ºè®®éœ€æœ¬åœ°åŒ–ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰
- å»ºè®®æ–‡æœ¬å¯é…ç½®ï¼ˆæ”¯æŒåç»­ä¼˜åŒ–ï¼‰
- æ€§èƒ½è¦æ±‚ï¼šæ ¡éªŒæ—¶é—´ < 1ms
- å‘Šè­¦éœ€è¦åœ¨ UI ä¸Šçªå‡ºæ˜¾ç¤ºï¼ˆçº¢è‰²/é»„è‰²æ ‡è¯†ï¼‰

### å»ºè®®å±•ç¤ºè§„åˆ™
- **CRITICALLY_LOW / CRITICALLY_HIGH**ï¼šçº¢è‰²å‘Šè­¦æ¡† + éœ‡åŠ¨æé†’
- **LOW / HIGH**ï¼šé»„è‰²è­¦å‘Šæ¡†
- **NORMAL**ï¼šç»¿è‰²æç¤º
- **SLIGHTLY_HIGH**ï¼šæµ…é»„è‰²æç¤º

## 7. Test Index
- Test File: `/shared/src/commonTest/kotlin/com/twelfth/domain/glucose/ValidateGlucoseValueTest.kt`
- Test Coverage: 11 ä¸ª AC æµ‹è¯•ç”¨ä¾‹

## 8. UI Integration Notes
å½“ç”¨æˆ·è¾“å…¥è¡€ç³–å€¼åï¼ŒUI éœ€è¦ï¼š
1. è°ƒç”¨ `validateGlucoseValue()` è·å–æ ¡éªŒç»“æœ
2. å¦‚æœ `alert != null`ï¼Œæ˜¾ç¤ºå‘Šè­¦å¼¹çª—
3. æ˜¾ç¤º `suggestion` æ–‡æœ¬ç»™ç”¨æˆ·
4. æ ¹æ® `level` ä½¿ç”¨ä¸åŒé¢œè‰²æ ‡è¯†ï¼š
   - CRITICALLY_LOW/HIGH: çº¢è‰² + éœ‡åŠ¨
   - LOW/HIGH: é»„è‰²
   - NORMAL: ç»¿è‰²
   - SLIGHTLY_HIGH: æµ…é»„è‰²
5. å…è®¸ç”¨æˆ·ç¡®è®¤åç»§ç»­ä¿å­˜è®°å½•
