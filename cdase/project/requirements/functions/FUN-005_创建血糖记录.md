# Function: FUN-005 创建血糖记录

## 0. Metadata
- ID: FUN-005
- Feature ID: FTR-003
- Owner: hangxiao
- Version: v0.1
- Last Updated: 2026-01-31 15:00
- Status: Draft

## 1. Purpose
调用后端 API 创建血糖记录，并将数据持久化到数据库。

## 2. API/SPI Contract

### Function Signature (Kotlin)
```kotlin
/**
 * 创建血糖记录
 * 
 * @param request 血糖记录创建请求
 * @return 创建的血糖记录
 * @throws ApiException 当 API 调用失败时
 */
suspend fun createGlucoseRecord(request: CreateGlucoseRecordRequest): GlucoseRecord

data class CreateGlucoseRecordRequest(
    val value: Float,                // 血糖值（mmol/L）
    val measureType: MeasureType,    // 测量类型
    val measuredAt: Long? = null,    // 测量时间（可选，默认当前时间）
    val note: String? = null         // 备注（可选）
)
```

### REST API
- **Method**: `POST /api/v1/glucose/records`
- **Headers**: 
  - `Authorization: Bearer <token>` 或 `X-Guest-Id: <guestId>`
- **Request Body**:
  ```json
  {
    "value": 6.5,
    "measureType": "after_meal",
    "measuredAt": 1706543210000,
    "note": "今天吃了甜食"
  }
  ```
- **Response Body**:
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "userId": "GUEST_1706543210123_a3f9c2e1",
    "value": 6.5,
    "measureType": "after_meal",
    "measuredAt": 1706543210000,
    "note": "今天吃了甜食",
    "createdAt": 1706543215000,
    "updatedAt": 1706543215000
  }
  ```

## 3. Acceptance Criteria

- **AC-01**: Given 有效的血糖记录请求（value=6.5, type=AFTER_MEAL）, When 调用 API, Then 返回创建的记录，包含 UUID
- **AC-02**: Given 请求中未指定 measuredAt, When 调用 API, Then 使用当前时间作为测量时间
- **AC-03**: Given 请求中血糖值超出范围, When 调用 API, Then 返回 400 BadRequest
- **AC-04**: Given 未授权的请求（无 token 或 guest ID）, When 调用 API, Then 返回 401 Unauthorized
- **AC-05**: Given 网络连接失败, When 调用 API, Then 抛出 NetworkException
- **AC-06**: Given 后端返回 500 错误, When 调用 API, Then 抛出 ServerException
- **AC-07**: Given 创建成功, When 返回记录, Then userId 匹配当前用户ID（访客ID或正式用户ID）

## 4. Business Rules
- 血糖值必须已通过 FUN-004 校验
- 测量时间不能晚于当前时间
- 访客和正式用户均可创建记录
- 每条记录自动关联当前用户ID

## 5. Invariants
- **INV-01**: 创建的记录必须包含有效的 UUID
- **INV-02**: userId 必须与请求的认证信息一致
- **INV-03**: createdAt 和 updatedAt 由后端生成，不可由客户端指定

## 6. Dependencies
- FUN-004: 血糖值范围校验（必须先通过校验）
- FTR-001: 访客ID生成（访客用户需要 Guest ID）

## 7. Error Handling
- **400 BadRequest**: 血糖值超出范围或格式错误
- **401 Unauthorized**: 未授权
- **500 ServerError**: 后端系统错误
- **NetworkError**: 网络连接失败

## 8. Implementation Notes
- 使用 Ktor Client 发送 HTTP 请求
- 支持重试机制（网络失败时最多重试 2 次）
- 请求超时时间：10 秒
- 成功后更新本地缓存（可选）

## 9. Test Index
- Test File: `/shared/src/commonTest/kotlin/com/twelfth/domain/glucose/CreateGlucoseRecordTest.kt`
- Integration Test: `/androidApp/src/androidTest/kotlin/com/twelfth/android/glucose/CreateGlucoseRecordIntegrationTest.kt`
- Test Coverage: 7 个 AC 测试用例
