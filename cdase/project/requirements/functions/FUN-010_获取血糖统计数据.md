# Function: FUN-010 获取血糖统计数据

## 0. Metadata
- ID: FUN-010
- Feature ID: FTR-004
- Owner: hangxiao
- Version: v0.1
- Last Updated: 2026-01-31 15:05
- Status: Draft

## 1. Purpose
调用后端 API 获取指定周期的血糖统计数据（平均值、最高值、最低值、达标率）。

## 2. API/SPI Contract

### Function Signature (Kotlin)
```kotlin
/**
 * 获取血糖统计数据
 * 
 * @param period 统计周期（今日/近7天/近30天）
 * @param targetValue 达标目标值，默认 7.0 mmol/L
 * @return 统计数据
 * @throws ApiException 当 API 调用失败时
 */
suspend fun getGlucoseStatistics(
    period: StatisticsPeriod,
    targetValue: Float = 7.0f
): GlucoseStatistics

enum class StatisticsPeriod {
    TODAY,          // 今日
    LAST_7_DAYS,    // 近7天
    LAST_30_DAYS    // 近30天
}

data class GlucoseStatistics(
    val period: StatisticsPeriod,
    val recordCount: Int,
    val averageValue: Float,
    val maxValue: Float,
    val minValue: Float,
    val targetRate: Float,
    val targetValue: Float
)
```

### REST API
- **Method**: `GET /api/v1/glucose/statistics`
- **Headers**: 
  - `Authorization: Bearer <token>` 或 `X-Guest-Id: <guestId>`
- **Query Params**:
  - `period`: today / last7days / last30days
  - `targetValue`: 达标目标值（可选，默认 7.0）
- **Response Body**:
  ```json
  {
    "period": "last7days",
    "recordCount": 21,
    "averageValue": 6.8,
    "maxValue": 9.2,
    "minValue": 4.5,
    "targetRate": 85.7,
    "targetValue": 7.0
  }
  ```

## 3. Acceptance Criteria

- **AC-01**: Given 用户近7天有10条记录, When 请求 LAST_7_DAYS 统计, Then 返回 recordCount=10 和正确的平均值/最高/最低值
- **AC-02**: Given 用户今日无记录, When 请求 TODAY 统计, Then 返回 recordCount=0, 其他值为 0 或 null
- **AC-03**: Given 用户近7天有10条记录（7条 < 7.0, 3条 >= 7.0）, When 请求统计, Then targetRate = 70.0
- **AC-04**: Given targetValue = 8.0, When 请求统计, Then 使用 8.0 作为达标阈值计算达标率
- **AC-05**: Given 未授权的请求, When 调用 API, Then 返回 401 Unauthorized
- **AC-06**: Given 后端返回 500 错误, When 调用 API, Then 抛出 ServerException
- **AC-07**: Given 请求成功, When 返回统计数据, Then 平均值精度为小数点后1位

## 4. Business Rules
- 平均值 = sum(values) / count
- 最高值 = max(values)
- 最低值 = min(values)
- 达标率 = (count(value < targetValue) / count) × 100%
- 所有数值精度：小数点后1位

### 时间范围
- TODAY: 当天 00:00:00 至当前时间
- LAST_7_DAYS: 当前时间往前推 7×24 小时
- LAST_30_DAYS: 当前时间往前推 30×24 小时

## 5. Invariants
- **INV-01**: recordCount >= 0
- **INV-02**: 当 recordCount = 0 时，averageValue/maxValue/minValue 为 0 或 null
- **INV-03**: 达标率范围：0.0 - 100.0

## 6. Dependencies
- FTR-003: 血糖记录管理（必须先有记录数据）

## 7. Error Handling
- **401 Unauthorized**: 未授权
- **500 ServerError**: 后端系统错误
- **NetworkError**: 网络连接失败

## 8. Implementation Notes
- 统计计算在后端完成（数据库聚合查询）
- 前端缓存统计结果 5 分钟
- 请求超时时间：10 秒
- 支持下拉刷新强制更新

## 9. Test Index
- Test File: `/shared/src/commonTest/kotlin/com/twelfth/domain/glucose/GetGlucoseStatisticsTest.kt`
- Integration Test: `/androidApp/src/androidTest/kotlin/com/twelfth/android/glucose/GetStatisticsIntegrationTest.kt`
- Test Coverage: 7 个 AC 测试用例
