# Scenario: SCN-004 数字人智能对话与引导

## 0. Metadata
- ID: SCN-004
- Steward: hangxiao
- Priority: P0
- Version: v0.1
- Last Updated: 2026-01-29
- Status: Draft
- Development Phase: 第二阶段（3周）

## 1. Background

**用户角色**: 糖尿病患者（访客或正式用户）

**问题陈述**:
- 糖尿病患者需要专业的健康指导，但线下就医成本高、频率低
- 传统应用的表单录入方式体验差，用户容易放弃
- 患者希望像和真人医生交流一样，通过对话获得帮助和记录数据
- 需要实时交互体验，避免长时间等待 AI 响应

## 2. Core Scenario

### 2.1 初始化对话会话
1. 用户打开应用，进入"徐医生"数字人界面
2. 系统自动创建对话会话（Session），关联用户ID
3. 数字人主动打招呼：
   "您好，我是徐医生，您的专属健康助手。有什么可以帮您的吗？"

### 2.2 流式对话交互（核心体验）
4. 用户通过文字或语音输入消息：
   例如："我刚测了血糖6.5"
5. 前端显示"徐医生正在思考..."（thinking 状态）
6. **SSE 流式响应开始**：
   - 文字逐字显示（打字机效果）："您的餐后血糖6.5 mmol/L，控制得很不错..."
   - 同时播放语音（TTS 流式音频）
   - 首字响应时间 < 0.5 秒，用户感知为实时对话
7. 数字人边回复边执行操作（通过 Function Calling）：
   - 检测到用户提供了血糖数据
   - 自动调用后端接口 `save_blood_sugar(value=6.5, type="after_meal")`
   - 保存记录到数据库
   - 向用户确认："已为您记录餐后血糖6.5"

### 2.3 引导式信息录入（多轮对话）
8. 新用户首次使用，数字人主动引导：
   - "为了更好地为您服务，我想了解一些基本情况，可以吗？"
   - 用户同意后，数字人逐项询问：
     - 个人信息（姓名、年龄、性别）
     - 病例信息（患病时间、糖尿病类型、用药情况）
   - 每个回答通过 Function Call 自动保存
   - 引导完成后，数字人总结："信息已记录，现在可以开始记录您的健康数据了！"

### 2.4 智能对话能力
9. 用户可以自由提问，数字人基于知识库回答：
   - "糖尿病能吃水果吗？" → 专业知识解答
   - "我血糖一直降不下来怎么办？" → 提供建议并引导问诊
   - "今天吃了什么好？" → 推荐低糖饮食方案
10. 数字人记住对话上下文，支持多轮对话：
    - 用户："我血糖6.5"
    - 数字人："这是餐后血糖吗？"
    - 用户："是的"
    - 数字人："好的，已记录。"

### 2.5 查看对话历史
11. 用户可查看与徐医生的历史对话记录
12. 按时间倒序展示，支持分页加载

## 3. Expected Outcomes

### 用户视角
- ✅ 实时对话体验，首字响应 < 0.5 秒
- ✅ 打字机效果 + 流式语音，体验自然流畅
- ✅ 对话即录入，无需手动填表单
- ✅ 数字人理解上下文，支持多轮对话
- ✅ 专业的健康知识问答

### 系统视角
- ✅ 使用 SSE（Server-Sent Events）流式传输
- ✅ 集成阿里百炼 AI 服务（对话 + TTS）
- ✅ 支持 Function Calling，自动调用业务接口
- ✅ 对话历史持久化存储
- ✅ 支持降级为同步接口（不支持 SSE 的客户端）

## 4. Constraints & Rules

### 业务规则
1. **会话生命周期**：
   - 会话默认 30 分钟无操作自动失效
   - 用户可手动结束会话
   
2. **Function Call 权限**：
   - 访客只能调用查询类工具（如查询血糖记录）
   - 正式用户可调用所有工具（保存数据、问诊等）
   
3. **知识库范围**：
   - 专注于糖尿病相关知识
   - 超出范围的问题，引导用户联系专业医生

### 不变量（Invariants）
- **数据一致性**：Function Call 执行失败时，必须在对话中告知用户
- **上下文完整性**：每次请求携带会话ID，保持对话连贯性

### 边缘情况
1. **网络中断**：
   - SSE 连接断开时，前端重连并请求最新消息
   
2. **并发对话**：
   - 同一用户可同时存在多个会话（不同场景）
   - 每个会话独立的上下文
   
3. **敏感词过滤**：
   - AI 回复经过敏感词审核
   - 涉及诊断或处方建议时，添加免责声明

## 5. Evolution Hint

**全新能力**，是"糖小稳"的核心差异化功能。

**未来演进**：
- P1: 支持语音输入（ASR 语音识别）
- P1: 支持视频数字人（3D 虚拟形象）
- P2: 多角色数字人（营养师、运动教练等）
- P2: 情感陪伴功能（关怀问候、用药提醒）

---

**关联模块**: 数字人模块、阿里百炼集成
**被依赖场景**: SCN-002（血糖记录）、SCN-003（信息录入）、SCN-005（饮食记录）、SCN-008（健康问诊）
**关键技术**: SSE流式传输、Function Calling、TTS语音合成
