# Scenario: SCN-009 订阅套餐与支付

## 0. Metadata
- ID: SCN-009
- Steward: hangxiao
- Priority: P0
- Version: v0.1
- Last Updated: 2026-01-29
- Status: Draft
- Development Phase: 第四阶段（2周）

## 1. Background

**用户角色**: 糖尿病患者（正式用户）

**问题陈述**:
- 用户体验免费功能后，希望获得更专业的服务（如：真人医生图文问诊）
- 应用需要商业化变现，通过订阅套餐或单次付费获得收入
- 支付流程必须简单、安全、可靠
- 支付回调必须保证幂等性，避免重复扣费或漏单

## 2. Core Scenario

### 2.1 查看订阅套餐
1. 用户进入"会员中心"或"订阅套餐"页面
2. 展示套餐列表：
   - **免费版**（当前）：基础功能，AI 问诊
   - **月度会员**（￥29/月）：无限次 AI 问诊 + 5 次真人医生图文问诊
   - **年度会员**（￥299/年）：无限次 AI 问诊 + 50 次真人医生图文问诊 + 专属营养师
3. 每个套餐显示详细权益对比
4. 用户点击"立即订阅"

### 2.2 发起支付
5. 选择支付方式：
   - 微信支付（推荐）
   - 支付宝支付（P1 阶段）
6. 系统创建订单：
   - 生成唯一订单号（ORDER_YYYYMMDDHHMMSS_RANDOM）
   - 订单状态：待支付（pending）
   - 记录订单信息到数据库
7. 调用微信支付 API，生成支付参数
8. 拉起微信支付界面

### 2.3 用户完成支付
9. 用户在微信支付界面确认支付
10. 微信扣款成功

### 2.4 支付回调处理（关键流程）
11. 微信支付平台异步回调后端接口：
    `POST /api/v1/subscriptions/payment/callback/wechat`
12. **幂等性保证**（防止重复处理）：
    - 使用分布式锁（Redis）：`LOCK:ORDER:{orderId}`
    - 检查订单状态，如果已处理，直接返回成功
13. **订单状态更新**：
    - 验证回调签名（防止伪造）
    - 更新订单状态：已支付（paid）
    - 记录支付流水号（微信交易单号）
14. **业务逻辑执行**：
    - 根据套餐类型，更新用户权益：
      - 设置会员到期时间
      - 增加问诊次数配额
    - 创建订阅记录（subscription）
15. **返回成功响应**给微信支付平台
16. **前端轮询或推送**通知用户支付成功

### 2.5 支付结果展示
17. 用户收到支付成功通知
18. 跳转到"支付成功"页面：
    - 显示订单信息
    - 显示会员权益和到期时间
19. 用户可进入"我的订单"查看订单详情

### 2.6 订阅状态管理
20. 用户进入"会员中心"，查看当前订阅状态：
    - 会员类型（月度/年度）
    - 到期时间
    - 剩余问诊次数
21. 到期前 3 天，系统推送续费提醒
22. 到期后，自动降级为免费版

### 2.7 订单查询
23. 用户进入"我的订单"页面
24. 查看订单列表（按时间倒序）：
    - 订单号、套餐名称、金额、状态、支付时间
25. 点击订单可查看详情
26. 支持申请退款（P1 阶段）

## 3. Expected Outcomes

### 用户视角
- ✅ 套餐权益清晰，价格透明
- ✅ 支付流程简单，操作不超过 3 步
- ✅ 支付成功后立即生效，无需等待
- ✅ 可随时查看订单和会员状态

### 系统视角
- ✅ 订单唯一性保证（订单号不重复）
- ✅ 支付回调幂等性处理（防止重复扣费）
- ✅ 订单状态机严格管理（pending → paid → activated）
- ✅ 支付流水完整记录（审计追溯）
- ✅ 分布式锁保证并发安全

## 4. Constraints & Rules

### 业务规则
1. **用户限制**：
   - 仅正式用户可购买订阅（访客不可）
   - 一个用户同一时间只能有一个有效订阅
   
2. **订单有效期**：
   - 待支付订单 30 分钟未支付自动关闭
   - 已支付订单不可取消（可申请退款）
   
3. **权益叠加规则**：
   - 续费时，剩余天数累加到新订阅
   - 问诊次数不累加（每月重置）
   
4. **退款规则**（P1 阶段）：
   - 购买 7 天内可申请退款
   - 已使用的问诊次数按单次价格扣除

### 不变量（Invariants）
- **金额一致性**：订单金额必须与套餐价格一致
- **幂等性**：同一笔支付回调多次调用，只处理一次
- **审计完整性**：所有订单和支付操作必须记录日志

### 边缘情况
1. **支付超时**：
   - 用户拉起支付后长时间未操作，订单自动关闭
   
2. **重复支付**：
   - 用户在订单关闭前重复点击支付，生成新订单
   - 原订单标记为已取消
   
3. **回调延迟**：
   - 微信支付回调可能延迟几秒到几分钟
   - 前端轮询订单状态，最长等待 3 分钟
   
4. **回调丢失**：
   - 如果回调丢失，用户可手动"查询订单状态"
   - 系统主动查询微信支付订单状态

## 5. Evolution Hint

**全新能力**。

**未来演进**：
- P1: 支持支付宝支付
- P1: 支持退款流程
- P1: 单次购买服务（如：￥9.9/次图文问诊）
- P2: 优惠券和促销活动
- P2: 订阅自动续费（免密支付）
- P2: 家庭套餐（一人购买，全家使用）

---

**关联模块**: 订阅模块、支付集成
**依赖场景**: SCN-001（用户身份 - 仅正式用户可订阅）
**关键技术**: 微信支付 API、分布式锁（Redis）、幂等性处理、订单状态机
