@startuml
title FTR-001 访客ID生成与管理 - Sequence Diagram

actor 用户 as User
participant "Android APP\n(MainActivity)" as App
participant "GuestIdManager\n(KMM Shared)" as Manager
participant "LocalStorage\n(Android Impl)" as Storage
participant "SharedPreferences" as AndroidPrefs
participant "后端API\n(/api/v1/users/guest)" as API

== 首次访问场景 ==
User -> App: 打开 Android 应用
activate App

App -> Manager: detectGuestId(localStorage)
activate Manager
note right of Manager: FUN-001: 检测访客ID存在性\n(KMM Shared 模块)
Manager -> Storage: getString("GUEST_ID")
activate Storage
Storage -> AndroidPrefs: getString("GUEST_ID", null)
activate AndroidPrefs
AndroidPrefs --> Storage: null
deactivate AndroidPrefs
Storage --> Manager: null (不存在)
deactivate Storage
Manager --> App: null
deactivate Manager

App -> Manager: generateGuestId(localStorage)
activate Manager
note right of Manager: FUN-002: 生成访客ID\n(KMM Shared 模块)
Manager -> Manager: 生成ID\nGUEST_<timestamp>_<random>
Manager -> Storage: setString("GUEST_ID", guestId)
activate Storage
Storage -> AndroidPrefs: putString("GUEST_ID", guestId)
activate AndroidPrefs
AndroidPrefs --> Storage: 成功
deactivate AndroidPrefs
Storage --> Manager: 存储成功
deactivate Storage
Manager --> App: guestId
deactivate Manager

App -> API: POST /api/v1/users/guest/register
note right of App: 可选：将访客ID注册到后端
activate API
API --> App: {guestId: "GUEST_..."}
deactivate API

App --> User: 进入主页，访客身份生效
deactivate App

== 重复访问场景 ==
User -> App: 再次打开应用
activate App

App -> Manager: detectGuestId(context)
activate Manager
Manager -> Storage: getString("GUEST_ID", null)
activate Storage
Storage --> Manager: guestId (已存在)
deactivate Storage
Manager --> App: guestId
deactivate Manager

App --> User: 进入主页，复用访客身份
deactivate App

== 错误场景：访客ID格式无效 ==
User -> App: 打开应用
activate App

App -> Manager: detectGuestId(context)
activate Manager
Manager -> Storage: getString("GUEST_ID", null)
activate Storage
Storage --> Manager: "invalid_format"
deactivate Storage

Manager -> Manager: 验证格式：不符合规范
Manager -> Storage: remove("GUEST_ID")
activate Storage
Storage --> Manager: 清除成功
deactivate Storage
Manager --> App: null
deactivate Manager

App -> Manager: generateGuestId(context)
note right of Manager: 重新生成访客ID
activate Manager
Manager -> Manager: 生成新ID
Manager -> Storage: putString("GUEST_ID", newGuestId)
activate Storage
Storage --> Manager: 存储成功
deactivate Storage
Manager --> App: newGuestId
deactivate Manager

App --> User: 进入主页，新访客身份生效
deactivate App

== 错误场景：SharedPreferences 写入失败 ==
User -> App: 打开应用
activate App

App -> Manager: detectGuestId(context)
activate Manager
Manager -> Storage: getString("GUEST_ID", null)
activate Storage
Storage --> Manager: null
deactivate Storage
Manager --> App: null
deactivate Manager

App -> Manager: generateGuestId(context)
activate Manager
Manager -> Manager: 生成ID
Manager -> Storage: putString("GUEST_ID", guestId)
activate Storage
Storage --> Manager: ❌ StorageException
deactivate Storage
Manager --> App: 抛出 StorageException
deactivate Manager

App -> User: 显示错误提示\n"初始化失败，请重试"
deactivate App

@enduml
