@startuml
title FTR-001 访客ID生成与管理 - Class Diagram

package "Android/Data Layer" {
  class GuestIdManager {
    - STORAGE_KEY: String = "GUEST_ID"
    - PREFS_NAME: String = "tangxiaonuan_prefs"
    - ID_PATTERN: Regex = Regex("^GUEST_\\d{13}_[a-z0-9]{8}$")
    
    + detectGuestId(context: Context): String?
    + generateGuestId(context: Context): String
    + validateGuestId(id: String): Boolean
    - generateRandomString(length: Int): String
    - getCurrentTimestamp(): Long
  }
  
  note right of GuestIdManager::detectGuestId
    FUN-001: 检测访客ID存在性
    从 SharedPreferences 读取访客ID
    如果格式无效，清除并返回 null
  end note
  
  note right of GuestIdManager::generateGuestId
    FUN-002: 生成访客ID
    格式: GUEST_<timestamp>_<random>
    生成后立即存储到 SharedPreferences
  end note
}

package "Android Framework" {
  interface SharedPreferences <<external>> {
    + getString(key: String, defValue: String?): String?
    + edit(): Editor
  }
  
  interface Editor <<external>> {
    + putString(key: String, value: String): Editor
    + remove(key: String): Editor
    + apply(): void
  }
  
  note right of SharedPreferences
    Android 原生存储 API
    提供轻量级键值对存储能力
  end note
}

package "Backend API" <<optional>> {
  interface UserGuestAPI <<external>> {
    + POST /api/v1/users/guest/register
    + Request: {}
    + Response: {guestId: String}
  }
  
  note right of UserGuestAPI
    后端访客注册接口（可选）
    用于将访客ID注册到后端
    Android 客户端生成ID后可选调用
  end note
}

GuestIdManager ..> SharedPreferences : uses
SharedPreferences ..> Editor : creates
GuestIdManager ..> UserGuestAPI : optional\nregister

package "Models" {
  class GuestIdResponse {
    + guestId: String
  }
  
  class StorageException <<exception>> {
    + message: String
    + cause: Throwable?
  }
  
  note right of StorageException
    存储异常
    当 SharedPreferences 写入失败时抛出
  end note
}

GuestIdManager ..> GuestIdResponse : returns
GuestIdManager ..> StorageException : throws

@enduml
