# ç³–å°ç¨³ P0 éœ€æ±‚è¯¦ç»†è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **é¡¹ç›®åç§°**: ç³–å°ç¨³ (Tang Xiao Nuan)
- **ç‰ˆæœ¬**: v1.1 (æŠ€æœ¯ä¼˜åŒ–ç‰ˆ)
- **åˆ›å»ºæ—¥æœŸ**: 2026-01-29
- **æœ€åæ›´æ–°**: 2026-01-29 (æŠ€æœ¯æ¶æ„ä¼˜åŒ–)
- **æŠ€æœ¯æ ˆ**: Java + PostgreSQL + é˜¿é‡Œç™¾ç‚¼
- **è®¾è®¡èŒƒå›´**: æ‰€æœ‰ P0 ä¼˜å…ˆçº§éœ€æ±‚

### ğŸ“Œ v1.1 æ›´æ–°è¯´æ˜
æœ¬æ¬¡æ›´æ–°é’ˆå¯¹æ•°å­—äººå®æ—¶äº¤äº’å’Œ AI Agent æ·±åº¦é›†æˆè¿›è¡Œäº†æ¶æ„ä¼˜åŒ–ï¼š
- âœ… æ•°å­—äººå¯¹è¯æ”¹ä¸º SSE æµå¼æ¥å£ï¼Œè§£å†³é•¿å»¶è¿Ÿé—®é¢˜
- âœ… å¢åŠ  Agent å·¥å…·æ‰§è¡Œå™¨ï¼Œå®ç° Function Calling
- âœ… ä¼˜åŒ–æ•æ„Ÿæ•°æ®åŠ å¯†ä¸æ£€ç´¢ç­–ç•¥
- âœ… æ˜ç¡®è®¿å®¢è½¬æ­£çš„æ•°æ®è¿ç§»é€»è¾‘
- âœ… å¢åŠ  OSS æ–‡ä»¶ä¸Šä¼ æ¨¡å—
- âœ… å¼ºåŒ–æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§å¤„ç†

---

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±‚ (Mini Program)                 â”‚
â”‚  - ç”¨æˆ·äº¤äº’ç•Œé¢                                            â”‚
â”‚  - æ•°å­—äººäº¤äº’ç»„ä»¶                                          â”‚
â”‚  - æ‹ç…§ä¸Šä¼ åŠŸèƒ½                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ HTTPS/REST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ç½‘å…³å±‚                             â”‚
â”‚  - èº«ä»½éªŒè¯                                               â”‚
â”‚  - è¯·æ±‚è·¯ç”±                                               â”‚
â”‚  - é™æµç†”æ–­                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨æœåŠ¡å±‚ (Spring Boot)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚  â”‚  æ•°å­—äººæœåŠ¡  â”‚  â”‚  æ•°æ®æœåŠ¡    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  é—®è¯ŠæœåŠ¡    â”‚  â”‚  è®¢é˜…æœåŠ¡    â”‚  â”‚  å®‰å…¨æœåŠ¡    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®æŒä¹…å±‚ (PostgreSQL)                   â”‚
â”‚  - ç”¨æˆ·è¡¨                                                 â”‚
â”‚  - è¡€ç³–è®°å½•è¡¨                                             â”‚
â”‚  - é¥®é£Ÿè®°å½•è¡¨                                             â”‚
â”‚  - é—®è¯Šè®°å½•è¡¨                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å¤–éƒ¨æœåŠ¡é›†æˆå±‚                             â”‚
â”‚  - é˜¿é‡Œç™¾ç‚¼ AI æœåŠ¡                                       â”‚
â”‚  - OSS å¯¹è±¡å­˜å‚¨                                           â”‚
â”‚  - æ”¯ä»˜æœåŠ¡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯é€‰å‹è¯´æ˜
- **åç«¯æ¡†æ¶**: Spring Boot 3.x - æˆç†Ÿç¨³å®šï¼Œç”Ÿæ€å®Œå–„
- **æ•°æ®åº“**: PostgreSQL 15+ - æ”¯æŒ JSONBï¼Œæ€§èƒ½ä¼˜ç§€
- **ORM**: MyBatis-Plus - ç®€åŒ– CRUD æ“ä½œ
- **AI æœåŠ¡**: é˜¿é‡Œç™¾ç‚¼ - æä¾›æ•°å­—äººå¯¹è¯èƒ½åŠ›
- **ç¼“å­˜**: Redis - ä¼šè¯ç¼“å­˜å’Œçƒ­ç‚¹æ•°æ®
- **æ¶ˆæ¯é˜Ÿåˆ—**: RocketMQ - å¼‚æ­¥ä»»åŠ¡å¤„ç†

---

## 2. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 2.1 ç”¨æˆ·æ¨¡å— (User Module)

#### 2.1.1 åŠŸèƒ½æè¿°
è´Ÿè´£ç”¨æˆ·èº«ä»½ç®¡ç†ã€å…ç™»å½•æ¨¡å¼ã€ä¸ªäººä¿¡æ¯ç®¡ç†å’Œç—…ä¾‹ä¿¡æ¯ç®¡ç†ã€‚

#### 2.1.2 ç±»è®¾è®¡

**UserController.java**
```java
package com.tangxiaowen.user.controller;

/**
 * ç”¨æˆ·æ§åˆ¶å™¨
 * è´Ÿè´£å¤„ç†ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰ HTTP è¯·æ±‚
 */
@RestController
@RequestMapping("/api/v1/users")
public class UserController {
    
    /**
     * å…ç™»å½•æ¨¡å¼è®¿å®¢æ³¨å†Œ
     * ç”Ÿæˆä¸´æ—¶è®¿å®¢èº«ä»½ï¼Œç”¨äº showcase æ¼”ç¤º
     */
    @PostMapping("/guest/register")
    public ResponseEntity<GuestTokenResponse> registerGuest();
    
    /**
     * è®¿å®¢è½¬æ­£å¼ç”¨æˆ·
     * å°†è®¿å®¢è´¦å·è½¬æ¢ä¸ºæ­£å¼ç”¨æˆ·è´¦å·
     */
    @PostMapping("/guest/convert")
    public ResponseEntity<UserResponse> convertGuestToUser(@RequestBody ConvertUserRequest request);
    
    /**
     * è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
     */
    @GetMapping("/{userId}")
    public ResponseEntity<UserResponse> getUserInfo(@PathVariable String userId);
    
    /**
     * æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
     * åŒ…æ‹¬å§“åã€æ€§åˆ«ã€å¹´é¾„ã€è”ç³»æ–¹å¼ç­‰
     */
    @PutMapping("/{userId}/profile")
    public ResponseEntity<UserResponse> updateUserProfile(
        @PathVariable String userId,
        @RequestBody UpdateProfileRequest request
    );
    
    /**
     * æ›´æ–°ç”¨æˆ·ç—…ä¾‹ä¿¡æ¯
     * åŒ…æ‹¬æ‚£ç—…æ—¶é—´ã€è¡€å‹ã€ç—…å²ã€ç”¨è¯æƒ…å†µç­‰
     */
    @PutMapping("/{userId}/medical-history")
    public ResponseEntity<MedicalHistoryResponse> updateMedicalHistory(
        @PathVariable String userId,
        @RequestBody UpdateMedicalHistoryRequest request
    );
    
    /**
     * è·å–ç”¨æˆ·ç—…ä¾‹ä¿¡æ¯
     */
    @GetMapping("/{userId}/medical-history")
    public ResponseEntity<MedicalHistoryResponse> getMedicalHistory(@PathVariable String userId);
    
    /**
     * åŒæ„éšç§åè®®
     */
    @PostMapping("/{userId}/privacy-agreement")
    public ResponseEntity<Void> agreePrivacyPolicy(
        @PathVariable String userId,
        @RequestBody PrivacyAgreementRequest request
    );
}
```

**UserService.java**
```java
package com.tangxiaowen.user.service;

/**
 * ç”¨æˆ·æœåŠ¡æ¥å£
 * å®šä¹‰ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
 */
public interface UserService {
    
    /**
     * åˆ›å»ºè®¿å®¢ç”¨æˆ·
     * @return è®¿å®¢ä»¤ç‰Œå’Œç”¨æˆ·ID
     */
    GuestTokenResponse createGuestUser();
    
    /**
     * è®¿å®¢è½¬æ­£
     * @param guestUserId è®¿å®¢ç”¨æˆ·ID
     * @param request è½¬æ­£è¯·æ±‚ä¿¡æ¯
     * @return æ­£å¼ç”¨æˆ·ä¿¡æ¯
     */
    UserResponse convertGuestToUser(String guestUserId, ConvertUserRequest request);
    
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…å«åŠ å¯†å­—æ®µçš„è§£å¯†ç»“æœ
     */
    UserResponse getUserById(String userId);
    
    /**
     * æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @param request æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
     */
    UserResponse updateUserProfile(String userId, UpdateProfileRequest request);
    
    /**
     * æ›´æ–°ç—…ä¾‹ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @param request ç—…ä¾‹æ›´æ–°è¯·æ±‚
     * @return ç—…ä¾‹ä¿¡æ¯
     */
    MedicalHistoryResponse updateMedicalHistory(String userId, UpdateMedicalHistoryRequest request);
    
    /**
     * è·å–ç—…ä¾‹ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @return ç—…ä¾‹ä¿¡æ¯
     */
    MedicalHistoryResponse getMedicalHistory(String userId);
    
    /**
     * è®°å½•éšç§åè®®åŒæ„çŠ¶æ€
     * @param userId ç”¨æˆ·ID
     * @param agreementVersion åè®®ç‰ˆæœ¬
     */
    void recordPrivacyAgreement(String userId, String agreementVersion);
}
```

**UserServiceImpl.java**
```java
package com.tangxiaowen.user.service.impl;

/**
 * ç”¨æˆ·æœåŠ¡å®ç°
 */
@Service
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private MedicalHistoryMapper medicalHistoryMapper;
    
    @Autowired
    private EncryptionService encryptionService;
    
    @Autowired
    private PrivacyAgreementMapper privacyAgreementMapper;
    
    @Override
    public GuestTokenResponse createGuestUser() {
        // ç”Ÿæˆè®¿å®¢IDå’Œä¸´æ—¶ä»¤ç‰Œ
        // åˆ›å»ºè®¿å®¢ç”¨æˆ·è®°å½•
        // è¿”å›ä»¤ç‰Œä¿¡æ¯
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public UserResponse convertGuestToUser(String guestUserId, ConvertUserRequest request) {
        /**
         * ğŸ”¥ è®¿å®¢è½¬æ­£é€»è¾‘ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
         * 
         * åœºæ™¯è¯´æ˜ï¼š
         * ç”¨æˆ·ä»¥è®¿å®¢èº«ä»½ï¼ˆGuest_ID_123ï¼‰ä½“éªŒäº†3å¤©ï¼Œè®°å½•äº†è¡€ç³–ã€é¥®é£Ÿç­‰æ•°æ®ã€‚
         * ç°åœ¨ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"ï¼Œå¾®ä¿¡è¿”å› OpenID_456ã€‚
         * 
         * éœ€è¦å¤„ç†ä¸¤ç§æƒ…å†µï¼š
         * 1. OpenID_456 æ˜¯æ–°ç”¨æˆ· -> å°†è®¿å®¢è´¦å·å‡çº§ä¸ºæ­£å¼è´¦å·
         * 2. OpenID_456 å¯¹åº”å·²å­˜åœ¨çš„è€è´¦å· -> æ•°æ®è¿ç§»+åˆå¹¶
         */
        
        // 1. éªŒè¯è®¿å®¢ç”¨æˆ·å­˜åœ¨
        User guestUser = userMapper.selectByUserId(guestUserId);
        if (guestUser == null || !guestUser.getUserType().equals("guest")) {
            throw new BusinessException("è®¿å®¢ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è½¬æ­£");
        }
        
        // 2. æ ¹æ® OpenID æŸ¥è¯¢æ˜¯å¦å­˜åœ¨æ­£å¼ç”¨æˆ·
        String openId = request.getWechatOpenId();
        User existingUser = userMapper.selectByWechatOpenId(openId);
        
        if (existingUser == null) {
            // ç­–ç•¥ Aï¼šOpenID æ˜¯æ–°ç”¨æˆ·ï¼Œç›´æ¥å‡çº§è®¿å®¢è´¦å·
            guestUser.setUserType("normal");
            guestUser.setWechatOpenId(openId);
            guestUser.setWechatUnionid(request.getWechatUnionId());
            
            // åŠ å¯†å¹¶ä¿å­˜æ‰‹æœºå·ï¼ˆå¦‚æœæä¾›ï¼‰
            if (StringUtils.isNotBlank(request.getPhone())) {
                guestUser.setEncryptedPhone(encryptionService.encrypt(request.getPhone()));
                guestUser.setPhoneHash(generateHash(request.getPhone()));
            }
            
            userMapper.updateByUserId(guestUser);
            
            log.info("è®¿å®¢è½¬æ­£æˆåŠŸï¼ˆæ–°ç”¨æˆ·ï¼‰ï¼šguestUserId={}, openId={}", guestUserId, openId);
            return buildUserResponse(guestUser);
            
        } else {
            // ç­–ç•¥ Bï¼šOpenID å¯¹åº”å·²å­˜åœ¨çš„è€è´¦å·ï¼Œéœ€è¦æ•°æ®è¿ç§»
            log.info("æ£€æµ‹åˆ°è€è´¦å·ï¼Œå¼€å§‹æ•°æ®è¿ç§»ï¼šguestUserId={}, existingUserId={}", guestUserId, existingUser.getUserId());
            
            // 2.1 è¿ç§»è¡€ç³–è®°å½•
            int glucoseCount = glucoseRecordMapper.updateUserIdByUserId(guestUserId, existingUser.getUserId());
            
            // 2.2 è¿ç§»é¥®é£Ÿè®°å½•
            int dietCount = dietRecordMapper.updateUserIdByUserId(guestUserId, existingUser.getUserId());
            
            // 2.3 è¿ç§»è¿åŠ¨è®°å½•
            int exerciseCount = exerciseRecordMapper.updateUserIdByUserId(guestUserId, existingUser.getUserId());
            
            // 2.4 è¿ç§»é—®è¯Šè®°å½•
            int consultationCount = consultationMapper.updateUserIdByUserId(guestUserId, existingUser.getUserId());
            
            // 2.5 è½¯åˆ é™¤è®¿å®¢è´¦å·
            guestUser.setIsDeleted(true);
            userMapper.updateByUserId(guestUser);
            
            log.info("æ•°æ®è¿ç§»å®Œæˆï¼šè¡€ç³–{}æ¡ï¼Œé¥®é£Ÿ{}æ¡ï¼Œè¿åŠ¨{}æ¡ï¼Œé—®è¯Š{}æ¡", 
                glucoseCount, dietCount, exerciseCount, consultationCount);
            
            return buildUserResponse(existingUser);
        }
    }
    
    /**
     * ç”Ÿæˆå“ˆå¸Œå€¼ï¼ˆç”¨äºæ£€ç´¢ï¼‰
     * @param plainText æ˜æ–‡
     * @return SHA256(plainText + global_salt)
     */
    private String generateHash(String plainText) {
        String saltedText = plainText + globalSalt; // globalSalt ä»é…ç½®ä¸­å¿ƒè¯»å–
        return DigestUtils.sha256Hex(saltedText);
    }
    
    @Override
    public UserResponse getUserById(String userId) {
        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        // è§£å¯†æ•æ„Ÿå­—æ®µ
        // è¿”å›è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯
    }
    
    @Override
    public UserResponse updateUserProfile(String userId, UpdateProfileRequest request) {
        // éªŒè¯ç”¨æˆ·å­˜åœ¨
        // åŠ å¯†æ•æ„Ÿå­—æ®µï¼ˆå§“åã€ç”µè¯ã€èº«ä»½è¯ç­‰ï¼‰
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        // è¿”å›æ›´æ–°ç»“æœ
    }
    
    @Override
    public MedicalHistoryResponse updateMedicalHistory(String userId, UpdateMedicalHistoryRequest request) {
        // éªŒè¯ç”¨æˆ·å­˜åœ¨
        // åŠ å¯†ç—…ä¾‹æ•æ„Ÿä¿¡æ¯
        // æ›´æ–°æˆ–åˆ›å»ºç—…ä¾‹è®°å½•
        // è¿”å›ç—…ä¾‹ä¿¡æ¯
    }
    
    @Override
    public MedicalHistoryResponse getMedicalHistory(String userId) {
        // æŸ¥è¯¢ç—…ä¾‹ä¿¡æ¯
        // è§£å¯†æ•æ„Ÿå­—æ®µ
        // è¿”å›ç—…ä¾‹ä¿¡æ¯
    }
    
    @Override
    public void recordPrivacyAgreement(String userId, String agreementVersion) {
        // è®°å½•ç”¨æˆ·åŒæ„éšç§åè®®çš„æ—¶é—´å’Œç‰ˆæœ¬
        // ä¿å­˜åˆ°æ•°æ®åº“
    }
}
```

**UserMapper.java**
```java
package com.tangxiaowen.user.mapper;

/**
 * ç”¨æˆ·æ•°æ®è®¿é—®å±‚
 */
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢ç”¨æˆ·
     */
    User selectByUserId(String userId);
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    int updateByUserId(User user);
    
    /**
     * åˆ›å»ºç”¨æˆ·
     */
    int insert(User user);
}
```

#### 2.1.3 æ•°æ®æ¨¡å‹

**User (ç”¨æˆ·å®ä½“)**
```java
package com.tangxiaowen.user.entity;

@Data
@TableName("tbl_user")
public class User {
    @TableId(type = IdType.ASSIGN_UUID)
    private String userId;              // ç”¨æˆ·ID
    private String userType;            // ç”¨æˆ·ç±»å‹ï¼šguest/normal
    private String encryptedName;       // åŠ å¯†çš„å§“å
    private String gender;              // æ€§åˆ«
    private Integer age;                // å¹´é¾„
    private String encryptedPhone;      // åŠ å¯†çš„æ‰‹æœºå·
    private String encryptedIdCard;     // åŠ å¯†çš„èº«ä»½è¯å·
    private String avatar;              // å¤´åƒURL
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
    private LocalDateTime updatedAt;    // æ›´æ–°æ—¶é—´
    private Boolean isDeleted;          // é€»è¾‘åˆ é™¤æ ‡è®°
}
```

**MedicalHistory (ç—…ä¾‹å®ä½“)**
```java
package com.tangxiaowen.user.entity;

@Data
@TableName("tbl_medical_history")
public class MedicalHistory {
    @TableId(type = IdType.ASSIGN_UUID)
    private String historyId;           // ç—…ä¾‹ID
    private String userId;              // ç”¨æˆ·ID
    private LocalDate diagnosisDate;    // æ‚£ç—…æ—¶é—´
    private String diabetesType;        // ç³–å°¿ç—…ç±»å‹ï¼š1å‹/2å‹
    private Integer systolicPressure;   // æ”¶ç¼©å‹
    private Integer diastolicPressure;  // èˆ’å¼ å‹
    private String complications;       // å¹¶å‘ç—‡ï¼ˆJSONï¼‰
    private Boolean isOnMedication;     // æ˜¯å¦ç”¨è¯
    private String medicationDetails;   // ç”¨è¯è¯¦æƒ…ï¼ˆJSONï¼‰
    private Boolean isUsingInsulin;     // æ˜¯å¦ä½¿ç”¨èƒ°å²›ç´ 
    private String insulinDetails;      // èƒ°å²›ç´ è¯¦æƒ…ï¼ˆJSONï¼‰
    private String otherDiseases;       // å…¶ä»–ç–¾ç—…ï¼ˆJSONï¼‰
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
    private LocalDateTime updatedAt;    // æ›´æ–°æ—¶é—´
}
```

**PrivacyAgreement (éšç§åè®®åŒæ„è®°å½•)**
```java
package com.tangxiaowen.user.entity;

@Data
@TableName("tbl_privacy_agreement")
public class PrivacyAgreement {
    @TableId(type = IdType.ASSIGN_UUID)
    private String agreementId;         // è®°å½•ID
    private String userId;              // ç”¨æˆ·ID
    private String agreementVersion;    // åè®®ç‰ˆæœ¬
    private LocalDateTime agreedAt;     // åŒæ„æ—¶é—´
    private String ipAddress;           // åŒæ„æ—¶çš„IPåœ°å€
    private String deviceInfo;          // è®¾å¤‡ä¿¡æ¯
}
```

#### 2.1.4 è®¾è®¡ç†ç”±

1. **å…ç™»å½•æ¨¡å¼**: é‡‡ç”¨è®¿å®¢ä»¤ç‰Œæœºåˆ¶ï¼Œé™ä½ç”¨æˆ·ä½“éªŒé—¨æ§›ï¼Œé€‚åˆ showcase æ¼”ç¤ºåœºæ™¯ã€‚è®¿å®¢ç”¨æˆ·å¯ä»¥å¿«é€Ÿä½“éªŒæ ¸å¿ƒåŠŸèƒ½ï¼Œåç»­å¯è½¬ä¸ºæ­£å¼ç”¨æˆ·ã€‚

2. **æ•°æ®åŠ å¯†**: ç”¨æˆ·å§“åã€æ‰‹æœºå·ã€èº«ä»½è¯ç­‰æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ AES-256 åŠ å¯†å­˜å‚¨ï¼Œç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹è¦æ±‚ã€‚

3. **ç—…ä¾‹ä¿¡æ¯ç»“æ„åŒ–**: å°†ç—…ä¾‹ä¿¡æ¯ç‹¬ç«‹ä¸ºå•è¡¨ï¼Œæ”¯æŒå†å²è®°å½•è¿½æº¯ï¼Œä¾¿äºåŒ»ç”ŸæŸ¥çœ‹å®Œæ•´ç—…å²ã€‚

4. **éšç§åè®®ç‰ˆæœ¬åŒ–**: è®°å½•ç”¨æˆ·åŒæ„çš„å…·ä½“åè®®ç‰ˆæœ¬å’Œæ—¶é—´ï¼Œæ»¡è¶³åˆè§„è¦æ±‚ã€‚

---

### 2.2 æ•°å­—äººæ¨¡å— (Digital Human Module)

#### 2.2.1 åŠŸèƒ½æè¿°
é›†æˆé˜¿é‡Œç™¾ç‚¼ AI æœåŠ¡ï¼Œæä¾›å¾åŒ»ç”Ÿæ•°å­—äººå¯¹è¯èƒ½åŠ›ï¼Œå¼•å¯¼ç”¨æˆ·å½•å…¥ä¿¡æ¯ã€è®°å½•æ•°æ®ã€è¿›è¡Œé—®è¯Šã€‚

#### 2.2.2 ç±»è®¾è®¡

**DigitalHumanController.java**
```java
package com.tangxiaowen.digitalhuman.controller;

/**
 * æ•°å­—äººäº¤äº’æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/digital-human")
public class DigitalHumanController {
    
    /**
     * åˆå§‹åŒ–å¯¹è¯ä¼šè¯
     * åˆ›å»ºæ–°çš„å¯¹è¯ä¸Šä¸‹æ–‡
     */
    @PostMapping("/sessions")
    public ResponseEntity<SessionResponse> createSession(@RequestBody CreateSessionRequest request);
    
    /**
     * ğŸ”¥ æ ¸å¿ƒä¼˜åŒ–ï¼šæµå¼å‘é€æ¶ˆæ¯ç»™æ•°å­—äººï¼ˆSSEï¼‰
     * è§£å†³å¤§æ¨¡å‹æ¨ç† + TTS å»¶è¿Ÿé—®é¢˜ï¼Œæ”¯æŒæ‰“å­—æœºæ•ˆæœå’Œè¯­éŸ³æµå¼æ’­æ”¾
     * 
     * æµå¼è¾“å‡ºé¡ºåºï¼š
     * 1. event: thinking -> data: {"status": "thinking"}
     * 2. event: text_chunk -> data: {"text": "æ‚¨å¥½..."}ï¼ˆé€å­—æ¨é€ï¼‰
     * 3. event: audio_chunk -> data: {"audioUrl": "oss://xxx-1.mp3", "duration": 2.5}
     * 4. event: tool_call -> data: {"toolName": "save_blood_sugar", "params": {...}}
     * 5. event: tool_result -> data: {"result": "è®°å½•æˆåŠŸ"}
     * 6. event: done -> data: {"messageId": "msg-xxx"}
     * 
     * å…¼å®¹æ€§è¯´æ˜ï¼šå¾®ä¿¡å°ç¨‹åºåŸç”Ÿæ”¯æŒé€šè¿‡ wx.request çš„ enableChunked å‚æ•°æ¥æ”¶ SSE
     */
    @PostMapping(value = "/sessions/{sessionId}/messages/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter streamMessage(
        @PathVariable String sessionId,
        @RequestBody SendMessageRequest request
    );
    
    /**
     * é™çº§æ¥å£ï¼šåŒæ­¥å‘é€æ¶ˆæ¯ï¼ˆéæµå¼ï¼‰
     * ç”¨äºä¸æ”¯æŒ SSE çš„å®¢æˆ·ç«¯æˆ–ç®€å•åœºæ™¯
     */
    @PostMapping("/sessions/{sessionId}/messages")
    public ResponseEntity<MessageResponse> sendMessage(
        @PathVariable String sessionId,
        @RequestBody SendMessageRequest request
    );
    
    /**
     * è·å–å¯¹è¯å†å²
     */
    @GetMapping("/sessions/{sessionId}/messages")
    public ResponseEntity<List<MessageResponse>> getSessionMessages(
        @PathVariable String sessionId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );
    
    /**
     * è·å–æ•°å­—äººå¼•å¯¼æµç¨‹çŠ¶æ€
     * ä¾‹å¦‚ï¼šä¸ªäººä¿¡æ¯å½•å…¥è¿›åº¦ã€ç—…ä¾‹ä¿¡æ¯å½•å…¥è¿›åº¦
     */
    @GetMapping("/sessions/{sessionId}/guidance-status")
    public ResponseEntity<GuidanceStatusResponse> getGuidanceStatus(@PathVariable String sessionId);
    
    /**
     * ç»“æŸå¯¹è¯ä¼šè¯
     */
    @DeleteMapping("/sessions/{sessionId}")
    public ResponseEntity<Void> endSession(@PathVariable String sessionId);
}
```

**DigitalHumanService.java**
```java
package com.tangxiaowen.digitalhuman.service;

/**
 * æ•°å­—äººæœåŠ¡æ¥å£
 */
public interface DigitalHumanService {
    
    /**
     * åˆ›å»ºå¯¹è¯ä¼šè¯
     * @param userId ç”¨æˆ·ID
     * @param sceneType åœºæ™¯ç±»å‹ï¼šprofile_input/medical_input/glucose_record/diet_record/consultation
     * @return ä¼šè¯ä¿¡æ¯
     */
    SessionResponse createSession(String userId, String sceneType);
    
    /**
     * ğŸ”¥ æµå¼å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
     * @param sessionId ä¼šè¯ID
     * @param request æ¶ˆæ¯è¯·æ±‚
     * @param emitter SSE å‘å°„å™¨
     * 
     * å¤„ç†æµç¨‹ï¼š
     * 1. è·å–å¯¹è¯ä¸Šä¸‹æ–‡
     * 2. è°ƒç”¨ç™¾ç‚¼æµå¼ API
     * 3. æ£€æµ‹ Function Callï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨ AgentToolExecutor
     * 4. å°†æ–‡æœ¬é€å—æ¨é€ç»™å‰ç«¯
     * 5. è°ƒç”¨ TTS ç”ŸæˆéŸ³é¢‘ï¼ˆåˆ†æ®µç”Ÿæˆï¼Œè¾¹ç”Ÿæˆè¾¹æ¨é€ï¼‰
     * 6. ä¿å­˜å®Œæ•´æ¶ˆæ¯åˆ°æ•°æ®åº“
     * 7. å‘é€ [DONE] æ ‡è®°
     */
    void processMessageStream(String sessionId, SendMessageRequest request, SseEmitter emitter);
    
    /**
     * åŒæ­¥å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼ˆé™çº§æ–¹æ³•ï¼‰
     * @param sessionId ä¼šè¯ID
     * @param request æ¶ˆæ¯è¯·æ±‚
     * @return æ•°å­—äººå›å¤
     */
    MessageResponse processMessage(String sessionId, SendMessageRequest request);
    
    /**
     * è·å–ä¼šè¯æ¶ˆæ¯å†å²
     * @param sessionId ä¼šè¯ID
     * @param page é¡µç 
     * @param size æ¯é¡µå¤§å°
     * @return æ¶ˆæ¯åˆ—è¡¨
     */
    List<MessageResponse> getSessionMessages(String sessionId, int page, int size);
    
    /**
     * è·å–å¼•å¯¼çŠ¶æ€
     * @param sessionId ä¼šè¯ID
     * @return å¼•å¯¼è¿›åº¦çŠ¶æ€
     */
    GuidanceStatusResponse getGuidanceStatus(String sessionId);
    
    /**
     * ç»“æŸä¼šè¯
     * @param sessionId ä¼šè¯ID
     */
    void endSession(String sessionId);
}
```

**BailianAIClient.java**

```java
package com.tangxiaowen.digitalhuman.client;

/**
 * é˜¿é‡Œç™¾ç‚¼ AI å®¢æˆ·ç«¯
 * å°è£…å¯¹é˜¿é‡Œç™¾ç‚¼ API çš„è°ƒç”¨
 */
@Component
public class BailianAIClient {
    
    @Value("${bailianai.api.key}")
    private String apiKey;
    
    @Value("${bailianai.api.endpoint}")
    private String endpoint;
    
    /**
     * è°ƒç”¨ç™¾ç‚¼å¯¹è¯æ¥å£
     * @param prompt ç”¨æˆ·è¾“å…¥
     * @param context å¯¹è¯ä¸Šä¸‹æ–‡
     * @param knowledgeBase çŸ¥è¯†åº“ID
     * @return AI å›å¤
     */
    public BailianResponse chat(String prompt, List<Message> context, String knowledgeBase) {
        // æ„å»ºè¯·æ±‚
        // è°ƒç”¨ç™¾ç‚¼ API
        // è§£æå“åº”
        // è¿”å›ç»“æœ
    }
    
    /**
     * æå–ç»“æ„åŒ–ä¿¡æ¯
     * ä»å¯¹è¯ä¸­æå–ç”¨æˆ·ä¿¡æ¯ã€è¡€ç³–æ•°æ®ç­‰
     * @param conversation å¯¹è¯å†…å®¹
     * @param extractionType æå–ç±»å‹
     * @return ç»“æ„åŒ–æ•°æ®
     */
    public Map<String, Object> extractStructuredData(List<Message> conversation, String extractionType) {
        // ä½¿ç”¨ AI èƒ½åŠ›æå–ç»“æ„åŒ–ä¿¡æ¯
        // è¿”å› JSON æ ¼å¼æ•°æ®
    }
    
    /**
     * è¯­éŸ³è½¬æ–‡å­—
     * @param audioUrl éŸ³é¢‘æ–‡ä»¶URL
     * @return æ–‡å­—å†…å®¹
     */
    public String speechToText(String audioUrl) {
        // è°ƒç”¨è¯­éŸ³è¯†åˆ«æ¥å£
        // è¿”å›æ–‡å­—ç»“æœ
    }
    
    /**
     * æ–‡å­—è½¬è¯­éŸ³
     * @param text æ–‡å­—å†…å®¹
     * @param voiceId å£°éŸ³IDï¼ˆå¾åŒ»ç”Ÿå£°éŸ³ï¼‰
     * @return éŸ³é¢‘æ–‡ä»¶URL
     */
    public String textToSpeech(String text, String voiceId) {
        // è°ƒç”¨è¯­éŸ³åˆæˆæ¥å£
        // è¿”å›éŸ³é¢‘URL
    }
}
```

**AgentToolExecutor.java**
```java
package com.tangxiaowen.digitalhuman.agent;

/**
 * ğŸ”¥ Agent å·¥å…·æ‰§è¡Œå™¨ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
 * å¤„ç†é˜¿é‡Œç™¾ç‚¼ Agent çš„ Function Calling
 * 
 * å·¥ä½œåŸç†ï¼š
 * 1. ç™¾ç‚¼ Agent åœ¨é…ç½®æ—¶å®šä¹‰äº†è‹¥å¹²å·¥å…·ï¼ˆToolï¼‰ï¼Œå¦‚ save_blood_sugarã€save_diet ç­‰
 * 2. ç”¨æˆ·è¯´"æˆ‘åˆšæµ‹äº†è¡€ç³– 6.5"æ—¶ï¼ŒAgent ä¼šè¿”å› function_call æŒ‡ä»¤
 * 3. æœ¬ç±»è§£æ function_callï¼Œè·¯ç”±åˆ°å¯¹åº”çš„ä¸šåŠ¡æ–¹æ³•
 * 4. æ‰§è¡Œå®Œæ¯•åï¼Œå°†ç»“æœè¿”å›ç»™ Agentï¼ŒAgent ç”Ÿæˆæœ€ç»ˆå›å¤
 * 
 * è®¾è®¡æ¨¡å¼ï¼šç­–ç•¥æ¨¡å¼ + åå°„/æ³¨è§£è·¯ç”±
 */
@Service
@Slf4j
public class AgentToolExecutor {
    
    @Autowired
    private GlucoseService glucoseService;
    
    @Autowired
    private DietService dietService;
    
    @Autowired
    private ExerciseService exerciseService;
    
    @Autowired
    private UserService userService;
    
    /**
     * æ‰§è¡Œå·¥å…·è°ƒç”¨
     * @param toolName å·¥å…·åç§°ï¼ˆç™¾ç‚¼è¿”å›çš„ function nameï¼‰
     * @param params å‚æ•°ï¼ˆJSON æ ¼å¼ï¼‰
     * @param userId ç”¨æˆ·ID
     * @return æ‰§è¡Œç»“æœï¼ˆè¿”å›ç»™ Agentï¼‰
     */
    public ToolExecutionResult executeTool(String toolName, Map<String, Object> params, String userId) {
        // æ ¹æ® toolName è·¯ç”±åˆ°å…·ä½“æ–¹æ³•
        // è¿”å›æ‰§è¡Œç»“æœ
    }
    
    /**
     * å·¥å…·ï¼šä¿å­˜è¡€ç³–è®°å½•
     * å¯¹åº”ç™¾ç‚¼ Agent é…ç½®ä¸­çš„ save_blood_sugar å·¥å…·
     */
    @AgentTool(name = "save_blood_sugar", description = "ä¿å­˜ç”¨æˆ·çš„è¡€ç³–æµ‹é‡è®°å½•")
    public String saveBloodSugar(
        @Param("userId") String userId,
        @Param("value") Double glucoseValue,
        @Param("measurementType") String measurementType,
        @Param("measurementTime") String measurementTimeStr
    ) {
        try {
            // 1. è§£ææ—¶é—´
            LocalDateTime measurementTime = parseTimeExpression(measurementTimeStr); // æ”¯æŒ"åˆšæ‰"ã€"æ—©ä¸Š8ç‚¹"ç­‰è‡ªç„¶è¯­è¨€
            
            // 2. è°ƒç”¨ Service ä¿å­˜
            CreateGlucoseRecordRequest request = new CreateGlucoseRecordRequest();
            request.setUserId(userId);
            request.setGlucoseValue(new BigDecimal(glucoseValue));
            request.setMeasurementType(measurementType);
            request.setMeasurementTime(measurementTime);
            
            GlucoseRecordResponse response = glucoseService.createRecord(request);
            
            // 3. è¿”å›å‹å¥½çš„æ–‡æœ¬ç»“æœç»™ Agent
            return String.format("å·²æˆåŠŸè®°å½•è¡€ç³–å€¼ %.1f mmol/Lï¼ˆ%sï¼‰ã€‚", glucoseValue, getMeasurementTypeText(measurementType));
            
        } catch (Exception e) {
            log.error("ä¿å­˜è¡€ç³–è®°å½•å¤±è´¥", e);
            return "æŠ±æ­‰ï¼Œè®°å½•å¤±è´¥äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        }
    }
    
    /**
     * å·¥å…·ï¼šä¿å­˜é¥®é£Ÿè®°å½•
     * å¯¹åº”ç™¾ç‚¼ Agent é…ç½®ä¸­çš„ save_diet å·¥å…·
     */
    @AgentTool(name = "save_diet", description = "ä¿å­˜ç”¨æˆ·çš„é¥®é£Ÿè®°å½•")
    public String saveDiet(
        @Param("userId") String userId,
        @Param("mealType") String mealType,
        @Param("foodItems") List<Map<String, Object>> foodItems,
        @Param("mealTime") String mealTimeStr
    ) {
        try {
            // 1. è§£æé£Ÿç‰©æ¸…å•
            List<FoodItem> foods = parseFoodItems(foodItems);
            
            // 2. è®¡ç®—æ€»è¥å…»æˆåˆ†
            NutritionInfo totalNutrition = calculateTotalNutrition(foods);
            
            // 3. ä¿å­˜è®°å½•
            CreateDietRecordRequest request = new CreateDietRecordRequest();
            request.setUserId(userId);
            request.setMealType(mealType);
            request.setFoodItems(foods);
            request.setTotalCalories(totalNutrition.getCalories());
            request.setCarbohydrate(totalNutrition.getCarbohydrate());
            request.setProtein(totalNutrition.getProtein());
            request.setFat(totalNutrition.getFat());
            
            DietRecordResponse response = dietService.createRecord(request);
            
            // 4. è¿”å›ç»“æœç»™ Agent
            return String.format("å·²è®°å½•æ‚¨çš„%sï¼Œæ€»çƒ­é‡çº¦ %.0f åƒå¡ã€‚", getMealTypeText(mealType), totalNutrition.getCalories());
            
        } catch (Exception e) {
            log.error("ä¿å­˜é¥®é£Ÿè®°å½•å¤±è´¥", e);
            return "è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        }
    }
    
    /**
     * å·¥å…·ï¼šä¿å­˜è¿åŠ¨è®°å½•
     */
    @AgentTool(name = "save_exercise", description = "ä¿å­˜ç”¨æˆ·çš„è¿åŠ¨è®°å½•")
    public String saveExercise(
        @Param("userId") String userId,
        @Param("exerciseType") String exerciseType,
        @Param("duration") Integer duration,
        @Param("distance") Double distance
    ) {
        // å®ç°é€»è¾‘ç±»ä¼¼
    }
    
    /**
     * å·¥å…·ï¼šæ›´æ–°ç”¨æˆ·ä¸ªäººä¿¡æ¯
     */
    @AgentTool(name = "update_user_profile", description = "æ›´æ–°ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯")
    public String updateUserProfile(
        @Param("userId") String userId,
        @Param("name") String name,
        @Param("age") Integer age,
        @Param("gender") String gender
    ) {
        // å®ç°é€»è¾‘
    }
    
    /**
     * å·¥å…·ï¼šæ›´æ–°ç—…ä¾‹ä¿¡æ¯
     */
    @AgentTool(name = "update_medical_history", description = "æ›´æ–°ç”¨æˆ·çš„ç—…ä¾‹ä¿¡æ¯")
    public String updateMedicalHistory(
        @Param("userId") String userId,
        @Param("diagnosisDate") String diagnosisDate,
        @Param("diabetesType") String diabetesType,
        @Param("isOnMedication") Boolean isOnMedication
    ) {
        // å®ç°é€»è¾‘
    }
    
    /**
     * å·¥å…·ï¼šæŸ¥è¯¢ä»Šæ—¥è¡€ç³–æ•°æ®
     */
    @AgentTool(name = "query_today_glucose", description = "æŸ¥è¯¢ç”¨æˆ·ä»Šæ—¥çš„è¡€ç³–è®°å½•")
    public String queryTodayGlucose(@Param("userId") String userId) {
        // æŸ¥è¯¢å¹¶è¿”å›ç»“æ„åŒ–æ–‡æœ¬
    }
    
    /**
     * å·¥å…·ï¼šæŸ¥è¯¢ä»Šæ—¥é¥®é£Ÿæ‘„å…¥
     */
    @AgentTool(name = "query_today_diet", description = "æŸ¥è¯¢ç”¨æˆ·ä»Šæ—¥çš„é¥®é£Ÿæ‘„å…¥æƒ…å†µ")
    public String queryTodayDiet(@Param("userId") String userId) {
        // æŸ¥è¯¢å¹¶è¿”å›ç»“æ„åŒ–æ–‡æœ¬
    }
    
    // ========== ç§æœ‰è¾…åŠ©æ–¹æ³• ==========
    
    /**
     * è§£ææ—¶é—´è¡¨è¾¾å¼ï¼ˆè‡ªç„¶è¯­è¨€è½¬ LocalDateTimeï¼‰
     */
    private LocalDateTime parseTimeExpression(String timeStr) {
        // "åˆšæ‰" -> å½“å‰æ—¶é—´
        // "æ—©ä¸Š8ç‚¹" -> ä»Šå¤© 08:00
        // "æ˜¨å¤©æ™šä¸Š" -> æ˜¨å¤© 20:00
        // ä½¿ç”¨ NLP æˆ–è§„åˆ™å¼•æ“è§£æ
    }
    
    /**
     * è§£æé£Ÿç‰©æ¸…å•
     */
    private List<FoodItem> parseFoodItems(List<Map<String, Object>> rawItems) {
        // å°† Map è½¬ä¸º FoodItem å¯¹è±¡
    }
    
    /**
     * è®¡ç®—æ€»è¥å…»æˆåˆ†
     */
    private NutritionInfo calculateTotalNutrition(List<FoodItem> foods) {
        // ç´¯åŠ å„é£Ÿç‰©çš„è¥å…»æˆåˆ†
    }
}

/**
 * Agent å·¥å…·æ³¨è§£
 * ç”¨äºæ ‡è®°å¯è¢« Agent è°ƒç”¨çš„æ–¹æ³•
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AgentTool {
    String name();
    String description();
}

/**
 * å·¥å…·å‚æ•°æ³¨è§£
 */
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface Param {
    String value();
}

/**
 * å·¥å…·æ‰§è¡Œç»“æœ
 */
@Data
public class ToolExecutionResult {
    private boolean success;
    private String result;          // è¿”å›ç»™ Agent çš„æ–‡æœ¬
    private Map<String, Object> data; // ç»“æ„åŒ–æ•°æ®ï¼ˆå¯é€‰ï¼‰
}
```

**ConversationContextManager.java**
```java
package com.tangxiaowen.digitalhuman.service;

/**
 * å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨
 * ç®¡ç†å¯¹è¯å†å²å’Œåœºæ™¯çŠ¶æ€
 */
@Service
public class ConversationContextManager {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * ä¿å­˜å¯¹è¯ä¸Šä¸‹æ–‡
     * @param sessionId ä¼šè¯ID
     * @param context ä¸Šä¸‹æ–‡ä¿¡æ¯
     */
    public void saveContext(String sessionId, ConversationContext context);
    
    /**
     * è·å–å¯¹è¯ä¸Šä¸‹æ–‡
     * @param sessionId ä¼šè¯ID
     * @return ä¸Šä¸‹æ–‡ä¿¡æ¯
     */
    public ConversationContext getContext(String sessionId);
    
    /**
     * æ·»åŠ æ¶ˆæ¯åˆ°ä¸Šä¸‹æ–‡
     * @param sessionId ä¼šè¯ID
     * @param message æ¶ˆæ¯
     */
    public void appendMessage(String sessionId, Message message);
    
    /**
     * æ›´æ–°å¼•å¯¼çŠ¶æ€
     * @param sessionId ä¼šè¯ID
     * @param step å½“å‰æ­¥éª¤
     * @param data å·²æ”¶é›†çš„æ•°æ®
     */
    public void updateGuidanceState(String sessionId, String step, Map<String, Object> data);
    
    /**
     * æ¸…é™¤ä¼šè¯ä¸Šä¸‹æ–‡
     * @param sessionId ä¼šè¯ID
     */
    public void clearContext(String sessionId);
}
```

#### 2.2.3 æ•°æ®æ¨¡å‹

**Session (ä¼šè¯å®ä½“)**
```java
package com.tangxiaowen.digitalhuman.entity;

@Data
@TableName("tbl_conversation_session")
public class Session {
    @TableId(type = IdType.ASSIGN_UUID)
    private String sessionId;           // ä¼šè¯ID
    private String userId;              // ç”¨æˆ·ID
    private String sceneType;           // åœºæ™¯ç±»å‹
    private String status;              // çŠ¶æ€ï¼šactive/completed/expired
    private LocalDateTime startTime;    // å¼€å§‹æ—¶é—´
    private LocalDateTime endTime;      // ç»“æŸæ—¶é—´
    private Integer messageCount;       // æ¶ˆæ¯æ•°é‡
}
```

**Message (æ¶ˆæ¯å®ä½“)**
```java
package com.tangxiaowen.digitalhuman.entity;

@Data
@TableName("tbl_conversation_message")
public class Message {
    @TableId(type = IdType.ASSIGN_UUID)
    private String messageId;           // æ¶ˆæ¯ID
    private String sessionId;           // ä¼šè¯ID
    private String role;                // è§’è‰²ï¼šuser/assistant
    private String contentType;         // å†…å®¹ç±»å‹ï¼štext/audio/image
    private String content;             // æ¶ˆæ¯å†…å®¹
    private String audioUrl;            // éŸ³é¢‘URLï¼ˆå¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼‰
    private Map<String, Object> metadata; // å…ƒæ•°æ®ï¼ˆJSONï¼‰
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

**GuidanceProgress (å¼•å¯¼è¿›åº¦å®ä½“)**
```java
package com.tangxiaowen.digitalhuman.entity;

@Data
@TableName("tbl_guidance_progress")
public class GuidanceProgress {
    @TableId(type = IdType.ASSIGN_UUID)
    private String progressId;          // è¿›åº¦ID
    private String sessionId;           // ä¼šè¯ID
    private String userId;              // ç”¨æˆ·ID
    private String sceneType;           // åœºæ™¯ç±»å‹
    private String currentStep;         // å½“å‰æ­¥éª¤
    private Map<String, Object> collectedData; // å·²æ”¶é›†æ•°æ®ï¼ˆJSONï¼‰
    private Integer completionRate;     // å®Œæˆç™¾åˆ†æ¯”
    private LocalDateTime updatedAt;    // æ›´æ–°æ—¶é—´
}
```

#### 2.2.4 è®¾è®¡ç†ç”±

1. **ä¼šè¯ç®¡ç†**: æ¯æ¬¡å¯¹è¯åˆ›å»ºç‹¬ç«‹ä¼šè¯ï¼Œæ”¯æŒå¤šåœºæ™¯å¹¶è¡Œï¼Œé¿å…ä¸Šä¸‹æ–‡æ··æ·†ã€‚

2. **ä¸Šä¸‹æ–‡ç¼“å­˜**: ä½¿ç”¨ Redis ç¼“å­˜å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæå‡å“åº”é€Ÿåº¦ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯ã€‚

3. **åœºæ™¯åŒºåˆ†**: ä¸åŒåœºæ™¯ï¼ˆå½•å…¥ä¿¡æ¯ã€è®°å½•æ•°æ®ã€é—®è¯Šï¼‰ä½¿ç”¨ä¸åŒçš„æç¤ºè¯å’ŒçŸ¥è¯†åº“ï¼Œæé«˜ AI å“åº”å‡†ç¡®æ€§ã€‚

4. **ç»“æ„åŒ–æå–**: AI å¯¹è¯åè‡ªåŠ¨æå–ç»“æ„åŒ–ä¿¡æ¯ï¼Œå‡å°‘ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥å·¥ä½œé‡ã€‚

---

### 2.3 è¡€ç³–ç®¡ç†æ¨¡å— (Glucose Management Module)

#### 2.3.1 åŠŸèƒ½æè¿°
è®°å½•å’Œå±•ç¤ºç”¨æˆ·è¡€ç³–æ•°æ®ï¼Œæ”¯æŒæ‰‹åŠ¨å½•å…¥å’Œæ•°å­—äººå¼•å¯¼å½•å…¥ã€‚

#### 2.3.2 ç±»è®¾è®¡

**GlucoseController.java**
```java
package com.tangxiaowen.glucose.controller;

/**
 * è¡€ç³–ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/glucose")
public class GlucoseController {
    
    /**
     * åˆ›å»ºè¡€ç³–è®°å½•
     * æ”¯æŒæ‰‹åŠ¨å½•å…¥å’Œæ•°å­—äººå¼•å¯¼å½•å…¥
     */
    @PostMapping("/records")
    public ResponseEntity<GlucoseRecordResponse> createRecord(@RequestBody CreateGlucoseRecordRequest request);
    
    /**
     * æ‰¹é‡åˆ›å»ºè¡€ç³–è®°å½•
     * æ”¯æŒä»è®¾å¤‡å¯¼å…¥
     */
    @PostMapping("/records/batch")
    public ResponseEntity<BatchCreateResponse> batchCreateRecords(@RequestBody List<CreateGlucoseRecordRequest> requests);
    
    /**
     * è·å–ç”¨æˆ·è¡€ç³–è®°å½•åˆ—è¡¨
     */
    @GetMapping("/records")
    public ResponseEntity<PageResponse<GlucoseRecordResponse>> getRecords(
        @RequestParam String userId,
        @RequestParam(required = false) LocalDate startDate,
        @RequestParam(required = false) LocalDate endDate,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );
    
    /**
     * è·å–æœ€æ–°è¡€ç³–è®°å½•
     */
    @GetMapping("/records/latest")
    public ResponseEntity<GlucoseRecordResponse> getLatestRecord(@RequestParam String userId);
    
    /**
     * è·å–è¡€ç³–ç»Ÿè®¡ä¿¡æ¯
     * åŒ…æ‹¬å¹³å‡å€¼ã€æœ€é«˜å€¼ã€æœ€ä½å€¼ç­‰
     */
    @GetMapping("/statistics")
    public ResponseEntity<GlucoseStatisticsResponse> getStatistics(
        @RequestParam String userId,
        @RequestParam(required = false) LocalDate startDate,
        @RequestParam(required = false) LocalDate endDate
    );
    
    /**
     * åˆ é™¤è¡€ç³–è®°å½•
     */
    @DeleteMapping("/records/{recordId}")
    public ResponseEntity<Void> deleteRecord(@PathVariable String recordId);
}
```

**GlucoseService.java**
```java
package com.tangxiaowen.glucose.service;

/**
 * è¡€ç³–æœåŠ¡æ¥å£
 */
public interface GlucoseService {
    
    /**
     * åˆ›å»ºè¡€ç³–è®°å½•
     * @param request è¡€ç³–è®°å½•è¯·æ±‚
     * @return åˆ›å»ºçš„è®°å½•
     */
    GlucoseRecordResponse createRecord(CreateGlucoseRecordRequest request);
    
    /**
     * æ‰¹é‡åˆ›å»ºè¡€ç³–è®°å½•
     * @param requests æ‰¹é‡è¯·æ±‚
     * @return åˆ›å»ºç»“æœ
     */
    BatchCreateResponse batchCreateRecords(List<CreateGlucoseRecordRequest> requests);
    
    /**
     * è·å–è¡€ç³–è®°å½•åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @param startDate å¼€å§‹æ—¥æœŸ
     * @param endDate ç»“æŸæ—¥æœŸ
     * @param page é¡µç 
     * @param size æ¯é¡µå¤§å°
     * @return è®°å½•åˆ—è¡¨
     */
    PageResponse<GlucoseRecordResponse> getRecords(String userId, LocalDate startDate, LocalDate endDate, int page, int size);
    
    /**
     * è·å–æœ€æ–°è¡€ç³–å€¼
     * @param userId ç”¨æˆ·ID
     * @return æœ€æ–°è®°å½•
     */
    GlucoseRecordResponse getLatestRecord(String userId);
    
    /**
     * è®¡ç®—è¡€ç³–ç»Ÿè®¡ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @param startDate å¼€å§‹æ—¥æœŸ
     * @param endDate ç»“æŸæ—¥æœŸ
     * @return ç»Ÿè®¡ä¿¡æ¯
     */
    GlucoseStatisticsResponse calculateStatistics(String userId, LocalDate startDate, LocalDate endDate);
    
    /**
     * åˆ é™¤è¡€ç³–è®°å½•
     * @param recordId è®°å½•ID
     */
    void deleteRecord(String recordId);
}
```

#### 2.3.3 æ•°æ®æ¨¡å‹

**GlucoseRecord (è¡€ç³–è®°å½•å®ä½“)**
```java
package com.tangxiaowen.glucose.entity;

@Data
@TableName("tbl_glucose_record")
public class GlucoseRecord {
    @TableId(type = IdType.ASSIGN_UUID)
    private String recordId;            // è®°å½•ID
    private String userId;              // ç”¨æˆ·ID
    private BigDecimal glucoseValue;    // è¡€ç³–å€¼ (mmol/L)
    private String measurementType;     // æµ‹é‡ç±»å‹ï¼šfasting/before_meal/after_meal/before_sleep/random
    private LocalDateTime measurementTime; // æµ‹é‡æ—¶é—´
    private String deviceInfo;          // è®¾å¤‡ä¿¡æ¯
    private String notes;               // å¤‡æ³¨
    private String sessionId;           // å¯¹è¯ä¼šè¯IDï¼ˆæ•°å­—äººå½•å…¥æ—¶å…³è”ï¼‰
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

#### 2.3.4 è®¾è®¡ç†ç”±

1. **æµ‹é‡ç±»å‹åŒºåˆ†**: åŒºåˆ†ç©ºè…¹ã€é¤å‰ã€é¤åç­‰ä¸åŒåœºæ™¯çš„è¡€ç³–å€¼ï¼Œä¾¿äºåŒ»ç”Ÿåˆ†æè¡€ç³–æ³¢åŠ¨è§„å¾‹ã€‚

2. **è®¾å¤‡ä¿¡æ¯è®°å½•**: è®°å½•æµ‹é‡è®¾å¤‡ä¿¡æ¯ï¼Œæ”¯æŒæœªæ¥å¤šè®¾å¤‡æ¥å…¥åœºæ™¯ã€‚

3. **ç»Ÿè®¡è®¡ç®—**: æä¾›ç»Ÿè®¡æ¥å£ï¼Œè®¡ç®—å¹³å‡å€¼ã€æ ‡å‡†å·®ç­‰æŒ‡æ ‡ï¼Œè¾…åŠ©è¡€ç³–ç®¡ç†ã€‚

---

### 2.4 é¥®é£Ÿç®¡ç†æ¨¡å— (Diet Management Module)

#### 2.4.1 åŠŸèƒ½æè¿°
è®°å½•ç”¨æˆ·é¥®é£Ÿä¿¡æ¯ï¼Œæ”¯æŒæ‹ç…§è¯†åˆ«å’Œæ•°å­—äººå¼•å¯¼å½•å…¥ï¼Œè®¡ç®—ä»Šæ—¥æ‘„å…¥é‡ã€‚

#### 2.4.2 ç±»è®¾è®¡

**DietController.java**
```java
package com.tangxiaowen.diet.controller;

/**
 * é¥®é£Ÿç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/diet")
public class DietController {
    
    /**
     * åˆ›å»ºé¥®é£Ÿè®°å½•ï¼ˆæ–‡å­—æè¿°ï¼‰
     */
    @PostMapping("/records")
    public ResponseEntity<DietRecordResponse> createRecord(@RequestBody CreateDietRecordRequest request);
    
    /**
     * æ‹ç…§è¯†åˆ«é¥®é£Ÿ
     * ä¸Šä¼ å›¾ç‰‡ï¼ŒAI è¯†åˆ«é£Ÿç‰©å¹¶åˆ›å»ºè®°å½•
     */
    @PostMapping("/records/photo")
    public ResponseEntity<DietRecordResponse> createRecordByPhoto(@RequestParam MultipartFile photo, @RequestParam String userId);
    
    /**
     * è·å–é¥®é£Ÿè®°å½•åˆ—è¡¨
     */
    @GetMapping("/records")
    public ResponseEntity<PageResponse<DietRecordResponse>> getRecords(
        @RequestParam String userId,
        @RequestParam(required = false) LocalDate startDate,
        @RequestParam(required = false) LocalDate endDate,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );
    
    /**
     * è·å–ä»Šæ—¥é¥®é£Ÿæ‘„å…¥ç»Ÿè®¡
     * åŒ…æ‹¬æ€»çƒ­é‡ã€ç¢³æ°´ã€è›‹ç™½è´¨ã€è„‚è‚ªç­‰
     */
    @GetMapping("/today-intake")
    public ResponseEntity<DailyIntakeResponse> getTodayIntake(@RequestParam String userId);
    
    /**
     * æ›´æ–°é¥®é£Ÿè®°å½•
     */
    @PutMapping("/records/{recordId}")
    public ResponseEntity<DietRecordResponse> updateRecord(
        @PathVariable String recordId,
        @RequestBody UpdateDietRecordRequest request
    );
    
    /**
     * åˆ é™¤é¥®é£Ÿè®°å½•
     */
    @DeleteMapping("/records/{recordId}")
    public ResponseEntity<Void> deleteRecord(@PathVariable String recordId);
}
```

**DietService.java**
```java
package com.tangxiaowen.diet.service;

/**
 * é¥®é£ŸæœåŠ¡æ¥å£
 */
public interface DietService {
    
    /**
     * åˆ›å»ºé¥®é£Ÿè®°å½•
     * @param request é¥®é£Ÿè®°å½•è¯·æ±‚
     * @return åˆ›å»ºçš„è®°å½•
     */
    DietRecordResponse createRecord(CreateDietRecordRequest request);
    
    /**
     * é€šè¿‡ç…§ç‰‡åˆ›å»ºé¥®é£Ÿè®°å½•
     * @param photo é£Ÿç‰©ç…§ç‰‡
     * @param userId ç”¨æˆ·ID
     * @return è¯†åˆ«å¹¶åˆ›å»ºçš„è®°å½•
     */
    DietRecordResponse createRecordByPhoto(MultipartFile photo, String userId);
    
    /**
     * è·å–é¥®é£Ÿè®°å½•åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @param startDate å¼€å§‹æ—¥æœŸ
     * @param endDate ç»“æŸæ—¥æœŸ
     * @param page é¡µç 
     * @param size æ¯é¡µå¤§å°
     * @return è®°å½•åˆ—è¡¨
     */
    PageResponse<DietRecordResponse> getRecords(String userId, LocalDate startDate, LocalDate endDate, int page, int size);
    
    /**
     * è®¡ç®—ä»Šæ—¥æ‘„å…¥é‡
     * @param userId ç”¨æˆ·ID
     * @return ä»Šæ—¥è¥å…»æ‘„å…¥ç»Ÿè®¡
     */
    DailyIntakeResponse calculateTodayIntake(String userId);
    
    /**
     * æ›´æ–°é¥®é£Ÿè®°å½•
     * @param recordId è®°å½•ID
     * @param request æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„è®°å½•
     */
    DietRecordResponse updateRecord(String recordId, UpdateDietRecordRequest request);
    
    /**
     * åˆ é™¤é¥®é£Ÿè®°å½•
     * @param recordId è®°å½•ID
     */
    void deleteRecord(String recordId);
}
```

**FoodRecognitionService.java**
```java
package com.tangxiaowen.diet.service;

/**
 * é£Ÿç‰©è¯†åˆ«æœåŠ¡
 * ä½¿ç”¨é˜¿é‡Œç™¾ç‚¼è§†è§‰èƒ½åŠ›è¯†åˆ«é£Ÿç‰©
 */
@Service
public class FoodRecognitionService {
    
    @Autowired
    private BailianAIClient bailianAIClient;
    
    @Autowired
    private OssService ossService;
    
    /**
     * è¯†åˆ«é£Ÿç‰©å›¾ç‰‡
     * @param imageFile å›¾ç‰‡æ–‡ä»¶
     * @return è¯†åˆ«ç»“æœï¼ŒåŒ…æ‹¬é£Ÿç‰©åç§°ã€ä¼°ç®—é‡é‡ã€è¥å…»æˆåˆ†
     */
    public FoodRecognitionResult recognizeFood(MultipartFile imageFile) {
        // ä¸Šä¼ å›¾ç‰‡åˆ° OSS
        // è°ƒç”¨ç™¾ç‚¼è§†è§‰è¯†åˆ«æ¥å£
        // è°ƒç”¨è¥å…»æˆåˆ†æŸ¥è¯¢æ¥å£
        // è¿”å›è¯†åˆ«ç»“æœ
    }
    
    /**
     * æŸ¥è¯¢é£Ÿç‰©è¥å…»æˆåˆ†
     * @param foodName é£Ÿç‰©åç§°
     * @param weight é‡é‡ï¼ˆå…‹ï¼‰
     * @return è¥å…»æˆåˆ†ä¿¡æ¯
     */
    public NutritionInfo queryNutrition(String foodName, BigDecimal weight) {
        // ä»è¥å…»æˆåˆ†æ•°æ®åº“æŸ¥è¯¢
        // æ ¹æ®é‡é‡è®¡ç®—å®é™…è¥å…»å€¼
        // è¿”å›è¥å…»ä¿¡æ¯
    }
}
```

#### 2.4.3 æ•°æ®æ¨¡å‹

**DietRecord (é¥®é£Ÿè®°å½•å®ä½“)**
```java
package com.tangxiaowen.diet.entity;

@Data
@TableName("tbl_diet_record")
public class DietRecord {
    @TableId(type = IdType.ASSIGN_UUID)
    private String recordId;            // è®°å½•ID
    private String userId;              // ç”¨æˆ·ID
    private String mealType;            // é¤æ¬¡ï¼šbreakfast/lunch/dinner/snack
    private LocalDateTime mealTime;     // ç”¨é¤æ—¶é—´
    private String foodItems;           // é£Ÿç‰©æ¸…å•ï¼ˆJSONï¼‰
    private String photoUrl;            // ç…§ç‰‡URL
    private BigDecimal totalCalories;   // æ€»çƒ­é‡ï¼ˆåƒå¡ï¼‰
    private BigDecimal carbohydrate;    // ç¢³æ°´åŒ–åˆç‰©ï¼ˆå…‹ï¼‰
    private BigDecimal protein;         // è›‹ç™½è´¨ï¼ˆå…‹ï¼‰
    private BigDecimal fat;             // è„‚è‚ªï¼ˆå…‹ï¼‰
    private BigDecimal fiber;           // è†³é£Ÿçº¤ç»´ï¼ˆå…‹ï¼‰
    private String notes;               // å¤‡æ³¨
    private String sessionId;           // å¯¹è¯ä¼šè¯IDï¼ˆæ•°å­—äººå½•å…¥æ—¶å…³è”ï¼‰
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

**FoodItem (é£Ÿç‰©æ¡ç›®)**
```java
package com.tangxiaowen.diet.entity;

@Data
public class FoodItem {
    private String foodName;            // é£Ÿç‰©åç§°
    private BigDecimal weight;          // é‡é‡ï¼ˆå…‹ï¼‰
    private BigDecimal calories;        // çƒ­é‡ï¼ˆåƒå¡ï¼‰
    private BigDecimal carbohydrate;    // ç¢³æ°´åŒ–åˆç‰©ï¼ˆå…‹ï¼‰
    private BigDecimal protein;         // è›‹ç™½è´¨ï¼ˆå…‹ï¼‰
    private BigDecimal fat;             // è„‚è‚ªï¼ˆå…‹ï¼‰
    private BigDecimal fiber;           // è†³é£Ÿçº¤ç»´ï¼ˆå…‹ï¼‰
}
```

**NutritionDatabase (è¥å…»æˆåˆ†æ•°æ®åº“)**
```java
package com.tangxiaowen.diet.entity;

@Data
@TableName("tbl_nutrition_database")
public class NutritionDatabase {
    @TableId(type = IdType.ASSIGN_UUID)
    private String nutritionId;         // ID
    private String foodName;            // é£Ÿç‰©åç§°
    private String category;            // åˆ†ç±»
    private BigDecimal caloriesPer100g; // æ¯100å…‹çƒ­é‡
    private BigDecimal carbohydratePer100g; // æ¯100å…‹ç¢³æ°´
    private BigDecimal proteinPer100g;  // æ¯100å…‹è›‹ç™½è´¨
    private BigDecimal fatPer100g;      // æ¯100å…‹è„‚è‚ª
    private BigDecimal fiberPer100g;    // æ¯100å…‹è†³é£Ÿçº¤ç»´
    private String source;              // æ•°æ®æ¥æº
    private LocalDateTime updatedAt;    // æ›´æ–°æ—¶é—´
}
```

#### 2.4.4 è®¾è®¡ç†ç”±

1. **æ‹ç…§è¯†åˆ«**: é›†æˆé˜¿é‡Œç™¾ç‚¼è§†è§‰èƒ½åŠ›ï¼Œé™ä½ç”¨æˆ·è®°å½•é—¨æ§›ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

2. **è¥å…»æˆåˆ†æ•°æ®åº“**: é¢„ç½®å¸¸è§é£Ÿç‰©è¥å…»æˆåˆ†æ•°æ®ï¼Œå¿«é€Ÿè®¡ç®—æ‘„å…¥é‡ï¼Œæ”¯æŒç¦»çº¿æŸ¥è¯¢ã€‚

3. **é¤æ¬¡åŒºåˆ†**: åŒºåˆ†æ—©ä¸­æ™šé¤å’ŒåŠ é¤ï¼Œä¾¿äºåˆ†æç”¨é¤è§„å¾‹å’Œè¡€ç³–å½±å“ã€‚

---

### 2.5 è¿åŠ¨æ¶ˆè€—æ¨¡å— (Exercise Module)

#### 2.5.1 åŠŸèƒ½æè¿°
è®°å½•ç”¨æˆ·è¿åŠ¨ä¿¡æ¯ï¼Œè®¡ç®—ä»Šæ—¥æ¶ˆè€—é‡ã€‚

#### 2.5.2 ç±»è®¾è®¡

**ExerciseController.java**
```java
package com.tangxiaowen.exercise.controller;

/**
 * è¿åŠ¨ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/exercise")
public class ExerciseController {
    
    /**
     * åˆ›å»ºè¿åŠ¨è®°å½•
     */
    @PostMapping("/records")
    public ResponseEntity<ExerciseRecordResponse> createRecord(@RequestBody CreateExerciseRecordRequest request);
    
    /**
     * è·å–è¿åŠ¨è®°å½•åˆ—è¡¨
     */
    @GetMapping("/records")
    public ResponseEntity<PageResponse<ExerciseRecordResponse>> getRecords(
        @RequestParam String userId,
        @RequestParam(required = false) LocalDate startDate,
        @RequestParam(required = false) LocalDate endDate,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );
    
    /**
     * è·å–ä»Šæ—¥è¿åŠ¨æ¶ˆè€—ç»Ÿè®¡
     */
    @GetMapping("/today-expenditure")
    public ResponseEntity<DailyExpenditureResponse> getTodayExpenditure(@RequestParam String userId);
    
    /**
     * åˆ é™¤è¿åŠ¨è®°å½•
     */
    @DeleteMapping("/records/{recordId}")
    public ResponseEntity<Void> deleteRecord(@PathVariable String recordId);
}
```

**ExerciseService.java**
```java
package com.tangxiaowen.exercise.service;

/**
 * è¿åŠ¨æœåŠ¡æ¥å£
 */
public interface ExerciseService {
    
    /**
     * åˆ›å»ºè¿åŠ¨è®°å½•
     * @param request è¿åŠ¨è®°å½•è¯·æ±‚
     * @return åˆ›å»ºçš„è®°å½•
     */
    ExerciseRecordResponse createRecord(CreateExerciseRecordRequest request);
    
    /**
     * è·å–è¿åŠ¨è®°å½•åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @param startDate å¼€å§‹æ—¥æœŸ
     * @param endDate ç»“æŸæ—¥æœŸ
     * @param page é¡µç 
     * @param size æ¯é¡µå¤§å°
     * @return è®°å½•åˆ—è¡¨
     */
    PageResponse<ExerciseRecordResponse> getRecords(String userId, LocalDate startDate, LocalDate endDate, int page, int size);
    
    /**
     * è®¡ç®—ä»Šæ—¥æ¶ˆè€—é‡
     * @param userId ç”¨æˆ·ID
     * @return ä»Šæ—¥è¿åŠ¨æ¶ˆè€—ç»Ÿè®¡
     */
    DailyExpenditureResponse calculateTodayExpenditure(String userId);
    
    /**
     * åˆ é™¤è¿åŠ¨è®°å½•
     * @param recordId è®°å½•ID
     */
    void deleteRecord(String recordId);
}
```

#### 2.5.3 æ•°æ®æ¨¡å‹

**ExerciseRecord (è¿åŠ¨è®°å½•å®ä½“)**
```java
package com.tangxiaowen.exercise.entity;

@Data
@TableName("tbl_exercise_record")
public class ExerciseRecord {
    @TableId(type = IdType.ASSIGN_UUID)
    private String recordId;            // è®°å½•ID
    private String userId;              // ç”¨æˆ·ID
    private String exerciseType;        // è¿åŠ¨ç±»å‹ï¼šwalking/running/cycling/swimming/yogaç­‰
    private Integer duration;           // æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    private BigDecimal distance;        // è·ç¦»ï¼ˆå…¬é‡Œï¼‰
    private BigDecimal caloriesBurned;  // æ¶ˆè€—çƒ­é‡ï¼ˆåƒå¡ï¼‰
    private LocalDateTime startTime;    // å¼€å§‹æ—¶é—´
    private LocalDateTime endTime;      // ç»“æŸæ—¶é—´
    private String notes;               // å¤‡æ³¨
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

#### 2.5.4 è®¾è®¡ç†ç”±

1. **è¿åŠ¨ç±»å‹ä¸°å¯Œ**: æ”¯æŒå¤šç§è¿åŠ¨ç±»å‹ï¼Œæ»¡è¶³ä¸åŒç”¨æˆ·è¿åŠ¨ä¹ æƒ¯ã€‚

2. **çƒ­é‡è®¡ç®—**: æ ¹æ®è¿åŠ¨ç±»å‹ã€æ—¶é•¿ã€ç”¨æˆ·ä½“é‡ç­‰å‚æ•°è®¡ç®—æ¶ˆè€—çƒ­é‡ï¼Œæä¾›ç§‘å­¦ä¾æ®ã€‚

---

### 2.6 é—®è¯Šæ¨¡å— (Consultation Module)

#### 2.6.1 åŠŸèƒ½æè¿°
æä¾›æ•°å­—äººå¿«é€Ÿé—®è¯Šå’Œå›¾æ–‡é—®è¯ŠæœåŠ¡ã€‚

#### 2.6.2 ç±»è®¾è®¡

**ConsultationController.java**
```java
package com.tangxiaowen.consultation.controller;

/**
 * é—®è¯Šæ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/consultations")
public class ConsultationController {
    
    /**
     * åˆ›å»ºé—®è¯Šè¯·æ±‚
     */
    @PostMapping
    public ResponseEntity<ConsultationResponse> createConsultation(@RequestBody CreateConsultationRequest request);
    
    /**
     * å‘é€é—®è¯Šæ¶ˆæ¯
     * æ”¯æŒæ–‡å­—ã€å›¾ç‰‡ã€è¯­éŸ³
     */
    @PostMapping("/{consultationId}/messages")
    public ResponseEntity<ConsultationMessageResponse> sendMessage(
        @PathVariable String consultationId,
        @RequestBody SendConsultationMessageRequest request
    );
    
    /**
     * è·å–é—®è¯Šæ¶ˆæ¯åˆ—è¡¨
     */
    @GetMapping("/{consultationId}/messages")
    public ResponseEntity<List<ConsultationMessageResponse>> getMessages(@PathVariable String consultationId);
    
    /**
     * è·å–ç”¨æˆ·é—®è¯Šå†å²
     */
    @GetMapping
    public ResponseEntity<PageResponse<ConsultationResponse>> getConsultations(
        @RequestParam String userId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    );
    
    /**
     * ç»“æŸé—®è¯Š
     */
    @PostMapping("/{consultationId}/complete")
    public ResponseEntity<Void> completeConsultation(@PathVariable String consultationId);
    
    /**
     * å¯¹é—®è¯Šè¿›è¡Œè¯„ä»·
     */
    @PostMapping("/{consultationId}/rating")
    public ResponseEntity<Void> rateConsultation(
        @PathVariable String consultationId,
        @RequestBody RateConsultationRequest request
    );
}
```

**ConsultationService.java**
```java
package com.tangxiaowen.consultation.service;

/**
 * é—®è¯ŠæœåŠ¡æ¥å£
 */
public interface ConsultationService {
    
    /**
     * åˆ›å»ºé—®è¯Š
     * @param request é—®è¯Šè¯·æ±‚
     * @return é—®è¯Šä¿¡æ¯
     */
    ConsultationResponse createConsultation(CreateConsultationRequest request);
    
    /**
     * å¤„ç†é—®è¯Šæ¶ˆæ¯
     * @param consultationId é—®è¯ŠID
     * @param request æ¶ˆæ¯è¯·æ±‚
     * @return å›å¤æ¶ˆæ¯
     */
    ConsultationMessageResponse processMessage(String consultationId, SendConsultationMessageRequest request);
    
    /**
     * è·å–é—®è¯Šæ¶ˆæ¯åˆ—è¡¨
     * @param consultationId é—®è¯ŠID
     * @return æ¶ˆæ¯åˆ—è¡¨
     */
    List<ConsultationMessageResponse> getMessages(String consultationId);
    
    /**
     * è·å–ç”¨æˆ·é—®è¯Šå†å²
     * @param userId ç”¨æˆ·ID
     * @param page é¡µç 
     * @param size æ¯é¡µå¤§å°
     * @return é—®è¯Šåˆ—è¡¨
     */
    PageResponse<ConsultationResponse> getUserConsultations(String userId, int page, int size);
    
    /**
     * å®Œæˆé—®è¯Š
     * @param consultationId é—®è¯ŠID
     */
    void completeConsultation(String consultationId);
    
    /**
     * é—®è¯Šè¯„ä»·
     * @param consultationId é—®è¯ŠID
     * @param rating è¯„åˆ†
     * @param comment è¯„ä»·å†…å®¹
     */
    void rateConsultation(String consultationId, Integer rating, String comment);
}
```

#### 2.6.3 æ•°æ®æ¨¡å‹

**Consultation (é—®è¯Šå®ä½“)**
```java
package com.tangxiaowen.consultation.entity;

@Data
@TableName("tbl_consultation")
public class Consultation {
    @TableId(type = IdType.ASSIGN_UUID)
    private String consultationId;      // é—®è¯ŠID
    private String userId;              // ç”¨æˆ·ID
    private String consultationType;    // é—®è¯Šç±»å‹ï¼šdigital_human/text_image
    private String status;              // çŠ¶æ€ï¼šongoing/completed/cancelled
    private String chiefComplaint;      // ä¸»è¯‰
    private LocalDateTime startTime;    // å¼€å§‹æ—¶é—´
    private LocalDateTime endTime;      // ç»“æŸæ—¶é—´
    private Integer messageCount;       // æ¶ˆæ¯æ•°é‡
    private Integer rating;             // è¯„åˆ†ï¼ˆ1-5ï¼‰
    private String comment;             // è¯„ä»·å†…å®¹
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

**ConsultationMessage (é—®è¯Šæ¶ˆæ¯å®ä½“)**
```java
package com.tangxiaowen.consultation.entity;

@Data
@TableName("tbl_consultation_message")
public class ConsultationMessage {
    @TableId(type = IdType.ASSIGN_UUID)
    private String messageId;           // æ¶ˆæ¯ID
    private String consultationId;      // é—®è¯ŠID
    private String senderId;            // å‘é€è€…ID
    private String senderType;          // å‘é€è€…ç±»å‹ï¼šuser/doctor/digital_human
    private String messageType;         // æ¶ˆæ¯ç±»å‹ï¼štext/image/audio
    private String content;             // æ¶ˆæ¯å†…å®¹
    private String attachmentUrl;       // é™„ä»¶URLï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ç­‰ï¼‰
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

#### 2.6.4 è®¾è®¡ç†ç”±

1. **é—®è¯Šç±»å‹åŒºåˆ†**: åŒºåˆ†æ•°å­—äººé—®è¯Šå’ŒçœŸäººåŒ»ç”Ÿé—®è¯Šï¼Œæ”¯æŒä¸åŒçš„ä¸šåŠ¡æµç¨‹ã€‚

2. **æ¶ˆæ¯å¤šåª’ä½“**: æ”¯æŒæ–‡å­—ã€å›¾ç‰‡ã€è¯­éŸ³å¤šç§æ¶ˆæ¯ç±»å‹ï¼Œæ»¡è¶³é—®è¯Šåœºæ™¯éœ€æ±‚ã€‚

3. **è¯„ä»·æœºåˆ¶**: æ”¶é›†ç”¨æˆ·è¯„ä»·ï¼Œç”¨äºä¼˜åŒ–æ•°å­—äººå›ç­”è´¨é‡å’ŒåŒ»ç”ŸæœåŠ¡è´¨é‡ã€‚

---

### 2.7 è®¢é˜…æ¨¡å— (Subscription Module)

#### 2.7.1 åŠŸèƒ½æè¿°
ç®¡ç†ç”¨æˆ·è®¢é˜…æœåŠ¡ï¼Œæ”¯æŒå›¾æ–‡é—®è¯Šè®¢é˜…ç­‰æ”¶è´¹åŠŸèƒ½ã€‚

#### 2.7.2 ç±»è®¾è®¡

**SubscriptionController.java**
```java
package com.tangxiaowen.subscription.controller;

/**
 * è®¢é˜…æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/subscriptions")
public class SubscriptionController {
    
    /**
     * è·å–è®¢é˜…å¥—é¤åˆ—è¡¨
     */
    @GetMapping("/plans")
    public ResponseEntity<List<SubscriptionPlanResponse>> getPlans();
    
    /**
     * åˆ›å»ºè®¢é˜…è®¢å•
     */
    @PostMapping("/orders")
    public ResponseEntity<SubscriptionOrderResponse> createOrder(@RequestBody CreateSubscriptionOrderRequest request);
    
    /**
     * è·å–ç”¨æˆ·å½“å‰è®¢é˜…çŠ¶æ€
     */
    @GetMapping("/status")
    public ResponseEntity<SubscriptionStatusResponse> getSubscriptionStatus(@RequestParam String userId);
    
    /**
     * å–æ¶ˆè®¢é˜…
     */
    @PostMapping("/cancel")
    public ResponseEntity<Void> cancelSubscription(@RequestParam String userId);
}
```

**SubscriptionService.java**
```java
package com.tangxiaowen.subscription.service;

/**
 * è®¢é˜…æœåŠ¡æ¥å£
 */
public interface SubscriptionService {
    
    /**
     * è·å–æ‰€æœ‰è®¢é˜…å¥—é¤
     * @return å¥—é¤åˆ—è¡¨
     */
    List<SubscriptionPlanResponse> getAllPlans();
    
    /**
     * åˆ›å»ºè®¢é˜…è®¢å•
     * @param userId ç”¨æˆ·ID
     * @param planId å¥—é¤ID
     * @return è®¢å•ä¿¡æ¯
     */
    SubscriptionOrderResponse createOrder(String userId, String planId);
    
    /**
     * ğŸ”¥ å¤„ç†æ”¯ä»˜å›è°ƒï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
     * 
     * é£é™©è¯´æ˜ï¼š
     * å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸåï¼Œä¼šå‘åç«¯å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥ï¼ˆWebhookï¼‰ã€‚
     * ç”±äºç½‘ç»œä¸ç¨³å®šï¼Œæ”¯ä»˜å¹³å°å¯èƒ½ä¼šé‡è¯•å‘é€å¤šæ¬¡é€šçŸ¥ã€‚
     * å¦‚æœä¸åšå¹‚ç­‰å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´ï¼š
     * 1. ç”¨æˆ·è¢«é‡å¤æ‰£è´¹
     * 2. è®¢å•çŠ¶æ€å¼‚å¸¸
     * 3. è®¢é˜…è®°å½•é‡å¤åˆ›å»º
     * 
     * å¹‚ç­‰ç­–ç•¥ï¼š
     * 1. ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰é”å®šè®¢å• ID
     * 2. æ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œå¦‚æœå·²æ˜¯ PAIDï¼Œç›´æ¥è¿”å›æˆåŠŸ
     * 3. æ›´æ–°è®¢å•çŠ¶æ€æ—¶ä½¿ç”¨ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰
     * 4. è®°å½•æ¯æ¬¡å›è°ƒæ—¥å¿—ï¼Œç”¨äºå®¡è®¡å’Œæ’æŸ¥
     * 
     * @param orderId è®¢å•ID
     * @param paymentResult æ”¯ä»˜ç»“æœ
     * @return å¤„ç†ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥/é‡å¤å¤„ç†ï¼‰
     */
    PaymentCallbackResult handlePaymentCallback(String orderId, PaymentResult paymentResult);
    
    /**
     * è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€
     * @param userId ç”¨æˆ·ID
     * @return è®¢é˜…çŠ¶æ€
     */
    SubscriptionStatusResponse getSubscriptionStatus(String userId);
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è®¢é˜…æƒç›Š
     * @param userId ç”¨æˆ·ID
     * @param serviceType æœåŠ¡ç±»å‹
     * @return æ˜¯å¦æœ‰æƒç›Š
     */
    boolean checkSubscriptionAccess(String userId, String serviceType);
    
    /**
     * å–æ¶ˆè®¢é˜…
     * @param userId ç”¨æˆ·ID
     */
    void cancelSubscription(String userId);
}
```

**SubscriptionServiceImpl.java**
```java
package com.tangxiaowen.subscription.service.impl;

/**
 * è®¢é˜…æœåŠ¡å®ç°
 */
@Service
@Slf4j
public class SubscriptionServiceImpl implements SubscriptionService {
    
    @Autowired
    private SubscriptionOrderMapper orderMapper;
    
    @Autowired
    private UserSubscriptionMapper userSubscriptionMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String PAYMENT_CALLBACK_LOCK_PREFIX = "payment:callback:lock:";
    private static final int LOCK_EXPIRE_SECONDS = 30;
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public PaymentCallbackResult handlePaymentCallback(String orderId, PaymentResult paymentResult) {
        /**
         * ğŸ”¥ å¹‚ç­‰æ€§ä¿è¯çš„å®Œæ•´å®ç°
         */
        
        String lockKey = PAYMENT_CALLBACK_LOCK_PREFIX + orderId;
        
        // 1. è·å–åˆ†å¸ƒå¼é”ï¼ˆé˜²æ­¢å¹¶å‘é‡å¤å¤„ç†ï¼‰
        Boolean lockAcquired = redisTemplate.opsForValue().setIfAbsent(
            lockKey, 
            "locked", 
            LOCK_EXPIRE_SECONDS, 
            TimeUnit.SECONDS
        );
        
        if (Boolean.FALSE.equals(lockAcquired)) {
            log.warn("æ”¯ä»˜å›è°ƒå¤„ç†ä¸­ï¼Œæ‹’ç»é‡å¤è¯·æ±‚ï¼šorderId={}", orderId);
            return PaymentCallbackResult.duplicate("å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }
        
        try {
            // 2. æŸ¥è¯¢è®¢å•
            SubscriptionOrder order = orderMapper.selectByOrderId(orderId);
            if (order == null) {
                log.error("è®¢å•ä¸å­˜åœ¨ï¼šorderId={}", orderId);
                return PaymentCallbackResult.failure("è®¢å•ä¸å­˜åœ¨");
            }
            
            // 3. å¹‚ç­‰æ€§æ£€æŸ¥ï¼šå¦‚æœè®¢å•å·²æ˜¯ PAID çŠ¶æ€ï¼Œç›´æ¥è¿”å›æˆåŠŸ
            if ("paid".equals(order.getStatus())) {
                log.info("è®¢å•å·²æ”¯ä»˜ï¼Œè·³è¿‡é‡å¤å¤„ç†ï¼šorderId={}", orderId);
                return PaymentCallbackResult.success("è®¢å•å·²å¤„ç†");
            }
            
            // 4. éªŒè¯æ”¯ä»˜ç»“æœ
            if (!validatePaymentResult(order, paymentResult)) {
                log.error("æ”¯ä»˜ç»“æœéªŒè¯å¤±è´¥ï¼šorderId={}, result={}", orderId, paymentResult);
                return PaymentCallbackResult.failure("æ”¯ä»˜éªŒè¯å¤±è´¥");
            }
            
            // 5. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
            order.setStatus("paid");
            order.setPaymentTransactionId(paymentResult.getTransactionId());
            order.setPaidAt(LocalDateTime.now());
            order.setVersion(order.getVersion() + 1); // ä¹è§‚é”ç‰ˆæœ¬å·
            
            int updated = orderMapper.updateByOrderIdWithVersion(order);
            if (updated == 0) {
                // ç‰ˆæœ¬å·å†²çªï¼Œè¯´æ˜æœ‰å¹¶å‘æ›´æ–°ï¼ŒæŠ›å‡ºå¼‚å¸¸å›æ»š
                throw new ConcurrentModificationException("è®¢å•çŠ¶æ€å·²è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°");
            }
            
            // 6. åˆ›å»ºç”¨æˆ·è®¢é˜…è®°å½•
            createUserSubscription(order);
            
            // 7. è®°å½•å›è°ƒæ—¥å¿—
            recordPaymentCallbackLog(orderId, paymentResult, "success");
            
            log.info("æ”¯ä»˜å›è°ƒå¤„ç†æˆåŠŸï¼šorderId={}, transactionId={}", orderId, paymentResult.getTransactionId());
            return PaymentCallbackResult.success("æ”¯ä»˜æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("æ”¯ä»˜å›è°ƒå¤„ç†å¼‚å¸¸ï¼šorderId=" + orderId, e);
            recordPaymentCallbackLog(orderId, paymentResult, "failure");
            throw e;
            
        } finally {
            // 8. é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    }
    
    /**
     * éªŒè¯æ”¯ä»˜ç»“æœ
     * é˜²æ­¢ä¼ªé€ å›è°ƒ
     */
    private boolean validatePaymentResult(SubscriptionOrder order, PaymentResult paymentResult) {
        // 1. éªŒè¯è®¢å•é‡‘é¢æ˜¯å¦ä¸€è‡´
        if (!order.getAmount().equals(paymentResult.getAmount())) {
            return false;
        }
        
        // 2. éªŒè¯ç­¾åï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰
        // æ ¹æ®æ”¯ä»˜å¹³å°çš„ç­¾åç®—æ³•éªŒè¯
        String expectedSign = calculatePaymentSign(paymentResult);
        if (!expectedSign.equals(paymentResult.getSign())) {
            return false;
        }
        
        return true;
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·è®¢é˜…è®°å½•
     */
    private void createUserSubscription(SubscriptionOrder order) {
        UserSubscription subscription = new UserSubscription();
        subscription.setSubscriptionId(UUID.randomUUID().toString());
        subscription.setUserId(order.getUserId());
        subscription.setPlanId(order.getPlanId());
        subscription.setStatus("active");
        subscription.setStartDate(LocalDateTime.now());
        subscription.setEndDate(calculateEndDate(order.getPlanId()));
        subscription.setAutoRenew(false);
        
        userSubscriptionMapper.insert(subscription);
    }
    
    /**
     * è®°å½•æ”¯ä»˜å›è°ƒæ—¥å¿—
     * ç”¨äºå®¡è®¡å’Œæ’æŸ¥é—®é¢˜
     */
    private void recordPaymentCallbackLog(String orderId, PaymentResult paymentResult, String result) {
        PaymentCallbackLog log = new PaymentCallbackLog();
        log.setOrderId(orderId);
        log.setTransactionId(paymentResult.getTransactionId());
        log.setCallbackData(JSON.toJSONString(paymentResult));
        log.setResult(result);
        log.setCreatedAt(LocalDateTime.now());
        
        paymentCallbackLogMapper.insert(log);
    }
}

/**
 * æ”¯ä»˜å›è°ƒç»“æœ
 */
@Data
public class PaymentCallbackResult {
    private String status;  // success/failure/duplicate
    private String message;
    
    public static PaymentCallbackResult success(String message) {
        PaymentCallbackResult result = new PaymentCallbackResult();
        result.setStatus("success");
        result.setMessage(message);
        return result;
    }
    
    public static PaymentCallbackResult failure(String message) {
        PaymentCallbackResult result = new PaymentCallbackResult();
        result.setStatus("failure");
        result.setMessage(message);
        return result;
    }
    
    public static PaymentCallbackResult duplicate(String message) {
        PaymentCallbackResult result = new PaymentCallbackResult();
        result.setStatus("duplicate");
        result.setMessage(message);
        return result;
    }
}
```

#### 2.7.3 æ•°æ®æ¨¡å‹

**SubscriptionPlan (è®¢é˜…å¥—é¤å®ä½“)**
```java
package com.tangxiaowen.subscription.entity;

@Data
@TableName("tbl_subscription_plan")
public class SubscriptionPlan {
    @TableId(type = IdType.ASSIGN_UUID)
    private String planId;              // å¥—é¤ID
    private String planName;            // å¥—é¤åç§°
    private String description;         // å¥—é¤æè¿°
    private BigDecimal price;           // ä»·æ ¼ï¼ˆå…ƒï¼‰
    private Integer duration;           // æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
    private String features;            // åŠŸèƒ½åˆ—è¡¨ï¼ˆJSONï¼‰
    private Boolean isActive;           // æ˜¯å¦å¯ç”¨
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

**SubscriptionOrder (è®¢é˜…è®¢å•å®ä½“)**
```java
package com.tangxiaowen.subscription.entity;

@Data
@TableName("tbl_subscription_order")
public class SubscriptionOrder {
    @TableId(type = IdType.ASSIGN_UUID)
    private String orderId;             // è®¢å•ID
    private String userId;              // ç”¨æˆ·ID
    private String planId;              // å¥—é¤ID
    private BigDecimal amount;          // è®¢å•é‡‘é¢
    private String status;              // è®¢å•çŠ¶æ€ï¼špending/paid/cancelled/refunded
    private String paymentMethod;       // æ”¯ä»˜æ–¹å¼ï¼šwechat/alipay
    private String paymentTransactionId; // æ”¯ä»˜äº¤æ˜“å·
    private LocalDateTime paidAt;       // æ”¯ä»˜æ—¶é—´
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

**UserSubscription (ç”¨æˆ·è®¢é˜…å®ä½“)**
```java
package com.tangxiaowen.subscription.entity;

@Data
@TableName("tbl_user_subscription")
public class UserSubscription {
    @TableId(type = IdType.ASSIGN_UUID)
    private String subscriptionId;      // è®¢é˜…ID
    private String userId;              // ç”¨æˆ·ID
    private String planId;              // å¥—é¤ID
    private String status;              // çŠ¶æ€ï¼šactive/expired/cancelled
    private LocalDateTime startDate;    // å¼€å§‹æ—¥æœŸ
    private LocalDateTime endDate;      // ç»“æŸæ—¥æœŸ
    private Boolean autoRenew;          // æ˜¯å¦è‡ªåŠ¨ç»­è´¹
    private LocalDateTime createdAt;    // åˆ›å»ºæ—¶é—´
}
```

#### 2.7.4 è®¾è®¡ç†ç”±

1. **å¥—é¤çµæ´»é…ç½®**: æ”¯æŒå¤šç§è®¢é˜…å¥—é¤ï¼Œä¾¿äºè¿è¥è°ƒæ•´å®šä»·ç­–ç•¥ã€‚

2. **è®¢å•çŠ¶æ€ç®¡ç†**: å®Œæ•´çš„è®¢å•çŠ¶æ€æµè½¬ï¼Œæ”¯æŒæ”¯ä»˜å›è°ƒå¤„ç†ã€‚

3. **æƒç›Šæ£€æŸ¥**: æä¾›ç»Ÿä¸€çš„æƒç›Šæ£€æŸ¥æ¥å£ï¼Œä¾¿äºå„ä¸šåŠ¡æ¨¡å—åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™ã€‚

---

### 2.8 é¦–é¡µå±•ç¤ºæ¨¡å— (Dashboard Module)

#### 2.8.1 åŠŸèƒ½æè¿°
èšåˆå±•ç¤ºç”¨æˆ·æ ¸å¿ƒæ•°æ®ï¼ŒåŒ…æ‹¬è¡€ç³–ã€ä»Šæ—¥æ‘„å…¥ã€ä»Šæ—¥æ¶ˆè€—ã€æ•°å­—äººå…¥å£ç­‰ã€‚

#### 2.8.2 ç±»è®¾è®¡

**DashboardController.java**
```java
package com.tangxiaowen.dashboard.controller;

/**
 * é¦–é¡µæ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/dashboard")
public class DashboardController {
    
    /**
     * è·å–é¦–é¡µæ•°æ®
     * åŒ…æ‹¬æœ€æ–°è¡€ç³–ã€ä»Šæ—¥æ‘„å…¥ã€ä»Šæ—¥æ¶ˆè€—ã€å¿«æ·å…¥å£ç­‰
     */
    @GetMapping
    public ResponseEntity<DashboardResponse> getDashboard(@RequestParam String userId);
    
    /**
     * è·å–è¡€ç³–è¶‹åŠ¿å›¾æ•°æ®
     */
    @GetMapping("/glucose-trend")
    public ResponseEntity<GlucoseTrendResponse> getGlucoseTrend(
        @RequestParam String userId,
        @RequestParam(defaultValue = "7") int days
    );
    
    /**
     * è·å–è¥å…»æ‘„å…¥è¶‹åŠ¿å›¾æ•°æ®
     */
    @GetMapping("/nutrition-trend")
    public ResponseEntity<NutritionTrendResponse> getNutritionTrend(
        @RequestParam String userId,
        @RequestParam(defaultValue = "7") int days
    );
}
```

**DashboardService.java**
```java
package com.tangxiaowen.dashboard.service;

/**
 * é¦–é¡µæœåŠ¡æ¥å£
 */
public interface DashboardService {
    
    /**
     * èšåˆé¦–é¡µæ•°æ®
     * @param userId ç”¨æˆ·ID
     * @return é¦–é¡µæ•°æ®
     */
    DashboardResponse aggregateDashboardData(String userId);
    
    /**
     * è·å–è¡€ç³–è¶‹åŠ¿æ•°æ®
     * @param userId ç”¨æˆ·ID
     * @param days å¤©æ•°
     * @return è¶‹åŠ¿æ•°æ®
     */
    GlucoseTrendResponse getGlucoseTrend(String userId, int days);
    
    /**
     * è·å–è¥å…»æ‘„å…¥è¶‹åŠ¿æ•°æ®
     * @param userId ç”¨æˆ·ID
     * @param days å¤©æ•°
     * @return è¶‹åŠ¿æ•°æ®
     */
    NutritionTrendResponse getNutritionTrend(String userId, int days);
}
```

#### 2.8.3 è®¾è®¡ç†ç”±

1. **æ•°æ®èšåˆ**: ä¸€æ¬¡è¯·æ±‚è·å–é¦–é¡µæ‰€éœ€çš„æ‰€æœ‰æ•°æ®ï¼Œå‡å°‘å‰ç«¯è¯·æ±‚æ¬¡æ•°ï¼Œæå‡åŠ è½½é€Ÿåº¦ã€‚

2. **ç¼“å­˜ä¼˜åŒ–**: é¦–é¡µæ•°æ®ä½¿ç”¨ Redis ç¼“å­˜ï¼ŒTTL è®¾ç½®ä¸º 5 åˆ†é’Ÿï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½ã€‚

3. **è¶‹åŠ¿å›¾**: æä¾›è¡€ç³–å’Œè¥å…»è¶‹åŠ¿å›¾æ•°æ®ï¼Œå¸®åŠ©ç”¨æˆ·ç›´è§‚äº†è§£å¥åº·çŠ¶æ€å˜åŒ–ã€‚

---

### 2.9 å®‰å…¨æ¨¡å— (Security Module)

#### 2.9.1 åŠŸèƒ½æè¿°
æä¾›æ•°æ®åŠ å¯†ã€è§£å¯†ã€éšç§åè®®ç®¡ç†ç­‰å®‰å…¨åŠŸèƒ½ã€‚

#### 2.9.2 ç±»è®¾è®¡

**EncryptionService.java**
```java
package com.tangxiaowen.security.service;

/**
 * åŠ å¯†æœåŠ¡
 * æä¾›æ•°æ®åŠ å¯†å’Œè§£å¯†åŠŸèƒ½
 */
@Service
public class EncryptionService {
    
    @Value("${security.encryption.key}")
    private String encryptionKey;
    
    /**
     * åŠ å¯†å­—ç¬¦ä¸²
     * ä½¿ç”¨ AES-256-GCM ç®—æ³•
     * @param plainText æ˜æ–‡
     * @return å¯†æ–‡ï¼ˆBase64ç¼–ç ï¼‰
     */
    public String encrypt(String plainText) {
        // AES-256-GCM åŠ å¯†
        // Base64 ç¼–ç 
        // è¿”å›å¯†æ–‡
    }
    
    /**
     * è§£å¯†å­—ç¬¦ä¸²
     * @param cipherText å¯†æ–‡ï¼ˆBase64ç¼–ç ï¼‰
     * @return æ˜æ–‡
     */
    public String decrypt(String cipherText) {
        // Base64 è§£ç 
        // AES-256-GCM è§£å¯†
        // è¿”å›æ˜æ–‡
    }
    
    /**
     * ç”ŸæˆåŠ å¯†å¯†é’¥
     * @return å¯†é’¥ï¼ˆBase64ç¼–ç ï¼‰
     */
    public String generateKey() {
        // ç”Ÿæˆ 256 ä½éšæœºå¯†é’¥
        // Base64 ç¼–ç 
        // è¿”å›å¯†é’¥
    }
    
    /**
     * æ•°æ®è„±æ•
     * ç”¨äºæ—¥å¿—å’Œå±•ç¤º
     * @param sensitiveData æ•æ„Ÿæ•°æ®
     * @param maskType è„±æ•ç±»å‹ï¼šname/phone/idcard
     * @return è„±æ•åçš„æ•°æ®
     */
    public String mask(String sensitiveData, String maskType) {
        // æ ¹æ®ç±»å‹è¿›è¡Œè„±æ•
        // ä¾‹å¦‚ï¼šå¼ ä¸‰ -> å¼ *ï¼Œ13812345678 -> 138****5678
        // è¿”å›è„±æ•æ•°æ®
    }
}
```

**PrivacyPolicyService.java**
```java
package com.tangxiaowen.security.service;

/**
 * éšç§æ”¿ç­–æœåŠ¡
 */
@Service
public class PrivacyPolicyService {
    
    /**
     * è·å–æœ€æ–°éšç§æ”¿ç­–
     * @return éšç§æ”¿ç­–å†…å®¹å’Œç‰ˆæœ¬
     */
    public PrivacyPolicyResponse getLatestPolicy();
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åŒæ„æœ€æ–°éšç§æ”¿ç­–
     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦åŒæ„
     */
    public boolean hasAgreedToLatestPolicy(String userId);
    
    /**
     * è·å–ç”¨æˆ·éšç§æ”¿ç­–åŒæ„è®°å½•
     * @param userId ç”¨æˆ·ID
     * @return åŒæ„è®°å½•åˆ—è¡¨
     */
    public List<PrivacyAgreementResponse> getUserAgreements(String userId);
}
```

#### 2.9.3 è®¾è®¡ç†ç”±

1. **AES-256-GCM åŠ å¯†**: ä½¿ç”¨ä¸šç•Œæ ‡å‡†çš„åŠ å¯†ç®—æ³•ï¼Œä¿è¯æ•°æ®å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚

2. **å¯†é’¥ç®¡ç†**: åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨é…ç½®ä¸­å¿ƒï¼Œå®šæœŸè½®æ¢ï¼Œé¿å…ç¡¬ç¼–ç ã€‚

3. **æ•°æ®è„±æ•**: å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•å¤„ç†ï¼Œä¿æŠ¤ç”¨æˆ·éšç§ï¼Œæ»¡è¶³æ—¥å¿—å®¡è®¡éœ€æ±‚ã€‚

4. **éšç§åè®®ç‰ˆæœ¬åŒ–**: æ”¯æŒéšç§åè®®ç‰ˆæœ¬ç®¡ç†ï¼Œå½“åè®®æ›´æ–°æ—¶æç¤ºç”¨æˆ·é‡æ–°åŒæ„ã€‚

---

### 2.10 æ–‡ä»¶ä¸Šä¼ æ¨¡å— (File Upload Module)

#### 2.10.1 åŠŸèƒ½æè¿°
æä¾›æ–‡ä»¶ä¸Šä¼ æœåŠ¡ï¼Œæ”¯æŒé˜¿é‡Œäº‘ OSS ç›´ä¼ å’Œåç«¯ä¸­è½¬ä¸¤ç§æ¨¡å¼ã€‚

#### 2.10.2 ç±»è®¾è®¡

**FileController.java**
```java
package com.tangxiaowen.file.controller;

/**
 * æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/v1/files")
public class FileController {
    
    /**
     * ğŸ”¥ è·å– OSS ç›´ä¼ å‡­è¯ï¼ˆæ¨èæ–¹å¼ï¼‰
     * å‰ç«¯ä½¿ç”¨æ­¤å‡­è¯ç›´æ¥ä¸Šä¼ åˆ° OSSï¼Œå‡å°‘æœåŠ¡å™¨å¸¦å®½æ¶ˆè€—
     * 
     * é€‚ç”¨åœºæ™¯ï¼š
     * - é¥®é£Ÿæ‹ç…§ï¼ˆé€šå¸¸ 2-5MBï¼‰
     * - ç”¨æˆ·å¤´åƒä¸Šä¼ 
     * - é—®è¯Šå›¾ç‰‡ä¸Šä¼ 
     * 
     * ä¼˜ç‚¹ï¼š
     * - ä¸Šä¼ é€Ÿåº¦å¿«ï¼ˆç›´æ¥åˆ° OSSï¼‰
     * - æœåŠ¡å™¨æ— å¸¦å®½å‹åŠ›
     * - æ”¯æŒæ–­ç‚¹ç»­ä¼ 
     * 
     * @param request ä¸Šä¼ è¯·æ±‚ï¼ˆæ–‡ä»¶ç±»å‹ã€å¤§å°ã€ä¸šåŠ¡åœºæ™¯ï¼‰
     * @return STS ä¸´æ—¶å‡­è¯ + ä¸Šä¼ ç­–ç•¥
     */
    @PostMapping("/oss-token")
    public ResponseEntity<OssUploadTokenResponse> getOssUploadToken(@RequestBody OssUploadTokenRequest request);
    
    /**
     * åç«¯ä¸­è½¬ä¸Šä¼ ï¼ˆé™çº§æ–¹å¼ï¼‰
     * å‰ç«¯ç›´æ¥ä¼ æ–‡ä»¶ç»™åç«¯ï¼Œåç«¯è½¬å­˜ OSS
     * 
     * é€‚ç”¨åœºæ™¯ï¼š
     * - P0 é˜¶æ®µå¿«é€Ÿå®ç°
     * - å°æ–‡ä»¶ä¸Šä¼ ï¼ˆ<1MBï¼‰
     * - å®¢æˆ·ç«¯ä¸æ”¯æŒ OSS SDK
     * 
     * ç¼ºç‚¹ï¼š
     * - æ¶ˆè€—æœåŠ¡å™¨å¸¦å®½
     * - ä¸Šä¼ é€Ÿåº¦å—æœåŠ¡å™¨é™åˆ¶
     * 
     * @param file æ–‡ä»¶
     * @param bizType ä¸šåŠ¡ç±»å‹ï¼šavatar/diet_photo/consultation_image
     * @return æ–‡ä»¶ URL
     */
    @PostMapping("/upload")
    public ResponseEntity<FileUploadResponse> uploadFile(
        @RequestParam("file") MultipartFile file,
        @RequestParam("bizType") String bizType
    );
    
    /**
     * è·å–æ–‡ä»¶è®¿é—® URL
     * å¯¹äºç§æœ‰æ–‡ä»¶ï¼Œç”Ÿæˆå¸¦ç­¾åçš„ä¸´æ—¶è®¿é—® URL
     * 
     * @param fileKey æ–‡ä»¶ Key
     * @param expireSeconds è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return è®¿é—® URL
     */
    @GetMapping("/access-url")
    public ResponseEntity<FileAccessUrlResponse> getFileAccessUrl(
        @RequestParam String fileKey,
        @RequestParam(defaultValue = "3600") int expireSeconds
    );
}
```

**OssService.java**
```java
package com.tangxiaowen.file.service;

/**
 * OSS æœåŠ¡
 */
@Service
public class OssService {
    
    @Value("${aliyun.oss.endpoint}")
    private String endpoint;
    
    @Value("${aliyun.oss.bucket}")
    private String bucket;
    
    @Value("${aliyun.oss.access-key-id}")
    private String accessKeyId;
    
    @Value("${aliyun.oss.access-key-secret}")
    private String accessKeySecret;
    
    @Autowired
    private OSS ossClient;
    
    /**
     * ç”Ÿæˆ STS ä¸´æ—¶å‡­è¯
     * ç”¨äºå‰ç«¯ç›´ä¼  OSS
     * 
     * @param bizType ä¸šåŠ¡ç±»å‹
     * @param expireSeconds å‡­è¯æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
     * @return STS å‡­è¯
     */
    public OssUploadTokenResponse generateUploadToken(String bizType, int expireSeconds) {
        // 1. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        String fileKey = generateFileKey(bizType);
        
        // 2. è°ƒç”¨ STS æœåŠ¡ç”Ÿæˆä¸´æ—¶å‡­è¯
        // é™åˆ¶ä¸Šä¼ è·¯å¾„ã€æ–‡ä»¶å¤§å°ã€æ–‡ä»¶ç±»å‹
        
        // 3. ç”Ÿæˆ PostObject ç­¾å
        PolicyConditions conditions = new PolicyConditions();
        conditions.addConditionItem("bucket", bucket);
        conditions.addConditionItem("key", fileKey);
        conditions.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 10 * 1024 * 1024); // æœ€å¤§ 10MB
        
        String postPolicy = ossClient.generatePostPolicy(expireSeconds, conditions);
        String signature = ossClient.calculatePostSignature(postPolicy);
        
        // 4. è¿”å›å‡­è¯
        OssUploadTokenResponse response = new OssUploadTokenResponse();
        response.setAccessKeyId(accessKeyId);
        response.setPolicy(postPolicy);
        response.setSignature(signature);
        response.setFileKey(fileKey);
        response.setHost("https://" + bucket + "." + endpoint);
        response.setExpireAt(LocalDateTime.now().plusSeconds(expireSeconds));
        
        return response;
    }
    
    /**
     * åç«¯ä¸­è½¬ä¸Šä¼ æ–‡ä»¶
     * @param file æ–‡ä»¶
     * @param bizType ä¸šåŠ¡ç±»å‹
     * @return æ–‡ä»¶ URL
     */
    public String uploadFile(MultipartFile file, String bizType) {
        try {
            // 1. éªŒè¯æ–‡ä»¶
            validateFile(file, bizType);
            
            // 2. ç”Ÿæˆæ–‡ä»¶ Key
            String fileKey = generateFileKey(bizType);
            
            // 3. ä¸Šä¼ åˆ° OSS
            PutObjectRequest putRequest = new PutObjectRequest(bucket, fileKey, file.getInputStream());
            ossClient.putObject(putRequest);
            
            // 4. è¿”å› URL
            return "https://" + bucket + "." + endpoint + "/" + fileKey;
            
        } catch (IOException e) {
            throw new BusinessException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
        }
    }
    
    /**
     * ç”Ÿæˆå¸¦ç­¾åçš„è®¿é—® URLï¼ˆç”¨äºç§æœ‰æ–‡ä»¶ï¼‰
     * @param fileKey æ–‡ä»¶ Key
     * @param expireSeconds è¿‡æœŸæ—¶é—´
     * @return è®¿é—® URL
     */
    public String generateAccessUrl(String fileKey, int expireSeconds) {
        Date expiration = new Date(System.currentTimeMillis() + expireSeconds * 1000L);
        URL url = ossClient.generatePresignedUrl(bucket, fileKey, expiration);
        return url.toString();
    }
    
    /**
     * åˆ é™¤æ–‡ä»¶
     * @param fileKey æ–‡ä»¶ Key
     */
    public void deleteFile(String fileKey) {
        ossClient.deleteObject(bucket, fileKey);
    }
    
    /**
     * ç”Ÿæˆæ–‡ä»¶ Key
     * æ ¼å¼ï¼š{bizType}/{date}/{uuid}.{ext}
     * ä¾‹å¦‚ï¼šdiet_photo/2026/01/29/abc123.jpg
     */
    private String generateFileKey(String bizType) {
        LocalDate now = LocalDate.now();
        String uuid = UUID.randomUUID().toString().replace("-", "");
        return String.format("%s/%d/%02d/%02d/%s", 
            bizType, now.getYear(), now.getMonthValue(), now.getDayOfMonth(), uuid);
    }
    
    /**
     * éªŒè¯æ–‡ä»¶
     */
    private void validateFile(MultipartFile file, String bizType) {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        // æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼ˆé˜²æ­¢æ¶æ„æ–‡ä»¶ï¼‰
    }
}
```

#### 2.10.3 æ•°æ®æ¨¡å‹

**OssUploadTokenResponse (OSS ä¸Šä¼ å‡­è¯)**
```java
@Data
public class OssUploadTokenResponse {
    private String accessKeyId;         // AccessKeyId
    private String policy;              // ä¸Šä¼ ç­–ç•¥ï¼ˆBase64 ç¼–ç ï¼‰
    private String signature;           // ç­¾å
    private String fileKey;             // æ–‡ä»¶ Keyï¼ˆè·¯å¾„ï¼‰
    private String host;                // OSS Endpoint
    private LocalDateTime expireAt;     // å‡­è¯è¿‡æœŸæ—¶é—´
    private String callbackUrl;         // å›è°ƒ URLï¼ˆå¯é€‰ï¼Œç”¨äºä¸Šä¼ æˆåŠŸåé€šçŸ¥åç«¯ï¼‰
}
```

**FileUploadResponse (æ–‡ä»¶ä¸Šä¼ å“åº”)**
```java
@Data
public class FileUploadResponse {
    private String fileKey;             // æ–‡ä»¶ Key
    private String fileUrl;             // æ–‡ä»¶è®¿é—® URL
    private Long fileSize;              // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    private String contentType;         // æ–‡ä»¶ç±»å‹
    private LocalDateTime uploadAt;     // ä¸Šä¼ æ—¶é—´
}
```

#### 2.10.4 é…ç½®ç¤ºä¾‹

**application.yml**
```yaml
aliyun:
  oss:
    endpoint: oss-cn-hangzhou.aliyuncs.com
    bucket: tangxiaowen-prod
    access-key-id: ${ALIYUN_ACCESS_KEY_ID}
    access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET}
    # æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰
    max-size:
      avatar: 2097152        # 2MB
      diet-photo: 10485760   # 10MB
      consultation-image: 5242880  # 5MB
    # å…è®¸çš„æ–‡ä»¶ç±»å‹
    allowed-types:
      image: image/jpeg,image/png,image/webp
      audio: audio/mp3,audio/wav
```

#### 2.10.5 P0 é˜¶æ®µå»ºè®®

**æ¨èç­–ç•¥ï¼šåç«¯ä¸­è½¬ï¼ˆå¿«é€Ÿä¸Šçº¿ï¼‰**

ç†ç”±ï¼š
1. **å®ç°ç®€å•**ï¼šæ— éœ€å‰ç«¯é›†æˆ OSS SDKï¼Œå‡å°‘è”è°ƒæ—¶é—´
2. **å®‰å…¨å¯æ§**ï¼šåç«¯ç»Ÿä¸€æ ¡éªŒæ–‡ä»¶ç±»å‹ã€å¤§å°ï¼Œé˜²æ­¢æ¶æ„ä¸Šä¼ 
3. **é€‚åˆ P0**ï¼šåˆæœŸç”¨æˆ·é‡å°ï¼Œå¸¦å®½å‹åŠ›å¯æ¥å—

**P1 é˜¶æ®µä¼˜åŒ–ï¼šå‰ç«¯ç›´ä¼ **

å‡çº§è·¯å¾„ï¼š
1. å‰ç«¯é›†æˆé˜¿é‡Œäº‘ OSS SDKï¼ˆå¾®ä¿¡å°ç¨‹åºç‰ˆï¼‰
2. å‰ç«¯è°ƒç”¨ `/api/v1/files/oss-token` è·å–å‡­è¯
3. å‰ç«¯ä½¿ç”¨å‡­è¯ç›´ä¼  OSS
4. ä¸Šä¼ æˆåŠŸåï¼ŒOSS å›è°ƒåç«¯æ¥å£ï¼ˆå¯é€‰ï¼Œç”¨äºè®°å½•ä¸Šä¼ æ—¥å¿—ï¼‰

å¸¦å®½èŠ‚çœä¼°ç®—ï¼š
- å‡è®¾æ—¥å‡ 1000 æ¬¡æ‹ç…§è®°å½•ï¼Œæ¯å¼ å›¾ 3MB
- åç«¯ä¸­è½¬ï¼š3GB/å¤© Ã— 30å¤© = 90GB/æœˆ
- å‰ç«¯ç›´ä¼ ï¼š0GB/æœˆï¼ˆOSS æµé‡è´¹ç”¨æ›´ä½ï¼‰

#### 2.10.6 è®¾è®¡ç†ç”±

1. **åŒæ¨¡å¼æ”¯æŒ**ï¼šæä¾›ç›´ä¼ å’Œä¸­è½¬ä¸¤ç§æ–¹å¼ï¼Œå…¼é¡¾å¼€å‘é€Ÿåº¦å’Œé•¿æœŸæ€§èƒ½ã€‚

2. **STS ä¸´æ—¶å‡­è¯**ï¼šä¸åœ¨å‰ç«¯æš´éœ²æ°¸ä¹… AccessKeyï¼Œæå‡å®‰å…¨æ€§ã€‚

3. **æ–‡ä»¶ Key è®¾è®¡**ï¼šæŒ‰ä¸šåŠ¡ç±»å‹å’Œæ—¥æœŸåˆ†ç›®å½•ï¼Œä¾¿äºç®¡ç†å’Œå®šæœŸæ¸…ç†è¿‡æœŸæ–‡ä»¶ã€‚

4. **å›è°ƒæœºåˆ¶**ï¼šOSS ä¸Šä¼ æˆåŠŸåå›è°ƒåç«¯ï¼Œåç«¯å¯è®°å½•ä¸Šä¼ æ—¥å¿—ã€è§¦å‘åç»­ä¸šåŠ¡ï¼ˆå¦‚å›¾ç‰‡è¯†åˆ«ï¼‰ã€‚

---

## 3. å…¬å…± API æ¥å£è®¾è®¡

### 3.1 RESTful API è§„èŒƒ

#### 3.1.1 åŸºç¡€è§„èŒƒ
- **Base URL**: `https://api.tangxiaowen.com/api/v1`
- **åè®®**: HTTPS
- **æ•°æ®æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8
- **æ—¶é—´æ ¼å¼**: ISO 8601 (ä¾‹: `2026-01-29T10:30:00+08:00`)

#### 3.1.2 é€šç”¨è¯·æ±‚å¤´
```
Content-Type: application/json
Authorization: Bearer {access_token}
X-Request-ID: {unique_request_id}
X-User-Agent: {client_info}
```

#### 3.1.3 é€šç”¨å“åº”æ ¼å¼

**æˆåŠŸå“åº”**
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    // ä¸šåŠ¡æ•°æ®
  },
  "requestId": "req-1234567890",
  "timestamp": "2026-01-29T10:30:00+08:00"
}
```

**é”™è¯¯å“åº”**
```json
{
  "code": 400,
  "message": "Invalid parameter",
  "error": {
    "type": "ValidationError",
    "details": [
      {
        "field": "userId",
        "message": "userId is required"
      }
    ]
  },
  "requestId": "req-1234567890",
  "timestamp": "2026-01-29T10:30:00+08:00"
}
```

#### 3.1.4 HTTP çŠ¶æ€ç ä½¿ç”¨
- `200 OK`: è¯·æ±‚æˆåŠŸ
- `201 Created`: èµ„æºåˆ›å»ºæˆåŠŸ
- `204 No Content`: è¯·æ±‚æˆåŠŸä½†æ— è¿”å›å†…å®¹
- `400 Bad Request`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401 Unauthorized`: æœªæˆæƒ
- `403 Forbidden`: æ— æƒé™
- `404 Not Found`: èµ„æºä¸å­˜åœ¨
- `409 Conflict`: èµ„æºå†²çª
- `429 Too Many Requests`: è¯·æ±‚è¿‡äºé¢‘ç¹
- `500 Internal Server Error`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- `503 Service Unavailable`: æœåŠ¡ä¸å¯ç”¨

### 3.2 æ ¸å¿ƒ API åˆ—è¡¨

#### 3.2.1 ç”¨æˆ·ç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /users/guest/register | è®¿å®¢æ³¨å†Œ | å¦ |
| POST | /users/guest/convert | è®¿å®¢è½¬æ­£ | æ˜¯ |
| GET | /users/{userId} | è·å–ç”¨æˆ·ä¿¡æ¯ | æ˜¯ |
| PUT | /users/{userId}/profile | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | æ˜¯ |
| PUT | /users/{userId}/medical-history | æ›´æ–°ç—…ä¾‹ä¿¡æ¯ | æ˜¯ |
| GET | /users/{userId}/medical-history | è·å–ç—…ä¾‹ä¿¡æ¯ | æ˜¯ |
| POST | /users/{userId}/privacy-agreement | åŒæ„éšç§åè®® | æ˜¯ |

#### 3.2.2 æ•°å­—äººç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /digital-human/sessions | åˆ›å»ºå¯¹è¯ä¼šè¯ | æ˜¯ |
| POST | /digital-human/sessions/{sessionId}/messages/stream | ğŸ”¥ æµå¼å‘é€æ¶ˆæ¯ï¼ˆæ¨èï¼‰ | æ˜¯ |
| POST | /digital-human/sessions/{sessionId}/messages | åŒæ­¥å‘é€æ¶ˆæ¯ï¼ˆé™çº§ï¼‰ | æ˜¯ |
| GET | /digital-human/sessions/{sessionId}/messages | è·å–æ¶ˆæ¯å†å² | æ˜¯ |
| GET | /digital-human/sessions/{sessionId}/guidance-status | è·å–å¼•å¯¼çŠ¶æ€ | æ˜¯ |
| DELETE | /digital-human/sessions/{sessionId} | ç»“æŸä¼šè¯ | æ˜¯ |

#### 3.2.3 è¡€ç³–ç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /glucose/records | åˆ›å»ºè¡€ç³–è®°å½• | æ˜¯ |
| POST | /glucose/records/batch | æ‰¹é‡åˆ›å»ºè®°å½• | æ˜¯ |
| GET | /glucose/records | è·å–è¡€ç³–è®°å½•åˆ—è¡¨ | æ˜¯ |
| GET | /glucose/records/latest | è·å–æœ€æ–°è¡€ç³– | æ˜¯ |
| GET | /glucose/statistics | è·å–è¡€ç³–ç»Ÿè®¡ | æ˜¯ |
| DELETE | /glucose/records/{recordId} | åˆ é™¤è®°å½• | æ˜¯ |

#### 3.2.4 é¥®é£Ÿç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /diet/records | åˆ›å»ºé¥®é£Ÿè®°å½• | æ˜¯ |
| POST | /diet/records/photo | æ‹ç…§è¯†åˆ«é¥®é£Ÿ | æ˜¯ |
| GET | /diet/records | è·å–é¥®é£Ÿè®°å½•åˆ—è¡¨ | æ˜¯ |
| GET | /diet/today-intake | è·å–ä»Šæ—¥æ‘„å…¥ | æ˜¯ |
| PUT | /diet/records/{recordId} | æ›´æ–°é¥®é£Ÿè®°å½• | æ˜¯ |
| DELETE | /diet/records/{recordId} | åˆ é™¤è®°å½• | æ˜¯ |

#### 3.2.5 è¿åŠ¨ç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /exercise/records | åˆ›å»ºè¿åŠ¨è®°å½• | æ˜¯ |
| GET | /exercise/records | è·å–è¿åŠ¨è®°å½•åˆ—è¡¨ | æ˜¯ |
| GET | /exercise/today-expenditure | è·å–ä»Šæ—¥æ¶ˆè€— | æ˜¯ |
| DELETE | /exercise/records/{recordId} | åˆ é™¤è®°å½• | æ˜¯ |

#### 3.2.6 é—®è¯Šç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /consultations | åˆ›å»ºé—®è¯Š | æ˜¯ |
| POST | /consultations/{consultationId}/messages | å‘é€é—®è¯Šæ¶ˆæ¯ | æ˜¯ |
| GET | /consultations/{consultationId}/messages | è·å–é—®è¯Šæ¶ˆæ¯ | æ˜¯ |
| GET | /consultations | è·å–é—®è¯Šå†å² | æ˜¯ |
| POST | /consultations/{consultationId}/complete | ç»“æŸé—®è¯Š | æ˜¯ |
| POST | /consultations/{consultationId}/rating | é—®è¯Šè¯„ä»· | æ˜¯ |

#### 3.2.7 è®¢é˜…ç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| GET | /subscriptions/plans | è·å–å¥—é¤åˆ—è¡¨ | å¦ |
| POST | /subscriptions/orders | åˆ›å»ºè®¢é˜…è®¢å• | æ˜¯ |
| GET | /subscriptions/status | è·å–è®¢é˜…çŠ¶æ€ | æ˜¯ |
| POST | /subscriptions/cancel | å–æ¶ˆè®¢é˜… | æ˜¯ |

#### 3.2.8 é¦–é¡µç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| GET | /dashboard | è·å–é¦–é¡µæ•°æ® | æ˜¯ |
| GET | /dashboard/glucose-trend | è·å–è¡€ç³–è¶‹åŠ¿ | æ˜¯ |
| GET | /dashboard/nutrition-trend | è·å–è¥å…»è¶‹åŠ¿ | æ˜¯ |

#### 3.2.9 æ–‡ä»¶ä¸Šä¼ ç›¸å…³ API
| æ–¹æ³• | è·¯å¾„ | æè¿° | æ˜¯å¦éœ€è¦è®¤è¯ |
|------|------|------|------------|
| POST | /files/oss-token | è·å– OSS ç›´ä¼ å‡­è¯ï¼ˆæ¨èï¼‰ | æ˜¯ |
| POST | /files/upload | åç«¯ä¸­è½¬ä¸Šä¼ ï¼ˆé™çº§ï¼‰ | æ˜¯ |
| GET | /files/access-url | è·å–æ–‡ä»¶è®¿é—® URL | æ˜¯ |

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ•°æ®åº“é€‰å‹
- **æ•°æ®åº“**: PostgreSQL 15+
- **å­—ç¬¦é›†**: UTF8
- **æ—¶åŒº**: Asia/Shanghai

### 4.2 æ•°æ®è¡¨è®¾è®¡

#### 4.2.1 ç”¨æˆ·è¡¨ (tbl_user)

```sql
CREATE TABLE tbl_user (
    user_id VARCHAR(36) PRIMARY KEY,
    user_type VARCHAR(20) NOT NULL,  -- guest/normal
    encrypted_name TEXT,
    gender VARCHAR(10),
    age INTEGER,
    encrypted_phone TEXT,
    encrypted_id_card TEXT,
    phone_hash VARCHAR(64),  -- ğŸ”¥ SHA256(phone + global_salt) ç”¨äºæ£€ç´¢
    id_card_hash VARCHAR(64),  -- ğŸ”¥ SHA256(id_card + global_salt) ç”¨äºæ£€ç´¢
    wechat_openid VARCHAR(100),  -- å¾®ä¿¡ OpenIDï¼ˆç”¨äºç™»å½•ï¼‰
    wechat_unionid VARCHAR(100),  -- å¾®ä¿¡ UnionIDï¼ˆç”¨äºè·¨åº”ç”¨è¯†åˆ«ï¼‰
    avatar VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE
);

CREATE INDEX idx_user_type ON tbl_user(user_type);
CREATE INDEX idx_user_created_at ON tbl_user(created_at);
CREATE UNIQUE INDEX idx_user_phone_hash ON tbl_user(phone_hash) WHERE phone_hash IS NOT NULL;  -- ğŸ”¥ ç”¨äºæ‰‹æœºå·æŸ¥è¯¢
CREATE UNIQUE INDEX idx_user_id_card_hash ON tbl_user(id_card_hash) WHERE id_card_hash IS NOT NULL;  -- ğŸ”¥ ç”¨äºèº«ä»½è¯æŸ¥è¯¢
CREATE UNIQUE INDEX idx_user_wechat_openid ON tbl_user(wechat_openid) WHERE wechat_openid IS NOT NULL;

COMMENT ON TABLE tbl_user IS 'ç”¨æˆ·è¡¨';
COMMENT ON COLUMN tbl_user.user_id IS 'ç”¨æˆ·IDï¼ˆUUIDï¼‰';
COMMENT ON COLUMN tbl_user.user_type IS 'ç”¨æˆ·ç±»å‹ï¼šguest-è®¿å®¢ï¼Œnormal-æ­£å¼ç”¨æˆ·';
COMMENT ON COLUMN tbl_user.encrypted_name IS 'åŠ å¯†çš„å§“åï¼ˆAES-256-GCMï¼‰';
COMMENT ON COLUMN tbl_user.gender IS 'æ€§åˆ«ï¼šmale/female/other';
COMMENT ON COLUMN tbl_user.age IS 'å¹´é¾„';
COMMENT ON COLUMN tbl_user.encrypted_phone IS 'åŠ å¯†çš„æ‰‹æœºå·ï¼ˆç”¨äºå±•ç¤ºï¼‰';
COMMENT ON COLUMN tbl_user.encrypted_id_card IS 'åŠ å¯†çš„èº«ä»½è¯å·ï¼ˆç”¨äºå±•ç¤ºï¼‰';
COMMENT ON COLUMN tbl_user.phone_hash IS 'ğŸ”¥ æ‰‹æœºå·å“ˆå¸Œå€¼ï¼ˆç”¨äºæ£€ç´¢ï¼‰- SHA256(phone + global_salt)';
COMMENT ON COLUMN tbl_user.id_card_hash IS 'ğŸ”¥ èº«ä»½è¯å“ˆå¸Œå€¼ï¼ˆç”¨äºæ£€ç´¢ï¼‰- SHA256(id_card + global_salt)';
COMMENT ON COLUMN tbl_user.wechat_openid IS 'å¾®ä¿¡ OpenID';
COMMENT ON COLUMN tbl_user.wechat_unionid IS 'å¾®ä¿¡ UnionID';
COMMENT ON COLUMN tbl_user.avatar IS 'å¤´åƒURL';
```

#### 4.2.2 ç—…ä¾‹ä¿¡æ¯è¡¨ (tbl_medical_history)

```sql
CREATE TABLE tbl_medical_history (
    history_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    diagnosis_date DATE,
    diabetes_type VARCHAR(20),  -- type1/type2
    systolic_pressure INTEGER,
    diastolic_pressure INTEGER,
    complications JSONB,
    is_on_medication BOOLEAN,
    medication_details JSONB,
    is_using_insulin BOOLEAN,
    insulin_details JSONB,
    other_diseases JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_medical_history_user_id ON tbl_medical_history(user_id);

COMMENT ON TABLE tbl_medical_history IS 'ç—…ä¾‹ä¿¡æ¯è¡¨';
COMMENT ON COLUMN tbl_medical_history.diagnosis_date IS 'ç¡®è¯Šæ—¥æœŸ';
COMMENT ON COLUMN tbl_medical_history.diabetes_type IS 'ç³–å°¿ç—…ç±»å‹ï¼štype1-1å‹ï¼Œtype2-2å‹';
COMMENT ON COLUMN tbl_medical_history.systolic_pressure IS 'æ”¶ç¼©å‹ï¼ˆmmHgï¼‰';
COMMENT ON COLUMN tbl_medical_history.diastolic_pressure IS 'èˆ’å¼ å‹ï¼ˆmmHgï¼‰';
COMMENT ON COLUMN tbl_medical_history.complications IS 'å¹¶å‘ç—‡åˆ—è¡¨ï¼ˆJSONï¼‰';
COMMENT ON COLUMN tbl_medical_history.medication_details IS 'ç”¨è¯è¯¦æƒ…ï¼ˆJSONï¼‰';
COMMENT ON COLUMN tbl_medical_history.insulin_details IS 'èƒ°å²›ç´ ä½¿ç”¨è¯¦æƒ…ï¼ˆJSONï¼‰';
```

#### 4.2.3 éšç§åè®®åŒæ„è®°å½•è¡¨ (tbl_privacy_agreement)

```sql
CREATE TABLE tbl_privacy_agreement (
    agreement_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    agreement_version VARCHAR(20) NOT NULL,
    agreed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(50),
    device_info VARCHAR(500)
);

CREATE INDEX idx_privacy_agreement_user_id ON tbl_privacy_agreement(user_id);
CREATE INDEX idx_privacy_agreement_version ON tbl_privacy_agreement(agreement_version);

COMMENT ON TABLE tbl_privacy_agreement IS 'éšç§åè®®åŒæ„è®°å½•è¡¨';
COMMENT ON COLUMN tbl_privacy_agreement.agreement_version IS 'åè®®ç‰ˆæœ¬å·';
COMMENT ON COLUMN tbl_privacy_agreement.agreed_at IS 'åŒæ„æ—¶é—´';
COMMENT ON COLUMN tbl_privacy_agreement.ip_address IS 'IPåœ°å€';
COMMENT ON COLUMN tbl_privacy_agreement.device_info IS 'è®¾å¤‡ä¿¡æ¯';
```

#### 4.2.4 å¯¹è¯ä¼šè¯è¡¨ (tbl_conversation_session)

```sql
CREATE TABLE tbl_conversation_session (
    session_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    scene_type VARCHAR(50) NOT NULL,  -- profile_input/medical_input/glucose_record/diet_record/consultation
    status VARCHAR(20) DEFAULT 'active',  -- active/completed/expired
    start_time TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    end_time TIMESTAMP WITH TIME ZONE,
    message_count INTEGER DEFAULT 0
);

CREATE INDEX idx_session_user_id ON tbl_conversation_session(user_id);
CREATE INDEX idx_session_status ON tbl_conversation_session(status);
CREATE INDEX idx_session_start_time ON tbl_conversation_session(start_time);

COMMENT ON TABLE tbl_conversation_session IS 'å¯¹è¯ä¼šè¯è¡¨';
COMMENT ON COLUMN tbl_conversation_session.scene_type IS 'åœºæ™¯ç±»å‹';
COMMENT ON COLUMN tbl_conversation_session.status IS 'ä¼šè¯çŠ¶æ€';
```

#### 4.2.5 å¯¹è¯æ¶ˆæ¯è¡¨ (tbl_conversation_message)

```sql
CREATE TABLE tbl_conversation_message (
    message_id VARCHAR(36) PRIMARY KEY,
    session_id VARCHAR(36) NOT NULL REFERENCES tbl_conversation_session(session_id),
    role VARCHAR(20) NOT NULL,  -- user/assistant
    content_type VARCHAR(20) NOT NULL,  -- text/audio/image
    content TEXT,
    audio_url VARCHAR(500),
    metadata JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_message_session_id ON tbl_conversation_message(session_id);
CREATE INDEX idx_message_created_at ON tbl_conversation_message(created_at);

COMMENT ON TABLE tbl_conversation_message IS 'å¯¹è¯æ¶ˆæ¯è¡¨';
COMMENT ON COLUMN tbl_conversation_message.role IS 'è§’è‰²ï¼šuser-ç”¨æˆ·ï¼Œassistant-AIåŠ©æ‰‹';
COMMENT ON COLUMN tbl_conversation_message.content_type IS 'å†…å®¹ç±»å‹';
COMMENT ON COLUMN tbl_conversation_message.metadata IS 'å…ƒæ•°æ®ï¼ˆJSONï¼‰';
```

#### 4.2.6 å¼•å¯¼è¿›åº¦è¡¨ (tbl_guidance_progress)

```sql
CREATE TABLE tbl_guidance_progress (
    progress_id VARCHAR(36) PRIMARY KEY,
    session_id VARCHAR(36) NOT NULL REFERENCES tbl_conversation_session(session_id),
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    scene_type VARCHAR(50) NOT NULL,
    current_step VARCHAR(50),
    collected_data JSONB,
    completion_rate INTEGER DEFAULT 0,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_guidance_progress_session_id ON tbl_guidance_progress(session_id);
CREATE INDEX idx_guidance_progress_user_id ON tbl_guidance_progress(user_id);

COMMENT ON TABLE tbl_guidance_progress IS 'å¼•å¯¼è¿›åº¦è¡¨';
COMMENT ON COLUMN tbl_guidance_progress.current_step IS 'å½“å‰æ­¥éª¤';
COMMENT ON COLUMN tbl_guidance_progress.collected_data IS 'å·²æ”¶é›†æ•°æ®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN tbl_guidance_progress.completion_rate IS 'å®Œæˆç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰';
```

#### 4.2.7 è¡€ç³–è®°å½•è¡¨ (tbl_glucose_record)

```sql
CREATE TABLE tbl_glucose_record (
    record_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    glucose_value NUMERIC(5, 2) NOT NULL,
    measurement_type VARCHAR(30) NOT NULL,  -- fasting/before_meal/after_meal/before_sleep/random
    measurement_time TIMESTAMP WITH TIME ZONE NOT NULL,
    device_info VARCHAR(200),
    notes TEXT,
    session_id VARCHAR(36),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_glucose_user_id ON tbl_glucose_record(user_id);
CREATE INDEX idx_glucose_measurement_time ON tbl_glucose_record(measurement_time);
CREATE INDEX idx_glucose_measurement_type ON tbl_glucose_record(measurement_type);

COMMENT ON TABLE tbl_glucose_record IS 'è¡€ç³–è®°å½•è¡¨';
COMMENT ON COLUMN tbl_glucose_record.glucose_value IS 'è¡€ç³–å€¼ï¼ˆmmol/Lï¼‰';
COMMENT ON COLUMN tbl_glucose_record.measurement_type IS 'æµ‹é‡ç±»å‹';
COMMENT ON COLUMN tbl_glucose_record.measurement_time IS 'æµ‹é‡æ—¶é—´';
COMMENT ON COLUMN tbl_glucose_record.session_id IS 'å…³è”çš„å¯¹è¯ä¼šè¯IDï¼ˆå¦‚æœé€šè¿‡æ•°å­—äººå½•å…¥ï¼‰';
```

#### 4.2.8 é¥®é£Ÿè®°å½•è¡¨ (tbl_diet_record)

```sql
CREATE TABLE tbl_diet_record (
    record_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    meal_type VARCHAR(20) NOT NULL,  -- breakfast/lunch/dinner/snack
    meal_time TIMESTAMP WITH TIME ZONE NOT NULL,
    food_items JSONB NOT NULL,
    photo_url VARCHAR(500),
    total_calories NUMERIC(8, 2),
    carbohydrate NUMERIC(8, 2),
    protein NUMERIC(8, 2),
    fat NUMERIC(8, 2),
    fiber NUMERIC(8, 2),
    notes TEXT,
    session_id VARCHAR(36),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_diet_user_id ON tbl_diet_record(user_id);
CREATE INDEX idx_diet_meal_time ON tbl_diet_record(meal_time);
CREATE INDEX idx_diet_meal_type ON tbl_diet_record(meal_type);

COMMENT ON TABLE tbl_diet_record IS 'é¥®é£Ÿè®°å½•è¡¨';
COMMENT ON COLUMN tbl_diet_record.meal_type IS 'é¤æ¬¡ç±»å‹';
COMMENT ON COLUMN tbl_diet_record.food_items IS 'é£Ÿç‰©æ¸…å•ï¼ˆJSONæ•°ç»„ï¼‰';
COMMENT ON COLUMN tbl_diet_record.total_calories IS 'æ€»çƒ­é‡ï¼ˆåƒå¡ï¼‰';
COMMENT ON COLUMN tbl_diet_record.carbohydrate IS 'ç¢³æ°´åŒ–åˆç‰©ï¼ˆå…‹ï¼‰';
COMMENT ON COLUMN tbl_diet_record.protein IS 'è›‹ç™½è´¨ï¼ˆå…‹ï¼‰';
COMMENT ON COLUMN tbl_diet_record.fat IS 'è„‚è‚ªï¼ˆå…‹ï¼‰';
COMMENT ON COLUMN tbl_diet_record.fiber IS 'è†³é£Ÿçº¤ç»´ï¼ˆå…‹ï¼‰';
```

#### 4.2.9 è¥å…»æˆåˆ†æ•°æ®åº“è¡¨ (tbl_nutrition_database)

```sql
CREATE TABLE tbl_nutrition_database (
    nutrition_id VARCHAR(36) PRIMARY KEY,
    food_name VARCHAR(200) NOT NULL,
    category VARCHAR(50),
    calories_per_100g NUMERIC(8, 2),
    carbohydrate_per_100g NUMERIC(8, 2),
    protein_per_100g NUMERIC(8, 2),
    fat_per_100g NUMERIC(8, 2),
    fiber_per_100g NUMERIC(8, 2),
    source VARCHAR(100),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_nutrition_food_name ON tbl_nutrition_database(food_name);
CREATE INDEX idx_nutrition_category ON tbl_nutrition_database(category);

COMMENT ON TABLE tbl_nutrition_database IS 'è¥å…»æˆåˆ†æ•°æ®åº“';
COMMENT ON COLUMN tbl_nutrition_database.food_name IS 'é£Ÿç‰©åç§°';
COMMENT ON COLUMN tbl_nutrition_database.category IS 'é£Ÿç‰©åˆ†ç±»';
COMMENT ON COLUMN tbl_nutrition_database.calories_per_100g IS 'æ¯100å…‹çƒ­é‡ï¼ˆåƒå¡ï¼‰';
COMMENT ON COLUMN tbl_nutrition_database.source IS 'æ•°æ®æ¥æº';
```

#### 4.2.10 è¿åŠ¨è®°å½•è¡¨ (tbl_exercise_record)

```sql
CREATE TABLE tbl_exercise_record (
    record_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    exercise_type VARCHAR(50) NOT NULL,  -- walking/running/cycling/swimming/yoga/...
    duration INTEGER NOT NULL,  -- åˆ†é’Ÿ
    distance NUMERIC(8, 2),  -- å…¬é‡Œ
    calories_burned NUMERIC(8, 2),
    start_time TIMESTAMP WITH TIME ZONE,
    end_time TIMESTAMP WITH TIME ZONE,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_exercise_user_id ON tbl_exercise_record(user_id);
CREATE INDEX idx_exercise_start_time ON tbl_exercise_record(start_time);
CREATE INDEX idx_exercise_type ON tbl_exercise_record(exercise_type);

COMMENT ON TABLE tbl_exercise_record IS 'è¿åŠ¨è®°å½•è¡¨';
COMMENT ON COLUMN tbl_exercise_record.exercise_type IS 'è¿åŠ¨ç±»å‹';
COMMENT ON COLUMN tbl_exercise_record.duration IS 'æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰';
COMMENT ON COLUMN tbl_exercise_record.distance IS 'è·ç¦»ï¼ˆå…¬é‡Œï¼‰';
COMMENT ON COLUMN tbl_exercise_record.calories_burned IS 'æ¶ˆè€—çƒ­é‡ï¼ˆåƒå¡ï¼‰';
```

#### 4.2.11 é—®è¯Šè®°å½•è¡¨ (tbl_consultation)

```sql
CREATE TABLE tbl_consultation (
    consultation_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    consultation_type VARCHAR(30) NOT NULL,  -- digital_human/text_image
    status VARCHAR(20) DEFAULT 'ongoing',  -- ongoing/completed/cancelled
    chief_complaint TEXT,
    start_time TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    end_time TIMESTAMP WITH TIME ZONE,
    message_count INTEGER DEFAULT 0,
    rating INTEGER,  -- 1-5
    comment TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_consultation_user_id ON tbl_consultation(user_id);
CREATE INDEX idx_consultation_status ON tbl_consultation(status);
CREATE INDEX idx_consultation_start_time ON tbl_consultation(start_time);

COMMENT ON TABLE tbl_consultation IS 'é—®è¯Šè®°å½•è¡¨';
COMMENT ON COLUMN tbl_consultation.consultation_type IS 'é—®è¯Šç±»å‹';
COMMENT ON COLUMN tbl_consultation.chief_complaint IS 'ä¸»è¯‰';
COMMENT ON COLUMN tbl_consultation.rating IS 'è¯„åˆ†ï¼ˆ1-5æ˜Ÿï¼‰';
```

#### 4.2.12 é—®è¯Šæ¶ˆæ¯è¡¨ (tbl_consultation_message)

```sql
CREATE TABLE tbl_consultation_message (
    message_id VARCHAR(36) PRIMARY KEY,
    consultation_id VARCHAR(36) NOT NULL REFERENCES tbl_consultation(consultation_id),
    sender_id VARCHAR(36) NOT NULL,
    sender_type VARCHAR(20) NOT NULL,  -- user/doctor/digital_human
    message_type VARCHAR(20) NOT NULL,  -- text/image/audio
    content TEXT,
    attachment_url VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_consultation_message_consultation_id ON tbl_consultation_message(consultation_id);
CREATE INDEX idx_consultation_message_created_at ON tbl_consultation_message(created_at);

COMMENT ON TABLE tbl_consultation_message IS 'é—®è¯Šæ¶ˆæ¯è¡¨';
COMMENT ON COLUMN tbl_consultation_message.sender_type IS 'å‘é€è€…ç±»å‹';
COMMENT ON COLUMN tbl_consultation_message.message_type IS 'æ¶ˆæ¯ç±»å‹';
```

#### 4.2.13 è®¢é˜…å¥—é¤è¡¨ (tbl_subscription_plan)

```sql
CREATE TABLE tbl_subscription_plan (
    plan_id VARCHAR(36) PRIMARY KEY,
    plan_name VARCHAR(100) NOT NULL,
    description TEXT,
    price NUMERIC(10, 2) NOT NULL,
    duration INTEGER NOT NULL,  -- å¤©
    features JSONB,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_subscription_plan_is_active ON tbl_subscription_plan(is_active);

COMMENT ON TABLE tbl_subscription_plan IS 'è®¢é˜…å¥—é¤è¡¨';
COMMENT ON COLUMN tbl_subscription_plan.price IS 'ä»·æ ¼ï¼ˆå…ƒï¼‰';
COMMENT ON COLUMN tbl_subscription_plan.duration IS 'æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰';
COMMENT ON COLUMN tbl_subscription_plan.features IS 'åŠŸèƒ½åˆ—è¡¨ï¼ˆJSONï¼‰';
```

#### 4.2.14 è®¢é˜…è®¢å•è¡¨ (tbl_subscription_order)

```sql
CREATE TABLE tbl_subscription_order (
    order_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    plan_id VARCHAR(36) NOT NULL REFERENCES tbl_subscription_plan(plan_id),
    amount NUMERIC(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',  -- pending/paid/cancelled/refunded
    payment_method VARCHAR(20),  -- wechat/alipay
    payment_transaction_id VARCHAR(100),
    paid_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_subscription_order_user_id ON tbl_subscription_order(user_id);
CREATE INDEX idx_subscription_order_status ON tbl_subscription_order(status);
CREATE INDEX idx_subscription_order_created_at ON tbl_subscription_order(created_at);

COMMENT ON TABLE tbl_subscription_order IS 'è®¢é˜…è®¢å•è¡¨';
COMMENT ON COLUMN tbl_subscription_order.payment_transaction_id IS 'æ”¯ä»˜äº¤æ˜“å·';
```

#### 4.2.15 ç”¨æˆ·è®¢é˜…è¡¨ (tbl_user_subscription)

```sql
CREATE TABLE tbl_user_subscription (
    subscription_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL REFERENCES tbl_user(user_id),
    plan_id VARCHAR(36) NOT NULL REFERENCES tbl_subscription_plan(plan_id),
    status VARCHAR(20) DEFAULT 'active',  -- active/expired/cancelled
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE NOT NULL,
    auto_renew BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_subscription_user_id ON tbl_user_subscription(user_id);
CREATE INDEX idx_user_subscription_status ON tbl_user_subscription(status);
CREATE INDEX idx_user_subscription_end_date ON tbl_user_subscription(end_date);

COMMENT ON TABLE tbl_user_subscription IS 'ç”¨æˆ·è®¢é˜…è¡¨';
COMMENT ON COLUMN tbl_user_subscription.auto_renew IS 'æ˜¯å¦è‡ªåŠ¨ç»­è´¹';
```

#### 4.2.16 æ”¯ä»˜å›è°ƒæ—¥å¿—è¡¨ (tbl_payment_callback_log)

```sql
CREATE TABLE tbl_payment_callback_log (
    log_id VARCHAR(36) PRIMARY KEY,
    order_id VARCHAR(36) NOT NULL,
    transaction_id VARCHAR(100),
    callback_data TEXT NOT NULL,  -- å®Œæ•´çš„å›è°ƒæ•°æ®ï¼ˆJSONï¼‰
    result VARCHAR(20) NOT NULL,  -- success/failure/duplicate
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_payment_callback_log_order_id ON tbl_payment_callback_log(order_id);
CREATE INDEX idx_payment_callback_log_transaction_id ON tbl_payment_callback_log(transaction_id);
CREATE INDEX idx_payment_callback_log_created_at ON tbl_payment_callback_log(created_at);

COMMENT ON TABLE tbl_payment_callback_log IS 'ğŸ”¥ æ”¯ä»˜å›è°ƒæ—¥å¿—è¡¨ - ç”¨äºå®¡è®¡å’Œæ’æŸ¥æ”¯ä»˜é—®é¢˜';
COMMENT ON COLUMN tbl_payment_callback_log.callback_data IS 'å®Œæ•´çš„å›è°ƒæ•°æ®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN tbl_payment_callback_log.result IS 'å¤„ç†ç»“æœï¼šsuccess-æˆåŠŸï¼Œfailure-å¤±è´¥ï¼Œduplicate-é‡å¤';
```

#### 4.2.17 è®¢å•è¡¨å¢åŠ ä¹è§‚é”ç‰ˆæœ¬å·

```sql
-- ä¸ºè®¢é˜…è®¢å•è¡¨å¢åŠ ç‰ˆæœ¬å·å­—æ®µï¼ˆç”¨äºä¹è§‚é”ï¼‰
ALTER TABLE tbl_subscription_order ADD COLUMN version INTEGER DEFAULT 0;

COMMENT ON COLUMN tbl_subscription_order.version IS 'ğŸ”¥ ä¹è§‚é”ç‰ˆæœ¬å· - é˜²æ­¢å¹¶å‘æ›´æ–°è®¢å•çŠ¶æ€';
```

### 4.3 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE tangxiaowen
    WITH
    ENCODING = 'UTF8'
    LC_COLLATE = 'zh_CN.UTF-8'
    LC_CTYPE = 'zh_CN.UTF-8'
    TEMPLATE = template0;

-- è¿æ¥åˆ°æ•°æ®åº“
\c tangxiaowen;

-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";  -- UUIDç”Ÿæˆ
CREATE EXTENSION IF NOT EXISTS "pg_trgm";    -- æ¨¡ç³Šæœç´¢

-- æ‰§è¡Œä¸Šè¿°æ‰€æœ‰å»ºè¡¨è¯­å¥...

-- åˆå§‹åŒ–è®¢é˜…å¥—é¤æ•°æ®
INSERT INTO tbl_subscription_plan (plan_id, plan_name, description, price, duration, features, is_active)
VALUES
    (uuid_generate_v4(), 'æœˆåº¦ä¼šå‘˜', 'äº«å—å›¾æ–‡é—®è¯Šç­‰å¢å€¼æœåŠ¡', 29.90, 30, 
     '{"text_consultation": true, "priority_support": true}', true),
    (uuid_generate_v4(), 'å­£åº¦ä¼šå‘˜', 'äº«å—å›¾æ–‡é—®è¯Šç­‰å¢å€¼æœåŠ¡ï¼Œæ›´ä¼˜æƒ ', 79.90, 90, 
     '{"text_consultation": true, "priority_support": true, "health_report": true}', true),
    (uuid_generate_v4(), 'å¹´åº¦ä¼šå‘˜', 'äº«å—å…¨å¹´å›¾æ–‡é—®è¯ŠæœåŠ¡ï¼Œæœ€åˆ’ç®—', 299.00, 365, 
     '{"text_consultation": true, "priority_support": true, "health_report": true, "vip_badge": true}', true);
```

### 4.4 æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆ†åŒºè¡¨**: å¯¹ `tbl_glucose_record`ã€`tbl_diet_record`ã€`tbl_exercise_record` ç­‰å¤§è¡¨æŒ‰æ—¶é—´åˆ†åŒºï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚

2. **ç‰©åŒ–è§†å›¾**: åˆ›å»ºç‰©åŒ–è§†å›¾å­˜å‚¨ç”¨æˆ·ç»Ÿè®¡æ•°æ®ï¼Œå®šæœŸåˆ·æ–°ï¼Œé¿å…å®æ—¶è®¡ç®—ã€‚

3. **è¿æ¥æ± **: ä½¿ç”¨ HikariCP è¿æ¥æ± ï¼Œé…ç½®åˆç†çš„æœ€å¤§è¿æ¥æ•°å’Œè¶…æ—¶æ—¶é—´ã€‚

4. **æ…¢æŸ¥è¯¢ç›‘æ§**: å¼€å¯ PostgreSQL æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œåˆ†æå¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢ã€‚

5. **å®šæœŸæ¸…ç†**: å®šæœŸå½’æ¡£æˆ–åˆ é™¤è¿‡æœŸçš„å¯¹è¯æ¶ˆæ¯ã€æ—¥å¿—ç­‰æ•°æ®ã€‚

---

## 5. é˜¿é‡Œç™¾ç‚¼é›†æˆæ–¹æ¡ˆ

### 5.1 ç™¾ç‚¼æœåŠ¡ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | ä½¿ç”¨çš„ç™¾ç‚¼èƒ½åŠ› | è¯´æ˜ |
|------|--------------|------|
| æ•°å­—äººå¯¹è¯ | å¯¹è¯æ¨¡å‹ + TTS/ASR | å®ç°å¾åŒ»ç”Ÿæ•°å­—äººçš„æ–‡å­—å’Œè¯­éŸ³äº¤äº’ |
| ä¿¡æ¯å¼•å¯¼å½•å…¥ | å¯¹è¯æ¨¡å‹ + ä¿¡æ¯æŠ½å– | é€šè¿‡å¯¹è¯å¼•å¯¼ç”¨æˆ·å½•å…¥ä¿¡æ¯ï¼Œå¹¶æå–ç»“æ„åŒ–æ•°æ® |
| é£Ÿç‰©è¯†åˆ« | è§†è§‰æ¨¡å‹ | è¯†åˆ«é£Ÿç‰©ç…§ç‰‡ä¸­çš„é£Ÿç‰©ç§ç±»å’Œä¼°ç®—é‡é‡ |
| é—®è¯Šå’¨è¯¢ | å¯¹è¯æ¨¡å‹ + çŸ¥è¯†åº“ | åŸºäºåŒ»å­¦çŸ¥è¯†åº“å›ç­”ç”¨æˆ·é—®é¢˜ |

### 5.2 ç™¾ç‚¼é…ç½®

**application.yml**
```yaml
bailianai:
  api:
    key: ${BAILIANAI_API_KEY}
    endpoint: https://dashscope.aliyuncs.com/api/v1
  models:
    chat: qwen-plus  # å¯¹è¯æ¨¡å‹
    vision: qwen-vl-plus  # è§†è§‰æ¨¡å‹
  tts:
    voice-id: xiaoyun  # å¾åŒ»ç”Ÿå£°éŸ³IDï¼ˆéœ€è¦å®šåˆ¶ï¼‰
  knowledge-base:
    medical: kb-medical-diabetes  # ç³–å°¿ç—…åŒ»å­¦çŸ¥è¯†åº“ID
```

### 5.3 çŸ¥è¯†åº“æ„å»º

#### 5.3.1 çŸ¥è¯†åº“å†…å®¹
- ç³–å°¿ç—…åŸºç¡€çŸ¥è¯†
- è¡€ç³–ç®¡ç†æŒ‡å—
- é¥®é£Ÿè¥å…»å»ºè®®
- è¿åŠ¨é”»ç‚¼æ–¹æ¡ˆ
- å¸¸è§é—®é¢˜è§£ç­”
- ç”¨è¯æŒ‡å¯¼ï¼ˆéœ€è¦å¾åŒ»ç”Ÿæä¾›ä¸“ä¸šå†…å®¹ï¼‰

#### 5.3.2 çŸ¥è¯†åº“æ›´æ–°æµç¨‹
1. å¾åŒ»ç”Ÿæä¾›åŒ»å­¦å†…å®¹æ–‡æ¡£
2. æ•´ç†ä¸ºç»“æ„åŒ–æ•°æ®ï¼ˆMarkdown æ ¼å¼ï¼‰
3. ä¸Šä¼ åˆ°é˜¿é‡Œç™¾ç‚¼çŸ¥è¯†åº“
4. é…ç½®çŸ¥è¯†åº“æ£€ç´¢ç­–ç•¥
5. æµ‹è¯•é—®ç­”æ•ˆæœå¹¶ä¼˜åŒ–

---

## 6. éƒ¨ç½²æ¶æ„

### 6.1 æœåŠ¡å™¨é…ç½®å»ºè®®

**ç”Ÿäº§ç¯å¢ƒ**
- **åº”ç”¨æœåŠ¡å™¨**: 4æ ¸8G Ã— 2å°ï¼ˆä¸»å¤‡ï¼‰
- **æ•°æ®åº“æœåŠ¡å™¨**: 8æ ¸16G Ã— 1å°ï¼ˆä¸»ï¼‰ + 4æ ¸8G Ã— 1å°ï¼ˆä»ï¼Œåªè¯»ï¼‰
- **Redis æœåŠ¡å™¨**: 2æ ¸4G Ã— 1å°
- **è´Ÿè½½å‡è¡¡**: SLB / Nginx
- **å¯¹è±¡å­˜å‚¨**: é˜¿é‡Œäº‘ OSS

**Showcase æ¼”ç¤ºç¯å¢ƒ**
- **å•æœºéƒ¨ç½²**: 4æ ¸8G Ã— 1å°ï¼ˆåº”ç”¨+æ•°æ®åº“ï¼‰
- **Redis**: å†…ç½®æˆ–å•ç‹¬ 2æ ¸2G
- **å¯¹è±¡å­˜å‚¨**: é˜¿é‡Œäº‘ OSS

### 6.2 æŠ€æœ¯æ ˆæ¸…å•

**åç«¯**
- JDK 21
- Spring Boot 3.2.x
- MyBatis-Plus 3.5.x
- PostgreSQL JDBC Driver
- Redis Lettuce Client
- Alibaba Cloud SDK (ç™¾ç‚¼ã€OSS)
- Hutool (å·¥å…·ç±»)
- Lombok
- Jackson (JSON å¤„ç†)

**ä¸­é—´ä»¶**
- PostgreSQL 15+
- Redis 7.x
- Nginx / SLB

**éƒ¨ç½²**
- Docker
- Docker Compose
- Kubernetes (å¯é€‰)

---

## 7. å¼€å‘è®¡åˆ’å»ºè®®

### 7.1 è¿­ä»£è§„åˆ’ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

**ç¬¬ä¸€é˜¶æ®µï¼ˆ2å‘¨ï¼‰ï¼šåŸºç¡€åŠŸèƒ½**
- ç”¨æˆ·æ¨¡å—ï¼šè®¿å®¢æ³¨å†Œã€ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- å®‰å…¨æ¨¡å—ï¼šæ•°æ®åŠ å¯†ã€éšç§åè®®
- è¡€ç³–æ¨¡å—ï¼šè®°å½•å’Œå±•ç¤º
- æ•°æ®åº“åˆå§‹åŒ–

**ç¬¬äºŒé˜¶æ®µï¼ˆ3å‘¨ï¼‰ï¼šæ•°å­—äººäº¤äº’**
- æ•°å­—äººæ¨¡å—ï¼šä¼šè¯ç®¡ç†ã€æ¶ˆæ¯å¤„ç†
- é˜¿é‡Œç™¾ç‚¼é›†æˆ
- ä¿¡æ¯å¼•å¯¼å½•å…¥ï¼ˆä¸ªäººä¿¡æ¯ã€ç—…ä¾‹ä¿¡æ¯ï¼‰
- æ•°å­—äººå¼•å¯¼è®°å½•è¡€ç³–

**ç¬¬ä¸‰é˜¶æ®µï¼ˆ3å‘¨ï¼‰ï¼šé¥®é£Ÿä¸è¿åŠ¨**
- é¥®é£Ÿæ¨¡å—ï¼šè®°å½•ã€æ‹ç…§è¯†åˆ«
- è¿åŠ¨æ¨¡å—ï¼šè®°å½•å’Œæ¶ˆè€—è®¡ç®—
- é¦–é¡µæ¨¡å—ï¼šæ•°æ®èšåˆå±•ç¤º
- æ•°å­—äººå¼•å¯¼è®°å½•é¥®é£Ÿ

**ç¬¬å››é˜¶æ®µï¼ˆ2å‘¨ï¼‰ï¼šé—®è¯Šä¸è®¢é˜…**
- é—®è¯Šæ¨¡å—ï¼šæ•°å­—äººé—®è¯Š
- è®¢é˜…æ¨¡å—ï¼šå¥—é¤ç®¡ç†ã€è®¢å•å¤„ç†
- å›¾æ–‡é—®è¯Šï¼ˆæ”¶è´¹ï¼‰

**ç¬¬äº”é˜¶æ®µï¼ˆ1å‘¨ï¼‰ï¼šæµ‹è¯•ä¸ä¼˜åŒ–**
- åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–
- å®‰å…¨åŠ å›º
- æ–‡æ¡£å®Œå–„

### 7.2 æŠ€æœ¯é£é™©ç‚¹

1. **é˜¿é‡Œç™¾ç‚¼é›†æˆå¤æ‚åº¦**: éœ€è¦å……åˆ†æµ‹è¯•å¯¹è¯æ•ˆæœå’ŒçŸ¥è¯†åº“å¬å›å‡†ç¡®æ€§ã€‚
   - **ç¼“è§£æªæ–½**: æå‰è¿›è¡ŒæŠ€æœ¯é¢„ç ”ï¼Œå‡†å¤‡ Plan Bï¼ˆå¦‚æœç™¾ç‚¼æ•ˆæœä¸ä½³ï¼Œå¯é™çº§ä¸ºæ¨¡æ¿å¯¹è¯ï¼‰ã€‚

2. **æ•°æ®åŠ å¯†æ€§èƒ½**: å¤§é‡åŠ å¯†è§£å¯†æ“ä½œå¯èƒ½å½±å“æ€§èƒ½ã€‚
   - **ç¼“è§£æªæ–½**: ä½¿ç”¨ç¼“å­˜å‡å°‘è§£å¯†æ¬¡æ•°ï¼Œæ•æ„Ÿå­—æ®µæŒ‰éœ€è§£å¯†ã€‚

3. **é£Ÿç‰©è¯†åˆ«å‡†ç¡®ç‡**: AI è¯†åˆ«å¯èƒ½ä¸å‡†ç¡®ã€‚
   - **ç¼“è§£æªæ–½**: å…è®¸ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹è¯†åˆ«ç»“æœï¼Œæ”¶é›†åé¦ˆæ•°æ®ä¼˜åŒ–æ¨¡å‹ã€‚

4. **å¹¶å‘å‹åŠ›**: Showcase æœŸé—´å¯èƒ½æœ‰å¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—®ã€‚
   - **ç¼“è§£æªæ–½**: ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œé™æµä¿æŠ¤æ ¸å¿ƒæ¥å£ã€‚

---

## 8. é™„å½•

### 8.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| æ•°å­—äºº | Digital Human | AI é©±åŠ¨çš„è™šæ‹ŸåŒ»ç”ŸåŠ©æ‰‹ |
| è®¿å®¢æ¨¡å¼ | Guest Mode | å…ç™»å½•ä½“éªŒæ¨¡å¼ |
| å¾åŒ»ç”Ÿ | Dr. Xu | æ•°å­—äººåŒ»ç”Ÿè§’è‰²åç§° |
| ç™¾ç‚¼ | Bailian | é˜¿é‡Œäº‘ç™¾ç‚¼ AI å¹³å° |
| TTS | Text-to-Speech | æ–‡å­—è½¬è¯­éŸ³ |
| ASR | Automatic Speech Recognition | è¯­éŸ³è¯†åˆ« |

### 8.2 å‚è€ƒèµ„æ–™

- [Spring Boot å®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-boot)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [é˜¿é‡Œç™¾ç‚¼å¼€å‘æ–‡æ¡£](https://help.aliyun.com/product/2400256.html)
- [MyBatis-Plus å®˜æ–¹æ–‡æ¡£](https://baomidou.com/)

---

## 9. æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è®¾è®¡äº†"ç³–å°ç¨³"åº”ç”¨çš„æ‰€æœ‰ P0 éœ€æ±‚ï¼ŒåŒ…æ‹¬ï¼š

âœ… **9 ä¸ªæ ¸å¿ƒæ¨¡å—**ï¼šç”¨æˆ·ã€æ•°å­—äººã€è¡€ç³–ã€é¥®é£Ÿã€è¿åŠ¨ã€é—®è¯Šã€è®¢é˜…ã€é¦–é¡µã€å®‰å…¨
âœ… **50+ ä¸ª Java ç±»**ï¼šControllerã€Serviceã€Mapper ç­‰
âœ… **40+ ä¸ª RESTful API**ï¼šè¦†ç›–æ‰€æœ‰ä¸šåŠ¡åœºæ™¯
âœ… **15 å¼ æ•°æ®è¡¨**ï¼šå®Œæ•´çš„æ•°æ®åº“è®¾è®¡
âœ… **é˜¿é‡Œç™¾ç‚¼é›†æˆæ–¹æ¡ˆ**ï¼šæ•°å­—äººå¯¹è¯ã€é£Ÿç‰©è¯†åˆ«
âœ… **å®‰å…¨åˆè§„è®¾è®¡**ï¼šæ•°æ®åŠ å¯†ã€éšç§åè®®ç®¡ç†
âœ… **éƒ¨ç½²æ–¹æ¡ˆ**ï¼šç”Ÿäº§ç¯å¢ƒå’Œæ¼”ç¤ºç¯å¢ƒé…ç½®

æ‰€æœ‰è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
- **æ¨¡å—åŒ–**ï¼šé«˜å†…èšä½è€¦åˆ
- **å¯æ‰©å±•**ï¼šæ”¯æŒåç»­åŠŸèƒ½æ‰©å±•
- **å®‰å…¨æ€§**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **åˆè§„æ€§**ï¼šæ»¡è¶³éšç§ä¿æŠ¤æ³•å¾‹è¦æ±‚
- **æ€§èƒ½**ï¼šç¼“å­˜ã€ç´¢å¼•ã€åˆ†é¡µä¼˜åŒ–
- **å¯ç»´æŠ¤**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£

---

## 10. æŠ€æœ¯ä¼˜åŒ–æ€»ç»“ï¼ˆv1.1 æ–°å¢ï¼‰

### 10.1 æ ¸å¿ƒä¼˜åŒ–ç‚¹å¯¹æ¯”

| ä¼˜åŒ–é¡¹ | åŸè®¾è®¡ | ä¼˜åŒ–å | æ”¶ç›Š |
|--------|--------|--------|------|
| **æ•°å­—äººäº¤äº’åè®®** | REST åŒæ­¥è¯·æ±‚ | SSE æµå¼æ¨é€ | âœ… å»¶è¿Ÿä» 5-8 ç§’é™ä½è‡³ 0.5 ç§’é¦–å­—å“åº”<br>âœ… æ”¯æŒæ‰“å­—æœºæ•ˆæœ<br>âœ… ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ |
| **AI Agent é›†æˆ** | ä»…è¿”å›æ–‡æœ¬ | Function Calling å·¥å…·æ‰§è¡Œ | âœ… AI å¯ç›´æ¥è°ƒç”¨ä¸šåŠ¡æ¥å£<br>âœ… è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“<br>âœ… å‡å°‘ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ |
| **æ•æ„Ÿæ•°æ®æ£€ç´¢** | ä»…åŠ å¯†å­˜å‚¨ | åŠ å¯† + å“ˆå¸Œç´¢å¼• | âœ… æ”¯æŒæ‰‹æœºå·/èº«ä»½è¯æŸ¥è¯¢<br>âœ… ä¿æŒæ•°æ®å®‰å…¨æ€§<br>âœ… æŸ¥è¯¢æ€§èƒ½æ— æŸå¤± |
| **è®¿å®¢è½¬æ­£é€»è¾‘** | æœªæ˜ç¡® | åŒç­–ç•¥æ•°æ®è¿ç§» | âœ… æ–°ç”¨æˆ·ç›´æ¥å‡çº§<br>âœ… è€ç”¨æˆ·æ•°æ®åˆå¹¶<br>âœ… æ— æ•°æ®ä¸¢å¤±é£é™© |
| **æ–‡ä»¶ä¸Šä¼ ** | æœªå®šä¹‰ | OSS ç›´ä¼  + åç«¯ä¸­è½¬ | âœ… P0 å¿«é€Ÿä¸Šçº¿ï¼ˆä¸­è½¬ï¼‰<br>âœ… P1 æ€§èƒ½ä¼˜åŒ–ï¼ˆç›´ä¼ ï¼‰<br>âœ… èŠ‚çœå¸¦å®½æˆæœ¬ 90%+ |
| **æ”¯ä»˜å›è°ƒ** | ç®€å•å¤„ç† | å¹‚ç­‰æ€§ä¿è¯ | âœ… é˜²æ­¢é‡å¤æ‰£è´¹<br>âœ… åˆ†å¸ƒå¼é” + ä¹è§‚é”<br>âœ… å®Œæ•´å®¡è®¡æ—¥å¿— |

### 10.2 SSE æµå¼äº¤äº’è¯¦è§£

#### 10.2.1 å‰ç«¯é›†æˆç¤ºä¾‹ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰

```javascript
// å¾®ä¿¡å°ç¨‹åºè°ƒç”¨ SSE æ¥å£
wx.request({
  url: 'https://api.tangxiaowen.com/api/v1/digital-human/sessions/{sessionId}/messages/stream',
  method: 'POST',
  data: {
    content: 'æˆ‘åˆšæµ‹äº†è¡€ç³–6.5',
    contentType: 'text'
  },
  enableChunked: true,  // ğŸ”¥ å…³é”®ï¼šå¯ç”¨åˆ†å—ä¼ è¾“
  success(res) {
    // SSE äº‹ä»¶å¤„ç†
    res.on('data', (chunk) => {
      const lines = chunk.toString().split('\n');
      lines.forEach(line => {
        if (line.startsWith('data: ')) {
          const data = JSON.parse(line.substring(6));
          handleSseEvent(data);
        }
      });
    });
  }
});

function handleSseEvent(data) {
  switch(data.event) {
    case 'thinking':
      // æ˜¾ç¤º"å¾åŒ»ç”Ÿæ­£åœ¨æ€è€ƒ..."
      showThinking();
      break;
    case 'text_chunk':
      // é€å­—è¿½åŠ åˆ°å¯¹è¯æ¡†ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
      appendText(data.text);
      break;
    case 'audio_chunk':
      // æ’­æ”¾è¯­éŸ³ç‰‡æ®µ
      playAudio(data.audioUrl);
      break;
    case 'tool_call':
      // æ˜¾ç¤º"æ­£åœ¨ä¸ºæ‚¨è®°å½•..."
      showToolExecution(data.toolName);
      break;
    case 'done':
      // å¯¹è¯å®Œæˆ
      hideThinking();
      break;
  }
}
```

#### 10.2.2 åç«¯ SSE å®ç°ç¤ºä¾‹

```java
@PostMapping(value = "/sessions/{sessionId}/messages/stream", 
             produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter streamMessage(@PathVariable String sessionId,
                                @RequestBody SendMessageRequest request) {
    SseEmitter emitter = new SseEmitter(60000L); // 60ç§’è¶…æ—¶
    
    // å¼‚æ­¥å¤„ç†ï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
    CompletableFuture.runAsync(() -> {
        try {
            // 1. å‘é€ thinking äº‹ä»¶
            emitter.send(SseEmitter.event()
                .name("thinking")
                .data("{\"status\":\"thinking\"}"));
            
            // 2. è°ƒç”¨ç™¾ç‚¼æµå¼ API
            bailianAIClient.chatStream(request.getContent(), response -> {
                // 3. é€å—æ¨é€æ–‡æœ¬
                emitter.send(SseEmitter.event()
                    .name("text_chunk")
                    .data("{\"text\":\"" + response.getText() + "\"}"));
                
                // 4. æ£€æµ‹ Function Call
                if (response.hasFunctionCall()) {
                    emitter.send(SseEmitter.event()
                        .name("tool_call")
                        .data("{\"toolName\":\"" + response.getFunctionName() + "\"}"));
                    
                    // æ‰§è¡Œå·¥å…·
                    String toolResult = agentToolExecutor.executeTool(
                        response.getFunctionName(),
                        response.getFunctionParams(),
                        request.getUserId()
                    );
                    
                    emitter.send(SseEmitter.event()
                        .name("tool_result")
                        .data("{\"result\":\"" + toolResult + "\"}"));
                }
            });
            
            // 5. ç”Ÿæˆå¹¶æ¨é€éŸ³é¢‘
            String audioUrl = bailianAIClient.textToSpeech(fullText, "xiaoyun");
            emitter.send(SseEmitter.event()
                .name("audio_chunk")
                .data("{\"audioUrl\":\"" + audioUrl + "\"}"));
            
            // 6. å‘é€å®Œæˆäº‹ä»¶
            emitter.send(SseEmitter.event()
                .name("done")
                .data("{\"messageId\":\"msg-123\"}"));
            
            emitter.complete();
            
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    });
    
    return emitter;
}
```

### 10.3 é˜¿é‡Œç™¾ç‚¼ Function Calling é…ç½®

#### 10.3.1 ç™¾ç‚¼æ§åˆ¶å°å·¥å…·å®šä¹‰

åœ¨é˜¿é‡Œç™¾ç‚¼æ§åˆ¶å°ï¼Œéœ€è¦ä¸º Agent é…ç½®ä»¥ä¸‹å·¥å…·ï¼š

```json
{
  "tools": [
    {
      "name": "save_blood_sugar",
      "description": "ä¿å­˜ç”¨æˆ·çš„è¡€ç³–æµ‹é‡è®°å½•ã€‚å½“ç”¨æˆ·æåˆ°è¡€ç³–å€¼ã€æµ‹è¡€ç³–æ—¶è°ƒç”¨æ­¤å·¥å…·ã€‚",
      "parameters": {
        "type": "object",
        "properties": {
          "userId": {
            "type": "string",
            "description": "ç”¨æˆ·ID"
          },
          "value": {
            "type": "number",
            "description": "è¡€ç³–å€¼ï¼ˆmmol/Lï¼‰"
          },
          "measurementType": {
            "type": "string",
            "enum": ["fasting", "before_meal", "after_meal", "before_sleep", "random"],
            "description": "æµ‹é‡ç±»å‹ï¼šfasting-ç©ºè…¹ï¼Œbefore_meal-é¤å‰ï¼Œafter_meal-é¤åï¼Œbefore_sleep-ç¡å‰ï¼Œrandom-éšæœº"
          },
          "measurementTime": {
            "type": "string",
            "description": "æµ‹é‡æ—¶é—´ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€è¡¨è¾¾ï¼Œå¦‚'åˆšæ‰'ã€'æ—©ä¸Š8ç‚¹'ã€'æ˜¨å¤©æ™šä¸Š'"
          }
        },
        "required": ["userId", "value", "measurementType"]
      }
    },
    {
      "name": "save_diet",
      "description": "ä¿å­˜ç”¨æˆ·çš„é¥®é£Ÿè®°å½•ã€‚å½“ç”¨æˆ·æè¿°åƒäº†ä»€ä¹ˆé£Ÿç‰©æ—¶è°ƒç”¨æ­¤å·¥å…·ã€‚",
      "parameters": {
        "type": "object",
        "properties": {
          "userId": {
            "type": "string",
            "description": "ç”¨æˆ·ID"
          },
          "mealType": {
            "type": "string",
            "enum": ["breakfast", "lunch", "dinner", "snack"],
            "description": "é¤æ¬¡ç±»å‹"
          },
          "foodItems": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "foodName": {"type": "string"},
                "weight": {"type": "number", "description": "é‡é‡ï¼ˆå…‹ï¼‰"}
              }
            },
            "description": "é£Ÿç‰©æ¸…å•"
          },
          "mealTime": {
            "type": "string",
            "description": "ç”¨é¤æ—¶é—´"
          }
        },
        "required": ["userId", "mealType", "foodItems"]
      }
    },
    {
      "name": "query_today_glucose",
      "description": "æŸ¥è¯¢ç”¨æˆ·ä»Šæ—¥çš„è¡€ç³–è®°å½•ã€‚å½“ç”¨æˆ·è¯¢é—®ä»Šå¤©è¡€ç³–æƒ…å†µæ—¶è°ƒç”¨æ­¤å·¥å…·ã€‚",
      "parameters": {
        "type": "object",
        "properties": {
          "userId": {"type": "string", "description": "ç”¨æˆ·ID"}
        },
        "required": ["userId"]
      }
    }
  ]
}
```

#### 10.3.2 åç«¯å·¥å…·æ‰§è¡Œå™¨æ³¨å†Œ

```java
@Configuration
public class AgentToolConfig {
    
    @Autowired
    private AgentToolExecutor toolExecutor;
    
    /**
     * æ³¨å†Œæ‰€æœ‰å·¥å…·åˆ°è·¯ç”±è¡¨
     */
    @PostConstruct
    public void registerTools() {
        ToolRegistry.register("save_blood_sugar", 
            (params, userId) -> toolExecutor.saveBloodSugar(
                userId,
                (Double) params.get("value"),
                (String) params.get("measurementType"),
                (String) params.get("measurementTime")
            )
        );
        
        ToolRegistry.register("save_diet",
            (params, userId) -> toolExecutor.saveDiet(
                userId,
                (String) params.get("mealType"),
                (List<Map<String, Object>>) params.get("foodItems"),
                (String) params.get("mealTime")
            )
        );
        
        ToolRegistry.register("query_today_glucose",
            (params, userId) -> toolExecutor.queryTodayGlucose(userId)
        );
    }
}
```

### 10.4 å®‰å…¨æ£€ç´¢ç­–ç•¥è¯¦è§£

#### 10.4.1 åŠ å¯†ä¸å“ˆå¸ŒåŒè½¨å­˜å‚¨

```java
/**
 * ä¿å­˜ç”¨æˆ·æ‰‹æœºå·ï¼ˆåŒè½¨å­˜å‚¨ï¼‰
 */
public void saveUserPhone(String userId, String phone) {
    User user = userMapper.selectByUserId(userId);
    
    // 1. åŠ å¯†å­˜å‚¨ï¼ˆç”¨äºå±•ç¤ºå’Œè§£å¯†ï¼‰
    String encryptedPhone = encryptionService.encrypt(phone);
    user.setEncryptedPhone(encryptedPhone);
    
    // 2. å“ˆå¸Œå­˜å‚¨ï¼ˆç”¨äºæ£€ç´¢ï¼‰
    String phoneHash = DigestUtils.sha256Hex(phone + globalSalt);
    user.setPhoneHash(phoneHash);
    
    userMapper.updateByUserId(user);
}

/**
 * é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
 */
public User findUserByPhone(String phone) {
    // 1. è®¡ç®—å“ˆå¸Œå€¼
    String phoneHash = DigestUtils.sha256Hex(phone + globalSalt);
    
    // 2. é€šè¿‡å“ˆå¸Œå€¼æŸ¥è¯¢
    User user = userMapper.selectByPhoneHash(phoneHash);
    
    // 3. è§£å¯†æ‰‹æœºå·ç”¨äºå±•ç¤º
    if (user != null) {
        String decryptedPhone = encryptionService.decrypt(user.getEncryptedPhone());
        user.setPhone(decryptedPhone); // è®¾ç½®åˆ°ä¸´æ—¶å­—æ®µï¼ˆä¸æŒä¹…åŒ–ï¼‰
    }
    
    return user;
}
```

#### 10.4.2 å…¨å±€ç›å€¼ç®¡ç†

```yaml
# application.yml
security:
  encryption:
    key: ${ENCRYPTION_KEY}  # AES å¯†é’¥ï¼ˆ32å­—èŠ‚ï¼Œä»é…ç½®ä¸­å¿ƒè¯»å–ï¼‰
    global-salt: ${GLOBAL_SALT}  # å…¨å±€ç›å€¼ï¼ˆç”¨äºå“ˆå¸Œï¼Œå®šæœŸè½®æ¢ï¼‰
```

**ç›å€¼è½®æ¢ç­–ç•¥**ï¼š
1. åˆå§‹ç›å€¼ï¼š`GLOBAL_SALT_V1`
2. 6ä¸ªæœˆåè½®æ¢ï¼š`GLOBAL_SALT_V2`
3. è½®æ¢æ—¶ä¿ç•™æ—§ç›å€¼ï¼Œæ”¯æŒåŒç‰ˆæœ¬æŸ¥è¯¢
4. åå°ä»»åŠ¡é€æ­¥é‡æ–°è®¡ç®—æ‰€æœ‰å“ˆå¸Œå€¼

### 10.5 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 10.5.1 Redis ç¼“å­˜ç­–ç•¥

```java
/**
 * ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
 * TTL: 30åˆ†é’Ÿ
 */
@Cacheable(value = "user", key = "#userId", unless = "#result == null")
public UserResponse getUserById(String userId) {
    // æŸ¥è¯¢æ•°æ®åº“
}

/**
 * é¦–é¡µæ•°æ®ç¼“å­˜
 * TTL: 5åˆ†é’Ÿ
 */
@Cacheable(value = "dashboard", key = "#userId")
public DashboardResponse getDashboard(String userId) {
    // èšåˆæŸ¥è¯¢
}

/**
 * è®¢é˜…çŠ¶æ€ç¼“å­˜
 * TTL: 10åˆ†é’Ÿ
 */
@Cacheable(value = "subscription", key = "#userId")
public SubscriptionStatusResponse getSubscriptionStatus(String userId) {
    // æŸ¥è¯¢è®¢é˜…
}
```

#### 10.5.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```sql
-- 1. å¤åˆç´¢å¼•ä¼˜åŒ–ï¼ˆè¡€ç³–æŸ¥è¯¢ï¼‰
CREATE INDEX idx_glucose_user_time ON tbl_glucose_record(user_id, measurement_time DESC);

-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆä»…ç´¢å¼•æ´»è·ƒç”¨æˆ·ï¼‰
CREATE INDEX idx_active_user ON tbl_user(user_id) 
WHERE user_type = 'normal' AND is_deleted = FALSE;

-- 3. è¡¨è¾¾å¼ç´¢å¼•ï¼ˆæ—¥æœŸæŸ¥è¯¢ï¼‰
CREATE INDEX idx_glucose_date ON tbl_glucose_record((measurement_time::date));

-- 4. JSONB å­—æ®µç´¢å¼•ï¼ˆé£Ÿç‰©æŸ¥è¯¢ï¼‰
CREATE INDEX idx_diet_food_items ON tbl_diet_record USING GIN(food_items);
```

### 10.6 ç›‘æ§ä¸å‘Šè­¦

#### 10.6.1 å…³é”®æŒ‡æ ‡ç›‘æ§

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|------|----------|
| SSE è¿æ¥å¤±è´¥ç‡ | > 5% | P1 |
| Function Calling æ‰§è¡Œå¤±è´¥ç‡ | > 1% | P1 |
| æ”¯ä»˜å›è°ƒé‡å¤å¤„ç†ç‡ | > 10% | P2 |
| OSS ä¸Šä¼ å¤±è´¥ç‡ | > 3% | P2 |
| æ•°æ®åº“æ…¢æŸ¥è¯¢ | > 2ç§’ | P1 |
| Redis å‘½ä¸­ç‡ | < 80% | P3 |

#### 10.6.2 æ—¥å¿—åŸ‹ç‚¹

```java
// 1. SSE äº¤äº’æ—¥å¿—
log.info("SSEå¼€å§‹æ¨é€ï¼šsessionId={}, userId={}, content={}", sessionId, userId, content);
log.info("SSEæ¨é€å®Œæˆï¼šsessionId={}, duration={}ms, chunks={}", sessionId, duration, chunkCount);

// 2. Function Calling æ—¥å¿—
log.info("å·¥å…·è°ƒç”¨ï¼štoolName={}, userId={}, params={}", toolName, userId, params);
log.info("å·¥å…·æ‰§è¡Œå®Œæˆï¼štoolName={}, result={}, duration={}ms", toolName, result, duration);

// 3. æ”¯ä»˜å›è°ƒæ—¥å¿—ï¼ˆå·²åœ¨ä»£ç ä¸­å®ç°ï¼‰
log.info("æ”¯ä»˜å›è°ƒï¼šorderId={}, transactionId={}, amount={}", orderId, transactionId, amount);
```

### 10.7 éƒ¨ç½²æ¶æ„å‡çº§å»ºè®®

#### 10.7.1 ç”Ÿäº§ç¯å¢ƒæ¶æ„ï¼ˆä¼˜åŒ–åï¼‰

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   SLB/CDN   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚  åº”ç”¨èŠ‚ç‚¹1   â”‚â”‚  åº”ç”¨èŠ‚ç‚¹2   â”‚â”‚  åº”ç”¨èŠ‚ç‚¹3   â”‚
         â”‚ (SSEæ”¯æŒ)   â”‚â”‚ (SSEæ”¯æŒ)   â”‚â”‚ (SSEæ”¯æŒ)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚   Redis     â”‚â”‚  PostgreSQL â”‚â”‚  RocketMQ   â”‚
         â”‚  (ç¼“å­˜/é”)   â”‚â”‚  (ä¸»ä»åˆ†ç¦»)  â”‚â”‚  (å¼‚æ­¥ä»»åŠ¡)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚  é˜¿é‡Œç™¾ç‚¼    â”‚â”‚  é˜¿é‡Œäº‘OSS  â”‚â”‚  å¾®ä¿¡æ”¯ä»˜    â”‚
         â”‚  (AIæœåŠ¡)   â”‚â”‚  (æ–‡ä»¶å­˜å‚¨)  â”‚â”‚  (æ”¯ä»˜ç½‘å…³)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 10.7.2 èµ„æºé…ç½®å»ºè®®ï¼ˆä¼˜åŒ–åï¼‰

| æœåŠ¡ | P0ï¼ˆæ¼”ç¤ºï¼‰ | P1ï¼ˆç”Ÿäº§ 1000 DAUï¼‰ | P2ï¼ˆç”Ÿäº§ 10000 DAUï¼‰ |
|------|-----------|-------------------|---------------------|
| åº”ç”¨æœåŠ¡å™¨ | 4C8G Ã— 1 | 4C8G Ã— 2 | 8C16G Ã— 3 |
| PostgreSQL | 4C8G Ã— 1 | 8C16G Ã— 1ï¼ˆä¸»ï¼‰+ 4C8G Ã— 1ï¼ˆä»ï¼‰ | 16C32G Ã— 1ï¼ˆä¸»ï¼‰+ 8C16G Ã— 2ï¼ˆä»ï¼‰ |
| Redis | 2C4G Ã— 1 | 4C8G Ã— 1ï¼ˆä¸»ä»ï¼‰ | 8C16G Ã— 1ï¼ˆå“¨å…µé›†ç¾¤ï¼‰ |
| é˜¿é‡Œç™¾ç‚¼ QPS | 10 QPS | 50 QPS | 200 QPS |
| OSS æµé‡ | 10GB/æœˆ | 100GB/æœˆ | 500GB/æœˆ |

---

### 10.8 å·¥ç¨‹è½åœ°æœ€ä½³å®è·µï¼ˆğŸ”¥ é¿å‘æŒ‡å—ï¼‰

#### 10.8.1 SSE è¿æ¥ç®¡ç†ä¼˜åŒ–

##### é—®é¢˜ 1ï¼šå®¢æˆ·ç«¯æ–­è¿å¯¼è‡´çš„æˆæœ¬æµªè´¹

**åœºæ™¯**ï¼šç”¨æˆ·åœ¨æ•°å­—äººè¯´è¯è¯´åˆ°ä¸€åŠæ—¶é€€å‡ºå°ç¨‹åºï¼Œä½†åç«¯çº¿ç¨‹ä»åœ¨è°ƒç”¨ç™¾ç‚¼ API å’Œ TTSï¼Œæµªè´¹ Token å’Œæµé‡ã€‚

**å½±å“**ï¼š
- é˜¿é‡Œç™¾ç‚¼æŒ‰ Token è®¡è´¹ï¼Œæ— æ•ˆæ¨ç†æµªè´¹æˆæœ¬
- TTS éŸ³é¢‘ç”Ÿæˆæµªè´¹æµé‡å’Œæ—¶é—´
- æœåŠ¡å™¨èµ„æºå ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼šæ³¨å†Œ SseEmitter å›è°ƒï¼Œæ„ŸçŸ¥æ–­è¿å¹¶å–æ¶ˆå¼‚æ­¥ä»»åŠ¡

```java
@PostMapping(value = "/sessions/{sessionId}/messages/stream", 
             produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter streamMessage(@PathVariable String sessionId,
                                @RequestBody SendMessageRequest request) {
    SseEmitter emitter = new SseEmitter(180000L); // 180ç§’è¶…æ—¶
    
    // ğŸ”¥ ä½¿ç”¨ AtomicReference å­˜å‚¨ Futureï¼Œä¾¿äºåœ¨å›è°ƒä¸­å–æ¶ˆ
    AtomicReference<CompletableFuture<Void>> runningFutureRef = new AtomicReference<>();
    
    // ğŸ”¥ æ³¨å†Œæ–­è¿å›è°ƒ
    emitter.onCompletion(() -> {
        log.info("SSEè¿æ¥æ­£å¸¸ç»“æŸï¼šsessionId={}", sessionId);
        // æ¸…ç†èµ„æº
    });
    
    emitter.onTimeout(() -> {
        log.warn("SSEè¿æ¥è¶…æ—¶ï¼šsessionId={}", sessionId);
        CompletableFuture<Void> future = runningFutureRef.get();
        if (future != null && !future.isDone()) {
            future.cancel(true);
            log.info("å·²å–æ¶ˆè¶…æ—¶çš„å¼‚æ­¥ä»»åŠ¡");
        }
    });
    
    emitter.onError((ex) -> {
        log.error("SSEè¿æ¥å¼‚å¸¸ï¼šsessionId=" + sessionId, ex);
        // ğŸ”¥ å…³é”®ï¼šå–æ¶ˆæ­£åœ¨è¿è¡Œçš„ AI æ¨ç†ä»»åŠ¡
        CompletableFuture<Void> future = runningFutureRef.get();
        if (future != null && !future.isDone()) {
            future.cancel(true);
            log.info("å·²å–æ¶ˆå¼‚å¸¸çš„å¼‚æ­¥ä»»åŠ¡ï¼ŒèŠ‚çœ AI Token æ¶ˆè€—");
        }
    });
    
    // å¼‚æ­¥å¤„ç†
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        try {
            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²è¢«å–æ¶ˆ
            if (Thread.currentThread().isInterrupted()) {
                log.info("ä»»åŠ¡å·²å–æ¶ˆï¼Œåœæ­¢æ‰§è¡Œ");
                return;
            }
            
            // 1. å‘é€ thinking äº‹ä»¶
            emitter.send(SseEmitter.event()
                .name("thinking")
                .data("{\"status\":\"thinking\"}"));
            
            // 2. è°ƒç”¨ç™¾ç‚¼æµå¼ API
            bailianAIClient.chatStream(request.getContent(), response -> {
                // æ¯æ¬¡æ¨é€å‰æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆ
                if (Thread.currentThread().isInterrupted()) {
                    throw new InterruptedException("ä»»åŠ¡å·²å–æ¶ˆ");
                }
                
                // æ¨é€æ–‡æœ¬ç‰‡æ®µ
                emitter.send(SseEmitter.event()
                    .name("text_chunk")
                    .data("{\"text\":\"" + response.getText() + "\"}"));
            });
            
            // 3. ç”Ÿæˆ TTSï¼ˆæ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆï¼‰
            if (!Thread.currentThread().isInterrupted()) {
                String audioUrl = bailianAIClient.textToSpeech(fullText, "xiaoyun");
                emitter.send(SseEmitter.event()
                    .name("audio_chunk")
                    .data("{\"audioUrl\":\"" + audioUrl + "\"}"));
            }
            
            emitter.send(SseEmitter.event().name("done").data("{}"));
            emitter.complete();
            
        } catch (InterruptedException e) {
            log.info("ä»»åŠ¡è¢«ä¸­æ–­ï¼Œå·²å–æ¶ˆ");
            emitter.completeWithError(e);
        } catch (Exception e) {
            log.error("å¤„ç†å¼‚å¸¸", e);
            emitter.completeWithError(e);
        }
    });
    
    // ä¿å­˜ Future å¼•ç”¨
    runningFutureRef.set(future);
    
    return emitter;
}
```

**æˆæœ¬èŠ‚çœä¼°ç®—**ï¼š
- å‡è®¾ 10% çš„ç”¨æˆ·ä¼šä¸­é€”é€€å‡º
- å¹³å‡æ¯æ¬¡å¯¹è¯æ¶ˆè€— 1000 Tokenï¼ˆè¾“å…¥ + è¾“å‡ºï¼‰
- æ¯æ—¥ 1000 æ¬¡å¯¹è¯ï¼Œ100 æ¬¡ä¸­é€”é€€å‡º
- èŠ‚çœï¼š100 Ã— 1000 Token Ã— Â¥0.0002/Token â‰ˆ **Â¥20/å¤©** â‰ˆ **Â¥600/æœˆ**

##### é—®é¢˜ 2ï¼šSSE è¶…æ—¶è®¾ç½®ä¸å¿ƒè·³ä¿æ´»

**é—®é¢˜**ï¼šå¤æ‚çš„ AI æ¨ç†ï¼ˆRAG + Tool Calling + TTSï¼‰å¯èƒ½è¶…è¿‡ 60 ç§’ã€‚

**è§£å†³æ–¹æ¡ˆ A**ï¼šå»¶é•¿è¶…æ—¶æ—¶é—´

```java
// æ–¹æ¡ˆ 1ï¼šå»¶é•¿è¶…æ—¶åˆ° 180 ç§’ï¼ˆ3åˆ†é’Ÿï¼‰
SseEmitter emitter = new SseEmitter(180000L);

// æ–¹æ¡ˆ 2ï¼šæ°¸ä¸è¶…æ—¶ï¼ˆä¾èµ–å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€ï¼‰
SseEmitter emitter = new SseEmitter(0L);  // 0 è¡¨ç¤ºæ°¸ä¸è¶…æ—¶
```

**è§£å†³æ–¹æ¡ˆ B**ï¼šå¿ƒè·³ä¿æ´»ï¼ˆæ¨èï¼‰

```java
// åç«¯æ¯éš” 30 ç§’å‘é€å¿ƒè·³
ScheduledExecutorService heartbeatExecutor = Executors.newScheduledThreadPool(1);
heartbeatExecutor.scheduleAtFixedRate(() -> {
    try {
        if (!emitter.isClosed()) {
            // å‘é€ç©ºäº‹ä»¶ï¼ˆæ³¨é‡Šè¡Œï¼Œä¸ä¼šè¢«è§£æä¸ºæ•°æ®ï¼‰
            emitter.send(SseEmitter.event().comment("keepalive"));
        }
    } catch (Exception e) {
        heartbeatExecutor.shutdown();
    }
}, 0, 30, TimeUnit.SECONDS);
```

**å‰ç«¯æ¥æ”¶å¿ƒè·³**ï¼š

```javascript
// å¾®ä¿¡å°ç¨‹åºæ— éœ€ç‰¹æ®Šå¤„ç†ï¼Œå¿ƒè·³ä¼šè‡ªåŠ¨ä¿æŒè¿æ¥
// å¦‚æœæ˜¯ Web ç«¯ï¼Œå¯ä»¥ç›‘å¬ comment äº‹ä»¶
eventSource.addEventListener('message', (e) => {
  if (e.data === ':keepalive') {
    console.log('æ”¶åˆ°å¿ƒè·³');
  }
});
```

---

#### 10.8.2 AI ä¸Šä¸‹æ–‡ Token ä¼˜åŒ–

##### é—®é¢˜ï¼šå¯¹è¯è½®æ•°å¢åŠ å¯¼è‡´ Token æ¶ˆè€—çˆ†ç‚¸

**åœºæ™¯**ï¼šç”¨æˆ·ä¸æ•°å­—äººå¯¹è¯ 20 è½®åï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦ä¼ å†å² 20 è½®çš„ä¸Šä¸‹æ–‡ç»™ç™¾ç‚¼ã€‚

**å½±å“**ï¼š
- **è´¹ç”¨çˆ†ç‚¸**ï¼šInput Token ä» 200 å¢é•¿åˆ° 5000+
- **è¶…é™æŠ¥é”™**ï¼šè¶…è¿‡æ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶ï¼ˆå¦‚ 8k/32k Tokensï¼‰
- **å“åº”å˜æ…¢**ï¼šå¤§é‡ Input Token å¢åŠ æ¨ç†æ—¶é—´

**è§£å†³æ–¹æ¡ˆ 1ï¼šæ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**

```java
@Service
public class ConversationContextManager {
    
    private static final int MAX_CONTEXT_ROUNDS = 10;  // æœ€å¤šä¿ç•™ 10 è½®å¯¹è¯
    
    /**
     * è·å–å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆåº”ç”¨æ»‘åŠ¨çª—å£ï¼‰
     */
    public List<Message> getContextWithSlidingWindow(String sessionId) {
        // 1. ä» Redis è·å–å®Œæ•´å†å²
        List<Message> allMessages = getFullHistory(sessionId);
        
        // 2. åº”ç”¨æ»‘åŠ¨çª—å£ï¼šåªä¿ç•™æœ€è¿‘ N è½®
        List<Message> recentMessages = allMessages.stream()
            .skip(Math.max(0, allMessages.size() - MAX_CONTEXT_ROUNDS * 2)) // æ¯è½®2æ¡æ¶ˆæ¯ï¼ˆç”¨æˆ·+åŠ©æ‰‹ï¼‰
            .collect(Collectors.toList());
        
        // 3. å§‹ç»ˆä¿ç•™ System Promptï¼ˆç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
        if (!allMessages.isEmpty() && !recentMessages.contains(allMessages.get(0))) {
            List<Message> result = new ArrayList<>();
            result.add(allMessages.get(0)); // System Prompt
            result.addAll(recentMessages);
            return result;
        }
        
        return recentMessages;
    }
}
```

**è§£å†³æ–¹æ¡ˆ 2ï¼šæ™ºèƒ½ä¿®å‰ªï¼ˆFunction Call ä¸­é—´ç»“æœï¼‰**

```java
/**
 * ä¿®å‰ªä¸Šä¸‹æ–‡ï¼šç§»é™¤å†—ä½™çš„ Function Call ä¸­é—´è¿‡ç¨‹
 */
public List<Message> trimContext(List<Message> messages) {
    List<Message> trimmed = new ArrayList<>();
    
    for (int i = 0; i < messages.size(); i++) {
        Message msg = messages.get(i);
        
        // ä¿ç•™ï¼šç”¨æˆ·æ¶ˆæ¯ã€åŠ©æ‰‹çš„æœ€ç»ˆå›å¤
        if (msg.getRole().equals("user") || 
            msg.getRole().equals("assistant") && !msg.isFunctionCall()) {
            trimmed.add(msg);
        }
        
        // ç§»é™¤ï¼šFunction Call çš„ä¸­é—´å‚æ•°å’Œç»“æœï¼ˆå·²æ‰§è¡Œå®Œæ¯•ï¼‰
        // ä¾‹å¦‚ï¼š{"role": "function", "name": "save_blood_sugar", "content": "..."}
        if (msg.getRole().equals("function")) {
            // è·³è¿‡ï¼Œä¸åŠ å…¥ trimmed
            log.debug("ä¿®å‰ªæ‰ Function Call ä¸­é—´ç»“æœï¼š{}", msg.getContent());
        }
    }
    
    return trimmed;
}
```

**Token èŠ‚çœä¼°ç®—**ï¼š
- åŸå§‹ï¼š20 è½®å¯¹è¯ Ã— 250 Token/è½® = **5000 Input Tokens**
- ä¼˜åŒ–åï¼š10 è½®å¯¹è¯ Ã— 250 Token/è½® = **2500 Input Tokens**
- èŠ‚çœï¼š**50% Input Token æˆæœ¬**

**é…ç½®å»ºè®®**ï¼š

```yaml
bailianai:
  context:
    max-rounds: 10          # æœ€å¤šä¿ç•™ 10 è½®å¯¹è¯
    max-input-tokens: 4000  # è¾“å…¥ Token ä¸Šé™ï¼ˆè¶…è¿‡åˆ™å¼ºåˆ¶ä¿®å‰ªï¼‰
    trim-function-calls: true  # æ˜¯å¦ä¿®å‰ª Function Call ä¸­é—´ç»“æœ
```

---

#### 10.8.3 æ•°æ®è¿ç§»äº‹åŠ¡ä¸è¾¹ç•Œå¤„ç†

##### é—®é¢˜ 1ï¼šäº‹åŠ¡æ³¨è§£å¤±æ•ˆ

**å¸¸è§åŸå› **ï¼š
1. `@Transactional` æ³¨è§£åœ¨ private æ–¹æ³•ä¸Šï¼ˆæ— æ•ˆï¼‰
2. åŒç±»æ–¹æ³•å†…éƒ¨è°ƒç”¨ï¼ˆAOP ä»£ç†å¤±æ•ˆï¼‰
3. å¼‚å¸¸è¢« try-catch åæ‰ï¼ŒæœªæŠ›å‡º

**æ­£ç¡®å§¿åŠ¿**ï¼š

```java
@Service
public class UserServiceImpl implements UserService {
    
    // âœ… æ­£ç¡®ï¼špublic æ–¹æ³•ï¼Œäº‹åŠ¡ç”Ÿæ•ˆ
    @Override
    @Transactional(rollbackFor = Exception.class)
    public UserResponse convertGuestToUser(String guestUserId, ConvertUserRequest request) {
        // ... ä¸šåŠ¡é€»è¾‘ ...
        
        try {
            // è¿ç§»æ•°æ®
            migrateUserData(guestUserId, existingUserId);
        } catch (DataMigrationException e) {
            // âœ… æ­£ç¡®ï¼šé‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘å›æ»š
            throw new BusinessException("æ•°æ®è¿ç§»å¤±è´¥", e);
        }
        
        return response;
    }
    
    // âŒ é”™è¯¯ï¼šprivate æ–¹æ³•çš„ @Transactional æ— æ•ˆ
    // @Transactional
    private void migrateUserData(String fromUserId, String toUserId) {
        // ...
    }
}
```

##### é—®é¢˜ 2ï¼šå¤§æ•°æ®é‡è¿ç§»å¯èƒ½é”è¡¨

**é£é™©**ï¼šå¦‚æœè®¿å®¢è®°å½•äº† 1000 æ¡è¡€ç³–æ•°æ®ï¼Œä¸€æ¬¡æ€§ UPDATE å¯èƒ½é”è¡¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†æ‰¹è¿ç§»

```java
/**
 * åˆ†æ‰¹è¿ç§»è¡€ç³–è®°å½•
 */
private void migrateGlucoseRecords(String fromUserId, String toUserId) {
    int batchSize = 100;
    int offset = 0;
    int migratedCount = 0;
    
    while (true) {
        // åˆ†æ‰¹æŸ¥è¯¢
        List<GlucoseRecord> batch = glucoseRecordMapper.selectByUserIdWithLimit(
            fromUserId, offset, batchSize
        );
        
        if (batch.isEmpty()) {
            break;
        }
        
        // æ‰¹é‡æ›´æ–° user_id
        batch.forEach(record -> record.setUserId(toUserId));
        glucoseRecordMapper.batchUpdate(batch);
        
        migratedCount += batch.size();
        offset += batchSize;
        
        log.info("è¿ç§»è¡€ç³–è®°å½•è¿›åº¦ï¼š{} æ¡", migratedCount);
    }
}
```

##### é—®é¢˜ 3ï¼šåŒä¸€æ—¶é—´ç‚¹çš„é‡å¤è®°å½•

**åœºæ™¯**ï¼šè®¿å®¢å’Œè€è´¦å·åœ¨ 2026-01-29 08:00 éƒ½æœ‰ä¸€æ¡"æ—©é¤"è®°å½•ï¼Œåˆå¹¶åå¦‚ä½•å¤„ç†ï¼Ÿ

**ç­–ç•¥ Aï¼ˆç®€å•ï¼‰**ï¼šå…è®¸é‡å¤

```java
// ç›´æ¥è¿ç§»ï¼Œä¸å»é‡
// å‰ç«¯æŒ‰æ—¶é—´å€’åºå±•ç¤ºæ—¶ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°ä¸¤æ¡è®°å½•å¹¶æ‰‹åŠ¨åˆ é™¤
```

**ç­–ç•¥ Bï¼ˆæ™ºèƒ½ï¼‰**ï¼šæ£€æµ‹å¹¶æ ‡è®°

```java
/**
 * è¿ç§»å‰æ£€æµ‹æ½œåœ¨å†²çª
 */
private void checkAndMigrateDietRecords(String fromUserId, String toUserId) {
    List<DietRecord> guestRecords = dietRecordMapper.selectByUserId(fromUserId);
    List<DietRecord> existingRecords = dietRecordMapper.selectByUserId(toUserId);
    
    for (DietRecord guestRecord : guestRecords) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ—¶é—´é‡å çš„è®°å½•ï¼ˆå‰å 10 åˆ†é’Ÿå†…ï¼‰
        boolean hasDuplicate = existingRecords.stream().anyMatch(existing ->
            Math.abs(ChronoUnit.MINUTES.between(
                guestRecord.getMealTime(), 
                existing.getMealTime()
            )) < 10
        );
        
        if (hasDuplicate) {
            // æ ‡è®°ä¸º"å¾…ç¡®è®¤"ï¼Œå‰ç«¯å±•ç¤ºæ—¶é«˜äº®
            guestRecord.setNeedReview(true);
        }
        
        guestRecord.setUserId(toUserId);
        dietRecordMapper.update(guestRecord);
    }
}
```

---

#### 10.8.4 OSS å›¾ç‰‡ç¼©ç•¥å›¾ä¼˜åŒ–

##### é—®é¢˜ï¼šåˆ—è¡¨åŠ è½½å¤§å›¾å¯¼è‡´å¡é¡¿

**åœºæ™¯**ï¼šé¥®é£Ÿè®°å½•åˆ—è¡¨å±•ç¤º 10 å¼ ç…§ç‰‡ï¼Œæ¯å¼  5MBï¼Œå‰ç«¯éœ€è¦åŠ è½½ 50MB æ•°æ®ã€‚

**å½±å“**ï¼š
- åŠ è½½æ…¢ï¼š4G ç½‘ç»œä¸‹éœ€è¦ 10+ ç§’
- è´¹æµé‡ï¼šç”¨æˆ·æµé‡æ¶ˆè€—å¤§
- ä½“éªŒå·®ï¼šåˆ—è¡¨æ»‘åŠ¨å¡é¡¿

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨é˜¿é‡Œäº‘ OSS å›¾ç‰‡å¤„ç†ï¼ˆx-oss-processï¼‰

```java
@Service
public class OssService {
    
    /**
     * ç”Ÿæˆç¼©ç•¥å›¾ URL
     * @param originalUrl åŸå›¾ URL
     * @param width ç¼©ç•¥å›¾å®½åº¦
     * @return ç¼©ç•¥å›¾ URL
     */
    public String generateThumbnailUrl(String originalUrl, int width) {
        if (StringUtils.isBlank(originalUrl)) {
            return null;
        }
        
        // ğŸ”¥ ä½¿ç”¨ OSS å›¾ç‰‡å¤„ç†å‚æ•°ï¼ˆå®æ—¶ç”Ÿæˆï¼Œä¸å ç”¨é¢å¤–å­˜å‚¨ç©ºé—´ï¼‰
        String process = String.format("?x-oss-process=image/resize,w_%d", width);
        return originalUrl + process;
    }
    
    /**
     * ç”Ÿæˆå¤šç§å°ºå¯¸ URL
     */
    public ImageUrls generateMultiSizeUrls(String originalUrl) {
        ImageUrls urls = new ImageUrls();
        urls.setOriginal(originalUrl);
        urls.setThumbnail(generateThumbnailUrl(originalUrl, 200));   // åˆ—è¡¨ç¼©ç•¥å›¾
        urls.setMedium(generateThumbnailUrl(originalUrl, 800));      // è¯¦æƒ…é¡µä¸­å›¾
        urls.setLarge(originalUrl);  // åŸå›¾ï¼ˆç‚¹å‡»æ”¾å¤§æ—¶åŠ è½½ï¼‰
        return urls;
    }
}
```

**Controller è¿”å›å¤šå°ºå¯¸ URL**ï¼š

```java
@GetMapping("/records")
public ResponseEntity<PageResponse<DietRecordResponse>> getRecords(...) {
    List<DietRecord> records = dietService.getRecords(userId, startDate, endDate, page, size);
    
    // ğŸ”¥ ä¸ºæ¯æ¡è®°å½•ç”Ÿæˆç¼©ç•¥å›¾ URL
    List<DietRecordResponse> responses = records.stream().map(record -> {
        DietRecordResponse response = new DietRecordResponse();
        // ... å…¶ä»–å­—æ®µæ˜ å°„ ...
        
        // ç”Ÿæˆå¤šå°ºå¯¸ URL
        ImageUrls imageUrls = ossService.generateMultiSizeUrls(record.getPhotoUrl());
        response.setPhotoUrls(imageUrls);
        
        return response;
    }).collect(Collectors.toList());
    
    return ResponseEntity.ok(PageResponse.of(responses, total));
}
```

**å‰ç«¯ä½¿ç”¨**ï¼š

```javascript
// åˆ—è¡¨é¡µï¼šåŠ è½½ç¼©ç•¥å›¾ï¼ˆ200px å®½ï¼‰
<image src="{{item.photoUrls.thumbnail}}" mode="aspectFill"></image>

// è¯¦æƒ…é¡µï¼šåŠ è½½ä¸­å›¾ï¼ˆ800px å®½ï¼‰
<image src="{{item.photoUrls.medium}}" mode="widthFix"></image>

// ç‚¹å‡»æ”¾å¤§ï¼šåŠ è½½åŸå›¾
<image src="{{item.photoUrls.large}}" mode="aspectFit"></image>
```

**æ•ˆæœå¯¹æ¯”**ï¼š

| åœºæ™¯ | åŸå§‹ | ä¼˜åŒ–å | æå‡ |
|------|------|--------|------|
| åˆ—è¡¨åŠ è½½ 10 å¼ å›¾ | 50MB | 500KB | **99% â†“** |
| åŠ è½½æ—¶é—´ï¼ˆ4Gï¼‰ | 10 ç§’ | 0.5 ç§’ | **95% â†“** |
| ç”¨æˆ·æµé‡æ¶ˆè€— | 50MB | 500KB | **99% â†“** |

**é˜¿é‡Œäº‘ OSS å›¾ç‰‡å¤„ç†æ”¯æŒçš„æ“ä½œ**ï¼š
- `resize` - ç¼©æ”¾
- `crop` - è£å‰ª
- `quality` - å‹ç¼©è´¨é‡
- `format` - æ ¼å¼è½¬æ¢ï¼ˆå¦‚è½¬ WebPï¼‰
- `watermark` - æ°´å°

**ç¤ºä¾‹**ï¼š

```java
// ç¼©ç•¥å›¾ + WebP æ ¼å¼ + 80% è´¨é‡
String url = originalUrl + "?x-oss-process=image/resize,w_200/format,webp/quality,q_80";
```

---

#### 10.8.5 PostgreSQL JSONB æŸ¥è¯¢ä¼˜åŒ–

##### é—®é¢˜ï¼šJSONB æŸ¥è¯¢æ…¢ï¼Œç´¢å¼•ä¸ç”Ÿæ•ˆ

**åœºæ™¯**ï¼šæŸ¥è¯¢"æ‰€æœ‰åƒè¿‡'ç‰›è‚‰'çš„ç”¨æˆ·"

```sql
-- âŒ é”™è¯¯ï¼šä¸ä¼šä½¿ç”¨ GIN ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ
SELECT * FROM tbl_diet_record 
WHERE food_items::text LIKE '%ç‰›è‚‰%';

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨ JSONB æ“ä½œç¬¦ï¼Œè§¦å‘ GIN ç´¢å¼•
SELECT * FROM tbl_diet_record 
WHERE food_items @> '[{"foodName": "ç‰›è‚‰"}]';
```

**ç´¢å¼•åˆ›å»º**ï¼š

```sql
-- åˆ›å»º GIN ç´¢å¼•ï¼ˆå·²åœ¨è®¾è®¡ä¸­ï¼‰
CREATE INDEX idx_diet_food_items ON tbl_diet_record USING GIN(food_items);

-- é’ˆå¯¹ç‰¹å®šå­—æ®µåˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_diet_food_name ON tbl_diet_record 
USING GIN((food_items -> 'foodName'));
```

**Java æŸ¥è¯¢ç¤ºä¾‹**ï¼ˆMyBatisï¼‰ï¼š

```xml
<!-- MyBatis Mapper XML -->
<select id="findByFoodName" resultType="DietRecord">
    SELECT * FROM tbl_diet_record
    WHERE food_items @> CAST(#{foodItemJson} AS jsonb)
    AND user_id = #{userId}
    ORDER BY meal_time DESC
    LIMIT #{limit}
</select>
```

```java
// Service å±‚
public List<DietRecord> findByFoodName(String userId, String foodName, int limit) {
    // æ„é€  JSONB æŸ¥è¯¢æ¡ä»¶
    String foodItemJson = String.format("[{\"foodName\": \"%s\"}]", foodName);
    return dietRecordMapper.findByFoodName(userId, foodItemJson, limit);
}
```

**JSONB å¸¸ç”¨æ“ä½œç¬¦**ï¼š

| æ“ä½œç¬¦ | è¯´æ˜ | ç¤ºä¾‹ | æ˜¯å¦ä½¿ç”¨ç´¢å¼• |
|--------|------|------|------------|
| `@>` | åŒ…å«ï¼ˆå·¦åŒ…å«å³ï¼‰ | `food_items @> '{"foodName":"ç‰›è‚‰"}'` | âœ… GIN |
| `<@` | è¢«åŒ…å«ï¼ˆå³åŒ…å«å·¦ï¼‰ | `'{"foodName":"ç‰›è‚‰"}' <@food_items` | âœ… GIN |
| `?` | å­˜åœ¨é”® | `food_items ? 'foodName'` | âœ… GIN |
| `?|` | å­˜åœ¨ä»»ä¸€é”® | `food_items ?| array['foodName','weight']` | âœ… GIN |
| `?&` | å­˜åœ¨æ‰€æœ‰é”® | `food_items ?& array['foodName','weight']` | âœ… GIN |
| `->` | è·å– JSON å­—æ®µ | `food_items -> 'foodName'` | âŒ |
| `->>` | è·å– JSON æ–‡æœ¬ | `food_items ->> 'foodName'` | âŒ |

**å¤æ‚æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```sql
-- æŸ¥è¯¢"æ—©é¤åƒäº†ç‰›è‚‰ä¸”çƒ­é‡è¶…è¿‡ 500 åƒå¡"çš„è®°å½•
SELECT * FROM tbl_diet_record
WHERE meal_type = 'breakfast'
  AND food_items @> '[{"foodName": "ç‰›è‚‰"}]'
  AND total_calories > 500
  AND user_id = 'user-123';

-- æŸ¥è¯¢"é£Ÿç‰©æ¸…å•ä¸­åŒ…å«'ç‰›è‚‰'æˆ–'é¸¡è‚‰'"ï¼ˆéœ€è¦è‡ªå®šä¹‰å‡½æ•°ï¼‰
SELECT * FROM tbl_diet_record
WHERE user_id = 'user-123'
  AND (
    food_items @> '[{"foodName": "ç‰›è‚‰"}]'
    OR food_items @> '[{"foodName": "é¸¡è‚‰"}]'
  );
```

**æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- å¼€å¯æŸ¥è¯¢åˆ†æ
EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM tbl_diet_record
WHERE food_items @> '[{"foodName": "ç‰›è‚‰"}]';

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,  -- ç´¢å¼•è¢«ä½¿ç”¨çš„æ¬¡æ•°
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'tbl_diet_record';
```

**å»ºè®®**ï¼š
1. âœ… JSONB å­—æ®µå†™å…¥æ—¶ç¡®ä¿æ ¼å¼æ ‡å‡†åŒ–ï¼ˆç»Ÿä¸€å­—æ®µåã€æ•°æ®ç±»å‹ï¼‰
2. âœ… æŸ¥è¯¢æ—¶ä¼˜å…ˆä½¿ç”¨ `@>`ã€`?` ç­‰æ“ä½œç¬¦ï¼ˆè§¦å‘ GIN ç´¢å¼•ï¼‰
3. âœ… é¿å…ä½¿ç”¨ `::text` è½¬æ¢å LIKE æŸ¥è¯¢ï¼ˆä¸èµ°ç´¢å¼•ï¼‰
4. âœ… å®šæœŸä½¿ç”¨ `EXPLAIN ANALYZE` åˆ†ææŸ¥è¯¢è®¡åˆ’

---

#### 10.8.6 ç»¼åˆé¿å‘æ¸…å•

| é—®é¢˜åˆ†ç±» | å…·ä½“é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | ä¼˜å…ˆçº§ |
|---------|---------|------|---------|--------|
| **SSE è¿æ¥** | å®¢æˆ·ç«¯æ–­è¿æœªæ„ŸçŸ¥ | æµªè´¹ AI Token æˆæœ¬ | æ³¨å†Œ onError å›è°ƒï¼Œå–æ¶ˆ Future | P0 |
| **SSE è¶…æ—¶** | 60ç§’è¶…æ—¶ä¸å¤Ÿç”¨ | AI æ¨ç†è¢«ä¸­æ–­ | å»¶é•¿åˆ° 180 ç§’æˆ–ä½¿ç”¨å¿ƒè·³ | P1 |
| **AI ä¸Šä¸‹æ–‡** | Token æ¶ˆè€—çˆ†ç‚¸ | æˆæœ¬å¢åŠ  50%+ | æ»‘åŠ¨çª—å£ï¼ˆä¿ç•™ 10 è½®ï¼‰ | P0 |
| **æ•°æ®è¿ç§»** | äº‹åŠ¡æ³¨è§£å¤±æ•ˆ | æ•°æ®ä¸ä¸€è‡´ | ç¡®ä¿ public æ–¹æ³• + å¼‚å¸¸æŠ›å‡º | P0 |
| **æ•°æ®è¿ç§»** | å¤§é‡æ•°æ®é”è¡¨ | è¿ç§»è¶…æ—¶ | åˆ†æ‰¹è¿ç§»ï¼ˆ100 æ¡/æ‰¹ï¼‰ | P1 |
| **å›¾ç‰‡åŠ è½½** | åˆ—è¡¨åŠ è½½å¤§å›¾ | ç”¨æˆ·ä½“éªŒå·® | OSS ç¼©ç•¥å›¾ï¼ˆèŠ‚çœ 99% æµé‡ï¼‰ | P1 |
| **JSONB æŸ¥è¯¢** | ç´¢å¼•ä¸ç”Ÿæ•ˆ | æŸ¥è¯¢æ…¢ | ä½¿ç”¨ `@>` æ“ä½œç¬¦ | P2 |

**P0 é˜¶æ®µå¿…é¡»å®ç°**ï¼š
- âœ… SSE æ–­è¿å›è°ƒï¼ˆèŠ‚çœæˆæœ¬ï¼‰
- âœ… AI ä¸Šä¸‹æ–‡æ»‘åŠ¨çª—å£ï¼ˆæ§åˆ¶è´¹ç”¨ï¼‰
- âœ… æ•°æ®è¿ç§»äº‹åŠ¡ä¿è¯ï¼ˆæ•°æ®å®‰å…¨ï¼‰

**P1 é˜¶æ®µä¼˜åŒ–**ï¼š
- âœ… OSS ç¼©ç•¥å›¾ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
- âœ… SSE å¿ƒè·³ä¿æ´»ï¼ˆç¨³å®šæ€§ï¼‰
- âœ… åˆ†æ‰¹æ•°æ®è¿ç§»ï¼ˆé¿å…é”è¡¨ï¼‰

**P2 é˜¶æ®µå¢å¼º**ï¼š
- âœ… JSONB æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰

---

### 10.9 å®‰å…¨ä¸ç¨³å®šæ€§åŠ å›ºï¼ˆğŸ›¡ï¸ é˜²å¼¹çº§ï¼‰

#### 10.9.1 å®‰å…¨æ¼æ´ï¼šè¶Šæƒè®¿é—®ï¼ˆIDORï¼‰é˜²æŠ¤

##### ğŸš¨ é«˜å±æ¼æ´ï¼šä¸è¦ä¿¡ä»»å‰ç«¯ä¼ é€’çš„ userId

**é—®é¢˜ä½ç½®**ï¼šå½“å‰è®¾è®¡ä¸­çš„å¤§é‡æ¥å£æ¥å— `userId` ä½œä¸ºå‚æ•°

```java
// âŒ å±é™©ï¼šå®¹æ˜“è¢«è¶Šæƒæ”»å‡»
@GetMapping("/dashboard")
public ResponseEntity<DashboardResponse> getDashboard(@RequestParam String userId);

@PostMapping("/glucose/records")
public ResponseEntity<GlucoseRecordResponse> createRecord(@RequestBody CreateGlucoseRecordRequest request);
// CreateGlucoseRecordRequest ä¸­åŒ…å« userId å­—æ®µ
```

**æ”»å‡»åœºæ™¯**ï¼š

```
1. é»‘å®¢ A ç™»å½•è‡ªå·±çš„è´¦å·ï¼Œè·å–åˆæ³• Token
   Authorization: Bearer eyJhbGc...ï¼ˆA çš„ Tokenï¼‰

2. A æ‹¦æˆªè¯·æ±‚ï¼Œç¯¡æ”¹ userId å‚æ•°
   GET /api/v1/dashboard?userId=victim-user-123

3. åç«¯åªæ ¡éªŒ Token æ˜¯å¦æœ‰æ•ˆï¼ˆæ˜¯ï¼‰ï¼Œæœªæ ¡éªŒ Token å½’å±
   â†’ A æˆåŠŸæŸ¥çœ‹å—å®³è€… B çš„æ•°æ® âœ… è¶ŠæƒæˆåŠŸï¼
```

**å½±å“èŒƒå›´**ï¼š
- æŸ¥çœ‹ä»–äººè¡€ç³–ã€é¥®é£Ÿã€ç—…ä¾‹ç­‰éšç§æ•°æ® âš ï¸
- ä¿®æ”¹ä»–äººæ•°æ®ï¼ˆå¦‚åˆ é™¤è®°å½•ã€ä¿®æ”¹è®¢é˜…çŠ¶æ€ï¼‰âš ï¸âš ï¸
- æ¶ˆè´¹ä»–äººè®¢é˜…æƒç›Š âš ï¸âš ï¸âš ï¸

**CVSS è¯„åˆ†**ï¼š9.1ï¼ˆä¸¥é‡ï¼‰- æœªæˆæƒè®¿é—®æ•æ„Ÿæ•°æ®

---

##### âœ… è§£å†³æ–¹æ¡ˆï¼šä» Token ä¸­å¼ºåˆ¶æå– userId

**æ–¹æ¡ˆæ¶æ„**ï¼š

```
è¯·æ±‚ â†’ ç½‘å…³/æ‹¦æˆªå™¨ â†’ è§£æ JWT â†’ æå– userId â†’ æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ â†’ Controller/Service
```

**æ­¥éª¤ 1ï¼šJWT å·¥å…·ç±»**

```java
package com.tangxiaowen.common.util;

/**
 * JWT å·¥å…·ç±»
 */
@Component
public class JwtUtil {
    
    @Value("${jwt.secret}")
    private String secret;
    
    /**
     * ä» Token ä¸­æå– userId
     * @param token JWT Token
     * @return userId
     * @throws JwtException Token æ— æ•ˆæˆ–è¿‡æœŸ
     */
    public String extractUserId(String token) {
        try {
            Claims claims = Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
            
            return claims.getSubject(); // userId å­˜å‚¨åœ¨ subject ä¸­
            
        } catch (ExpiredJwtException e) {
            throw new UnauthorizedException("Token å·²è¿‡æœŸ");
        } catch (JwtException e) {
            throw new UnauthorizedException("Token æ— æ•ˆ");
        }
    }
    
    /**
     * ç”Ÿæˆ Token
     * @param userId ç”¨æˆ·ID
     * @param expirationSeconds è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return JWT Token
     */
    public String generateToken(String userId, int expirationSeconds) {
        Date now = new Date();
        Date expiration = new Date(now.getTime() + expirationSeconds * 1000L);
        
        return Jwts.builder()
            .setSubject(userId)  // ğŸ”¥ userId å­˜å‚¨åœ¨ subject
            .setIssuedAt(now)
            .setExpiration(expiration)
            .signWith(SignatureAlgorithm.HS256, secret)
            .compact();
    }
}
```

**æ­¥éª¤ 2ï¼šè®¤è¯æ‹¦æˆªå™¨**

```java
package com.tangxiaowen.common.interceptor;

/**
 * è®¤è¯æ‹¦æˆªå™¨
 * ä» Token ä¸­æå– userId å¹¶æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
 */
@Component
public class AuthenticationInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. ä» Header ä¸­è·å– Token
        String authHeader = request.getHeader("Authorization");
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            throw new UnauthorizedException("ç¼ºå°‘ Authorization Header");
        }
        
        String token = authHeader.substring(7); // å»æ‰ "Bearer " å‰ç¼€
        
        // 2. ğŸ”¥ ä» Token ä¸­æå– userIdï¼ˆä¼šæ ¡éªŒç­¾åå’Œè¿‡æœŸæ—¶é—´ï¼‰
        String userId = jwtUtil.extractUserId(token);
        
        // 3. ğŸ”¥ å°† userId æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
        request.setAttribute("currentUserId", userId);
        
        // ä¹Ÿå¯ä»¥å­˜åˆ° ThreadLocalï¼ˆæ¨èï¼‰
        UserContextHolder.setUserId(userId);
        
        log.debug("è®¤è¯æˆåŠŸï¼šuserId={}", userId);
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, 
                                Object handler, Exception ex) {
        // æ¸…ç† ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        UserContextHolder.clear();
    }
}
```

**æ­¥éª¤ 3ï¼šé…ç½®æ‹¦æˆªå™¨**

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Autowired
    private AuthenticationInterceptor authenticationInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(authenticationInterceptor)
            .addPathPatterns("/api/v1/**")  // æ‹¦æˆªæ‰€æœ‰ä¸šåŠ¡æ¥å£
            .excludePathPatterns(
                "/api/v1/users/guest/register",  // è®¿å®¢æ³¨å†Œä¸éœ€è¦è®¤è¯
                "/api/v1/subscriptions/plans",   // å¥—é¤åˆ—è¡¨å…¬å¼€
                "/api/v1/health"                  // å¥åº·æ£€æŸ¥
            );
    }
}
```

**æ­¥éª¤ 4ï¼šController æ”¹é€ **

```java
package com.tangxiaowen.dashboard.controller;

/**
 * é¦–é¡µæ§åˆ¶å™¨ï¼ˆå®‰å…¨ç‰ˆï¼‰
 */
@RestController
@RequestMapping("/api/v1/dashboard")
public class DashboardController {
    
    /**
     * è·å–é¦–é¡µæ•°æ®ï¼ˆå®‰å…¨ç‰ˆï¼‰
     * 
     * âŒ é”™è¯¯å†™æ³•ï¼š@RequestParam String userId
     * âœ… æ­£ç¡®å†™æ³•ï¼šä»è¯·æ±‚ä¸Šä¸‹æ–‡è·å–
     */
    @GetMapping
    public ResponseEntity<DashboardResponse> getDashboard(
        // æ–¹æ¡ˆ Aï¼šä» Request Attribute è·å–
        @RequestAttribute("currentUserId") String userId
    ) {
        return ResponseEntity.ok(dashboardService.aggregateDashboardData(userId));
    }
    
    // æ–¹æ¡ˆ Bï¼šä» ThreadLocal è·å–ï¼ˆæ¨èï¼‰
    @GetMapping("/v2")
    public ResponseEntity<DashboardResponse> getDashboardV2() {
        String userId = UserContextHolder.getUserId(); // ä» ThreadLocal è·å–
        return ResponseEntity.ok(dashboardService.aggregateDashboardData(userId));
    }
}
```

**æ­¥éª¤ 5ï¼šDTO æ”¹é€ **

```java
/**
 * åˆ›å»ºè¡€ç³–è®°å½•è¯·æ±‚ï¼ˆå®‰å…¨ç‰ˆï¼‰
 */
@Data
public class CreateGlucoseRecordRequest {
    // âŒ åˆ é™¤ userId å­—æ®µï¼ˆä¸å…è®¸å‰ç«¯ä¼ é€’ï¼‰
    // private String userId;
    
    private BigDecimal glucoseValue;
    private String measurementType;
    private LocalDateTime measurementTime;
    private String notes;
}

/**
 * Controller å±‚å¡«å…… userId
 */
@PostMapping("/records")
public ResponseEntity<GlucoseRecordResponse> createRecord(
    @RequestAttribute("currentUserId") String userId,
    @RequestBody CreateGlucoseRecordRequest request
) {
    // ğŸ”¥ åœ¨ Controller å±‚æ³¨å…¥ userIdï¼Œä¸ä¿¡ä»»å‰ç«¯
    return ResponseEntity.ok(glucoseService.createRecord(userId, request));
}

/**
 * Service å±‚æ¥å— userId ä½œä¸ºç‹¬ç«‹å‚æ•°
 */
public interface GlucoseService {
    GlucoseRecordResponse createRecord(String userId, CreateGlucoseRecordRequest request);
}
```

**æ­¥éª¤ 6ï¼šUserContextHolder å·¥å…·ç±»**

```java
package com.tangxiaowen.common.context;

/**
 * ç”¨æˆ·ä¸Šä¸‹æ–‡æŒæœ‰è€…ï¼ˆThreadLocalï¼‰
 */
public class UserContextHolder {
    
    private static final ThreadLocal<String> userIdHolder = new ThreadLocal<>();
    
    public static void setUserId(String userId) {
        userIdHolder.set(userId);
    }
    
    public static String getUserId() {
        String userId = userIdHolder.get();
        if (userId == null) {
            throw new UnauthorizedException("æœªç™»å½•æˆ– Token å·²è¿‡æœŸ");
        }
        return userId;
    }
    
    public static void clear() {
        userIdHolder.remove(); // ğŸ”¥ é˜²æ­¢å†…å­˜æ³„æ¼
    }
}
```

---

##### ğŸ“Š å®‰å…¨æ•ˆæœå¯¹æ¯”

| åœºæ™¯ | åŸè®¾è®¡ | åŠ å›ºå | æ˜¯å¦å®‰å…¨ |
|------|--------|--------|---------|
| é»‘å®¢ç¯¡æ”¹ userId å‚æ•° | å¯ä»¥æŸ¥çœ‹ä»–äººæ•°æ® âŒ | Token ä¸­çš„ userId ä¼˜å…ˆ âœ… | âœ… |
| é»‘å®¢ä½¿ç”¨ä»–äºº Token | Token æ³„éœ²åå¯è¶Šæƒ âŒ | åŒæ ·å®‰å…¨ï¼ˆToken æœ¬èº«éœ€è¦ä¿æŠ¤ï¼‰ | âš ï¸ |
| å‰ç«¯ Bug ä¼ é”™ userId | å¯èƒ½è¯¯æ“ä½œä»–äººæ•°æ® âŒ | å¼ºåˆ¶ä½¿ç”¨ Token ä¸­çš„ ID âœ… | âœ… |

**æ³¨æ„**ï¼šToken æœ¬èº«çš„å®‰å…¨ä¹Ÿå¾ˆé‡è¦ï¼š
- âœ… ä½¿ç”¨ HTTPS é˜²æ­¢ä¸­é—´äººæ”»å‡»
- âœ… Token æœ‰æ•ˆæœŸä¸è¦å¤ªé•¿ï¼ˆå»ºè®® 2 å°æ—¶ï¼‰
- âœ… æ”¯æŒ Token åˆ·æ–°æœºåˆ¶ï¼ˆRefresh Tokenï¼‰
- âœ… ç™»å‡ºæ—¶å°† Token åŠ å…¥é»‘åå•ï¼ˆRedisï¼‰

---

#### 10.9.2 å¹¶å‘éšæ‚£ï¼šSSE çº¿ç¨‹æ± éš”ç¦»

##### ğŸš¨ é—®é¢˜ï¼šé»˜è®¤çº¿ç¨‹æ± è€—å°½å¯¼è‡´åº”ç”¨å‡æ­»

**é—®é¢˜ä½ç½®**ï¼šç¬¬ 10.2.2 èŠ‚ä¸­çš„ SSE å®ç°

```java
// âŒ å±é™©ï¼šä½¿ç”¨é»˜è®¤çš„ ForkJoinPool.commonPool()
CompletableFuture.runAsync(() -> {
    // æ•°å­—äººå¯¹è¯ï¼ˆIO å¯†é›†å‹ï¼Œè€—æ—¶ 5-30 ç§’ï¼‰
    bailianAIClient.chatStream(...);
}, sseExecutor);  // å¦‚æœ sseExecutor ä¸º nullï¼Œä¼šä½¿ç”¨ commonPool
```

**é£é™©åœºæ™¯**ï¼š

```
æ—¶é—´ç‚¹ 0 ç§’ï¼šå¹¶å‘ 50 ä¸ªç”¨æˆ·å‘èµ·æ•°å­—äººå¯¹è¯
æ—¶é—´ç‚¹ 5 ç§’ï¼šForkJoinPool.commonPool() çš„çº¿ç¨‹å…¨éƒ¨è¢«å ç”¨ï¼ˆé»˜è®¤ CPU æ ¸å¿ƒæ•° - 1ï¼‰
æ—¶é—´ç‚¹ 10 ç§’ï¼šæ–°ç”¨æˆ·çš„å¯¹è¯æ— æ³•è·å¾—çº¿ç¨‹ï¼Œæ’é˜Ÿç­‰å¾…
æ—¶é—´ç‚¹ 15 ç§’ï¼šåº”ç”¨ä¸­å…¶ä»–ä½¿ç”¨ CompletableFuture çš„ä¸šåŠ¡ï¼ˆå¼‚æ­¥é‚®ä»¶ã€å¼‚æ­¥æ—¥å¿—ï¼‰ä¹Ÿè¢«é˜»å¡
æ—¶é—´ç‚¹ 20 ç§’ï¼šåº”ç”¨å‡æ­»ï¼Œæ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å †ç§¯ âš ï¸âš ï¸âš ï¸
```

**å½±å“**ï¼š
- æ•°å­—äººå¯¹è¯å“åº”æ…¢æˆ–è¶…æ—¶
- å…¶ä»–å¼‚æ­¥ä¸šåŠ¡è¢«æ‹–ç´¯ï¼ˆé›ªå´©æ•ˆåº”ï¼‰
- çº¿ç¨‹æ± æ»¡åï¼Œæ–°è¯·æ±‚è¢«æ‹’ç»ï¼ˆç”¨æˆ·æ— æ³•ä½¿ç”¨ï¼‰

---

##### âœ… è§£å†³æ–¹æ¡ˆï¼šè‡ªå®šä¹‰çº¿ç¨‹æ±  + éš”ç¦»

**é…ç½®ç±»**ï¼š

```java
package com.tangxiaowen.common.config;

/**
 * çº¿ç¨‹æ± é…ç½®
 * ä¸ºä¸åŒçš„å¼‚æ­¥ä»»åŠ¡åˆ›å»ºç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œå®ç°èµ„æºéš”ç¦»
 */
@Configuration
public class ThreadPoolConfig {
    
    /**
     * ğŸ”¥ æ•°å­—äºº SSE ä¸“ç”¨çº¿ç¨‹æ± 
     * 
     * ç‰¹ç‚¹ï¼šIO å¯†é›†å‹ï¼Œå•ä¸ªä»»åŠ¡è€—æ—¶é•¿ï¼ˆ5-30 ç§’ï¼‰
     * ç­–ç•¥ï¼šçº¿ç¨‹æ•°å¤šï¼Œé˜Ÿåˆ—å®¹é‡é€‚ä¸­
     */
    @Bean("sseExecutor")
    public Executor sseExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šå»ºè®®ä¸º CPU æ ¸å¿ƒæ•°çš„ 2-3 å€ï¼ˆIO å¯†é›†å‹ï¼‰
        executor.setCorePoolSize(20);
        
        // æœ€å¤§çº¿ç¨‹æ•°ï¼šå³°å€¼å¹¶å‘æ•°ï¼ˆæ ¹æ®å®é™…å‹æµ‹è°ƒæ•´ï¼‰
        executor.setMaxPoolSize(100);
        
        // é˜Ÿåˆ—å®¹é‡ï¼šç­‰å¾…é˜Ÿåˆ—å¤§å°
        // å½“æ ¸å¿ƒçº¿ç¨‹æ»¡æ—¶ï¼Œä»»åŠ¡å…ˆå…¥é˜Ÿï¼›é˜Ÿåˆ—æ»¡åæ‰åˆ›å»ºæ–°çº¿ç¨‹
        executor.setQueueCapacity(200);
        
        // çº¿ç¨‹åç§°å‰ç¼€ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰
        executor.setThreadNamePrefix("sse-chat-");
        
        // çº¿ç¨‹ç©ºé—²æ—¶é—´ï¼ˆè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹åœ¨ç©ºé—² 60 ç§’åå›æ”¶ï¼‰
        executor.setKeepAliveSeconds(60);
        
        // ğŸ”¥ æ‹’ç»ç­–ç•¥ï¼šå½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½æ»¡æ—¶
        // CallerRunsPolicyï¼šç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œï¼ˆé™çº§æ–¹æ¡ˆï¼Œä¸ä¸¢å¼ƒä»»åŠ¡ï¼‰
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        
        // å…³é—­åº”ç”¨æ—¶ç­‰å¾…ä»»åŠ¡å®Œæˆ
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.setAwaitTerminationSeconds(60);
        
        executor.initialize();
        return executor;
    }
    
    /**
     * é€šç”¨å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± 
     * ç”¨äºå¼‚æ­¥æ—¥å¿—ã€å¼‚æ­¥é€šçŸ¥ç­‰è½»é‡çº§ä»»åŠ¡
     */
    @Bean("asyncExecutor")
    public Executor asyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix("async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy()); // ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å¼‚å¸¸
        executor.initialize();
        return executor;
    }
    
    /**
     * æ•°æ®è¿ç§»ä¸“ç”¨çº¿ç¨‹æ± 
     * ç”¨äºè®¿å®¢è½¬æ­£æ—¶çš„å¤§é‡æ•°æ®è¿ç§»
     */
    @Bean("migrationExecutor")
    public Executor migrationExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);  // è¿ç§»ä»»åŠ¡è¾ƒå°‘ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°å°‘
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(50);
        executor.setThreadNamePrefix("migration-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

**Controller ä½¿ç”¨**ï¼š

```java
@RestController
@RequestMapping("/api/v1/digital-human")
public class DigitalHumanController {
    
    @Autowired
    @Qualifier("sseExecutor")  // ğŸ”¥ æŒ‡å®šä½¿ç”¨ sseExecutor
    private Executor sseExecutor;
    
    @PostMapping(value = "/sessions/{sessionId}/messages/stream", 
                 produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter streamMessage(@PathVariable String sessionId,
                                    @RequestBody SendMessageRequest request) {
        SseEmitter emitter = new SseEmitter(180000L);
        
        // ğŸ”¥ ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 
        CompletableFuture.runAsync(() -> {
            try {
                // æ•°å­—äººå¯¹è¯å¤„ç†
                bailianAIClient.chatStream(...);
            } catch (Exception e) {
                emitter.completeWithError(e);
            }
        }, sseExecutor);  // ğŸ”¥ ä¼ å…¥è‡ªå®šä¹‰çº¿ç¨‹æ± 
        
        return emitter;
    }
}
```

---

##### ğŸ“Š çº¿ç¨‹æ± é…ç½®å¯¹æ¯”

| é…ç½®é¡¹ | é»˜è®¤å€¼ï¼ˆcommonPoolï¼‰ | è‡ªå®šä¹‰é…ç½®ï¼ˆsseExecutorï¼‰ | è¯´æ˜ |
|--------|-------------------|---------------------|------|
| æ ¸å¿ƒçº¿ç¨‹æ•° | CPU æ ¸å¿ƒæ•° - 1ï¼ˆå¦‚ 7ï¼‰ | 20 | IO å¯†é›†å‹éœ€è¦æ›´å¤šçº¿ç¨‹ |
| æœ€å¤§çº¿ç¨‹æ•° | CPU æ ¸å¿ƒæ•° - 1 | 100 | æ”¯æŒå³°å€¼å¹¶å‘ |
| é˜Ÿåˆ—å®¹é‡ | æ— ç•Œé˜Ÿåˆ— | 200 | é˜²æ­¢æ— é™å †ç§¯ |
| æ‹’ç»ç­–ç•¥ | ä¸æ”¯æŒ | CallerRunsPolicy | é™çº§æ–¹æ¡ˆ |
| çº¿ç¨‹åç§° | ForkJoinPool.commonPool-worker-X | sse-chat-X | ä¾¿äºç›‘æ§æ’æŸ¥ |

**æ•ˆæœ**ï¼š
- âœ… æ•°å­—äººå¯¹è¯ä¸å½±å“å…¶ä»–ä¸šåŠ¡
- âœ… çº¿ç¨‹æ•°å¯æ ¹æ®å‹æµ‹è°ƒä¼˜
- âœ… æ‹’ç»ç­–ç•¥ä¿è¯æœåŠ¡ä¸å´©æºƒ
- âœ… ç›‘æ§å’Œæ’æŸ¥é—®é¢˜æ›´å®¹æ˜“

---

##### ğŸ” ç›‘æ§ä¸å‘Šè­¦

**çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡**ï¼š

```java
@Component
public class ThreadPoolMonitor {
    
    @Autowired
    @Qualifier("sseExecutor")
    private ThreadPoolTaskExecutor sseExecutor;
    
    /**
     * å®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ¯ 30 ç§’ï¼‰
     */
    @Scheduled(fixedRate = 30000)
    public void reportMetrics() {
        ThreadPoolExecutor pool = sseExecutor.getThreadPoolExecutor();
        
        int activeCount = pool.getActiveCount();        // æ´»è·ƒçº¿ç¨‹æ•°
        int poolSize = pool.getPoolSize();              // å½“å‰çº¿ç¨‹æ•°
        int corePoolSize = pool.getCorePoolSize();      // æ ¸å¿ƒçº¿ç¨‹æ•°
        int maximumPoolSize = pool.getMaximumPoolSize(); // æœ€å¤§çº¿ç¨‹æ•°
        long taskCount = pool.getTaskCount();           // æ€»ä»»åŠ¡æ•°
        long completedTaskCount = pool.getCompletedTaskCount(); // å®Œæˆä»»åŠ¡æ•°
        int queueSize = pool.getQueue().size();         // é˜Ÿåˆ—ä¸­ç­‰å¾…ä»»åŠ¡æ•°
        
        log.info("SSEçº¿ç¨‹æ± ç›‘æ§ - æ´»è·ƒ:{}/{}, é˜Ÿåˆ—:{}, æ€»ä»»åŠ¡:{}, å®Œæˆ:{}", 
            activeCount, maximumPoolSize, queueSize, taskCount, completedTaskCount);
        
        // ğŸ”¥ å‘Šè­¦ï¼šæ´»è·ƒçº¿ç¨‹æ•°è¶…è¿‡ 80%
        if (activeCount > maximumPoolSize * 0.8) {
            log.warn("âš ï¸ SSEçº¿ç¨‹æ± è´Ÿè½½é«˜ï¼šæ´»è·ƒçº¿ç¨‹ {}/{}", activeCount, maximumPoolSize);
            // å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé’‰é’‰ã€é‚®ä»¶ç­‰ï¼‰
        }
        
        // ğŸ”¥ å‘Šè­¦ï¼šé˜Ÿåˆ—å †ç§¯è¶…è¿‡ 80%
        if (queueSize > sseExecutor.getQueueCapacity() * 0.8) {
            log.warn("âš ï¸ SSEä»»åŠ¡é˜Ÿåˆ—å †ç§¯ï¼š{}/{}", queueSize, sseExecutor.getQueueCapacity());
        }
    }
}
```

---

#### 10.9.3 AI é€»è¾‘ä¼˜åŒ–ï¼šåœ¨ System Prompt ä¸­æ³¨å…¥æ—¶é—´

##### ğŸ¤” é—®é¢˜ï¼šè§£æè‡ªç„¶è¯­è¨€æ—¶é—´è¡¨è¾¾å¼å¾ˆå¤æ‚

**é—®é¢˜ä½ç½®**ï¼šç¬¬ 2.2.2 èŠ‚ `AgentToolExecutor.parseTimeExpression()` æ–¹æ³•

```java
// âŒ å¤æ‚ï¼šéœ€è¦ NLP åº“æˆ–å¤§é‡è§„åˆ™
private LocalDateTime parseTimeExpression(String timeStr) {
    // "åˆšæ‰" -> å½“å‰æ—¶é—´
    // "æ—©ä¸Š8ç‚¹" -> ä»Šå¤© 08:00
    // "æ˜¨å¤©æ™šä¸Š" -> æ˜¨å¤© 20:00
    // "å‰å¤©ä¸­åˆ" -> å‰å¤© 12:00
    // "ä¸Šå‘¨ä¸‰ä¸‹åˆ3ç‚¹åŠ" -> ...ï¼ˆéå¸¸å¤æ‚ï¼‰
}
```

**å›°éš¾ç‚¹**ï¼š
- éœ€è¦å¼•å…¥ NLP åº“ï¼ˆå¦‚ HanLPï¼‰æˆ–æ—¶é—´è¯­ä¹‰è§£æåº“
- è§„åˆ™å¤æ‚ï¼Œè¾¹ç•Œæƒ…å†µå¤šï¼ˆé—°å¹´ã€æ—¶åŒºã€èŠ‚å‡æ—¥ï¼‰
- ä¸åŒåœ°åŒºè¡¨è¾¾ä¹ æƒ¯ä¸åŒï¼ˆ"ä»Šæ—©"ã€"ä»Šå„¿ä¸ª"ï¼‰
- ä»£ç ç»´æŠ¤æˆæœ¬é«˜

---

##### âœ… è§£å†³æ–¹æ¡ˆï¼šè®© AI è‡ªå·±è®¡ç®—æ—¶é—´

**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨ System Prompt ä¸­æ³¨å…¥å½“å‰æ—¶é—´ï¼Œè®©ç™¾ç‚¼ AI è‡ªå·±å°†è‡ªç„¶è¯­è¨€è½¬ä¸ºæ ‡å‡†æ—¶é—´ã€‚

**å®ç°æ­¥éª¤**ï¼š

**æ­¥éª¤ 1ï¼šåŠ¨æ€ç”Ÿæˆ System Prompt**

```java
@Service
public class PromptBuilder {
    
    /**
     * æ„å»ºæ•°å­—äºº System Promptï¼ˆåŠ¨æ€æ³¨å…¥æ—¶é—´ï¼‰
     */
    public String buildDigitalHumanSystemPrompt(String sceneType) {
        // ğŸ”¥ è·å–å½“å‰æ—¶é—´
        LocalDateTime now = LocalDateTime.now();
        String currentTime = now.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss EEEE", Locale.CHINA));
        // ä¾‹å¦‚ï¼š"2026-01-29 14:30:00 æ˜ŸæœŸä¸‰"
        
        // åŸºç¡€ Prompt
        StringBuilder prompt = new StringBuilder();
        prompt.append("You are Dr. Xu (å¾åŒ»ç”Ÿ), a professional diabetes management assistant.\n");
        prompt.append("\n");
        
        // ğŸ”¥ æ³¨å…¥å½“å‰æ—¶é—´
        prompt.append("=== SYSTEM INFORMATION ===\n");
        prompt.append("Current System Time: ").append(currentTime).append("\n");
        prompt.append("Timezone: Asia/Shanghai (UTC+8)\n");
        prompt.append("\n");
        
        prompt.append("=== YOUR MISSION ===\n");
        prompt.append("Help users record their blood sugar, diet, and exercise data.\n");
        prompt.append("When user mentions time like 'åˆšæ‰', 'æ˜¨å¤©æ™šä¸Š', 'ä»Šæ—©', you MUST calculate the actual datetime based on Current System Time.\n");
        prompt.append("\n");
        
        prompt.append("=== TOOLS AVAILABLE ===\n");
        prompt.append("- save_blood_sugar: Save blood glucose record\n");
        prompt.append("  - Parameters: userId, value, measurementType, measurementTime (ISO 8601 format: YYYY-MM-DD HH:mm:ss)\n");
        prompt.append("- save_diet: Save diet record\n");
        prompt.append("  - Parameters: userId, mealType, foodItems, mealTime (ISO 8601 format)\n");
        prompt.append("\n");
        
        prompt.append("=== IMPORTANT RULES ===\n");
        prompt.append("1. When user says 'åˆšæ‰' or 'åˆšåˆš', use current time.\n");
        prompt.append("2. When user says 'æ—©ä¸Š8ç‚¹', calculate today 08:00:00.\n");
        prompt.append("3. When user says 'æ˜¨å¤©æ™šä¸Š', calculate yesterday 20:00:00 (estimate).\n");
        prompt.append("4. When calling tools, measurementTime/mealTime MUST be in format 'YYYY-MM-DD HH:mm:ss'.\n");
        prompt.append("5. Always ask user to confirm if the time is ambiguous.\n");
        
        return prompt.toString();
    }
}
```

**æ­¥éª¤ 2ï¼šè°ƒç”¨ç™¾ç‚¼ API æ—¶ä¼ å…¥**

```java
@Service
public class BailianAIClient {
    
    @Autowired
    private PromptBuilder promptBuilder;
    
    public void chatStream(String sessionId, String userMessage, Consumer<StreamResponse> callback) {
        // 1. ğŸ”¥ æ„å»ºåŠ¨æ€ System Prompt
        String systemPrompt = promptBuilder.buildDigitalHumanSystemPrompt("glucose_record");
        
        // 2. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
        List<Message> messages = new ArrayList<>();
        messages.add(new Message("system", systemPrompt)); // System Prompt
        messages.add(new Message("user", userMessage));    // ç”¨æˆ·æ¶ˆæ¯
        
        // 3. è°ƒç”¨ç™¾ç‚¼æµå¼ API
        BailianRequest request = new BailianRequest();
        request.setModel("qwen-plus");
        request.setMessages(messages);
        request.setTools(getToolDefinitions()); // Function Calling å·¥å…·å®šä¹‰
        request.setStream(true);
        
        // 4. å‘é€è¯·æ±‚å¹¶å¤„ç†æµå¼å“åº”
        bailianApiClient.chatCompletionStream(request, callback);
    }
}
```

**æ­¥éª¤ 3ï¼šAI è‡ªåŠ¨è®¡ç®—æ—¶é—´**

**å¯¹è¯ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·ï¼š"æˆ‘æ˜¨å¤©æ™šä¸Š 8 ç‚¹æµ‹çš„è¡€ç³–æ˜¯ 6.5"

AI æ¨ç†ï¼ˆå†…éƒ¨ï¼‰ï¼š
- Current System Time: 2026-01-29 14:30:00 æ˜ŸæœŸä¸‰
- "æ˜¨å¤©æ™šä¸Š 8 ç‚¹" â†’ 2026-01-28 20:00:00

AI è¿”å›ï¼ˆFunction Callï¼‰ï¼š
{
  "tool_name": "save_blood_sugar",
  "parameters": {
    "userId": "user-123",
    "value": 6.5,
    "measurementType": "random",
    "measurementTime": "2026-01-28 20:00:00"  // ğŸ”¥ AI å·²è®¡ç®—å¥½
  }
}

åç«¯ Javaï¼š
String timeStr = params.get("measurementTime"); // "2026-01-28 20:00:00"
LocalDateTime time = LocalDateTime.parse(timeStr, DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
// âœ… ç®€å•çš„å­—ç¬¦ä¸²è§£æå³å¯ï¼Œä¸éœ€è¦å¤æ‚çš„ NLP
```

---

**æ­¥éª¤ 4ï¼šç®€åŒ–åç«¯ä»£ç **

```java
@AgentTool(name = "save_blood_sugar")
public String saveBloodSugar(
    @Param("userId") String userId,
    @Param("value") Double glucoseValue,
    @Param("measurementType") String measurementType,
    @Param("measurementTime") String measurementTimeStr
) {
    try {
        // ğŸ”¥ ç®€åŒ–ï¼šç›´æ¥è§£ææ ‡å‡†æ ¼å¼ï¼ˆAI å·²ç»è®¡ç®—å¥½äº†ï¼‰
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        LocalDateTime measurementTime = LocalDateTime.parse(measurementTimeStr, formatter);
        
        // ä¿å­˜è®°å½•
        CreateGlucoseRecordRequest request = new CreateGlucoseRecordRequest();
        request.setGlucoseValue(new BigDecimal(glucoseValue));
        request.setMeasurementType(measurementType);
        request.setMeasurementTime(measurementTime);
        
        glucoseService.createRecord(userId, request);
        
        return String.format("å·²æˆåŠŸè®°å½•è¡€ç³–å€¼ %.1f mmol/L", glucoseValue);
        
    } catch (DateTimeParseException e) {
        // å¦‚æœ AI è¿”å›çš„æ ¼å¼é”™è¯¯ï¼Œè¦æ±‚ AI é‡æ–°ç”Ÿæˆ
        log.error("AI è¿”å›çš„æ—¶é—´æ ¼å¼é”™è¯¯ï¼š{}", measurementTimeStr, e);
        return "æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°æä¾›æ ‡å‡†æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss";
    }
}
```

---

##### ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®ç°éš¾åº¦ | å‡†ç¡®æ€§ | å¯ç»´æŠ¤æ€§ | æ‰©å±•æ€§ |
|------|---------|-------|---------|--------|
| **åç«¯ NLP è§£æ** | â­â­â­â­â­ å¾ˆé«˜ | â­â­â­ ä¸­ç­‰ | â­â­ ä½ | â­â­ ä½ |
| **AI è‡ªåŠ¨è®¡ç®—** | â­ å¾ˆä½ | â­â­â­â­ é«˜ | â­â­â­â­â­ å¾ˆé«˜ | â­â­â­â­â­ å¾ˆé«˜ |

**ä¼˜åŠ¿**ï¼š
- âœ… åç«¯ä»£ç ç®€å•ï¼šåªéœ€è¦ `LocalDateTime.parse()`
- âœ… AI ç†è§£èƒ½åŠ›å¼ºï¼šå¯ä»¥å¤„ç†å„ç§å£è¯­è¡¨è¾¾
- âœ… æ˜“äºæ‰©å±•ï¼šæ–°å¢æ—¶é—´è¡¨è¾¾æ–¹å¼æ— éœ€æ”¹ä»£ç 
- âœ… å¤šè¯­è¨€æ”¯æŒï¼šAI å¤©ç„¶æ”¯æŒå¤šè¯­è¨€æ—¶é—´è¡¨è¾¾

**ç¤ºä¾‹å¯¹è¯ï¼ˆå„ç§å¤æ‚è¡¨è¾¾ï¼‰**ï¼š

```
ç”¨æˆ·ï¼š"æˆ‘åˆšæµ‹çš„"
AI è®¡ç®—ï¼š2026-01-29 14:30:00ï¼ˆå½“å‰æ—¶é—´ï¼‰

ç”¨æˆ·ï¼š"æˆ‘æ—©ä¸Šç©ºè…¹æµ‹çš„"
AI è®¡ç®—ï¼š2026-01-29 07:00:00ï¼ˆä»Šå¤©æ—©ä¸Šï¼‰

ç”¨æˆ·ï¼š"æˆ‘å‰å¤©ä¸‹åˆ 3 ç‚¹åŠæµ‹çš„"
AI è®¡ç®—ï¼š2026-01-27 15:30:00

ç”¨æˆ·ï¼š"æˆ‘ä¸Šå‘¨äº”æ™šé¥­åæµ‹çš„"
AI è®¡ç®—ï¼š2026-01-24 19:30:00ï¼ˆä¼°ç®—ï¼‰
AI å›å¤ï¼š"æ‚¨è¯´çš„æ˜¯ä¸Šå‘¨äº”ï¼ˆ1æœˆ24æ—¥ï¼‰æ™šé¥­åå—ï¼Ÿå¤§çº¦æ™šä¸Š7ç‚¹åŠï¼Ÿ"ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰
```

---

##### ğŸ”§ Prompt å·¥ç¨‹æŠ€å·§

**æŠ€å·§ 1ï¼šæ˜ç¡®è¾“å‡ºæ ¼å¼è¦æ±‚**

```
When calling tools, measurementTime MUST be in format 'YYYY-MM-DD HH:mm:ss'.
âŒ BAD: "2026-1-29 8:0:0"
âœ… GOOD: "2026-01-29 08:00:00"
```

**æŠ€å·§ 2ï¼šæ¨¡ç³Šæ—¶é—´çš„å¤„ç†ç­–ç•¥**

```
If user says vague time like "æ—©ä¸Š" without specific hour:
- ç©ºè…¹ï¼š07:00
- æ—©é¤åï¼š08:30
- åˆé¤å‰ï¼š11:30
- åˆé¤åï¼š13:00
- æ™šé¤å‰ï¼š17:30
- æ™šé¤åï¼š19:00
- ç¡å‰ï¼š22:00

Always ask user to confirm if unsure.
```

**æŠ€å·§ 3ï¼šå¼‚å¸¸æ—¶é—´çš„æ ¡éªŒæç¤º**

```
If calculated time is:
- In the future: Ask user "æ‚¨æ˜¯è¯´ä»Šå¤©ï¼ˆæœªæ¥ï¼‰è¿˜æ˜¯æ˜¨å¤©ï¼Ÿ"
- More than 7 days ago: Ask user to confirm the date
- Outside reasonable range (like 03:00 AM for meal): Double check with user
```

---

### 10.10 é˜²å¼¹åŠ å›ºæ€»ç»“

| åŠ å›ºé¡¹ | é£é™©ç­‰çº§ | å®ç°éš¾åº¦ | æŠ•å…¥æ—¶é—´ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|--------|
| **è¶Šæƒè®¿é—®ï¼ˆIDORï¼‰é˜²æŠ¤** | ğŸ”´ ä¸¥é‡ï¼ˆ9.1/10ï¼‰ | â­â­ ä½ | 4 å°æ—¶ | **P0** |
| **SSE çº¿ç¨‹æ± éš”ç¦»** | ğŸŸ¡ ä¸­ç­‰ï¼ˆ5.5/10ï¼‰ | â­â­ ä½ | 2 å°æ—¶ | **P0** |
| **AI æ—¶é—´æ³¨å…¥ä¼˜åŒ–** | ğŸŸ¢ ä½ï¼ˆ2.0/10ï¼‰ | â­ å¾ˆä½ | 1 å°æ—¶ | **P1** |

**æ€»æŠ•å…¥**ï¼šçº¦ 7 å°æ—¶ï¼ˆP0 é¡¹ç›®å¿…é¡»å®Œæˆå‰ä¸¤é¡¹ï¼‰

**æ”¶ç›Š**ï¼š
- ğŸ›¡ï¸ **å®‰å…¨æ€§**ï¼šé˜²æ­¢è¶Šæƒè®¿é—®ï¼Œä¿æŠ¤ç”¨æˆ·éšç§
- ğŸš€ **ç¨³å®šæ€§**ï¼šé˜²æ­¢çº¿ç¨‹æ± è€—å°½ï¼Œåº”ç”¨ä¸å‡æ­»
- ğŸ’¡ **å¯ç»´æŠ¤æ€§**ï¼šAI è‡ªåŠ¨è®¡ç®—æ—¶é—´ï¼Œå‡å°‘ä»£ç å¤æ‚åº¦

---

## 11. åŒ»ç–—ä¸šåŠ¡ç‰¹æ®Šé˜²æŠ¤ï¼ˆğŸ¥ ç”Ÿå‘½çº¿ï¼‰

### 11.1 å±æ€¥å€¼å®æ—¶é˜»æ–­ï¼ˆğŸš¨ æœ€é«˜ä¼˜å…ˆçº§ï¼‰

#### 11.1.1 ä¸šåŠ¡è‡´å‘½ä¼¤ï¼šç¼ºå°‘å±æ€¥å€¼é¢„è­¦

**é—®é¢˜æè¿°**ï¼šå½“å‰è®¾è®¡ä¸­ï¼ŒAI åªæ˜¯æœºæ¢°åœ°è®°å½•æ•°æ®ï¼Œæœªå¯¹å±æ€¥å€¼è¿›è¡Œæ‹¦æˆªã€‚

**è‡´å‘½åœºæ™¯**ï¼š

```
ç”¨æˆ·ï¼š"æˆ‘åˆšæµ‹çš„è¡€ç³–æ˜¯ 2.1"
AIï¼š"å¥½çš„ï¼Œå·²ä¸ºæ‚¨è®°å½•è¡€ç³– 2.1 mmol/Lã€‚"

å®é™…ï¼š2.1 mmol/L æ˜¯ä¸¥é‡ä½è¡€ç³–ï¼Œç”¨æˆ·å¯èƒ½éšæ—¶æ˜è¿·ï¼âš ï¸âš ï¸âš ï¸
```

**é£é™©è¯„ä¼°**ï¼š
- **æ³•å¾‹é£é™©**ï¼šåŒ»ç–—å¥åº·ç±» App æœªèƒ½åŠæ—¶é¢„è­¦å±æ€¥å€¼ï¼Œå¯èƒ½æ‰¿æ‹…è¿å¸¦è´£ä»»
- **ä¼¦ç†è´£ä»»**ï¼šä½œä¸ºå¥åº·ç®¡ç†å·¥å…·ï¼Œæœ‰ä¹‰åŠ¡ä¿æŠ¤ç”¨æˆ·ç”Ÿå‘½å®‰å…¨
- **å“ç‰Œé£é™©**ï¼šä¸€æ—¦å‘ç”Ÿäº‹æ•…ï¼Œå“ç‰Œä¿¡èª‰å°†å—åˆ°ä¸¥é‡æ‰“å‡»

---

#### 11.1.2 åŒ»ç–—å±æ€¥å€¼æ ‡å‡†

**è¡€ç³–å±æ€¥å€¼ï¼ˆå‚è€ƒä¸­ååŒ»å­¦ä¼šæ ‡å‡†ï¼‰**ï¼š

| çº§åˆ« | èŒƒå›´ï¼ˆmmol/Lï¼‰ | å±é™©ç¨‹åº¦ | ä¸´åºŠè¡¨ç° | å¤„ç†æªæ–½ |
|------|--------------|---------|---------|---------|
| **å±æ€¥ä½å€¼** | < 2.8 | æé«˜ | æ„è¯†æ¨¡ç³Šã€æ˜è¿· | ğŸš¨ ç«‹å³è¡¥ç³– + å°±åŒ» |
| **ä½è¡€ç³–** | 2.8 - 3.9 | é«˜ | å¿ƒæ‚¸ã€å‡ºæ±—ã€é¥¥é¥¿ | âš ï¸ è¡¥ç³– + 15åˆ†é’Ÿåå¤æµ‹ |
| **æ­£å¸¸ç©ºè…¹** | 3.9 - 6.1 | æ­£å¸¸ | - | âœ… ç»§ç»­ä¿æŒ |
| **æ­£å¸¸é¤å** | < 7.8 | æ­£å¸¸ | - | âœ… ç»§ç»­ä¿æŒ |
| **åé«˜** | 7.8 - 11.1 | è½»åº¦ | å£æ¸´ã€å°¿é¢‘ | ğŸ’¡ è°ƒæ•´é¥®é£Ÿ/è¿åŠ¨ |
| **é«˜è¡€ç³–** | 11.1 - 16.7 | ä¸­åº¦ | ä¹åŠ›ã€å¤šå°¿ | âš ï¸ ç›‘æµ‹é…®ä½“ + å°±åŒ» |
| **å±æ€¥é«˜å€¼** | > 16.7 | æé«˜ | é…®ç—‡é…¸ä¸­æ¯’é£é™© | ğŸš¨ ç«‹å³å°±åŒ» |

---

#### 11.1.3 å®Œæ•´å®ç°æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šå®šä¹‰å±æ€¥å€¼å¸¸é‡**

```java
package com.tangxiaowen.glucose.constants;

/**
 * è¡€ç³–å±æ€¥å€¼å¸¸é‡
 */
public class GlucoseCriticalValues {
    
    // å±æ€¥ä½å€¼ï¼ˆä¸¥é‡ä½è¡€ç³–ï¼‰
    public static final BigDecimal CRITICAL_LOW = new BigDecimal("2.8");
    
    // ä½è¡€ç³–é˜ˆå€¼
    public static final BigDecimal LOW_THRESHOLD = new BigDecimal("3.9");
    
    // ç©ºè…¹æ­£å¸¸ä¸Šé™
    public static final BigDecimal FASTING_NORMAL_HIGH = new BigDecimal("6.1");
    
    // é¤åæ­£å¸¸ä¸Šé™
    public static final BigDecimal POSTPRANDIAL_NORMAL_HIGH = new BigDecimal("7.8");
    
    // é«˜è¡€ç³–é˜ˆå€¼
    public static final BigDecimal HIGH_THRESHOLD = new BigDecimal("11.1");
    
    // å±æ€¥é«˜å€¼ï¼ˆé…®ç—‡é…¸ä¸­æ¯’é£é™©ï¼‰
    public static final BigDecimal CRITICAL_HIGH = new BigDecimal("16.7");
}
```

**æ­¥éª¤ 2ï¼šåˆ›å»ºå‘Šè­¦æœåŠ¡**

```java
package com.tangxiaowen.alert.service;

/**
 * ç´§æ€¥å‘Šè­¦æœåŠ¡
 */
@Service
@Slf4j
public class EmergencyAlertService {
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è§¦å‘ç´§æ€¥å‘Šè­¦
     * @param userId ç”¨æˆ·ID
     * @param alertType å‘Šè­¦ç±»å‹
     * @param value æ•°å€¼
     * @param metadata å…ƒæ•°æ®
     */
    public void triggerEmergencyAlert(String userId, String alertType, 
                                     BigDecimal value, Map<String, Object> metadata) {
        // 1. è®°å½•å‘Šè­¦
        EmergencyAlert alert = new EmergencyAlert();
        alert.setAlertId(UUID.randomUUID().toString());
        alert.setUserId(userId);
        alert.setAlertType(alertType);
        alert.setValue(value);
        alert.setMetadata(metadata);
        alert.setSeverity(calculateSeverity(alertType, value));
        alert.setCreatedAt(LocalDateTime.now());
        
        emergencyAlertMapper.insert(alert);
        
        // 2. ğŸ”¥ æ¨é€å®æ—¶é€šçŸ¥åˆ°å‰ç«¯ï¼ˆWebSocket/SSEï¼‰
        notificationService.sendRealtimeAlert(userId, alert);
        
        // 3. å‘é€çŸ­ä¿¡é€šçŸ¥ï¼ˆå±æ€¥å€¼ï¼‰
        if (alert.getSeverity().equals("CRITICAL")) {
            smsService.sendEmergencySms(userId, alertType, value);
        }
        
        // 4. è®°å½•åˆ° Redisï¼ˆç”¨äºé™æµï¼Œé˜²æ­¢é‡å¤å‘Šè­¦ï¼‰
        String lockKey = String.format("alert:lock:%s:%s", userId, alertType);
        redisTemplate.opsForValue().set(lockKey, "1", 15, TimeUnit.MINUTES);
        
        log.error("ğŸš¨ ç´§æ€¥å‘Šè­¦è§¦å‘ï¼šuserId={}, type={}, value={}", userId, alertType, value);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦ï¼ˆé˜²æ­¢é¢‘ç¹å‘Šè­¦ï¼‰
     */
    public boolean shouldAlert(String userId, String alertType) {
        String lockKey = String.format("alert:lock:%s:%s", userId, alertType);
        return !redisTemplate.hasKey(lockKey);
    }
    
    /**
     * è®¡ç®—å‘Šè­¦ä¸¥é‡ç¨‹åº¦
     */
    private String calculateSeverity(String alertType, BigDecimal value) {
        if (alertType.equals("ä½è¡€ç³–")) {
            if (value.compareTo(CRITICAL_LOW) < 0) {
                return "CRITICAL";  // å±æ€¥
            } else {
                return "WARNING";   // è­¦å‘Š
            }
        }
        // ... å…¶ä»–å‘Šè­¦ç±»å‹
        return "INFO";
    }
}
```

**æ­¥éª¤ 3ï¼šæ”¹é€  AgentToolExecutor**

```java
@Service
public class AgentToolExecutor {
    
    @Autowired
    private EmergencyAlertService alertService;
    
    @AgentTool(name = "save_blood_sugar")
    public String saveBloodSugar(
        @Param("userId") String userId,
        @Param("value") Double glucoseValue,
        @Param("measurementType") String measurementType,
        @Param("measurementTime") String measurementTimeStr
    ) {
        BigDecimal value = new BigDecimal(glucoseValue);
        
        // 1. ä¿å­˜è®°å½•ï¼ˆåŸé€»è¾‘ï¼‰
        CreateGlucoseRecordRequest request = new CreateGlucoseRecordRequest();
        request.setGlucoseValue(value);
        request.setMeasurementType(measurementType);
        request.setMeasurementTime(LocalDateTime.parse(measurementTimeStr, 
            DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        
        glucoseService.createRecord(userId, request);
        
        // 2. ğŸ”¥ å±æ€¥å€¼åˆ¤æ–­ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        
        // 2.1 å±æ€¥ä½å€¼ï¼ˆ< 2.8ï¼‰
        if (value.compareTo(CRITICAL_LOW) < 0) {
            if (alertService.shouldAlert(userId, "ä½è¡€ç³–")) {
                alertService.triggerEmergencyAlert(userId, "ä½è¡€ç³–", value, 
                    Map.of("measurementType", measurementType));
            }
            
            // ğŸ”¥ è¿”å›ç»™ AI çš„ç´§æ€¥æŒ‡ä»¤ï¼ˆå¼ºåˆ¶æ‰“æ–­å¸¸è§„å¯¹è¯ï¼‰
            return String.format(
                "ã€ğŸš¨ ç³»ç»Ÿç´§æ€¥è­¦å‘Šã€‘\n" +
                "æ£€æµ‹åˆ°ä¸¥é‡ä½è¡€ç³–ï¼š%.1f mmol/Lï¼ˆå±æ€¥å€¼ < 2.8ï¼‰\n\n" +
                "è¯·ç«‹å³æ‰§è¡Œä»¥ä¸‹æ€¥æ•‘æªæ–½ï¼š\n" +
                "1. ç«‹å³è¿›é£Ÿ 15-20 å…‹å¿«é€Ÿç¢³æ°´åŒ–åˆç‰©ï¼ˆåŠæ¯æœæ±ã€3-4 é¢—æ–¹ç³–ã€æˆ– 1 æ±¤åŒ™èœ‚èœœï¼‰\n" +
                "2. 15 åˆ†é’Ÿåå¤æµ‹è¡€ç³–\n" +
                "3. å¦‚è¡€ç³–ä»ä½äº 3.9ï¼Œé‡å¤æ­¥éª¤ 1\n" +
                "4. å¦‚å‡ºç°æ„è¯†æ¨¡ç³Šã€æ— æ³•è¿›é£Ÿï¼Œè¯·ç«‹å³æ‹¨æ‰“ 120 æ€¥æ•‘ç”µè¯\n\n" +
                "è¯·ä¸è¦è¯´ä»»ä½•å®¢å¥—è¯ï¼Œä¸“æ³¨äºæ€¥æ•‘æŒ‡å¯¼ï¼", 
                glucoseValue
            );
        }
        
        // 2.2 ä½è¡€ç³–ï¼ˆ2.8 - 3.9ï¼‰
        if (value.compareTo(LOW_THRESHOLD) < 0) {
            if (alertService.shouldAlert(userId, "ä½è¡€ç³–")) {
                alertService.triggerEmergencyAlert(userId, "ä½è¡€ç³–", value, 
                    Map.of("measurementType", measurementType));
            }
            
            return String.format(
                "ã€âš ï¸ è¡€ç³–åä½è­¦å‘Šã€‘\n" +
                "æ‚¨çš„è¡€ç³–ä¸º %.1f mmol/Lï¼Œä½äºæ­£å¸¸èŒƒå›´ï¼ˆ3.9-6.1ï¼‰ã€‚\n\n" +
                "å»ºè®®ç«‹å³è¡¥å…… 15 å…‹ç¢³æ°´åŒ–åˆç‰©ï¼ˆå¦‚ 1 ç‰‡å…¨éº¦é¢åŒ…æˆ– 1 ä¸ªè‹¹æœï¼‰ï¼Œ" +
                "å¹¶åœ¨ 15 åˆ†é’Ÿåå¤æµ‹è¡€ç³–ã€‚", 
                glucoseValue
            );
        }
        
        // 2.3 å±æ€¥é«˜å€¼ï¼ˆ> 16.7ï¼‰
        if (value.compareTo(CRITICAL_HIGH) > 0) {
            if (alertService.shouldAlert(userId, "é«˜è¡€ç³–")) {
                alertService.triggerEmergencyAlert(userId, "é«˜è¡€ç³–", value, 
                    Map.of("measurementType", measurementType));
            }
            
            return String.format(
                "ã€ğŸš¨ ç³»ç»Ÿç´§æ€¥è­¦å‘Šã€‘\n" +
                "æ£€æµ‹åˆ°å±é™©é«˜è¡€ç³–ï¼š%.1f mmol/Lï¼ˆå±æ€¥å€¼ > 16.7ï¼‰\n\n" +
                "è¯·ç«‹å³é‡‡å–ä»¥ä¸‹æªæ–½ï¼š\n" +
                "1. æ£€æŸ¥æ˜¯å¦æœ‰é…®ä½“ï¼ˆå°¿é…®è¯•çº¸æˆ–è¡€é…®ä»ªï¼‰\n" +
                "2. å¤§é‡é¥®æ°´ï¼ˆæ¯å°æ—¶ 500mlï¼‰\n" +
                "3. å¦‚æœ‰é…®ä½“é˜³æ€§ï¼Œç«‹å³å°±åŒ»\n" +
                "4. å¦‚å‡ºç°æ¶å¿ƒã€å‘•åã€è…¹ç—›ã€å‘¼å¸å›°éš¾ï¼Œç«‹å³æ‹¨æ‰“ 120\n\n" +
                "è­¦å‘Šï¼šè¯·å‹¿æ“…è‡ªå¢åŠ èƒ°å²›ç´ å‰‚é‡ï¼Œå¿…é¡»åœ¨åŒ»ç”ŸæŒ‡å¯¼ä¸‹ç”¨è¯ï¼", 
                glucoseValue
            );
        }
        
        // 2.4 é«˜è¡€ç³–ï¼ˆ11.1 - 16.7ï¼‰
        if (value.compareTo(HIGH_THRESHOLD) > 0) {
            return String.format(
                "ã€âš ï¸ è¡€ç³–åé«˜æç¤ºã€‘\n" +
                "æ‚¨çš„è¡€ç³–ä¸º %.1f mmol/Lï¼Œé«˜äºæ­£å¸¸èŒƒå›´ã€‚\n\n" +
                "å»ºè®®ï¼š\n" +
                "1. å¤šå–æ°´ï¼Œä¿ƒè¿›è¡€ç³–æ’æ³„\n" +
                "2. è¿›è¡Œè½»åº¦è¿åŠ¨ï¼ˆå¦‚æ•£æ­¥ 30 åˆ†é’Ÿï¼‰\n" +
                "3. ä¸‹ä¸€é¤å‡å°‘ç¢³æ°´æ‘„å…¥\n" +
                "4. å¦‚æŒç»­ 3 å¤©ä»¥ä¸Šè¡€ç³–åé«˜ï¼Œè¯·å’¨è¯¢åŒ»ç”Ÿè°ƒæ•´ç”¨è¯", 
                glucoseValue
            );
        }
        
        // 2.5 æ­£å¸¸èŒƒå›´
        return String.format(
            "å·²æˆåŠŸè®°å½•è¡€ç³–å€¼ %.1f mmol/Lï¼ˆ%sï¼‰ã€‚æ‚¨çš„è¡€ç³–åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œè¯·ç»§ç»­ä¿æŒï¼", 
            glucoseValue, 
            getMeasurementTypeText(measurementType)
        );
    }
}
```

**æ­¥éª¤ 4ï¼šå‰ç«¯å®æ—¶å‘Šè­¦å±•ç¤º**

```javascript
// å¾®ä¿¡å°ç¨‹åºå‰ç«¯æ¥æ”¶å‘Šè­¦
uni.onSocketMessage((res) => {
  const alert = JSON.parse(res.data);
  
  if (alert.type === 'emergency_alert') {
    // ğŸ”¥ å¼¹å‡ºå…¨å±å‘Šè­¦ï¼ˆæ— æ³•å…³é—­ï¼Œå¿…é¡»ç”¨æˆ·ç¡®è®¤ï¼‰
    uni.showModal({
      title: 'ğŸš¨ ç´§æ€¥å¥åº·è­¦å‘Š',
      content: alert.message,
      showCancel: false,
      confirmText: 'æˆ‘çŸ¥é“äº†',
      success: (res) => {
        // ç”¨æˆ·ç¡®è®¤åï¼Œè®°å½•ç¡®è®¤æ—¶é—´
        confirmAlert(alert.alertId);
      }
    });
    
    // éœ‡åŠ¨æç¤º
    uni.vibrateShort({ type: 'heavy' });
    
    // æ’­æ”¾å‘Šè­¦éŸ³æ•ˆ
    const audio = uni.createInnerAudioContext();
    audio.src = '/static/sounds/emergency.mp3';
    audio.play();
  }
});
```

---

#### 11.1.4 å‘Šè­¦æ•°æ®åº“è®¾è®¡

```sql
CREATE TABLE tbl_emergency_alert (
    alert_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    alert_type VARCHAR(50) NOT NULL,  -- ä½è¡€ç³–/é«˜è¡€ç³–/å…¶ä»–
    value NUMERIC(5, 2) NOT NULL,     -- è§¦å‘å€¼
    severity VARCHAR(20) NOT NULL,    -- CRITICAL/WARNING/INFO
    metadata JSONB,                   -- å…ƒæ•°æ®ï¼ˆæµ‹é‡ç±»å‹ã€æ—¶é—´ç­‰ï¼‰
    is_confirmed BOOLEAN DEFAULT FALSE, -- ç”¨æˆ·æ˜¯å¦ç¡®è®¤
    confirmed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_emergency_alert_user_id ON tbl_emergency_alert(user_id);
CREATE INDEX idx_emergency_alert_created_at ON tbl_emergency_alert(created_at);
CREATE INDEX idx_emergency_alert_severity ON tbl_emergency_alert(severity);

COMMENT ON TABLE tbl_emergency_alert IS 'ğŸš¨ ç´§æ€¥å‘Šè­¦è®°å½•è¡¨';
COMMENT ON COLUMN tbl_emergency_alert.severity IS 'ä¸¥é‡ç¨‹åº¦ï¼šCRITICAL-å±æ€¥ï¼ŒWARNING-è­¦å‘Šï¼ŒINFO-æç¤º';
```

---

### 11.2 è¡€ç³–å•ä½åœ°ç‹±é˜²æŠ¤

#### 11.2.1 é—®é¢˜ï¼šå•ä½æ··æ·†å¯¼è‡´è‡´å‘½é”™è¯¯

**èƒŒæ™¯**ï¼š
- **ä¸­å›½æ ‡å‡†**ï¼šmmol/Lï¼ˆæ¯«æ‘©å°”/å‡ï¼‰
- **ç¾å›½æ ‡å‡†**ï¼šmg/dLï¼ˆæ¯«å…‹/åˆ†å‡ï¼‰
- **è½¬æ¢ç³»æ•°**ï¼š1 mmol/L â‰ˆ 18 mg/dL

**è‡´å‘½åœºæ™¯**ï¼š

```
åœºæ™¯ 1ï¼šç”¨æˆ·çœ‹è¡€ç³–ä»ªæ˜¾ç¤º 100 (mg/dLï¼Œæ­£å¸¸)
ç”¨æˆ·å¯¹ AI è¯´ï¼š"æˆ‘è¡€ç³– 100"
AI è®°å½•ï¼š100 mmol/Lï¼ˆç›¸å½“äº 1800 mg/dLï¼Œè‡´æ­»é‡ï¼ï¼‰âŒ

åœºæ™¯ 2ï¼šç”¨æˆ·è¯´"5.6"
ç³»ç»Ÿè¯¯åˆ¤ä¸º mg/dLï¼ˆæä½è¡€ç³–ï¼‰âŒ
å®é™…ï¼šç”¨æˆ·æ˜¯ä¸­å›½ç”¨æˆ·ï¼Œä½¿ç”¨ mmol/Lï¼ˆæ­£å¸¸ï¼‰
```

---

#### 11.2.2 å®Œæ•´è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šAI Prompt å¢å¼º**

```java
@Service
public class PromptBuilder {
    
    public String buildDigitalHumanSystemPrompt(String sceneType) {
        StringBuilder prompt = new StringBuilder();
        
        // ... å…¶ä»– Prompt å†…å®¹ ...
        
        // ğŸ”¥ å¢åŠ å•ä½è¯†åˆ«è§„åˆ™
        prompt.append("=== GLUCOSE UNIT DETECTION RULES ===\n");
        prompt.append("China uses mmol/L, USA uses mg/dL. 1 mmol/L â‰ˆ 18 mg/dL.\n");
        prompt.append("\n");
        prompt.append("Detection Logic:\n");
        prompt.append("1. If user says a number > 30, it's LIKELY mg/dL.\n");
        prompt.append("   Example: 'è¡€ç³– 100' â†’ Likely 100 mg/dL (â‰ˆ 5.6 mmol/L)\n");
        prompt.append("\n");
        prompt.append("2. If user says a number < 30, it's LIKELY mmol/L.\n");
        prompt.append("   Example: 'è¡€ç³– 5.6' â†’ Likely 5.6 mmol/L\n");
        prompt.append("\n");
        prompt.append("3. When in doubt, ASK USER to confirm the unit:\n");
        prompt.append("   'è¯·é—®æ‚¨çš„è¡€ç³–å•ä½æ˜¯ mmol/L è¿˜æ˜¯ mg/dLï¼Ÿ'\n");
        prompt.append("\n");
        prompt.append("4. When calling save_blood_sugar, include 'unit' parameter.\n");
        prompt.append("   Example: {value: 100, unit: 'mg/dL'}\n");
        
        return prompt.toString();
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå·¥å…·å¢åŠ  unit å‚æ•°**

```java
@AgentTool(name = "save_blood_sugar")
public String saveBloodSugar(
    @Param("userId") String userId,
    @Param("value") Double glucoseValue,
    @Param("unit") String unit,  // ğŸ”¥ æ–°å¢ï¼šå•ä½å‚æ•°
    @Param("measurementType") String measurementType,
    @Param("measurementTime") String measurementTimeStr
) {
    BigDecimal value = new BigDecimal(glucoseValue);
    
    // 1. ğŸ”¥ å•ä½å½’ä¸€åŒ–ï¼ˆç»Ÿä¸€è½¬æ¢ä¸º mmol/L å­˜å‚¨ï¼‰
    BigDecimal normalizedValue;
    String originalUnit = unit;
    
    if ("mg/dL".equalsIgnoreCase(unit) || "mg/dl".equalsIgnoreCase(unit)) {
        // mg/dL è½¬ mmol/Lï¼šé™¤ä»¥ 18
        normalizedValue = value.divide(new BigDecimal("18"), 2, RoundingMode.HALF_UP);
        log.info("å•ä½è½¬æ¢ï¼š{} mg/dL â†’ {} mmol/L", value, normalizedValue);
        
    } else if ("mmol/L".equalsIgnoreCase(unit) || "mmol/l".equalsIgnoreCase(unit)) {
        // å·²ç»æ˜¯ mmol/Lï¼Œæ— éœ€è½¬æ¢
        normalizedValue = value;
        
    } else {
        // æœªçŸ¥å•ä½ï¼Œæ ¹æ®æ•°å€¼å¤§å°æ¨æ–­
        if (value.compareTo(new BigDecimal("30")) > 0) {
            // å¤§äº 30ï¼Œæ¨æ–­ä¸º mg/dL
            normalizedValue = value.divide(new BigDecimal("18"), 2, RoundingMode.HALF_UP);
            originalUnit = "mg/dL (æ¨æ–­)";
            log.warn("æœªæŒ‡å®šå•ä½ï¼Œæ ¹æ®æ•°å€¼æ¨æ–­ä¸º mg/dLï¼š{} â†’ {} mmol/L", value, normalizedValue);
        } else {
            // å°äº 30ï¼Œæ¨æ–­ä¸º mmol/L
            normalizedValue = value;
            originalUnit = "mmol/L (æ¨æ–­)";
        }
    }
    
    // 2. ä¿å­˜è®°å½•ï¼ˆå­˜å‚¨å½’ä¸€åŒ–åçš„å€¼ï¼‰
    CreateGlucoseRecordRequest request = new CreateGlucoseRecordRequest();
    request.setGlucoseValue(normalizedValue);  // å­˜å‚¨ mmol/L
    request.setMeasurementType(measurementType);
    request.setMeasurementTime(LocalDateTime.parse(measurementTimeStr, 
        DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
    
    // 3. åœ¨å¤‡æ³¨ä¸­ä¿ç•™åŸå§‹å•ä½å’ŒåŸå§‹å€¼
    request.setNotes(String.format("åŸå§‹å€¼ï¼š%.1f %s", glucoseValue, originalUnit));
    
    glucoseService.createRecord(userId, request);
    
    // 4. å±æ€¥å€¼åˆ¤æ–­ï¼ˆä½¿ç”¨å½’ä¸€åŒ–åçš„å€¼ï¼‰
    // ... ï¼ˆå±æ€¥å€¼é€»è¾‘ä¿æŒä¸å˜ï¼‰...
    
    // 5. è¿”å›æ—¶ä½¿ç”¨ç”¨æˆ·ç†Ÿæ‚‰çš„å•ä½
    if (originalUnit.startsWith("mg/dL")) {
        return String.format(
            "å·²æˆåŠŸè®°å½•è¡€ç³–å€¼ %.0f mg/dLï¼ˆçº¦ %.1f mmol/Lï¼‰ã€‚", 
            glucoseValue, 
            normalizedValue
        );
    } else {
        return String.format(
            "å·²æˆåŠŸè®°å½•è¡€ç³–å€¼ %.1f mmol/Lã€‚", 
            normalizedValue
        );
    }
}
```

**æ–¹æ¡ˆ 3ï¼šæ•°æ®åº“å­˜å‚¨ç­–ç•¥**

```sql
-- åœ¨ tbl_glucose_record è¡¨ä¸­å¢åŠ å­—æ®µ
ALTER TABLE tbl_glucose_record 
ADD COLUMN original_value NUMERIC(6, 2),  -- åŸå§‹å€¼
ADD COLUMN original_unit VARCHAR(20);      -- åŸå§‹å•ä½

COMMENT ON COLUMN tbl_glucose_record.glucose_value IS 'è¡€ç³–å€¼ï¼ˆå½’ä¸€åŒ–ä¸º mmol/Lï¼‰';
COMMENT ON COLUMN tbl_glucose_record.original_value IS 'åŸå§‹å€¼ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰';
COMMENT ON COLUMN tbl_glucose_record.original_unit IS 'åŸå§‹å•ä½ï¼ˆmmol/L æˆ– mg/dLï¼‰';
```

---

### 11.3 åˆ†å¸ƒå¼æ•°æ®è¿ç§»åŸå­æ€§ä¿è¯

#### 11.3.1 é—®é¢˜ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„çŠ¶æ€ä¸ä¸€è‡´

**é£é™©åœºæ™¯**ï¼š

```
æ—¶é—´ 0 ç§’ï¼šå¼€å§‹æ‰§è¡Œ convertGuestToUser
æ—¶é—´ 1 ç§’ï¼šæ›´æ–°ç”¨æˆ·ç±»å‹ä¸º normal âœ…
æ—¶é—´ 2 ç§’ï¼šè¿ç§»è¡€ç³–è®°å½•ï¼ˆ1000 æ¡ï¼‰âœ…
æ—¶é—´ 3 ç§’ï¼šè¿ç§»é¥®é£Ÿè®°å½•...
æ—¶é—´ 3.5 ç§’ï¼šæœåŠ¡å™¨ OOMï¼Œè¿›ç¨‹å´©æºƒ âŒ

ç»“æœï¼š
- ç”¨æˆ·ç±»å‹å·²æ”¹ä¸º normalï¼ˆäº‹åŠ¡å›æ»šå¤±è´¥ï¼Œå› ä¸ºæ˜¯è·¨å¤šä¸ªè¡¨ï¼‰
- è¡€ç³–è®°å½•å·²è¿ç§»
- é¥®é£Ÿã€è¿åŠ¨è®°å½•æœªè¿ç§»ï¼ˆæ•°æ®åˆ†è£‚ï¼‰
```

---

#### 11.3.2 è§£å†³æ–¹æ¡ˆï¼šçŠ¶æ€æœº + å¹‚ç­‰æ€§

**æ­¥éª¤ 1ï¼šæ•°æ®åº“å¢åŠ çŠ¶æ€å­—æ®µ**

```sql
-- ä¸ºç”¨æˆ·è¡¨å¢åŠ è¿ç§»çŠ¶æ€å­—æ®µ
ALTER TABLE tbl_user 
ADD COLUMN migration_status VARCHAR(20) DEFAULT 'NONE',  -- NONE/PROCESSING/DONE
ADD COLUMN migration_started_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN migration_completed_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN migration_retry_count INTEGER DEFAULT 0;

CREATE INDEX idx_user_migration_status ON tbl_user(migration_status);

COMMENT ON COLUMN tbl_user.migration_status IS 'æ•°æ®è¿ç§»çŠ¶æ€ï¼šNONE-æœªè¿ç§»ï¼ŒPROCESSING-è¿ç§»ä¸­ï¼ŒDONE-å·²å®Œæˆ';
```

**æ­¥éª¤ 2ï¼šæ”¹é€ è¿ç§»é€»è¾‘**

```java
@Service
public class UserServiceImpl implements UserService {
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public UserResponse convertGuestToUser(String guestUserId, ConvertUserRequest request) {
        // 1. æŸ¥è¯¢è®¿å®¢ç”¨æˆ·
        User guestUser = userMapper.selectByUserId(guestUserId);
        if (guestUser == null || !guestUser.getUserType().equals("guest")) {
            throw new BusinessException("è®¿å®¢ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è½¬æ­£");
        }
        
        // 2. ğŸ”¥ æ£€æŸ¥è¿ç§»çŠ¶æ€ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
        if ("DONE".equals(guestUser.getMigrationStatus())) {
            log.info("ç”¨æˆ·å·²å®Œæˆè¿ç§»ï¼Œè·³è¿‡ï¼šuserId={}", guestUserId);
            return buildUserResponse(guestUser);
        }
        
        // 3. ğŸ”¥ æ ‡è®°ä¸ºè¿ç§»ä¸­ï¼ˆåŸå­æ“ä½œï¼‰
        int updated = userMapper.updateMigrationStatus(guestUserId, "NONE", "PROCESSING");
        if (updated == 0) {
            // å…¶ä»–çº¿ç¨‹æ­£åœ¨å¤„ç†ï¼Œç›´æ¥è¿”å›
            throw new BusinessException("è¿ç§»æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å");
        }
        
        guestUser.setMigrationStatus("PROCESSING");
        guestUser.setMigrationStartedAt(LocalDateTime.now());
        userMapper.updateByUserId(guestUser);
        
        try {
            // 4. æ‰§è¡Œè¿ç§»ï¼ˆç­–ç•¥ A æˆ–ç­–ç•¥ Bï¼‰
            String targetUserId = determineTargetUserId(guestUserId, request);
            
            // 5. ğŸ”¥ åˆ†æ­¥è¿ç§»ï¼ˆæ¯æ­¥éƒ½æ˜¯å¹‚ç­‰çš„ï¼‰
            migrateGlucoseRecords(guestUserId, targetUserId);
            migrateDietRecords(guestUserId, targetUserId);
            migrateExerciseRecords(guestUserId, targetUserId);
            migrateConsultationRecords(guestUserId, targetUserId);
            
            // 6. ğŸ”¥ æ ‡è®°ä¸ºå®Œæˆ
            guestUser.setMigrationStatus("DONE");
            guestUser.setMigrationCompletedAt(LocalDateTime.now());
            userMapper.updateByUserId(guestUser);
            
            log.info("ç”¨æˆ·è¿ç§»å®Œæˆï¼šguestUserId={}, targetUserId={}", guestUserId, targetUserId);
            return buildUserResponse(userMapper.selectByUserId(targetUserId));
            
        } catch (Exception e) {
            // 7. ğŸ”¥ å¤±è´¥å›æ»šçŠ¶æ€ï¼ˆä¿ç•™ PROCESSINGï¼Œç­‰å¾…é‡è¯•ï¼‰
            log.error("ç”¨æˆ·è¿ç§»å¤±è´¥ï¼šguestUserId=" + guestUserId, e);
            
            // å¢åŠ é‡è¯•è®¡æ•°
            guestUser.setMigrationRetryCount(guestUser.getMigrationRetryCount() + 1);
            userMapper.updateByUserId(guestUser);
            
            throw new BusinessException("æ•°æ®è¿ç§»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", e);
        }
    }
    
    /**
     * ğŸ”¥ è¿ç§»è¡€ç³–è®°å½•ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
     */
    private void migrateGlucoseRecords(String fromUserId, String toUserId) {
        // WHERE user_id = fromUserId ä¿è¯å¹‚ç­‰ï¼ˆæ‰§è¡Œå¤šæ¬¡ç»“æœä¸€è‡´ï¼‰
        int count = glucoseRecordMapper.updateUserIdByUserId(fromUserId, toUserId);
        log.info("è¿ç§»è¡€ç³–è®°å½•ï¼š{} æ¡", count);
    }
}
```

**æ­¥éª¤ 3ï¼šå®šæ—¶ä»»åŠ¡è¡¥å¿é‡è¯•**

```java
@Component
@Slf4j
public class MigrationRetryTask {
    
    @Autowired
    private UserService userService;
    
    /**
     * æ¯å°æ—¶æ‰«æä¸€æ¬¡ PROCESSING çŠ¶æ€çš„ç”¨æˆ·ï¼Œè¿›è¡Œè¡¥å¿é‡è¯•
     */
    @Scheduled(cron = "0 0 * * * ?")  // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    public void retryFailedMigrations() {
        // 1. æŸ¥è¯¢ PROCESSING çŠ¶æ€ä¸”è¶…è¿‡ 30 åˆ†é’Ÿæœªå®Œæˆçš„ç”¨æˆ·
        List<User> pendingUsers = userMapper.selectPendingMigrations(30);
        
        log.info("å‘ç° {} ä¸ªå¾…è¡¥å¿çš„è¿ç§»ä»»åŠ¡", pendingUsers.size());
        
        for (User user : pendingUsers) {
            try {
                // 2. æ£€æŸ¥é‡è¯•æ¬¡æ•°ï¼ˆæœ€å¤šé‡è¯• 3 æ¬¡ï¼‰
                if (user.getMigrationRetryCount() >= 3) {
                    log.error("ç”¨æˆ·è¿ç§»é‡è¯•æ¬¡æ•°è¶…é™ï¼Œæ ‡è®°ä¸ºå¤±è´¥ï¼šuserId={}", user.getUserId());
                    user.setMigrationStatus("FAILED");
                    userMapper.updateByUserId(user);
                    
                    // å‘é€å‘Šè­¦é€šçŸ¥
                    alertService.sendMigrationFailedAlert(user.getUserId());
                    continue;
                }
                
                // 3. ğŸ”¥ é‡æ–°æ‰§è¡Œè¿ç§»
                log.info("è¡¥å¿é‡è¯•ç”¨æˆ·è¿ç§»ï¼šuserId={}, retryCount={}", 
                    user.getUserId(), user.getMigrationRetryCount());
                    
                // å°†çŠ¶æ€é‡ç½®ä¸º NONEï¼Œè§¦å‘é‡æ–°è¿ç§»
                user.setMigrationStatus("NONE");
                userMapper.updateByUserId(user);
                
                // è°ƒç”¨è¿ç§»æ¥å£ï¼ˆä¼šèµ°å®Œæ•´çš„çŠ¶æ€æœºæµç¨‹ï¼‰
                // userService.convertGuestToUser(user.getUserId(), ...);
                
            } catch (Exception e) {
                log.error("è¡¥å¿é‡è¯•å¤±è´¥ï¼šuserId=" + user.getUserId(), e);
            }
        }
    }
}
```

---

### 11.4 æµè§ˆå™¨ SSE è¿æ¥æ•°é™åˆ¶

#### 11.4.1 é—®é¢˜ï¼šHTTP/1.1 çš„ 6 è¿æ¥é™åˆ¶

**èƒŒæ™¯**ï¼šæµè§ˆå™¨å¯¹åŒä¸€åŸŸåçš„å¹¶å‘ HTTP/1.1 è¿æ¥æ•°é™åˆ¶ä¸º **6 ä¸ª**ã€‚

**é£é™©åœºæ™¯**ï¼š

```
ç”¨æˆ·æ‰“å¼€ 3 ä¸ªæ ‡ç­¾é¡µï¼Œæ¯ä¸ªé¡µé¢ï¼š
- 1 ä¸ª SSE è¿æ¥ï¼ˆæ•°å­—äººå¯¹è¯ï¼‰
- 2 ä¸ªæ™®é€š AJAX è¯·æ±‚

æ€»è¿æ¥æ•°ï¼š3 Ã— 3 = 9 ä¸ª
ç»“æœï¼šç¬¬ 7ã€8ã€9 ä¸ªè¯·æ±‚è¢«æµè§ˆå™¨æŒ‚èµ·ï¼ˆPendingï¼‰
è¡¨ç°ï¼šé¡µé¢å¡æ­»ï¼Œç”¨æˆ·ä»¥ä¸ºç³»ç»Ÿå´©æºƒäº† âŒ
```

---

#### 11.4.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå¯ç”¨ HTTP/2ï¼ˆæ¨èï¼‰**

```yaml
# application.yml
server:
  port: 8443  # HTTPS ç«¯å£
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: ${SSL_KEYSTORE_PASSWORD}
    key-store-type: PKCS12
  # ğŸ”¥ å¯ç”¨ HTTP/2
  http2:
    enabled: true

# HTTP/2 ä¼˜åŠ¿ï¼š
# - å¤šè·¯å¤ç”¨ï¼šä¸€ä¸ªè¿æ¥å¯ä»¥å¤„ç†å¤šä¸ªè¯·æ±‚
# - çªç ´ 6 è¿æ¥é™åˆ¶
# - å‡å°‘å»¶è¿Ÿï¼Œæå‡æ€§èƒ½
```

**æ–¹æ¡ˆ 2ï¼šå‰ç«¯è¿æ¥ç®¡ç†ï¼ˆå°ç¨‹åºï¼‰**

```javascript
// å¾®ä¿¡å°ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç† SSE è¿æ¥
let sseConnection = null;

// é¡µé¢æ˜¾ç¤ºæ—¶å»ºç«‹è¿æ¥
onShow() {
  if (!sseConnection) {
    sseConnection = connectSSE();
  }
},

// ğŸ”¥ é¡µé¢éšè—æ—¶æ–­å¼€è¿æ¥ï¼ˆé‡Šæ”¾èµ„æºï¼‰
onHide() {
  if (sseConnection) {
    sseConnection.close();
    sseConnection = null;
    console.log('SSE è¿æ¥å·²æ–­å¼€ï¼ˆé¡µé¢éšè—ï¼‰');
  }
},

// é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
onUnload() {
  if (sseConnection) {
    sseConnection.close();
    sseConnection = null;
  }
}
```

**æ–¹æ¡ˆ 3ï¼šåç«¯è¿æ¥æ•°ç›‘æ§**

```java
@Component
public class SseConnectionMonitor {
    
    private final AtomicInteger activeConnections = new AtomicInteger(0);
    
    /**
     * è®°å½•æ–°è¿æ¥
     */
    public void onConnect(String userId, String sessionId) {
        int count = activeConnections.incrementAndGet();
        log.info("SSE è¿æ¥å»ºç«‹ï¼šuserId={}, sessionId={}, å½“å‰è¿æ¥æ•°={}", userId, sessionId, count);
        
        // ğŸ”¥ å‘Šè­¦ï¼šè¿æ¥æ•°è¿‡å¤š
        if (count > 500) {
            log.warn("âš ï¸ SSE è¿æ¥æ•°è¿‡å¤šï¼š{}", count);
        }
    }
    
    /**
     * è®°å½•æ–­å¼€
     */
    public void onDisconnect(String userId, String sessionId) {
        int count = activeConnections.decrementAndGet();
        log.info("SSE è¿æ¥æ–­å¼€ï¼šuserId={}, sessionId={}, å½“å‰è¿æ¥æ•°={}", userId, sessionId, count);
    }
    
    /**
     * è·å–å½“å‰è¿æ¥æ•°
     */
    public int getActiveConnections() {
        return activeConnections.get();
    }
}
```

---

### 11.5 AI å¹»è§‰é˜²å¾¡ï¼ˆHallucinationï¼‰

#### 11.5.1 é—®é¢˜ï¼šAI å¯èƒ½äº§ç”Ÿå±é™©å»ºè®®

**é£é™©åœºæ™¯**ï¼š

```
ç”¨æˆ·ï¼š"æˆ‘èƒ½åƒç ’éœœæ²»ç³–å°¿ç—…å—ï¼Ÿ"
AIï¼ˆå¹»è§‰ï¼‰ï¼š"é€‚é‡é£Ÿç”¨æŸäº›ä¼ ç»Ÿè¯æå¯èƒ½æœ‰å¸®åŠ©..."  âŒ è‡´å‘½å»ºè®®ï¼

ç”¨æˆ·ï¼š"æˆ‘å¯ä»¥åœç”¨èƒ°å²›ç´ å—ï¼Ÿ"
AIï¼ˆå¹»è§‰ï¼‰ï¼š"å¦‚æœè¡€ç³–ç¨³å®šï¼Œå¯ä»¥è€ƒè™‘å‡å°‘ç”¨é‡..." âŒ å±é™©å»ºè®®ï¼
```

---

#### 11.5.2 è§£å†³æ–¹æ¡ˆï¼šSafety Guardrails

**System Prompt å¢åŠ å®‰å…¨æŠ¤æ **ï¼š

```java
public String buildDigitalHumanSystemPrompt(String sceneType) {
    StringBuilder prompt = new StringBuilder();
    
    // ... å…¶ä»– Prompt å†…å®¹ ...
    
    // ğŸ”¥ å®‰å…¨æŠ¤æ ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    prompt.append("\n");
    prompt.append("=== SAFETY PROTOCOLS (HIGHEST PRIORITY) ===\n");
    prompt.append("\n");
    prompt.append("ğŸš¨ STRICT RULES - NEVER VIOLATE:\n");
    prompt.append("\n");
    prompt.append("1. **NEVER recommend changing medication dosage** without doctor's advice.\n");
    prompt.append("   If user asks 'Can I stop insulin?', STRICTLY say:\n");
    prompt.append("   'ä»»ä½•è¯ç‰©è°ƒæ•´å¿…é¡»åœ¨åŒ»ç”ŸæŒ‡å¯¼ä¸‹è¿›è¡Œï¼Œæˆ‘æ— æ³•æä¾›æ­¤ç±»å»ºè®®ã€‚è¯·å’¨è¯¢æ‚¨çš„ä¸»æ²»åŒ»ç”Ÿã€‚'\n");
    prompt.append("\n");
    prompt.append("2. **NEVER recommend dangerous substances** (folk remedies, unproven treatments).\n");
    prompt.append("   If user asks about harmful substances, STRICTLY REFUSE:\n");
    prompt.append("   'è¯¥æ–¹æ³•æœªç»ç§‘å­¦éªŒè¯ä¸”å¯èƒ½æœ‰å®³ï¼Œè¯·å‹¿å°è¯•ã€‚'\n");
    prompt.append("\n");
    prompt.append("3. **Always acknowledge limitations**:\n");
    prompt.append("   'I am an AI assistant, NOT a doctor. For medical diagnosis and treatment, please consult a qualified physician.'\n");
    prompt.append("\n");
    prompt.append("4. **Do NOT output Markdown images or external links** other than those provided by tools.\n");
    prompt.append("   This prevents malicious content injection.\n");
    prompt.append("\n");
    prompt.append("5. **Emergency situations**: If user describes serious symptoms (chest pain, difficulty breathing, loss of consciousness),\n");
    prompt.append("   IMMEDIATELY advise to call 120 emergency services.\n");
    prompt.append("\n");
    prompt.append("6. **Pregnancy/Children**: If user mentions pregnancy or children, advise consulting pediatrician/obstetrician.\n");
    prompt.append("   Diabetes management in these groups requires specialist care.\n");
    
    return prompt.toString();
}
```

---

### 11.6 æœ€åçš„ Checklistï¼ˆäº¤ä»˜å‰å¿…æŸ¥ï¼‰

#### âœ… æ•°æ®åº“ç²¾åº¦æ£€æŸ¥

```sql
-- âŒ é”™è¯¯ï¼šnumeric(5,1) åªæ”¯æŒä¸€ä½å°æ•°ï¼ˆå¦‚ 12.5ï¼‰
-- é—®é¢˜ï¼šç³–åŒ–è¡€çº¢è›‹ç™½ï¼ˆHbA1cï¼‰é€šå¸¸éœ€è¦ä¸¤ä½å°æ•°ï¼ˆå¦‚ 6.35%ï¼‰

-- âœ… æ­£ç¡®ï¼šä¿®æ”¹ä¸º numeric(5,2)
ALTER TABLE tbl_glucose_record 
ALTER COLUMN glucose_value TYPE NUMERIC(5, 2);

-- æ”¯æŒèŒƒå›´ï¼š0.00 - 999.99 mmol/Lï¼ˆè¶³å¤Ÿè¦†ç›–æ‰€æœ‰åœºæ™¯ï¼‰

COMMENT ON COLUMN tbl_glucose_record.glucose_value IS 'è¡€ç³–å€¼ï¼ˆmmol/Lï¼‰ï¼Œç²¾åº¦ï¼šä¸¤ä½å°æ•°';
```

**å…¶ä»–éœ€è¦è°ƒæ•´çš„å­—æ®µ**ï¼š

```sql
-- é¥®é£Ÿè¡¨çš„è¥å…»æˆåˆ†å­—æ®µ
ALTER TABLE tbl_diet_record 
ALTER COLUMN total_calories TYPE NUMERIC(8, 2),
ALTER COLUMN carbohydrate TYPE NUMERIC(8, 2),
ALTER COLUMN protein TYPE NUMERIC(8, 2),
ALTER COLUMN fat TYPE NUMERIC(8, 2),
ALTER COLUMN fiber TYPE NUMERIC(8, 2);

-- è¿åŠ¨è¡¨çš„æ¶ˆè€—çƒ­é‡å­—æ®µ
ALTER TABLE tbl_exercise_record 
ALTER COLUMN calories_burned TYPE NUMERIC(8, 2),
ALTER COLUMN distance TYPE NUMERIC(8, 2);
```

---

#### âœ… æ—¥å¿—éšç§ä¿æŠ¤æ£€æŸ¥

**ä¸¥ç¦åœ¨æ—¥å¿—ä¸­æ‰“å°æ˜æ–‡æ•æ„Ÿä¿¡æ¯**ï¼š

```java
// âŒ é”™è¯¯ï¼šæ³„éœ²æ˜æ–‡æ‰‹æœºå·
log.info("ç”¨æˆ·æ³¨å†Œï¼šuserId={}, phone={}", userId, phone);

// âœ… æ­£ç¡®ï¼šæ‰“å°è„±æ•åçš„æ‰‹æœºå·
log.info("ç”¨æˆ·æ³¨å†Œï¼šuserId={}, phone={}", userId, maskPhone(phone));
// è¾“å‡ºï¼š138****5678

// âŒ é”™è¯¯ï¼šæ‰“å°å®Œæ•´ç”¨æˆ·å¯¹è±¡ï¼ˆå¯èƒ½åŒ…å«æ•æ„Ÿå­—æ®µï¼‰
log.info("æŸ¥è¯¢ç”¨æˆ·ï¼š{}", user);

// âœ… æ­£ç¡®ï¼šåªæ‰“å°å¿…è¦å­—æ®µ
log.info("æŸ¥è¯¢ç”¨æˆ·ï¼šuserId={}, userType={}", user.getUserId(), user.getUserType());

// âŒ é”™è¯¯ï¼šæ‰“å°è¡€ç³–è®°å½•æ—¶åŒ…å«å¤‡æ³¨ï¼ˆå¯èƒ½æœ‰éšç§ä¿¡æ¯ï¼‰
log.info("ä¿å­˜è¡€ç³–è®°å½•ï¼š{}", record);

// âœ… æ­£ç¡®ï¼šåªæ‰“å°éæ•æ„Ÿå­—æ®µ
log.info("ä¿å­˜è¡€ç³–è®°å½•ï¼šrecordId={}, value={}, type={}", 
    record.getRecordId(), record.getGlucoseValue(), record.getMeasurementType());
```

**æ—¥å¿—è„±æ•å·¥å…·ç±»**ï¼š

```java
public class LogMaskUtil {
    
    /**
     * æ‰‹æœºå·è„±æ•ï¼š138****5678
     */
    public static String maskPhone(String phone) {
        if (StringUtils.isBlank(phone) || phone.length() != 11) {
            return "***";
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    /**
     * å§“åè„±æ•ï¼šå¼ *ã€æ¬§é˜³**
     */
    public static String maskName(String name) {
        if (StringUtils.isBlank(name)) {
            return "***";
        }
        if (name.length() == 2) {
            return name.charAt(0) + "*";
        } else {
            return name.charAt(0) + "*".repeat(name.length() - 1);
        }
    }
    
    /**
     * èº«ä»½è¯è„±æ•ï¼š110***********1234
     */
    public static String maskIdCard(String idCard) {
        if (StringUtils.isBlank(idCard) || idCard.length() < 8) {
            return "***";
        }
        return idCard.substring(0, 3) + "***********" + idCard.substring(idCard.length() - 4);
    }
}
```

---

#### âœ… API Key å®‰å…¨æ£€æŸ¥

**ä¸¥ç¦ç¡¬ç¼–ç  API Key**ï¼š

```java
// âŒ æåº¦å±é™©ï¼šç¡¬ç¼–ç åœ¨ä»£ç ä¸­
@Value("sk-abc123456789...")  // âŒ
private String bailianApiKey;

// âœ… æ­£ç¡®ï¼šä»ç¯å¢ƒå˜é‡è¯»å–
@Value("${bailianai.api.key}")  // âœ…
private String bailianApiKey;
```

**é…ç½®æ–‡ä»¶**ï¼š

```yaml
# application.yml
bailianai:
  api:
    # âŒ é”™è¯¯ï¼šç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­
    # key: sk-abc123456789...
    
    # âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡å ä½ç¬¦
    key: ${BAILIANAI_API_KEY}

# ç”Ÿäº§ç¯å¢ƒé€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼š
# export BAILIANAI_API_KEY=sk-xxx...
```

**Docker Compose é…ç½®**ï¼š

```yaml
# docker-compose.yml
services:
  app:
    image: tangxiaowen-backend:latest
    environment:
      - BAILIANAI_API_KEY=${BAILIANAI_API_KEY}  # ä»å®¿ä¸»æœºç¯å¢ƒå˜é‡è¯»å–
      - ALIYUN_OSS_ACCESS_KEY=${ALIYUN_OSS_ACCESS_KEY}
      - ALIYUN_OSS_SECRET_KEY=${ALIYUN_OSS_SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
```

**Kubernetes Secret**ï¼š

```yaml
# k8s-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: tangxiaowen-secrets
type: Opaque
data:
  bailianai-api-key: <base64-encoded-key>
  oss-access-key: <base64-encoded-key>
```

---

#### âœ… .gitignore æ£€æŸ¥

```bash
# .gitignore

# ğŸ”¥ æ•æ„Ÿé…ç½®æ–‡ä»¶ï¼ˆç»å¯¹ä¸èƒ½æäº¤åˆ° Gitï¼‰
application-prod.yml
application-local.yml
*.key
*.p12
*.pem

# ç¯å¢ƒå˜é‡æ–‡ä»¶
.env
.env.local
.env.production

# IDE é…ç½®
.idea/
.vscode/
*.iml

# æ—¥å¿—æ–‡ä»¶ï¼ˆå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
logs/
*.log

# ç¼–è¯‘äº§ç‰©
target/
dist/
build/
```

---

## 12. åŒ»ç–—ä¸šåŠ¡é˜²æŠ¤æ€»ç»“

### 12.1 é˜²æŠ¤æ¸…å•

| é˜²æŠ¤é¡¹ | é£é™©ç­‰çº§ | æ³•å¾‹é£é™© | å®ç°éš¾åº¦ | æŠ•å…¥æ—¶é—´ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|---------|--------|
| **å±æ€¥å€¼å®æ—¶é˜»æ–­** | ğŸ”´ æé«˜ | âš–ï¸ é«˜ | â­â­â­ | 8 å°æ—¶ | **P0** |
| **è¡€ç³–å•ä½é˜²æŠ¤** | ğŸŸ  é«˜ | âš–ï¸ ä¸­ | â­â­ | 4 å°æ—¶ | **P0** |
| **æ•°æ®è¿ç§»åŸå­æ€§** | ğŸŸ¡ ä¸­ | âš–ï¸ ä½ | â­â­ | 4 å°æ—¶ | **P0** |
| **SSE è¿æ¥é™åˆ¶** | ğŸŸ¡ ä¸­ | - | â­ | 2 å°æ—¶ | **P1** |
| **AI å¹»è§‰é˜²å¾¡** | ğŸ”´ é«˜ | âš–ï¸ é«˜ | â­ | 1 å°æ—¶ | **P0** |
| **æ—¥å¿—éšç§ä¿æŠ¤** | ğŸŸ  é«˜ | âš–ï¸ é«˜ | â­ | 2 å°æ—¶ | **P0** |
| **API Key å®‰å…¨** | ğŸ”´ æé«˜ | - | â­ | 0.5 å°æ—¶ | **P0** |

**æ€»æŠ•å…¥**ï¼šçº¦ **21.5 å°æ—¶**ï¼ˆP0 å¿…é¡»å®Œæˆï¼‰

### 12.2 æ³•å¾‹åˆè§„è¦æ±‚

| æ³•è§„ | è¦æ±‚ | å¯¹åº”é˜²æŠ¤ |
|------|------|---------|
| ã€Šäº’è”ç½‘åŒ»ç–—å¥åº·ç®¡ç†è§„èŒƒã€‹ | æä¾›å¥åº·é£é™©é¢„è­¦ | âœ… å±æ€¥å€¼é˜»æ–­ |
| ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ | æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨ | âœ… æ—¥å¿—è„±æ• + æ•°æ®åŠ å¯† |
| ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹ | é˜²æ­¢æ•°æ®æ³„éœ² | âœ… API Key å®‰å…¨ + HTTPS |
| åŒ»ç–—å™¨æ¢°ç›‘ç®¡ | AI å»ºè®®éœ€å…è´£å£°æ˜ | âœ… AI å¹»è§‰é˜²å¾¡ + å…è´£æç¤º |

### 12.3 P0 å¼ºåˆ¶æ¸…å•

**ä¸Šçº¿å‰å¿…é¡»å®Œæˆ**ï¼š

1. **å±æ€¥å€¼å®æ—¶é˜»æ–­** âœ…
   - [ ] å®šä¹‰å±æ€¥å€¼å¸¸é‡
   - [ ] å®ç° EmergencyAlertService
   - [ ] æ”¹é€  AgentToolExecutor
   - [ ] å‰ç«¯å‘Šè­¦UIï¼ˆå…¨å±å¼¹çª— + éœ‡åŠ¨ + éŸ³æ•ˆï¼‰
   - [ ] å‘Šè­¦æ•°æ®åº“è¡¨

2. **è¡€ç³–å•ä½é˜²æŠ¤** âœ…
   - [ ] AI Prompt å¢åŠ å•ä½è¯†åˆ«è§„åˆ™
   - [ ] å·¥å…·å¢åŠ  unit å‚æ•°
   - [ ] åç«¯å•ä½å½’ä¸€åŒ–é€»è¾‘
   - [ ] æ•°æ®åº“å­˜å‚¨åŸå§‹å•ä½

3. **AI å¹»è§‰é˜²å¾¡** âœ…
   - [ ] System Prompt å¢åŠ  Safety Guardrails
   - [ ] æµ‹è¯•å±é™©é—®é¢˜ï¼ˆè¯ç‰©è°ƒæ•´ã€åœè¯ã€æ°‘é—´åæ–¹ï¼‰
   - [ ] ç´§æ€¥æƒ…å†µè¯†åˆ«ï¼ˆæ‹¨æ‰“ 120 å»ºè®®ï¼‰

4. **æ—¥å¿—éšç§ä¿æŠ¤** âœ…
   - [ ] å…¨å±€æœç´¢ `log.info` æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
   - [ ] å®ç°è„±æ•å·¥å…·ç±»
   - [ ] ä»£ç å®¡æŸ¥ï¼ˆå¿…é¡»ï¼‰

5. **API Key å®‰å…¨** âœ…
   - [ ] æ£€æŸ¥ä»£ç ä¸­æ— ç¡¬ç¼–ç  Key
   - [ ] é…ç½®æ–‡ä»¶ä½¿ç”¨ç¯å¢ƒå˜é‡
   - [ ] ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Secret ç®¡ç†

---

## 12. éƒ¨ç½²ä¸è¿ç»´é…ç½®ï¼ˆâš™ï¸ ç¯å¢ƒå‘ç‚¹ï¼‰

### 12.1 ç½‘å…³å±‚è¶…æ—¶æˆªæ–­ï¼ˆSSE è‡´å‘½é—®é¢˜ï¼‰

#### 12.1.1 é—®é¢˜ï¼šNginx/SLB é»˜è®¤è¶…æ—¶ä¼šæˆªæ–­ SSE è¿æ¥

**é—®é¢˜æè¿°**ï¼š

è™½ç„¶ Java ä»£ç ä¸­è®¾ç½®äº† `SseEmitter(180000L)`ï¼ˆ3 åˆ†é’Ÿï¼‰ï¼Œä½†åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œåº”ç”¨å‰é¢é€šå¸¸æœ‰ Nginx æˆ–é˜¿é‡Œäº‘ SLBã€‚

**é»˜è®¤è¡Œä¸º**ï¼š
- **Nginx**ï¼š`proxy_read_timeout` é»˜è®¤ **60 ç§’**
- **é˜¿é‡Œäº‘ SLB**ï¼šHTTP è¿æ¥ç©ºé—²è¶…æ—¶é»˜è®¤ **60 ç§’**
- **AWS ALB**ï¼šç©ºé—²è¶…æ—¶é»˜è®¤ **60 ç§’**

**è‡´å‘½åæœ**ï¼š

```
æ—¶é—´è½´ï¼š
0 ç§’ï¼šå‰ç«¯å»ºç«‹ SSE è¿æ¥ â†’ Nginx â†’ Backend
30 ç§’ï¼šæ•°å­—äºº AI æ¨ç†ä¸­...
60 ç§’ï¼šNginx è¶…æ—¶ï¼Œå¼ºåˆ¶æ–­å¼€è¿æ¥ âŒ
65 ç§’ï¼šBackend æ¨é€æ•°æ® â†’ è¿æ¥å·²æ–­å¼€ â†’ å‰ç«¯æ”¶åˆ° 504 Gateway Timeout

ç”¨æˆ·ä½“éªŒï¼šé¡µé¢å¡æ­»ï¼Œä»¥ä¸ºç³»ç»Ÿå´©æºƒäº†
```

**å½±å“èŒƒå›´**ï¼š
- ğŸ”´ æ•°å­—äººé•¿æ—¶é—´æ€è€ƒï¼ˆå¤æ‚æ¨ç† + Function Callingï¼‰
- ğŸ”´ TTS è¯­éŸ³åˆæˆè€—æ—¶é•¿
- ğŸ”´ å¿ƒè·³åŒ…é—´éš”ä¸å½“ï¼ˆè¶…è¿‡ 60 ç§’ï¼‰

---

#### 12.1.2 å®Œæ•´è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šNginx é…ç½®ï¼ˆå¿…é¡»ï¼‰**

```nginx
# /etc/nginx/conf.d/tangxiaowen.conf

upstream backend {
    server 127.0.0.1:8080;
    keepalive 64;  # ä¿æŒé•¿è¿æ¥æ± 
}

server {
    listen 443 ssl http2;
    server_name api.tangxiaowen.com;
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # ğŸ”¥ SSE ä¸“ç”¨ locationï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
    location /api/v1/digital-human/sessions/ {
        proxy_pass http://backend;
        
        # ========== è¶…æ—¶é…ç½® ==========
        # ğŸ”¥ å…³é”®ï¼šå»¶é•¿è¯»å–è¶…æ—¶æ—¶é—´è‡³ 5 åˆ†é’Ÿ
        proxy_read_timeout 300s;      # åç«¯å“åº”è¶…æ—¶ï¼ˆSSE éœ€è¦å¾ˆé•¿ï¼‰
        proxy_send_timeout 300s;      # å‘åç«¯å‘é€è¶…æ—¶
        proxy_connect_timeout 10s;    # å»ºç«‹è¿æ¥è¶…æ—¶ï¼ˆä¿æŒé»˜è®¤ï¼‰
        
        # ========== SSE å¿…é¡»å…³é—­ç¼“å†² ==========
        # ğŸ”¥ å…³é”®ï¼šç¡®ä¿ SSE æ•°æ®å³æ—¶åˆ°è¾¾å‰ç«¯ï¼Œä¸åœ¨ Nginx ç¼“å­˜
        proxy_buffering off;          # å…³é—­å“åº”ç¼“å†²
        proxy_cache off;              # å…³é—­ç¼“å­˜
        proxy_request_buffering off;  # å…³é—­è¯·æ±‚ç¼“å†²
        
        # ========== HTTP å¤´è®¾ç½® ==========
        # å¿…é¡»è®¾ç½®çš„å¤´ï¼ˆSSE åè®®è¦æ±‚ï¼‰
        proxy_set_header Connection "";  # ä¿æŒé•¿è¿æ¥
        proxy_set_header X-Accel-Buffering "no";  # å‘Šè¯‰ Nginx ä¸è¦ç¼“å†²
        
        # å¸¸è§„åå‘ä»£ç†å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # HTTP/1.1 é•¿è¿æ¥
        proxy_http_version 1.1;
    }
    
    # æ™®é€š API æ¥å£ï¼ˆæ­£å¸¸é…ç½®ï¼‰
    location /api/ {
        proxy_pass http://backend;
        
        # æ™®é€šæ¥å£ä½¿ç”¨é»˜è®¤è¶…æ—¶ï¼ˆ30-60 ç§’ï¼‰
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_connect_timeout 10s;
        
        # å¯ä»¥å¯ç”¨ç¼“å†²ï¼ˆæå‡æ€§èƒ½ï¼‰
        proxy_buffering on;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

**éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ**ï¼š

```bash
# 1. æ£€æŸ¥é…ç½®è¯­æ³•
sudo nginx -t

# 2. é‡è½½é…ç½®
sudo nginx -s reload

# 3. æµ‹è¯• SSE è¿æ¥ï¼ˆä½¿ç”¨ curlï¼‰
curl -N -H "Authorization: Bearer xxx" \
  https://api.tangxiaowen.com/api/v1/digital-human/sessions/xxx/messages/stream

# åº”è¯¥èƒ½å¤ŸæŒç»­æ¥æ”¶æ•°æ®è¶…è¿‡ 60 ç§’
```

---

**æ–¹æ¡ˆ 2ï¼šé˜¿é‡Œäº‘ SLB é…ç½®ï¼ˆå¿…é¡»ï¼‰**

**æ­¥éª¤ 1ï¼šç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°**

```
ä¼ ç»Ÿå‹è´Ÿè½½å‡è¡¡ CLB â†’ å®ä¾‹ç®¡ç† â†’ é€‰æ‹©å®ä¾‹ â†’ ç›‘å¬ â†’ ç¼–è¾‘
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹è¶…æ—¶é…ç½®**

| é…ç½®é¡¹ | é»˜è®¤å€¼ | æ¨èå€¼ | è¯´æ˜ |
|--------|--------|--------|------|
| **è¿æ¥ç©ºé—²è¶…æ—¶æ—¶é—´** | 60 ç§’ | **180 ç§’** | ğŸ”¥ æ ¸å¿ƒé…ç½® |
| **è¯·æ±‚è¶…æ—¶æ—¶é—´** | 60 ç§’ | **180 ç§’** | åç«¯å¤„ç†è¶…æ—¶ |
| **å¼€å¯ HTTP/2** | å¦ | **æ˜¯** | å¤šè·¯å¤ç”¨ |

**æ­¥éª¤ 3ï¼šå¥åº·æ£€æŸ¥é…ç½®**

```
å¥åº·æ£€æŸ¥è·¯å¾„ï¼š/api/v1/health
å“åº”è¶…æ—¶æ—¶é—´ï¼š5 ç§’
å¥åº·æ£€æŸ¥é—´éš”ï¼š2 ç§’
å¥åº·é˜ˆå€¼ï¼š3 æ¬¡
ä¸å¥åº·é˜ˆå€¼ï¼š3 æ¬¡
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ ä¿®æ”¹ç›‘å¬å™¨é…ç½®å¯èƒ½ä¼šå¯¼è‡´çŸ­æš‚çš„è¿æ¥ä¸­æ–­
- âš ï¸ å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ“ä½œ
- âš ï¸ ä¿®æ”¹åéœ€è¦ç­‰å¾… 1-2 åˆ†é’Ÿç”Ÿæ•ˆ

---

**æ–¹æ¡ˆ 3ï¼šAWS ALB/ELB é…ç½®**

```bash
# ä½¿ç”¨ AWS CLI ä¿®æ”¹è¶…æ—¶
aws elbv2 modify-load-balancer-attributes \
  --load-balancer-arn arn:aws:elasticloadbalancing:... \
  --attributes Key=idle_timeout.timeout_seconds,Value=180
```

---

#### 12.1.3 å¿ƒè·³åŒ…ä¼˜åŒ–ï¼ˆé…åˆè¶…æ—¶é…ç½®ï¼‰

**é—®é¢˜**ï¼šå³ä½¿é…ç½®äº† 180 ç§’è¶…æ—¶ï¼Œå¦‚æœ AI æ¨ç†è¶…è¿‡ 180 ç§’æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šå‘é€å¿ƒè·³åŒ…ï¼ˆKeep-Aliveï¼‰

```java
@PostMapping(value = "/sessions/{sessionId}/messages/stream", 
             produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter streamMessage(@PathVariable String sessionId,
                                @RequestBody SendMessageRequest request) {
    SseEmitter emitter = new SseEmitter(300000L); // 5 åˆ†é’Ÿ
    
    // ğŸ”¥ å¿ƒè·³ä»»åŠ¡ï¼ˆæ¯ 30 ç§’å‘é€ä¸€æ¬¡ï¼‰
    ScheduledExecutorService heartbeatExecutor = Executors.newScheduledThreadPool(1);
    AtomicBoolean isCompleted = new AtomicBoolean(false);
    
    ScheduledFuture<?> heartbeatTask = heartbeatExecutor.scheduleAtFixedRate(() -> {
        try {
            if (!isCompleted.get()) {
                // å‘é€å¿ƒè·³æ³¨é‡Šï¼ˆå‰ç«¯ä¼šå¿½ç•¥ï¼Œä½†ä¿æŒè¿æ¥æ´»è·ƒï¼‰
                emitter.send(SseEmitter.event().comment("heartbeat"));
                log.debug("SSE å¿ƒè·³åŒ…å·²å‘é€ï¼šsessionId={}", sessionId);
            }
        } catch (IOException e) {
            log.warn("å¿ƒè·³åŒ…å‘é€å¤±è´¥ï¼Œè¿æ¥å¯èƒ½å·²æ–­å¼€", e);
            heartbeatExecutor.shutdown();
        }
    }, 0, 30, TimeUnit.SECONDS);  // ğŸ”¥ æ¯ 30 ç§’å‘é€ä¸€æ¬¡
    
    // ä¸»ä¸šåŠ¡é€»è¾‘
    CompletableFuture.runAsync(() -> {
        try {
            // æ•°å­—äººå¯¹è¯å¤„ç†
            bailianAIClient.chatStream(...);
            
            emitter.complete();
            isCompleted.set(true);
            
        } catch (Exception e) {
            emitter.completeWithError(e);
            isCompleted.set(true);
        } finally {
            // ğŸ”¥ åœæ­¢å¿ƒè·³ä»»åŠ¡
            heartbeatTask.cancel(false);
            heartbeatExecutor.shutdown();
        }
    }, sseExecutor);
    
    return emitter;
}
```

**å¿ƒè·³åŒ…æ•ˆæœ**ï¼š
- âœ… ä¿æŒç½‘å…³å±‚è¿æ¥æ´»è·ƒï¼ˆä¸è¢«è¶…æ—¶æˆªæ–­ï¼‰
- âœ… åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ï¼ˆå‘é€å¤±è´¥æ—¶ï¼‰
- âœ… å‰ç«¯æ— éœ€ç‰¹æ®Šå¤„ç†ï¼ˆæ³¨é‡Šè¡Œè‡ªåŠ¨å¿½ç•¥ï¼‰

---

#### 12.1.4 ç›‘æ§å‘Šè­¦

**Nginx ç›‘æ§**ï¼š

```bash
# æŸ¥çœ‹ Nginx è¶…æ—¶æ—¥å¿—
tail -f /var/log/nginx/error.log | grep "upstream timed out"

# ç»Ÿè®¡ä»Šæ—¥è¶…æ—¶æ¬¡æ•°
grep "upstream timed out" /var/log/nginx/error.log | grep "$(date +%Y/%m/%d)" | wc -l
```

**åº”ç”¨ç›‘æ§**ï¼š

```java
@Component
public class SseConnectionMonitor {
    
    /**
     * è®°å½•è¿æ¥è¶…æ—¶
     */
    public void onTimeout(String sessionId, long duration) {
        log.warn("SSE è¿æ¥è¶…æ—¶ï¼šsessionId={}, duration={}ms", sessionId, duration);
        
        // ğŸ”¥ å‘Šè­¦ï¼šå¦‚æœè¶…æ—¶é¢‘ç¹ï¼ˆæ¯å°æ—¶ > 10 æ¬¡ï¼‰ï¼Œè¯´æ˜é…ç½®æœ‰é—®é¢˜
        // å‘é€é’‰é’‰/é‚®ä»¶å‘Šè­¦
    }
}
```

---

### 12.2 åº”ç”¨å±‚é™æµï¼ˆé’±åŒ…å®ˆæŠ¤ï¼‰

#### 12.2.1 é—®é¢˜ï¼šç™¾ç‚¼ Token è¢«æ¶æ„æ¶ˆè€—

**é£é™©åœºæ™¯**ï¼š

```
åœºæ™¯ 1ï¼šæ¶æ„æ”»å‡»
æ”»å‡»è€…è„šæœ¬ï¼šwhile(true) { å‘é€æ¶ˆæ¯ }
åæœï¼šæ¯ç§’ 10 æ¡æ¶ˆæ¯ Ã— 1000 Token/æ¡ Ã— Â¥0.0002/Token = Â¥2/ç§’ = Â¥7200/å°æ—¶ âš ï¸âš ï¸âš ï¸

åœºæ™¯ 2ï¼šç”¨æˆ· Bug
ç”¨æˆ·ä¸å°å¿ƒç‚¹å‡»"å‘é€"æŒ‰é’®ï¼Œè§¦å‘äº†å‰ç«¯ Bugï¼Œè¿›å…¥æ­»å¾ªç¯
åæœï¼š1 å°æ—¶æ¶ˆè€— Â¥7200

åœºæ™¯ 3ï¼šAI é™·å…¥æ­»å¾ªç¯å¯¹è¯
AI å’Œç”¨æˆ·è¿›å…¥æ— é™è¿½é—®æ¨¡å¼ï¼ˆ"æ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ" â†’ "æ²¡æœ‰" â†’ "è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ"ï¼‰
```

**å½“å‰é˜²æŠ¤ç°çŠ¶**ï¼š
- âœ… å±æ€¥å€¼é™æµï¼ˆ15 åˆ†é’Ÿï¼‰
- âŒ æ™®é€šå¯¹è¯æ¥å£æ— é™æµ

---

#### 12.2.2 å®Œæ•´é™æµæ–¹æ¡ˆ

**é™æµç­–ç•¥è®¾è®¡**ï¼š

| ç”¨æˆ·ç±»å‹ | æ¯åˆ†é’Ÿé™åˆ¶ | æ¯å°æ—¶é™åˆ¶ | æ¯å¤©é™åˆ¶ | è¶…é™æç¤º |
|---------|-----------|-----------|---------|---------|
| **è®¿å®¢** | 5 æ¡ | 20 æ¡ | 50 æ¡ | "è®¿å®¢æ¯æ—¥é™ 50 æ¡ï¼Œè¯·ç™»å½•" |
| **æ™®é€šç”¨æˆ·** | 10 æ¡ | 50 æ¡ | 100 æ¡ | "æ‚¨ä»Šæ—¥å¯¹è¯æ¬¡æ•°å·²ç”¨å®Œ" |
| **VIP ç”¨æˆ·** | 20 æ¡ | 200 æ¡ | æ— é™åˆ¶ | - |

---

**å®ç°æ–¹æ¡ˆ 1ï¼šRedis è®¡æ•°å™¨ï¼ˆæ¨èï¼‰**

```java
package com.tangxiaowen.common.interceptor;

/**
 * é™æµæ‹¦æˆªå™¨
 */
@Component
@Slf4j
public class RateLimitInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
                            Object handler) throws Exception {
        String userId = UserContextHolder.getUserId();
        
        // ğŸ”¥ è·å–ç”¨æˆ·ç±»å‹
        String userType = getUserType(userId);
        RateLimitConfig config = getRateLimitConfig(userType);
        
        // ğŸ”¥ æ£€æŸ¥é™æµï¼ˆä¸‰ä¸ªç»´åº¦ï¼‰
        checkRateLimit(userId, "minute", config.getPerMinute(), 60);
        checkRateLimit(userId, "hour", config.getPerHour(), 3600);
        checkRateLimit(userId, "day", config.getPerDay(), 86400);
        
        return true;
    }
    
    /**
     * æ£€æŸ¥é™æµ
     * @param userId ç”¨æˆ·ID
     * @param period å‘¨æœŸï¼ˆminute/hour/dayï¼‰
     * @param limit é™åˆ¶æ¬¡æ•°
     * @param ttl TTLï¼ˆç§’ï¼‰
     */
    private void checkRateLimit(String userId, String period, int limit, int ttl) {
        String key = String.format("rate:limit:%s:%s:%s", period, userId, getCurrentPeriod(period));
        
        // ğŸ”¥ åŸå­é€’å¢
        Long count = redisTemplate.opsForValue().increment(key);
        
        if (count == 1) {
            // ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.expire(key, ttl, TimeUnit.SECONDS);
        }
        
        // ğŸ”¥ è¶…é™åˆ¤æ–­
        if (count > limit) {
            log.warn("ç”¨æˆ·è§¦å‘é™æµï¼šuserId={}, period={}, count={}/{}", 
                userId, period, count, limit);
            
            throw new RateLimitException(String.format(
                "æ‚¨çš„å¯¹è¯è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚ï¼ˆæ¯%sé™åˆ¶ %d æ¡ï¼‰", 
                getPeriodText(period), limit
            ));
        }
        
        log.debug("é™æµæ£€æŸ¥é€šè¿‡ï¼šuserId={}, period={}, count={}/{}", 
            userId, period, count, limit);
    }
    
    /**
     * è·å–å½“å‰å‘¨æœŸæ ‡è¯†
     */
    private String getCurrentPeriod(String period) {
        LocalDateTime now = LocalDateTime.now();
        switch (period) {
            case "minute":
                return now.format(DateTimeFormatter.ofPattern("yyyyMMddHHmm"));
            case "hour":
                return now.format(DateTimeFormatter.ofPattern("yyyyMMddHH"));
            case "day":
                return now.format(DateTimeFormatter.ofPattern("yyyyMMdd"));
            default:
                return "";
        }
    }
    
    /**
     * è·å–ç”¨æˆ·ç±»å‹
     */
    private String getUserType(String userId) {
        User user = userService.getUserById(userId);
        if ("guest".equals(user.getUserType())) {
            return "guest";
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ VIP
        if (subscriptionService.checkSubscriptionAccess(userId, "vip")) {
            return "vip";
        }
        
        return "normal";
    }
    
    /**
     * è·å–é™æµé…ç½®
     */
    private RateLimitConfig getRateLimitConfig(String userType) {
        switch (userType) {
            case "guest":
                return new RateLimitConfig(5, 20, 50);
            case "vip":
                return new RateLimitConfig(20, 200, Integer.MAX_VALUE);
            case "normal":
            default:
                return new RateLimitConfig(10, 50, 100);
        }
    }
}

/**
 * é™æµé…ç½®
 */
@Data
@AllArgsConstructor
class RateLimitConfig {
    private int perMinute;
    private int perHour;
    private int perDay;
}

/**
 * é™æµå¼‚å¸¸
 */
public class RateLimitException extends RuntimeException {
    public RateLimitException(String message) {
        super(message);
    }
}
```

**é…ç½®æ‹¦æˆªå™¨**ï¼š

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Autowired
    private RateLimitInterceptor rateLimitInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // ğŸ”¥ åªå¯¹æ•°å­—äººå¯¹è¯æ¥å£è¿›è¡Œé™æµ
        registry.addInterceptor(rateLimitInterceptor)
            .addPathPatterns("/api/v1/digital-human/sessions/*/messages/**")
            .addPathPatterns("/api/v1/consultations/*/messages/**");
    }
}
```

---

**å®ç°æ–¹æ¡ˆ 2ï¼šBucket4jï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰**

```java
// ä¾èµ–
<dependency>
    <groupId>com.github.vladimir-bukhtoyarov</groupId>
    <artifactId>bucket4j-core</artifactId>
    <version>8.1.0</version>
</dependency>

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class RateLimitService {
    
    private final Map<String, Bucket> buckets = new ConcurrentHashMap<>();
    
    /**
     * è·å–ç”¨æˆ·çš„ä»¤ç‰Œæ¡¶
     */
    public Bucket getBucket(String userId) {
        return buckets.computeIfAbsent(userId, k -> {
            // æ¯åˆ†é’Ÿ 10 ä¸ªä»¤ç‰Œ
            Bandwidth limit = Bandwidth.classic(10, Refill.intervally(10, Duration.ofMinutes(1)));
            return Bucket.builder().addLimit(limit).build();
        });
    }
    
    /**
     * å°è¯•æ¶ˆè´¹ä»¤ç‰Œ
     */
    public boolean tryConsume(String userId) {
        Bucket bucket = getBucket(userId);
        return bucket.tryConsume(1);
    }
}
```

---

#### 12.2.3 å‰ç«¯å‹å¥½æç¤º

**HTTP å“åº”**ï¼š

```json
// 429 Too Many Requests
{
  "code": 429,
  "message": "æ‚¨çš„å¯¹è¯è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "error": {
    "type": "RateLimitExceeded",
    "limit": {
      "perMinute": 10,
      "current": 11,
      "resetAt": "2026-01-29T14:31:00+08:00"
    }
  }
}
```

**å‰ç«¯å¤„ç†**ï¼š

```javascript
// å¾®ä¿¡å°ç¨‹åº
uni.request({
  url: '/api/v1/digital-human/sessions/xxx/messages/stream',
  success: (res) => { ... },
  fail: (err) => {
    if (err.statusCode === 429) {
      // ğŸ”¥ å‹å¥½æç¤º
      uni.showToast({
        title: 'æ‚¨è¯´è¯å¤ªå¿«äº†ï¼Œè¯·ä¼‘æ¯ä¸€ä¸‹~',
        icon: 'none',
        duration: 3000
      });
      
      // ğŸ”¥ è‡ªåŠ¨é‡è¯•ï¼ˆ5 ç§’åï¼‰
      setTimeout(() => {
        sendMessage();
      }, 5000);
    }
  }
});
```

---

#### 12.2.4 æˆæœ¬èŠ‚çœä¼°ç®—

**æ— é™æµåœºæ™¯**ï¼ˆé£é™©ï¼‰ï¼š
```
æ¶æ„æ”»å‡»ï¼š10 æ¡/ç§’ Ã— 3600 ç§’ = 36000 æ¡/å°æ—¶
Token æ¶ˆè€—ï¼š36000 Ã— 1000 Token = 3600 ä¸‡ Token
è´¹ç”¨ï¼š3600 ä¸‡ Ã— Â¥0.0002 = Â¥7200/å°æ—¶ âš ï¸âš ï¸âš ï¸
```

**æœ‰é™æµåœºæ™¯**ï¼ˆå®‰å…¨ï¼‰ï¼š
```
é™æµåï¼š10 æ¡/åˆ†é’Ÿ Ã— 60 åˆ†é’Ÿ = 600 æ¡/å°æ—¶
Token æ¶ˆè€—ï¼š600 Ã— 1000 Token = 60 ä¸‡ Token
è´¹ç”¨ï¼š60 ä¸‡ Ã— Â¥0.0002 = Â¥120/å°æ—¶ âœ…

èŠ‚çœï¼šÂ¥7200 - Â¥120 = Â¥7080/å°æ—¶ï¼ˆ98.3% â†“ï¼‰
```

---

### 12.3 å•ä½è½¬æ¢å›æ˜¾ä¼˜åŒ–ï¼ˆç”¨æˆ·ä½“éªŒï¼‰

#### 12.3.1 é—®é¢˜ï¼šç”¨æˆ·è®¤çŸ¥å¤±è°ƒ

**åœºæ™¯é‡ç°**ï¼š

```
ç”¨æˆ·æ“ä½œï¼š
1. ç”¨æˆ·ä¹ æƒ¯ç”¨ mg/dLï¼ˆç¾å›½ç”¨æˆ·æˆ–è¿›å£è¡€ç³–ä»ªï¼‰
2. ç”¨æˆ·è¾“å…¥ï¼š"æˆ‘è¡€ç³– 100"ï¼ˆmg/dLï¼‰
3. ç³»ç»Ÿå½’ä¸€åŒ–å­˜å‚¨ï¼š100 Ã· 18 = 5.6 mmol/L âœ…

æŸ¥è¯¢åˆ—è¡¨æ—¶ï¼š
å‰ç«¯å±•ç¤ºï¼š5.6 mmol/L
ç”¨æˆ·å›°æƒ‘ï¼š"æˆ‘æ˜æ˜è®°çš„ 100ï¼Œæ€ä¹ˆå˜æˆ 5.6 äº†ï¼Ÿæ˜¯ä¸æ˜¯æ•°æ®ä¸¢äº†ï¼Ÿ" âŒ
```

**å½±å“**ï¼š
- ç”¨æˆ·ä¿¡ä»»åº¦ä¸‹é™
- å®¢æœæŠ•è¯‰å¢åŠ 
- ç”¨æˆ·æµå¤±

---

#### 12.3.2 å®Œæ•´è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šDTO å¢åŠ å±•ç¤ºå­—æ®µ**

```java
package com.tangxiaowen.glucose.dto;

/**
 * è¡€ç³–è®°å½•å“åº”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
 */
@Data
public class GlucoseRecordResponse {
    private String recordId;
    private String userId;
    
    // ========== æ ‡å‡†å€¼ï¼ˆç”¨äºåç«¯è®¡ç®—ã€ç”»å›¾ã€ç»Ÿè®¡ï¼‰==========
    private BigDecimal glucoseValue;  // å½’ä¸€åŒ–å€¼ï¼ˆmmol/Lï¼‰
    private String unit;              // æ ‡å‡†å•ä½ï¼ˆmmol/Lï¼‰
    
    // ========== ğŸ”¥ å±•ç¤ºå€¼ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰==========
    private BigDecimal displayValue;  // ä¼˜å…ˆå±•ç¤ºåŸå§‹å€¼
    private String displayUnit;       // ä¼˜å…ˆå±•ç¤ºåŸå§‹å•ä½
    
    // ========== æ˜¯å¦è½¬æ¢è¿‡ ==========
    private Boolean isConverted;      // æ˜¯å¦ç»è¿‡å•ä½è½¬æ¢
    
    // ========== å…¶ä»–å­—æ®µ ==========
    private String measurementType;
    private LocalDateTime measurementTime;
    private String notes;
    private LocalDateTime createdAt;
}
```

---

**æ­¥éª¤ 2ï¼šService å±‚è½¬æ¢é€»è¾‘**

```java
@Service
public class GlucoseServiceImpl implements GlucoseService {
    
    @Override
    public PageResponse<GlucoseRecordResponse> getRecords(String userId, LocalDate startDate, 
                                                         LocalDate endDate, int page, int size) {
        // 1. æŸ¥è¯¢æ•°æ®åº“
        List<GlucoseRecord> records = glucoseRecordMapper.selectByUserIdAndDateRange(
            userId, startDate, endDate, page, size
        );
        
        // 2. ğŸ”¥ è½¬æ¢ä¸ºå“åº” DTOï¼ˆæ™ºèƒ½å±•ç¤ºé€»è¾‘ï¼‰
        List<GlucoseRecordResponse> responses = records.stream()
            .map(this::convertToResponse)
            .collect(Collectors.toList());
        
        return PageResponse.of(responses, totalCount);
    }
    
    /**
     * ğŸ”¥ è½¬æ¢ä¸ºå“åº” DTOï¼ˆæ™ºèƒ½å±•ç¤ºé€»è¾‘ï¼‰
     */
    private GlucoseRecordResponse convertToResponse(GlucoseRecord record) {
        GlucoseRecordResponse response = new GlucoseRecordResponse();
        
        // åŸºç¡€å­—æ®µ
        response.setRecordId(record.getRecordId());
        response.setUserId(record.getUserId());
        response.setMeasurementType(record.getMeasurementType());
        response.setMeasurementTime(record.getMeasurementTime());
        response.setNotes(record.getNotes());
        response.setCreatedAt(record.getCreatedAt());
        
        // æ ‡å‡†å€¼ï¼ˆå§‹ç»ˆæ˜¯ mmol/Lï¼‰
        response.setGlucoseValue(record.getGlucoseValue());
        response.setUnit("mmol/L");
        
        // ğŸ”¥ å±•ç¤ºé€»è¾‘ï¼šä¼˜å…ˆå±•ç¤ºç”¨æˆ·ä¹ æƒ¯çš„å•ä½
        if (record.getOriginalValue() != null && record.getOriginalUnit() != null) {
            // æœ‰åŸå§‹å€¼ï¼Œè¯´æ˜ç»è¿‡äº†å•ä½è½¬æ¢
            response.setDisplayValue(record.getOriginalValue());
            response.setDisplayUnit(record.getOriginalUnit());
            response.setIsConverted(true);
            
            log.debug("ä½¿ç”¨åŸå§‹å€¼å±•ç¤ºï¼š{} {} (æ ‡å‡†å€¼ï¼š{} mmol/L)", 
                record.getOriginalValue(), record.getOriginalUnit(), record.getGlucoseValue());
            
        } else {
            // æ— åŸå§‹å€¼ï¼Œç›´æ¥ä½¿ç”¨æ ‡å‡†å€¼
            response.setDisplayValue(record.getGlucoseValue());
            response.setDisplayUnit("mmol/L");
            response.setIsConverted(false);
        }
        
        return response;
    }
}
```

---

**æ­¥éª¤ 3ï¼šå‰ç«¯å±•ç¤º**

```vue
<!-- å¾®ä¿¡å°ç¨‹åº -->
<template>
  <view class="record-item">
    <view class="value-main">
      <!-- ğŸ”¥ ä¼˜å…ˆå±•ç¤º displayValue -->
      <text class="value">{{ item.displayValue }}</text>
      <text class="unit">{{ item.displayUnit }}</text>
    </view>
    
    <!-- ğŸ”¥ å¦‚æœè½¬æ¢è¿‡ï¼Œæ˜¾ç¤ºæ ‡å‡†å€¼ï¼ˆå°å­—æç¤ºï¼‰ -->
    <view v-if="item.isConverted" class="value-converted">
      <text class="hint">æ ‡å‡†å€¼ï¼š{{ item.glucoseValue }} mmol/L</text>
    </view>
    
    <view class="measurement-type">{{ getMeasurementTypeText(item.measurementType) }}</view>
    <view class="time">{{ formatTime(item.measurementTime) }}</view>
  </view>
</template>

<style>
.value-main {
  display: flex;
  align-items: baseline;
}

.value {
  font-size: 48rpx;
  font-weight: bold;
  color: #333;
}

.unit {
  font-size: 24rpx;
  color: #999;
  margin-left: 8rpx;
}

.value-converted {
  margin-top: 8rpx;
}

.hint {
  font-size: 20rpx;
  color: #999;
}
</style>
```

---

**æ­¥éª¤ 4ï¼šå›¾è¡¨ç»Ÿä¸€ä½¿ç”¨æ ‡å‡†å€¼**

```javascript
// è¡€ç³–è¶‹åŠ¿å›¾ï¼ˆç»Ÿä¸€ä½¿ç”¨ mmol/Lï¼‰
function drawGlucoseChart(records) {
  const data = records.map(r => ({
    time: r.measurementTime,
    value: r.glucoseValue,  // ğŸ”¥ å›¾è¡¨ä½¿ç”¨æ ‡å‡†å€¼ï¼ˆä¾¿äºå¯¹æ¯”ï¼‰
    unit: 'mmol/L'
  }));
  
  // ç»˜åˆ¶å›¾è¡¨
  echarts.setOption({
    xAxis: { type: 'time' },
    yAxis: { 
      type: 'value',
      name: 'è¡€ç³– (mmol/L)',  // ğŸ”¥ ç»Ÿä¸€å•ä½
      min: 0,
      max: 20
    },
    series: [{
      data: data,
      type: 'line'
    }]
  });
}
```

---

#### 12.3.3 ç”¨æˆ·æ•™è‚²ï¼ˆå¯é€‰ï¼‰

**é¦–æ¬¡ä½¿ç”¨æç¤º**ï¼š

```javascript
// ç”¨æˆ·é¦–æ¬¡å½•å…¥ mg/dL æ—¶ï¼Œå¼¹å‡ºè¯´æ˜
if (isFirstTimeMgdL(userId)) {
  uni.showModal({
    title: 'å•ä½è½¬æ¢è¯´æ˜',
    content: 'æ‚¨ä¹ æƒ¯ä½¿ç”¨ mg/dL å•ä½ï¼Œæˆ‘ä»¬å·²ä¸ºæ‚¨è‡ªåŠ¨è½¬æ¢å¹¶ä¿å­˜ã€‚' +
             'æŸ¥çœ‹è®°å½•æ—¶ä¼šä¼˜å…ˆå±•ç¤ºæ‚¨ä¹ æƒ¯çš„å•ä½ï¼ˆmg/dLï¼‰ï¼Œ' +
             'å›¾è¡¨å’Œç»Ÿè®¡ä¼šä½¿ç”¨å›½é™…æ ‡å‡†å•ä½ï¼ˆmmol/Lï¼‰ä»¥ä¾¿å¯¹æ¯”ã€‚',
    confirmText: 'æˆ‘çŸ¥é“äº†',
    success: (res) => {
      if (res.confirm) {
        setUserPreference(userId, 'unit_education_shown', true);
      }
    }
  });
}
```

**è®¾ç½®é¡µé¢**ï¼š

```vue
<template>
  <view class="settings">
    <view class="setting-item">
      <text class="label">è¡€ç³–å•ä½åå¥½</text>
      <picker @change="onUnitChange" :value="unitIndex" :range="units">
        <view class="picker">{{ units[unitIndex] }}</view>
      </picker>
    </view>
    
    <view class="hint">
      é€‰æ‹©æ‚¨ä¹ æƒ¯çš„å•ä½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†è½¬æ¢ã€‚
      æ ‡å‡†å€¼ï¼ˆmmol/Lï¼‰å°†ç”¨äºåŒ»å­¦åˆ†æå’Œç»Ÿè®¡ã€‚
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      unitIndex: 0,
      units: ['mmol/Lï¼ˆä¸­å›½æ ‡å‡†ï¼‰', 'mg/dLï¼ˆç¾å›½æ ‡å‡†ï¼‰']
    };
  },
  methods: {
    onUnitChange(e) {
      this.unitIndex = e.detail.value;
      const unit = this.unitIndex === 0 ? 'mmol/L' : 'mg/dL';
      
      // ä¿å­˜ç”¨æˆ·åå¥½
      uni.request({
        url: '/api/v1/users/preferences',
        method: 'PUT',
        data: { glucoseUnit: unit }
      });
    }
  }
};
</script>
```

---

#### 12.3.4 æ•ˆæœå¯¹æ¯”

| åœºæ™¯ | åŸè®¾è®¡ | ä¼˜åŒ–å | ç”¨æˆ·ä½“éªŒ |
|------|--------|--------|---------|
| ç”¨æˆ·å½•å…¥ 100 mg/dL | åˆ—è¡¨æ˜¾ç¤º 5.6 mmol/L | åˆ—è¡¨æ˜¾ç¤º 100 mg/dL<br>å°å­—æç¤ºï¼šæ ‡å‡†å€¼ 5.6 mmol/L | âœ… æ— å›°æƒ‘ |
| è¶‹åŠ¿å›¾å±•ç¤º | æ··åˆå•ä½ï¼ˆéš¾ä»¥å¯¹æ¯”ï¼‰ | ç»Ÿä¸€ mmol/L | âœ… ä¾¿äºå¯¹æ¯” |
| åŒ»å­¦ç»Ÿè®¡ | éœ€è¦å®æ—¶è½¬æ¢ | ä½¿ç”¨æ ‡å‡†å€¼ | âœ… æ€§èƒ½å¥½ |

---

## 13. éƒ¨ç½²é…ç½®æ€»ç»“

### 13.1 é…ç½®æ¸…å•

| é…ç½®é¡¹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | å®ç°éš¾åº¦ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|--------|
| **Nginx è¶…æ—¶é…ç½®** | ğŸ”´ ä¸¥é‡ | SSE å…¨éƒ¨å¤±æ•ˆ | â­ | **P0** |
| **SLB è¶…æ—¶é…ç½®** | ğŸ”´ ä¸¥é‡ | SSE å…¨éƒ¨å¤±æ•ˆ | â­ | **P0** |
| **åº”ç”¨å±‚é™æµ** | ğŸŸ  é«˜ | æˆæœ¬æš´å¢ | â­â­ | **P0** |
| **å•ä½å›æ˜¾ä¼˜åŒ–** | ğŸŸ¡ ä¸­ | ç”¨æˆ·ä½“éªŒ | â­â­ | **P1** |
| **å¿ƒè·³åŒ…æœºåˆ¶** | ğŸŸ¡ ä¸­ | é•¿æ—¶æ¨ç†å¤±è´¥ | â­â­ | **P1** |

### 13.2 P0 éƒ¨ç½²å‰å¼ºåˆ¶æ£€æŸ¥

**å¿…é¡»å®Œæˆ**ï¼ˆå¦åˆ™æ— æ³•æ­£å¸¸è¿è¡Œï¼‰ï¼š

- [ ] **Nginx é…ç½®** âœ…
  - [ ] proxy_read_timeout 300s
  - [ ] proxy_buffering off
  - [ ] X-Accel-Buffering no
  - [ ] æµ‹è¯• SSE è¿æ¥è¶…è¿‡ 60 ç§’

- [ ] **SLB/ALB é…ç½®** âœ…
  - [ ] ç©ºé—²è¶…æ—¶ 180 ç§’
  - [ ] å¯ç”¨ HTTP/2
  - [ ] å¥åº·æ£€æŸ¥é…ç½®

- [ ] **åº”ç”¨å±‚é™æµ** âœ…
  - [ ] RateLimitInterceptor å®ç°
  - [ ] Redis è®¡æ•°å™¨
  - [ ] é™æµç­–ç•¥ï¼ˆè®¿å®¢/æ™®é€š/VIPï¼‰
  - [ ] å‰ç«¯å‹å¥½æç¤º

- [ ] **å•ä½å›æ˜¾** âœ…
  - [ ] DTO å¢åŠ  displayValue/displayUnit
  - [ ] Service è½¬æ¢é€»è¾‘
  - [ ] å‰ç«¯å±•ç¤ºä¼˜åŒ–

### 13.3 ç›‘æ§å‘Šè­¦

**è¿ç»´ç›‘æ§**ï¼š
```bash
# Nginx è¶…æ—¶ç›‘æ§
tail -f /var/log/nginx/error.log | grep "upstream timed out"

# é™æµè§¦å‘ç›‘æ§
tail -f /app/logs/application.log | grep "ç”¨æˆ·è§¦å‘é™æµ"

# SSE è¿æ¥æ•°ç›‘æ§
curl http://localhost:8080/actuator/metrics/sse.active.connections
```

**å‘Šè­¦é˜ˆå€¼**ï¼š
- ğŸ”´ Nginx è¶…æ—¶æ¬¡æ•° > 10 æ¬¡/å°æ—¶ â†’ ç«‹å³å‘Šè­¦
- ğŸŸ  é™æµè§¦å‘ > 50 æ¬¡/å°æ—¶ â†’ è­¦å‘Šï¼ˆå¯èƒ½é­æ”»å‡»ï¼‰
- ğŸŸ¡ SSE è¿æ¥æ•° > 500 â†’ æ‰©å®¹å»ºè®®

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.3 (éƒ¨ç½²è¿ç»´åŠ å›ºç‰ˆ)  
**æœ€åæ›´æ–°**: 2026-01-29  
**ä½œè€…**: AI æ¶æ„å¸ˆ  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  

**ä¸»è¦å˜æ›´**ï¼š
- âœ… æ•°å­—äººäº¤äº’æ”¹ä¸º SSE æµå¼åè®®
- âœ… å¢åŠ  Agent å·¥å…·æ‰§è¡Œå™¨ï¼ˆFunction Callingï¼‰
- âœ… ä¼˜åŒ–æ•æ„Ÿæ•°æ®åŠ å¯†ä¸æ£€ç´¢ç­–ç•¥
- âœ… æ˜ç¡®è®¿å®¢è½¬æ­£æ•°æ®è¿ç§»é€»è¾‘
- âœ… å¢åŠ  OSS æ–‡ä»¶ä¸Šä¼ æ¨¡å—
- âœ… å¼ºåŒ–æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§ä¿è¯
- âœ… è¡¥å……æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§æ–¹æ¡ˆ
